<%- include('partials/header', {title: 'S·ª≠a CTKM' , currentPage: 'edit-promotion' , time: time}) %>

<style>
    /* === CSS CHUNG CHO TRANG ADMIN === */
    .edit-promotion-container { max-width: 1100px; margin: 0 auto; padding: 20px; background: #f3f4f6; min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    
    .page-header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .page-header h1 { margin: 0; font-size: 20px; color: #111827; }
    .page-header p { margin: 5px 0 0; color: #6b7280; font-size: 13px; }
    .back-button { color: #4b5563; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; margin-bottom: 15px; font-weight: 500; }
    .back-button:hover { color: #111827; }

    /* === FORM STYLES === */
    .promo-form { display: flex; flex-direction: column; gap: 20px; }
    .form-section { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .form-section h3 { margin-top: 0; margin-bottom: 20px; font-size: 16px; font-weight: 700; color: #111827; border-bottom: 1px solid #f3f4f6; padding-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #111827; background-color: #fff; transition: border-color 0.15s ease; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 4px; display: block; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    .form-actions { position: sticky; bottom: 0; z-index: 10; background: #fff; padding: 15px 24px; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; justify-content: flex-end; gap: 12px; margin: 0 -20px -20px -20px; }
    .btn-primary { background: #111827; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-secondary { background: #fff; color: #374151; border: 1px solid #d1d5db; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; text-decoration: none; }

    /* RTE Toolbar */
    .rte-toolbar { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; background: #f9fafb; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; }
    .rte-btn { padding: 4px 10px; border: 1px solid #d1d5db; background: #fff; border-radius: 4px; cursor: pointer; font-size: 13px; color: #374151; }
    .rte-field { min-height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; }

    /* Table trong form */
    .detail-grid { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .detail-grid th { background: #f8fafc; padding: 16px; text-align: left; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; width: 220px; min-width: 220px; color: #334155; font-weight: 600; font-size: 14px; vertical-align: top; line-height: 1.5; }
    .detail-grid td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; background: #fff; }
    .detail-grid tr:last-child th, .detail-grid tr:last-child td { border-bottom: none; }
    
    /* CSS CHO C√ÅC BLOCK NH·∫¨P LI·ªÜU ƒê·∫∂C BI·ªÜT */
    .special-block { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .special-title { font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px dashed #cbd5e1; padding-bottom: 5px; }
    
    .sku-link-row { display: grid; grid-template-columns: 100px 2fr 1fr; gap: 10px; align-items: center; margin-bottom: 5px; font-size: 13px; }
    .sku-link-row input { font-size: 13px; padding: 6px; }
    .sku-info-display { color: #059669; font-weight: 500; font-size: 12px; }
    
    .combo-row, .gift-option { border: 1px solid #e5e7eb; background: #fff; padding: 10px; border-radius: 6px; margin-bottom: 10px; position: relative; }
    .remove-row-btn { position: absolute; top: 5px; right: 5px; color: #ef4444; cursor: pointer; font-size: 16px; font-weight: bold; }
    
    .add-btn-dashed { width: 100%; border: 1px dashed #3b82f6; color: #3b82f6; background: #eff6ff; padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 5px; }
    .add-btn-dashed:hover { background: #dbeafe; }

    @media (max-width: 768px) {
        .form-row { grid-template-columns: 1fr; }
        .sku-link-row { grid-template-columns: 1fr; }
        .detail-grid { display: block; overflow-x: auto; }
    }

    /* --- FIX LAYOUT TIER PRICE --- */
#tier-price-config {
    background: #f8fafc;        /* M√†u n·ªÅn nh·∫π cho n·ªïi b·∫≠t */
    border: 1px solid #3b82f6;   /* Vi·ªÅn xanh ch·ªß ƒë·∫°o */
    border-radius: 8px;          /* Bo g√≥c */
    padding: 20px;               /* ƒê·ªám b√™n trong (Fix l·ªói d√≠nh s√°t) */
    margin-top: 20px;            /* C√°ch b√™n tr√™n (Fix l·ªói ch·ªìng ch√©o) */
    margin-bottom: 20px;         /* C√°ch b√™n d∆∞·ªõi */
    clear: both;                 /* ƒê·∫£m b·∫£o kh√¥ng b·ªã c√°c ph·∫ßn t·ª≠ float ƒë√® l√™n */
}

/* Style cho b·∫£ng nh·∫≠p m·ªëc */
#tier-price-config table {
    background: #fff;
    width: 100%;
    margin-bottom: 10px;
}
#tier-price-config th {
    background: #eff6ff;
    color: #1e3a8a;
    font-size: 13px;
    padding: 8px;
}
#tier-price-config input.tier-qty, 
#tier-price-config input.tier-disc {
    text-align: center;
    font-weight: 600;
}
</style>

<div class="edit-promotion-container">
    <a href="/promo-management" class="back-button">‚Üê Quay l·∫°i danh s√°ch</a>

    <div class="page-header">
        <div>
            <h1>S·ª≠a Ch∆∞∆°ng Tr√¨nh Khuy·∫øn M√£i</h1>
            <p>ID: <%= promotion.id %></p>
        </div>
    </div>

    <% if (typeof error !=='undefined' && error) { %>
        <div style="background:#fef2f2; color:#991b1b; padding:12px; border-radius:6px; margin-bottom:20px; border:1px solid #fecaca;">
            ‚ö†Ô∏è <%= error %>
        </div>
    <% } %>
    <form action="/edit-promotion/<%= promotion.id %>" method="POST" class="promo-form" id="promoForm">
        
        <div class="form-section">
            <h3>1. Th√¥ng tin chung & Ph·∫°m vi</h3>
            <div class="form-group">
                <label>T√™n ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i *</label>
                <input type="text" name="name" value="<%= promotion.name %>" required>
                <input type="hidden" name="subgroup_name" value="<%= promotion.name %>"> 
            </div>
            <div class="form-group">
                <label>M√¥ t·∫£ ng·∫Øn (Hi·ªÉn th·ªã d∆∞·ªõi t√™n CTKM)</label>
                <textarea name="description" rows="2" placeholder="VD: √Åp d·ª•ng cho c√°c s·∫£n ph·∫©m Apple ch√≠nh h√£ng..." style="resize: vertical;"><%= promotion.description || '' %></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Lo·∫°i CTKM (Quy·∫øt ƒë·ªãnh form nh·∫≠p li·ªáu) *</label>
                    <select name="promo_type" id="promoTypeSelect" required onchange="handlePromoTypeChange()">
                        <option value="Kh√¥ng c√≥ m√£" <%= promotion.promo_type === 'Kh√¥ng c√≥ m√£' ? 'selected' : '' %>>Kh√¥ng c√≥ m√£</option>
                        <option value="Coupon" <%= promotion.promo_type === 'Coupon' ? 'selected' : '' %>>Coupon (Nh·∫≠p m√£)</option>
                        <option value="Voucher" <%= promotion.promo_type === 'Voucher' ? 'selected' : '' %>>Voucher (T·ª± ƒë·ªông)</option>
                        <option value="T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau" <%= promotion.promo_type === 'T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau' ? 'selected' : '' %>>T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau</option>
                        <option value="∆Øu ƒë√£i thanh to√°n" <%= promotion.promo_type === '∆Øu ƒë√£i thanh to√°n' ? 'selected' : '' %>>∆Øu ƒë√£i thanh to√°n</option>
                        <option value="Tr·∫£ g√≥p" <%= (promotion.promo_type || '').includes('Tr·∫£ g√≥p') ? 'selected' : '' %>>∆Øu ƒë√£i tr·∫£ g√≥p</option>
                        <option value="Gift" <%= promotion.promo_type === 'Gift' ? 'selected' : '' %>>Qu√† t·∫∑ng (Gift)</option>
                        <option value="Combo" <%= promotion.promo_type === 'Combo' ? 'selected' : '' %>>Combo</option>
                        <option value="Thi ƒëua n·ªôi b·ªô" <%= promotion.promo_type === 'Thi ƒëua n·ªôi b·ªô' ? 'selected' : '' %>>Thi ƒëua n·ªôi b·ªô</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nh√≥m (Group)</label>
                    <input type="text" name="group_name" value="<%= promotion.group_name || '' %>" placeholder="VD: BACK_TO_SCHOOL">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" name="start_date" value="<%= promotion.start_date %>" required></div>
                <div class="form-group"><label>Ng√†y k·∫øt th√∫c</label><input type="date" name="end_date" value="<%= promotion.end_date %>" required></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Channel</label>
                    <select name="channel">
                        <option value="All" <%= promotion.channel === 'All' ? 'selected' : '' %>>T·∫•t c·∫£</option>
                        <option value="Online" <%= promotion.channel === 'Online' ? 'selected' : '' %>>Online</option>
                        <option value="Offline" <%= promotion.channel === 'Offline' ? 'selected' : '' %>>Offline</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üè¢ Chi nh√°nh √°p d·ª•ng</label>
                    <% const branchList = ['HCM.BD', 'CP01', 'CP02', 'CP05', 'CP07', 'CP08', 'CP40', 'CP46', 'CP67', 'CP58', 'CP62', 'CP64', 'CP69']; %>
                    <% const currentBranches = promotion.apply_branches || []; %>
                    <select name="apply_branches[]" multiple class="multi-select" style="height: 100px;">
                        <% branchList.forEach(br => { %>
                            <option value="<%= br %>" <%= currentBranches.includes(br) ? 'selected' : '' %>><%= br %></option>
                        <% }) %>
                    </select>
                    <small class="hint">Gi·ªØ Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu. Kh√¥ng ch·ªçn = To√†n qu·ªëc.</small>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 10px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:normal;">
                    <input type="checkbox" name="show_multiple_in_group" style="width:auto;" <%= promotion.show_multiple_in_group ? 'checked' : '' %>>
                    <span>Lu√¥n hi·ªÉn th·ªã (Kh√¥ng ·∫©n d√π c√≥ CTKM t·ªët h∆°n trong c√πng nh√≥m)</span>
                </label>
            </div>
        </div>

        <div class="form-section" id="valueSection">
            <h3>2. Gi√° tr·ªã & M√£ gi·∫£m gi√°</h3>
            
            <div id="blockBasicValue">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ki·ªÉu gi·∫£m gi√°</label>
                        <select name="discount_value_type" id="discount_value_type" onchange="toggleDiscountInputs()">
                            <option value="">-- Kh√¥ng gi·∫£m ti·ªÅn tr·ª±c ti·∫øp --</option>
                            <option value="amount">Gi·∫£m s·ªë ti·ªÅn c·ªë ƒë·ªãnh (VNƒê)</option>
                            <option value="percent">Gi·∫£m theo ph·∫ßn trƒÉm (%)</option>
                        </select>
                    </div>
                    <div class="form-group" id="amountBox" style="display:none;">
                        <label>S·ªë ti·ªÅn gi·∫£m (VNƒê)</label>
                        <input type="number" name="discount_amount" placeholder="VD: 500000">
                    </div>
                    <div class="form-group" id="percentBox" style="display:none;">
                        <label>% Gi·∫£m</label>
                        <input type="number" name="discount_percent" placeholder="VD: 10">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ƒê∆°n t·ªëi thi·ªÉu (VNƒê)</label>
                        <input type="number" name="min_order_value" value="<%= promotion.min_order_value %>" placeholder="0">
                    </div>
                    <div class="form-group" id="capBox" style="display:none;">
                        <label>Gi·∫£m t·ªëi ƒëa (VNƒê)</label>
                        <input type="number" name="max_discount_amount" placeholder="N·∫øu gi·∫£m %, t·ªëi ƒëa bao nhi√™u?">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px; border-top: 1px dashed #e5e7eb; padding-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #b45309; cursor: pointer;">
                        <input type="checkbox" name="has_coupon_list" id="hasCouponListCheckbox" style="width: auto;" 
                        <%= (promotion.coupon_list && promotion.coupon_list.length > 0) ? 'checked' : '' %> 
                        onchange="toggleCouponBuilder()">
                        <span>S·ª≠ d·ª•ng danh s√°ch Coupon/Voucher (Nhi·ªÅu m√£)</span>
                    </label>
                </div>

                <div class="form-group" id="couponCodeInput">
                    <label>M√£ Coupon (M√£ ƒë∆°n)</label>
                    <input type="text" name="coupon_code" value="<%= promotion.coupon_code || '' %>" placeholder="VD: SUMMER2025">
                </div>

                <div id="couponListBuilder" style="display: none; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px; margin-top: 10px;">
                    <div class="special-title" style="color: #b45309; border-bottom-color: #fcd34d;">üìù Danh s√°ch m√£ gi·∫£m gi√°</div>
                    <div id="couponListContainer"></div>
                    <div class="add-btn-dashed" onclick="addCouponRow()" style="color:#b45309; border-color:#b45309; background:#fff; margin-top: 10px;">+ Th√™m d√≤ng m√£</div>
                </div>
            </div>

            <div id="blockNextOrder" class="special-block" style="display:none;">
                <div class="special-title">üé´ C·∫•u h√¨nh M√£ t·∫∑ng ƒë∆°n sau</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>M√£ gi·∫£m ƒë∆°n sau (N·∫øu c√≥)</label>
                        <input type="text" name="detail[next_order_code]" class="rte-field-input" placeholder="VD: THANKYOU">
                    </div>
                    <div class="form-group">
                        <label>C√°ch th·ª©c nh·∫≠n m√£</label>
                        <select name="detail[receive_method]" class="rte-field-input">
                            <option value="M√£ c·ªë ƒë·ªãnh">M√£ c·ªë ƒë·ªãnh (Chung)</option>
                            <option value="Qua App Consumer">Qua App Consumer (Voucher kho)</option>
                            <option value="SMS">G·ª≠i qua SMS</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Gi√° tr·ªã gi·∫£m (M√¥ t·∫£)</label>
                    <input type="text" name="detail[next_order_value]" class="rte-field-input" placeholder="VD: Gi·∫£m 100k cho ƒë∆°n t·ª´ 1 tri·ªáu">
                </div>
                
                <div class="form-group" style="margin-top: 10px; border-top: 1px dashed #cbd5e1; padding-top: 10px;">
                    <label>Danh s√°ch SKU √°p d·ª•ng m√£ gi·∫£m n√†y (List SKU):</label>
                    <textarea name="detail[next_order_target_skus]" rows="3" class="rte-field-input" 
                        placeholder="Paste danh s√°ch SKU v√†o ƒë√¢y (c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng)..."></textarea>
                    <small class="hint">V√≠ d·ª•: 2401001, 2401002 (ƒê·ªÉ tr·ªëng n·∫øu √°p d·ª•ng to√†n b·ªô)</small>
                </div>
            </div>

            <div id="blockInstallment" class="special-block" style="display:none;">
                <div class="special-title">üè¶ C·∫•u h√¨nh Tr·∫£ g√≥p</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i tr·∫£ g√≥p</label>
                        <select name="detail[installment_type]" class="rte-field-input">
                            <option value="Th·∫ª t√≠n d·ª•ng">Qua th·∫ª t√≠n d·ª•ng</option>
                            <option value="C√¥ng ty t√†i ch√≠nh">Qua c√¥ng ty t√†i ch√≠nh</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ƒê·ªëi t√°c</label>
                        <select name="detail[installment_partner]" class="rte-field-input">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="Vnpay">Vnpay</option>
                            <option value="Payoo">Payoo</option>
                            <option value="ACS">ACS</option>
                            <option value="HD SAISON">HD SAISON</option>
                            <option value="Home Credit">Home Credit</option>
                            <option value="Mcredit">Mcredit</option>
                            
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tr·∫£ tr∆∞·ªõc (%)</label>
                        <input type="text" name="detail[installment_prepay]" class="rte-field-input" placeholder="VD: 0% ho·∫∑c 20%">
                    </div>
                    <div class="form-group">
                        <label>L√£i su·∫•t (%)</label>
                        <input type="text" name="detail[installment_interest]" class="rte-field-input" placeholder="VD: 0%">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ph√≠ (N·∫øu c√≥)</label>
                    <input type="text" name="detail[installment_fee]" class="rte-field-input" placeholder="VD: 0ƒë ho·∫∑c Theo quy ƒë·ªãnh">
                </div>
            </div>

            <div id="blockGift" class="special-block" style="display:none;">
                <div class="special-title">üéÅ C·∫•u h√¨nh Qu√† t·∫∑ng (Options)</div>
                <div id="giftContainer"></div>
                <div class="add-btn-dashed" onclick="addGiftOption()">+ Th√™m Option qu√† t·∫∑ng</div>
            </div>

            <div id="blockCombo" class="special-block" style="display:none;">
                <div class="special-title">üß© C·∫•u h√¨nh Combo</div>
                <p class="hint">C√°c SKU trong combo s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c th√™m v√†o ph·∫°m vi t√¨m ki·∫øm.</p>
                <div id="comboContainer"></div>
                <div class="add-btn-dashed" onclick="addComboRow()">+ Th√™m b·ªô Combo</div>
                <div class="form-section" style="background:#f8fafc; border:1px solid #e2e8f0;">
    <h3 style="color:#2563eb; margin-bottom:15px; border-bottom:1px dashed #cbd5e1; padding-bottom:5px;">
        üß© C·∫•u h√¨nh Combo / Gh√©p SP
    </h3>

    <div class="form-group">
        <label>M√£ nh√≥m h√†ng gh√©p (Subcat)</label>
        <input type="text" name="detail[combo_partner_subcat]" class="form-control" placeholder="VD: NH01-02">
        <small class="text-muted">Nh·∫≠p m√£ nh√≥m h√†ng ƒë·ªÉ l·∫•y to√†n b·ªô s·∫£n ph·∫©m trong nh√≥m ƒë√≥.</small>
    </div>

    <div class="form-group">
        <label>Ho·∫∑c: Danh s√°ch SKU c·ª• th·ªÉ (∆Øu ti√™n)</label>
        <textarea name="detail[combo_sku_list]" class="form-control" rows="3" 
                  placeholder="Paste danh s√°ch m√£ SKU v√†o ƒë√¢y (VD: 23011, 23022...). N·∫øu nh·∫≠p √¥ n√†y, Subcat ·ªü tr√™n s·∫Ω b·ªã b·ªè qua."></textarea>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label>Gi√° tr·ªã gi·∫£m</label>
                <input type="number" name="detail[combo_discount_val]" class="form-control" placeholder="0">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>Lo·∫°i gi·∫£m</label>
                <select name="detail[combo_discount_type]" class="form-control">
                    <option value="amount">VNƒê (ƒë)</option>
                    <option value="percent">%</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>ƒê∆°n t·ªëi thi·ªÉu (ƒë)</label>
                <input type="number" name="detail[combo_min_order]" class="form-control" placeholder="0 = Kh√¥ng gi·ªõi h·∫°n">
            </div>
        </div>
    </div>
</div>


  <div style="margin-top:10px;" class="form-check form-switch">
    <input class="form-check-input" type="checkbox" id="trigger_tier_price" onchange="toggleTierConfig()">
    <label class="form-check-label fw-bold text-primary" for="trigger_tier_price">
        üì¶ K√≠ch ho·∫°t: Mua nhi·ªÅu gi·∫£m s√¢u (Tier Price)
    </label>
</div>

<div id="tier-price-config" style="display: none;">
    <div style="font-weight: 700; color: #1e40af; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px dashed #93c5fd; padding-bottom: 5px;">
        <i class="fas fa-layer-group"></i> C·∫•u h√¨nh M·ªëc S·ªë L∆∞·ª£ng
    </div>

    <div style="font-size: 13px; color: #1e3a8a; background: #dbeafe; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px;">
        ‚ÑπÔ∏è <strong>L∆∞u √Ω:</strong> B·∫£ng gi√° n√†y s·∫Ω √°p d·ª•ng cho c√°c s·∫£n ph·∫©m b·∫°n ch·ªçn ·ªü m·ª•c "4. PH·∫†M VI S·∫¢N PH·∫®M".
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead>
                <tr>
                    <th style="width: 30%;">Mua t·ª´ s·ªë l∆∞·ª£ng (Min)</th>
                    <th style="width: 35%;">M·ª©c gi·∫£m gi√°</th>
                    <th style="width: 25%;">ƒê∆°n v·ªã</th>
                    <th style="width: 10%;">X√≥a</th>
                </tr>
            </thead>
            <tbody id="tier-rows">
                </tbody>
        </table>
    </div>

    <button type="button" class="add-btn-dashed" onclick="addTierRow()" style="margin-top:0;">
        + Th√™m m·ªëc s·ªë l∆∞·ª£ng
    </button>
    
    <div style="margin-top: 8px; font-size: 12px; color: #ea580c; font-style: italic;">
        * Gi√° tr·ªã gi·∫£m ƒë∆∞·ª£c t√≠nh tr√™n ƒë∆°n gi√° m·ªói s·∫£n ph·∫©m.
    </div>


</div>
                </div>
            </div>
        <div class="form-section">
            <h3>3. N·ªôi dung & Quy ƒë·ªãnh</h3>
            <div class="rte-toolbar" id="rteToolbar">
                <button type="button" class="rte-btn" data-cmd="bold"><b>B</b></button>
                <button type="button" class="rte-btn" data-cmd="italic"><i>I</i></button>
                <button type="button" class="rte-btn" data-cmd="underline"><u>U</u></button>
                <input type="color" class="rte-btn" id="rteColor" style="width:30px; padding:0; height:26px;">
                <button type="button" class="rte-btn" id="rteLink">üîó Link</button>
            </div>
            <% const CONTENT_ROWS = ['N·ªôi dung', 'ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng √°p d·ª•ng', 'ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng lo·∫°i tr·ª´', 'Gi·ªõi h·∫°n l∆∞·ª£t √°p d·ª•ng', 'Y√™u c·∫ßu ƒë·∫∑c bi·ªát', 'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng coupon', 'Link n·ªôi b·ªô/ b√°o c√°o']; %>
            <table class="detail-grid">
                <tbody>
                    <% CONTENT_ROWS.forEach(function(label, idx){ %>
                        <tr>
                            <th><%= label %></th>
                            <td>
                                <div class="rte-field" contenteditable="true" data-name="detail[<%= label %>]" data-index="<%= idx %>">
                                    <%- (promotion.detail_fields && promotion.detail_fields[label]) ? promotion.detail_fields[label] : '' %>
                                </div>
                                <textarea name="detail[<%= label %>]" hidden></textarea>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <div class="form-section">
            <h3>4. Ph·∫°m vi s·∫£n ph·∫©m √°p d·ª•ng</h3>
            <div class="form-group">
                <label>√Åp d·ª•ng cho:</label>
                <% 
                    // Logic ∆∞u ti√™n l·∫•y apply_to_type t·ª´ DB
                    let currentScope = promotion.apply_to_type;

                    // Fallback cho data c≈© (n·∫øu DB ch∆∞a c√≥ field apply_to_type)
                    if (!currentScope) {
                        if (promotion.apply_to_all_skus) currentScope = 'all';
                        else if (promotion.promotion_skus && promotion.promotion_skus.length > 0) currentScope = 'sku';
                        else if (promotion.apply_brand_subcats && promotion.apply_brand_subcats.length > 0) currentScope = 'brand_subcat';
                        else if (promotion.apply_to_brands && promotion.apply_to_brands.length > 0) currentScope = 'brand';
                        else if (promotion.apply_to_categories && promotion.apply_to_categories.length > 0) currentScope = 'category';
                        else if (promotion.apply_to_subcats && promotion.apply_to_subcats.length > 0) currentScope = 'subcat';
                        else currentScope = 'all'; // M·∫∑c ƒë·ªãnh
                    }
                %>
                <select name="apply_to_type" id="applyToTypeSelect" onchange="toggleScopeFields()">
                    <option value="all" <%= currentScope === 'all' ? 'selected' : '' %>>T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                    <option value="sku" <%= currentScope === 'sku' ? 'selected' : '' %>>Theo danh s√°ch SKU</option>
                    <option value="brand" <%= currentScope === 'brand' ? 'selected' : '' %>>Theo Brand</option>
                    <option value="category" <%= currentScope === 'category' ? 'selected' : '' %>>Theo Category</option>
                    <option value="subcat" <%= currentScope === 'subcat' ? 'selected' : '' %>>Theo Subcat</option>
                    <option value="brand_subcat" <%= currentScope === 'brand_subcat' ? 'selected' : '' %>>Theo Brand + Subcat</option>
                </select>
            </div>

            <div id="skuField" style="display:none;" class="form-group">
                <label>Nh·∫≠p SKU (c√°ch nhau d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng)</label>
                <textarea name="skus" id="mainSkuTextarea" rows="5"><%= (promotion.promotion_skus || []).map(x => x.sku).join(', ') %></textarea>
                <p class="hint">N·∫øu ch·ªçn lo·∫°i Combo/Qu√† t·∫∑ng, SKU nh·∫≠p ·ªü tr√™n s·∫Ω t·ª± ƒë·ªông th√™m v√†o ƒë√¢y.</p>
            </div>
            <div id="brandField" style="display:none;" class="form-group">
                <label>Nh·∫≠p Brand (VD: Apple, Samsung)</label>
                <input type="text" name="apply_brands" value="<%= (promotion.apply_to_brands || []).join(', ') %>">
            </div>
            <div id="categoryField" style="display:none;" class="form-group">
                <label>Nh·∫≠p Category (VD: NH01)</label>
                <input type="text" name="apply_categories" value="<%= (promotion.apply_to_categories || []).join(', ') %>">
            </div>
            <div id="subcatField" style="display:none;" class="form-group">
                <label>Nh·∫≠p Subcat (VD: NH01-01)</label>
                <input type="text" name="apply_subcats" value="<%= (promotion.apply_to_subcats || []).join(', ') %>">
            </div>

            <hr style="border:0; border-top:1px dashed #e5e7eb; margin: 20px 0;">
            <div class="form-row">
                <div class="form-group">
                    <label>Lo·∫°i tr·ª´ Brand</label>
                    <input type="text" name="exclude_brands" value="<%= (promotion.exclude_brands || []).join(', ') %>">
                </div>
                <div class="form-group">
                    <label>Lo·∫°i tr·ª´ Subcat</label>
                    <input type="text" name="exclude_subcats" value="<%= (promotion.exclude_subcats || []).join(', ') %>">
                </div>
            </div>
            <div class="form-group">
                <label>Lo·∫°i tr·ª´ SKU c·ª• th·ªÉ</label>
                <textarea name="excluded_skus" rows="2" placeholder="SKU b·ªã ch·∫∑n..."><%= (promotion.promotion_excluded_skus || []).map(x=> x.sku).join(', ') %></textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>5. Quan h·ªá v·ªõi CTKM kh√°c</h3>
            <% 
               const grouped = {};
               (allPromosForCompat || []).forEach(p => { 
                   const g = p.group_name || 'Kh√°c'; 
                   (grouped[g] = grouped[g] || []).push(p); 
               });
               const groupNames = Object.keys(grouped).sort((a,b) => a.localeCompare(b,'vi'));
            %>
            <div class="form-row">
                <div class="form-group">
                    <label style="color:#059669;">‚úÖ √Åp d·ª•ng c√πng (C·ªông d·ªìn)</label>
                    <div style="display:flex; gap:8px; margin-bottom:6px;">
                        <select id="applyWithGroupPicker" style="flex:1;">
                            <option value="">-- Ch·ªçn nh√≥m nhanh --</option>
                            <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                        </select>
                        <button type="button" class="btn-secondary" id="btnSelectGroupAW" style="padding:4px 10px;">Ch·ªçn</button>
                        <button type="button" class="btn-secondary" id="btnUnselectGroupAW" style="padding:4px 10px;">B·ªè</button>
                    </div>
                    <select name="apply_with[]" multiple class="multi-select" id="applyWithSelect" style="height:150px;">
                        <% groupNames.forEach(g => { %>
                            <optgroup label="<%= g %>">
                                <% grouped[g].forEach(function(p){ 
                                    var label = p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name || p.name)) : p.name;
                                %>
                                    <option data-group="<%= g %>" value="<%= p.id %>" <%= (compatAllowIds||[]).includes(String(p.id)) ? 'selected' : '' %>><%= label %></option>
                                <% }) %>
                            </optgroup>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group">
                    <label style="color:#dc2626;">‚õî Kh√¥ng √°p d·ª•ng c√πng (Lo·∫°i tr·ª´)</label>
                    <div style="display:flex; gap:8px; margin-bottom:6px;">
                        <select id="excludeWithGroupPicker" style="flex:1;">
                            <option value="">-- Ch·ªçn nh√≥m nhanh --</option>
                            <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                        </select>
                        <button type="button" class="btn-secondary" id="btnSelectGroupEX" style="padding:4px 10px;">Ch·ªçn</button>
                        <button type="button" class="btn-secondary" id="btnUnselectGroupEX" style="padding:4px 10px;">B·ªè</button>
                    </div>
                    <select name="exclude_with[]" multiple class="multi-select" id="excludeWithSelect" style="height:150px;">
                        <% groupNames.forEach(g => { %>
                            <optgroup label="<%= g %>">
                                <% grouped[g].forEach(function(p){ 
                                    var label = p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name || p.name)) : p.name;
                                %>
                                    <option data-group="<%= g %>" value="<%= p.id %>" <%= (compatExclIds||[]).includes(String(p.id)) ? 'selected' : '' %>><%= label %></option>
                                <% }) %>
                            </optgroup>
                        <% }) %>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="window.location.href='/promo-management'">H·ªßy b·ªè</button>
            <button type="submit" class="btn-primary">L∆∞u thay ƒë·ªïi</button>
        </div>
    </form>

</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. [FIX] CH·ªåN NH√ìM NHANH (APPLY/EXCLUDE) ---
    
    // H√†m x·ª≠ l√Ω logic ch·ªçn
    window.handleGroupSelection = function(selectId, pickerId, isSelect) {
        const groupPicker = document.getElementById(pickerId);
        const groupName = groupPicker ? groupPicker.value : '';
        
        if (!groupName) {
            alert('Vui l√≤ng ch·ªçn m·ªôt nh√≥m trong danh s√°ch x·ªï xu·ªëng tr∆∞·ªõc!');
            return;
        }
  
        const selectBox = document.getElementById(selectId);
        if (!selectBox) return;

        let count = 0;
        Array.from(selectBox.options).forEach(option => {
            // So s√°nh data-group c·ªßa option v·ªõi nh√≥m ƒëang ch·ªçn
            if (option.getAttribute('data-group') === groupName) {
                option.selected = isSelect;
                count++;
            }
        });
        
        if(count === 0) {
            alert(`Kh√¥ng t√¨m th·∫•y CTKM n√†o thu·ªôc nh√≥m "${groupName}" trong danh s√°ch.`);
        }
    };

    // G·∫Øn s·ª± ki·ªán Click cho c√°c n√∫t (QUAN TR·ªåNG: Ph·∫ßn n√†y b·ªã thi·∫øu ·ªü code c≈©)
    
    // N√∫t cho ph·∫ßn √Åp d·ª•ng c√πng (Apply With)
    const btnSelectAW = document.getElementById('btnSelectGroupAW');
    const btnUnselectAW = document.getElementById('btnUnselectGroupAW');
    if(btnSelectAW) {
        btnSelectAW.onclick = function() { window.handleGroupSelection('applyWithSelect', 'applyWithGroupPicker', true); };
    }
    if(btnUnselectAW) {
        btnUnselectAW.onclick = function() { window.handleGroupSelection('applyWithSelect', 'applyWithGroupPicker', false); };
    }

    // N√∫t cho ph·∫ßn Lo·∫°i tr·ª´ (Exclude With)
    const btnSelectEX = document.getElementById('btnSelectGroupEX');
    const btnUnselectEX = document.getElementById('btnUnselectGroupEX');
    if(btnSelectEX) {
        btnSelectEX.onclick = function() { window.handleGroupSelection('excludeWithSelect', 'excludeWithGroupPicker', true); };
    }
    if(btnUnselectEX) {
        btnUnselectEX.onclick = function() { window.handleGroupSelection('excludeWithSelect', 'excludeWithGroupPicker', false); };
    }


    // --- 2. RTE & COLOR PICKER (Gi·ªØ nguy√™n) ---
    (function() {
        let savedRange = null; 
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) savedRange = sel.getRangeAt(0);
        }
      
        function restoreSelection() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
        }

        document.addEventListener('selectionchange', () => {
            const activeEl = document.activeElement;
            if (activeEl && activeEl.classList.contains('rte-field')) {
                saveSelection();
            }
        });

        document.querySelectorAll('.rte-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (btn.id === 'rteColor') return;
                e.preventDefault();
                restoreSelection();
                
                if (btn.id === 'rteLink') {
                    const url = prompt('Nh·∫≠p URL:', 'https://');
                    if (url) document.execCommand('createLink', false, url);
                } else {
                    document.execCommand(btn.dataset.cmd, false, null);
                }
            });
        });

        const colorInput = document.getElementById('rteColor');
        if (colorInput) {
            colorInput.addEventListener('input', (e) => {
                restoreSelection();
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('foreColor', false, e.target.value);
            });
            colorInput.addEventListener('click', () => restoreSelection());
        }
    })();

    // --- 3. H√ÄM CHECK SKU ---
    window.checkSkuInfo = async function(inputEl, displayEl) {
        const sku = inputEl.value.trim();
        if(!sku) { displayEl.innerHTML = ''; return; }
        
        displayEl.innerHTML = '<span style="color:#94a3b8; font-size:11px;">‚è≥ ƒêang ki·ªÉm tra...</span>';
        try {
            const res = await fetch(`/api/admin/search-sku-stock?q=${encodeURIComponent(sku)}`);
            const json = await res.json();
            
            if(json.ok && json.results && json.results.length > 0) {
                const found = json.results.find(i => i.sku == sku) || json.results[0];
                const priceStr = new Intl.NumberFormat('vi-VN').format(found.list_price || 0);
                const stockColor = found.stock > 0 ? '#16a34a' : '#dc2626';
                displayEl.innerHTML = `
                    <div style="line-height: 1.3; margin-top:2px;">
                        <div style="color:#0f172a; font-weight:600; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:350px;">
                            ${found.product_name}
                        </div>
                        <div style="font-size:11px;">
                            <span style="color:#64748b;">Gi√°: ${priceStr}ƒë</span> 
                            <span style="margin:0 4px; color:#cbd5e1;">|</span> 
                            <span style="color:${stockColor}; font-weight:700;">T·ªìn kho: ${found.stock}</span>
                        </div>
                    </div>
                `;
            } else {
                displayEl.innerHTML = `<span style="color:#dc2626; font-size:12px;">‚ùå Kh√¥ng t√¨m th·∫•y SKU n√†y</span>`;
            }
        } catch(e) { 
            console.error(e);
            displayEl.innerHTML = `<span style="color:#dc2626; font-size:12px;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi</span>`; 
        }
    };

    // --- 4. C√ÅC H√ÄM TOGGLE & DYNAMIC KH√ÅC ---
    window.handlePromoTypeChange = function() {
        const type = document.getElementById('promoTypeSelect').value;
        const blocks = ['blockBasicValue', 'blockNextOrder', 'blockInstallment', 'blockGift', 'blockCombo'];
        blocks.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });
        if (type === 'T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau') document.getElementById('blockNextOrder').style.display = 'block';
        else if ((type || '').includes('Tr·∫£ g√≥p')) document.getElementById('blockInstallment').style.display = 'block';
        else if (type === 'Gift' || type === 'Qu√† t·∫∑ng (Gift)') {
            document.getElementById('blockGift').style.display = 'block';
            if(!window.isEditModeLoading && document.getElementById('giftContainer').children.length === 0) addGiftOption();
        }
        else if (type === 'Combo') {
            document.getElementById('blockCombo').style.display = 'block';
            if(!window.isEditModeLoading && document.getElementById('comboContainer').children.length === 0) addComboRow();
        }
        else {
            document.getElementById('blockBasicValue').style.display = 'block';
        }
    };

    window.toggleDiscountInputs = function() {
        const t = document.getElementById('discount_value_type').value;
        ['amountBox', 'percentBox', 'capBox'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });
        if (t === 'amount') document.getElementById('amountBox').style.display = 'block';
        else if (t === 'percent') {
            document.getElementById('percentBox').style.display = 'block';
            document.getElementById('capBox').style.display = 'block';
        }
    };

    window.toggleScopeFields = function() {
        const typeSelect = document.getElementById('applyToTypeSelect');
        if(!typeSelect) return;
        const type = typeSelect.value;
        const fields = { sku: 'skuField', brand: 'brandField', category: 'categoryField', subcat: 'subcatField' };
        for (let k in fields) document.getElementById(fields[k]).style.display = 'none';
        
        if (type === 'brand_subcat') {
            document.getElementById('brandField').style.display = 'block';
            document.getElementById('subcatField').style.display = 'block';
        } else if (fields[type]) {
            document.getElementById(fields[type]).style.display = 'block';
        }
    };

    let giftIndex = 0; let comboIndex = 0; let couponIndex = 0;
    window.isEditModeLoading = false;

    window.addSkuInputToGroup = function(containerId, fieldNameBase, value = '') {
        const container = document.getElementById(containerId);
        if(!container) return;
        const div = document.createElement('div');
        div.className = 'sku-link-row';
        div.innerHTML = `
            <input type="text" class="auto-sku-input" name="${fieldNameBase}[]" placeholder="Nh·∫≠p SKU" value="${value}" onblur="checkSkuInfo(this, this.nextElementSibling)">
            <div class="sku-info-display" style="min-width:150px;"></div>
            <button type="button" onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">√ó</button>
        `;
        container.appendChild(div);
        if(value) { checkSkuInfo(div.querySelector('input'), div.querySelector('.sku-info-display')); }
    };

    window.addGiftOption = function(data = {}) {
        const container = document.getElementById('giftContainer');
        const idx = giftIndex++;
        const skuContainerId = `gift-skus-${idx}`;
        const codeVal = data.code || data.name || '';
        
        const div = document.createElement('div');
        div.className = 'gift-option';
        div.innerHTML = `
            <div class="remove-row-btn" onclick="this.parentElement.remove()">√ó</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#b45309">Option (ID: ${idx})</div>
            <div class="form-group">
                <input type="text" name="detail[gift_options][${idx}][code]" placeholder="T√™n g√≥i qu√† / M√£ (n·∫øu c√≥)" value="${codeVal}">
            </div>
            <label style="font-size:12px; font-weight:600;">Danh s√°ch s·∫£n ph·∫©m qu√† t·∫∑ng:</label>
            <div id="${skuContainerId}" style="margin-bottom:5px;"></div>
            <button type="button" class="add-btn-dashed" style="width:auto; padding:4px 10px; font-size:12px;"
            onclick="addSkuInputToGroup('${skuContainerId}', 'detail[gift_options][${idx}][skus]')">+ Th√™m SKU qu√†</button>
        `;
        container.appendChild(div);
        if (data.skus && Array.isArray(data.skus)) {
            data.skus.forEach(s => addSkuInputToGroup(skuContainerId, `detail[gift_options][${idx}][skus]`, s));
        } else if (!data.skus && !window.isEditModeLoading) {
            addSkuInputToGroup(skuContainerId, `detail[gift_options][${idx}][skus]`);
        }
    };

    window.addComboRow = function(data = {}) {
        const container = document.getElementById('comboContainer');
        const idx = comboIndex++;
        const skuContainerId = `combo-skus-${idx}`;
        const discVal = data.discount_val || '';
        const discType = data.discount_type || 'amount';
        const div = document.createElement('div');
        div.className = 'combo-row';
        div.innerHTML = `
            <div class="remove-row-btn" onclick="this.parentElement.remove()">√ó</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#4338ca">B·ªô Combo (ID: ${idx})</div>
            <label style="font-size:12px; font-weight:600;">C√°c s·∫£n ph·∫©m trong Combo:</label>
            <div id="${skuContainerId}" style="margin-bottom:8px;"></div>
            <button type="button" class="add-btn-dashed" style="width:auto; padding:4px 10px; font-size:12px;"
            onclick="addSkuInputToGroup('${skuContainerId}', 'detail[combos][${idx}][skus]')">+ Th√™m SKU v√†o combo</button>
            <div class="form-row" style="margin-top:10px; border-top:1px dashed #e5e7eb; padding-top:8px;">
                <input type="number" name="detail[combos][${idx}][discount_val]" placeholder="Gi√° tr·ªã gi·∫£m" value="${discVal}">
                <select name="detail[combos][${idx}][discount_type]">
                    <option value="amount" ${discType === 'amount' ? 'selected' : ''}>Gi·∫£m ti·ªÅn</option>
                    <option value="percent" ${discType === 'percent' ? 'selected' : ''}>Gi·∫£m %</option>
                </select>
            </div>
        `;
        container.appendChild(div);
        if (data.skus && Array.isArray(data.skus)) {
            data.skus.forEach(s => addSkuInputToGroup(skuContainerId, `detail[combos][${idx}][skus]`, s));
        } else if (!data.skus && !window.isEditModeLoading) {
            addSkuInputToGroup(skuContainerId, `detail[combos][${idx}][skus]`);
            addSkuInputToGroup(skuContainerId, `detail[combos][${idx}][skus]`);
        }
    };

    window.addCouponRow = function(data = {}) {
        const container = document.getElementById('couponListContainer');
        const idx = couponIndex++;
        const div = document.createElement('div');
        div.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px; gap:8px; margin-bottom:5px; align-items:center;';
        div.innerHTML = `
            <input type="text" name="coupons[${idx}][name]" placeholder="T√™n/Nh√≥m" value="${data.name || ''}">
            <input type="text" name="coupons[${idx}][code]" placeholder="M√£ Code" value="${data.code || ''}" required style="font-weight:bold; color:#b45309;">
            <input type="text" name="coupons[${idx}][discount]" placeholder="M·ª©c gi·∫£m" value="${data.discount || ''}">
            <input type="text" name="coupons[${idx}][note]" placeholder="Ghi ch√∫" value="${data.note || ''}">
            <button type="button" onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold; font-size:18px;">√ó</button>
        `;
        container.appendChild(div);
    };

    window.toggleCouponBuilder = function() {
        const checkbox = document.getElementById('hasCouponListCheckbox');
        if(!checkbox) return;
        const checked = checkbox.checked;
        document.getElementById('couponListBuilder').style.display = checked ? 'block' : 'none';
        document.getElementById('couponCodeInput').style.display = checked ? 'none' : 'block';
        if (checked && document.getElementById('couponListContainer').children.length === 0 && !window.isEditModeLoading) {
            addCouponRow();
        }
    };

    // --- 5. KH√îI PH·ª§C D·ªÆ LI·ªÜU ---
    (function() {
        window.isEditModeLoading = true;
        let promo = null;
        try { promo = <%- JSON.stringify(promotion) %>; } catch(e) {}
        
        if (!promo) { console.error("No promo data"); return; }

        // Restore Discount
        if (promo.discount_value_type) {
            const el = document.getElementById('discount_value_type');
            if(el) el.value = promo.discount_value_type;
            
            if (promo.discount_value_type === 'amount') {
                const inp = document.querySelector('input[name="discount_amount"]');
                if(inp) inp.value = promo.discount_value;
            } else if (promo.discount_value_type === 'percent') {
                const inp = document.querySelector('input[name="discount_percent"]');
                if(inp) inp.value = promo.discount_value;
            }
        }
        if (promo.max_discount_amount) {
            const inp = document.querySelector('input[name="max_discount_amount"]');
            if(inp) inp.value = promo.max_discount_amount;
        }

        // Restore Coupon List
        if (promo.coupon_list && Array.isArray(promo.coupon_list) && promo.coupon_list.length > 0) {
            promo.coupon_list.forEach(c => addCouponRow(c));
            const cb = document.getElementById('hasCouponListCheckbox');
            if(cb) { cb.checked = true; toggleCouponBuilder(); }
        }

        // Restore Detail Fields
        if(promo.detail_fields) {
            if(promo.detail_fields.gift_options) {
                const gifts = typeof promo.detail_fields.gift_options === 'object' ? Object.values(promo.detail_fields.gift_options) : [];
                gifts.forEach(g => addGiftOption(g));
            }
            if(promo.detail_fields.combos) {
                const combos = typeof promo.detail_fields.combos === 'object' ? Object.values(promo.detail_fields.combos) : [];
                combos.forEach(c => addComboRow(c));
            }
            
            document.querySelectorAll('[name^="detail["]').forEach(inp => {
                const match = inp.getAttribute('name').match(/detail\[(.*?)\]/);
                if(match && match[1]) {
                    const key = match[1];
                    if(!key.includes('gift_options') && !key.includes('combos') && promo.detail_fields[key]) {
                        inp.value = promo.detail_fields[key];
                    }
                }
            });

            document.querySelectorAll('.rte-field').forEach(div => {
                const nameAttr = div.getAttribute('data-name');
                const match = nameAttr.match(/detail\[(.*?)\]/);
                if(match && match[1] && promo.detail_fields[match[1]]) {
                    div.innerHTML = promo.detail_fields[match[1]];
                }
            });
        }
        
        toggleDiscountInputs();
        toggleScopeFields();
        handlePromoTypeChange();
        setTimeout(() => { window.isEditModeLoading = false; }, 500);
    })();
    
    // --- 6. SUBMIT ---
    const promoForm = document.getElementById('promoForm');
    if (promoForm) {
        promoForm.addEventListener('submit', () => {
            document.querySelectorAll('.rte-field').forEach((div) => {
                const name = div.getAttribute('data-name');
                const ta = document.querySelector(`textarea[name="${name}"]`);
                if (ta) ta.value = div.innerHTML;
            });
        });
    }
});


// H√ÄM B·∫¨T T·∫ÆT KH·ªêI VOLUME
function toggleVolumeBlock(checkbox) {
    const block = document.getElementById('volumeSettings');
    if (block) {
        block.style.display = checkbox.checked ? 'block' : 'none';
    }
}

// B·ªî SUNG LOGIC V√ÄO H√ÄM LOAD D·ªÆ LI·ªÜU T·ª∞ ƒê·ªòNG
// T√¨m ƒëo·∫°n: setTimeout(() => { window.isEditModeLoading = false; }, 500);
// V√† ch√®n ƒëo·∫°n n√†y v√†o NGAY TR∆Ø·ªöC d√≤ng ƒë√≥:

/* --- [M·ªöI] T·ª± ƒë·ªông b·∫≠t kh·ªëi Volume n·∫øu c√≥ d·ªØ li·ªáu c≈© --- */
const volSubcat = document.querySelector('input[name="detail[volume_subcat]"]');
if (volSubcat && volSubcat.value) {
    const chk = document.getElementById('chkVolumeToggle');
    if (chk) {
        chk.checked = true;
        toggleVolumeBlock(chk);
    }
}
/* ----------------------------------------------------- */


</script>
<script>
    // 1. Toggle hi·ªÉn th·ªã
    function toggleTierConfig() {
        const checkbox = document.getElementById('trigger_tier_price');
        const container = document.getElementById('tier-price-config');
        if (checkbox && container) {
            container.style.display = checkbox.checked ? 'block' : 'none';
            // N·∫øu b·∫≠t l√™n m√† tr·ªëng th√¨ th√™m d√≤ng m·∫´u
            const tbody = document.getElementById('tier-rows');
            if (checkbox.checked && tbody.children.length === 0 && !window.isLoadingData) {
                addTierRow();
            }
        }
    }

    // 2. Th√™m d√≤ng m·ªëc (Ch·ªâ v·∫Ω giao di·ªán, ch∆∞a t·∫°o input name v·ªôi)
    function addTierRow(data = {}) {
        const tbody = document.getElementById('tier-rows');
        const tr = document.createElement('tr');
        tr.className = 'tier-data-row'; // Class ƒë·ªÉ d·ªÖ select khi submit
        
        const qty = data.min_qty || 2;
        const disc = data.discount || 0;
        const type = data.type || 'amount';

        tr.innerHTML = `
            <td>
                <input type="number" class="form-control text-center tier-qty" value="${qty}" min="1" placeholder="SL">
            </td>
            <td>
                <input type="number" class="form-control text-end tier-disc" value="${disc}" min="0" placeholder="Gi·∫£m">
            </td>
            <td>
                <select class="form-control tier-type">
                    <option value="amount" ${type === 'amount' ? 'selected' : ''}>VNƒê (ƒë)</option>
                    <option value="percent" ${type === 'percent' ? 'selected' : ''}>%</option>
                </select>
            </td>
            <td style="text-align:center;">
                <button type="button" onclick="this.closest('tr').remove()" style="color:red; border:none; background:none; cursor:pointer;">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    // 3. Load d·ªØ li·ªáu c≈©
    document.addEventListener('DOMContentLoaded', function() {
        window.isLoadingData = true;
        try {
            var details = <%- JSON.stringify(promotion.detail_fields || {}) %>;
            
            // Check Tier Price
            if (details.tiers && Array.isArray(details.tiers) && details.tiers.length > 0) {
                const chk = document.getElementById('trigger_tier_price');
                if(chk) {
                    chk.checked = true;
                    toggleTierConfig();
                }
                const tbody = document.getElementById('tier-rows');
                if(tbody) {
                    tbody.innerHTML = ''; 
                    details.tiers.forEach(t => addTierRow(t));
                }
            }
        } catch (e) { console.error(e); }
        window.isLoadingData = false;
    });

    // 4. [QUAN TR·ªåNG NH·∫§T] X·ª≠ l√Ω tr∆∞·ªõc khi Submit
    // T·∫°o dynamic input name="detail[tiers][0][min_qty]" ƒë·ªÉ backend hi·ªÉu l√† array
    const formPromo = document.getElementById('promoForm') || document.querySelector('form[action^="/edit-promotion"]');
    
    if (formPromo) {
        formPromo.addEventListener('submit', function(e) {
            const checkbox = document.getElementById('trigger_tier_price');
            
            // X√≥a c√°c input hidden tiers c≈© (n·∫øu c√≥) ƒë·ªÉ tr√°nh tr√πng l·∫∑p khi b·∫•m submit nhi·ªÅu l·∫ßn
            document.querySelectorAll('.tier-hidden-input').forEach(el => el.remove());

            if (checkbox && checkbox.checked) {
                const rows = document.querySelectorAll('.tier-data-row');
                let validCount = 0;

                rows.forEach((row, index) => {
                    const qty = parseInt(row.querySelector('.tier-qty').value) || 0;
                    const discount = parseFloat(row.querySelector('.tier-disc').value) || 0;
                    const type = row.querySelector('.tier-type').value;

                    if (qty > 0) {
                        // T·∫°o input hidden ·∫£o ƒë·ªÉ g·ª≠i l√™n server
                        // name="detail[tiers][0][min_qty]"
                        createHiddenInput(formPromo, `detail[tiers][${validCount}][min_qty]`, qty);
                        createHiddenInput(formPromo, `detail[tiers][${validCount}][discount]`, discount);
                        createHiddenInput(formPromo, `detail[tiers][${validCount}][type]`, type);
                        validCount++;
                    }
                });

                if (validCount === 0) {
                    alert('B·∫°n ƒë√£ b·∫≠t Mua nhi·ªÅu gi·∫£m s√¢u nh∆∞ng ch∆∞a nh·∫≠p m·ªëc s·ªë l∆∞·ª£ng n√†o h·ª£p l·ªá.');
                    e.preventDefault();
                    return;
                }
            }
            // N·∫øu kh√¥ng check -> Kh√¥ng t·∫°o input -> Server nh·∫≠n detail.tiers = undefined (ho·∫∑c kh√¥ng update) -> ƒê√∫ng √Ω ƒë·ªì t·∫Øt.
        });
    }

    // Helper t·∫°o input hidden
    function createHiddenInput(form, name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        input.className = 'tier-hidden-input';
        form.appendChild(input);
    }
</script>

<%- include('partials/footer') %>a
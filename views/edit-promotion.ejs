<%- include('partials/header', {title: 'S·ª≠a CTKM' , currentPage: 'edit-promotion' , time: time}) %>

    <style>
        .edit-promotion-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .back-button {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .promo-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            margin-bottom: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .dynamic-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .add-item {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .remove-item {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
    </style>

    <div class="edit-promotion-container">
        <a href="/promo-management" class="back-button">‚Üê Quay l·∫°i</a>

        <div class="page-header">
            <h1>‚úèÔ∏è S·ª≠a CTKM: <%= promotion.name %>
            </h1>
            <p>ID: <%= promotion.id %>
            </p>
        </div>

        <% if (typeof error !=='undefined' && error) { %>
            <div class="error-message">
                ‚ö†Ô∏è <%= error %>
            </div>
            <% } %>

                <form action="/edit-promotion/<%= promotion.id %>" method="POST" class="promo-form">
                    <div class="form-section">
                        <h3>üìã Th√¥ng tin c∆° b·∫£n</h3>

                        <div class="form-group">
                            <label>T√™n CTKM *</label>
                            <input type="text" name="name" value="<%= promotion.name || '' %>" required>
                            <!-- Bi·∫øn th·ªÉ = T√™n CTKM -->
                            <input type="hidden" name="subgroup_name" value="<%= promotion.name || '' %>">
                        </div>
                        <div class="form-group">
                            <label>M√¥ t·∫£</label>
                            <textarea name="description" rows="3"><%= promotion.description || '' %></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>üìÖ Ng√†y b·∫Øt ƒë·∫ßu *</label>
                                <input type="date" name="start_date" value="<%= promotion.start_date %>" required>
                            </div>

                            <div class="form-group">
                                <label>üìÖ Ng√†y k·∫øt th√∫c *</label>
                                <input type="date" name="end_date" value="<%= promotion.end_date %>" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>üîÑ Channel √°p d·ª•ng</label>
                                <select name="channel">
                                    <option value="All" <%=promotion.channel==='All' ? 'selected' : '' %>>T·∫•t c·∫£
                                    </option>
                                    <option value="Online" <%=promotion.channel==='Online' ? 'selected' : '' %>>Online
                                    </option>
                                    <option value="Offline" <%=promotion.channel==='Offline' ? 'selected' : '' %>
                                        >Offline</option>
                                </select>
                            </div>
                                
                            <div class="form-group">
                                <label>üéÅ Lo·∫°i CTKM *</label>
                                <select name="promo_type" required>
                                    <option value="Kh√¥ng c√≥ m√£" <%=promotion.promo_type==='Kh√¥ng c√≥ m√£' ? 'selected'
                                        : '' %>>Kh√¥ng c√≥ m√£</option>
                                    <option value="Coupon" <%=promotion.promo_type==='Coupon' ? 'selected' : '' %>
                                        >Coupon</option>
                                    <option value="Voucher" <%=promotion.promo_type==='Voucher' ? 'selected' : '' %>
                                        >Voucher</option>
                                    <option value="∆Øu ƒë√£i thanh to√°n" <%=promotion.promo_type==='∆Øu ƒë√£i thanh to√°n'
                                        ? 'selected' : '' %>>∆Øu ƒë√£i thanh to√°n</option>
                                    <option value="Gift" <%=promotion.promo_type==='Gift' ? 'selected' : '' %>>Qu√† t·∫∑ng
                                        (Gift)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>üîë M√£ gi·∫£m gi√° (n·∫øu c√≥)</label>
                            <input type="text" name="coupon_code" value="<%= promotion.coupon_code || '' %>">
                        </div>


                        <div class="form-group">
    <label style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" name="has_coupon_list" id="hasCouponListCheckbox" style="width: auto;">
        Hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng danh s√°ch coupon/voucher
    </label>
</div>

<div class="form-section" id="couponListBuilder" style="display: none;">
    <h3>üìù Danh s√°ch Coupon</h3>
    <div id="couponListContainer">
        </div>
    <button type="button" class="btn btn-secondary" id="addCouponRowBtn" style="margin-top: 10px;">+ Th√™m d√≤ng</button>
</div>

                    <div class="form-group">
  <label>Gi√° tr·ªã gi·∫£m</label>
  <div class="grid-2">
    <div>
      <select name="discount_value_type" id="discount_value_type" onchange="toggleDiscountInputs()">
        <option value="">-- Ch·ªçn ki·ªÉu --</option>
        <option value="amount">Gi·∫£m ti·ªÅn (‚Ç´)</option>
        <option value="percent">Gi·∫£m theo %</option>
      </select>
    </div>
    <div id="amountBox" style="display:none;">
      <input type="number" name="discount_amount" placeholder="S·ªë ti·ªÅn gi·∫£m (‚Ç´)" min="0" step="1000">
    </div>
    <div id="percentBox" style="display:none;">
      <input type="number" name="discount_percent" placeholder="% gi·∫£m (0‚Äì100)" min="0" max="100" step="0.1">
    </div>
    <div id="capBox" style="display:none;">
      <input type="number" name="max_discount_amount" placeholder="Gi·∫£m t·ªëi ƒëa (‚Ç´)" min="0" step="1000">
    </div>
    <div>
      <input type="number" name="min_order_value" placeholder="ƒê∆°n t·ªëi thi·ªÉu (‚Ç´, ƒë·ªÉ tr·ªëng = 0)" min="0" step="1000">
    </div>
  </div>
  <small class="hint">Ch·ªçn ‚ÄúGi·∫£m ti·ªÅn‚Äù ‚Üí nh·∫≠p ‚ÄúS·ªë ti·ªÅn gi·∫£m‚Äù. Ch·ªçn ‚Äú%‚Äù ‚Üí nh·∫≠p ‚Äú% gi·∫£m‚Äù + ‚ÄúGi·∫£m t·ªëi ƒëa‚Äù.</small>
</div>

<script>
  function toggleDiscountInputs(){
    const t = document.getElementById('discount_value_type').value;
    document.getElementById('amountBox').style.display  = (t==='amount') ? 'block' : 'none';
    document.getElementById('percentBox').style.display = (t==='percent') ? 'block' : 'none';
    document.getElementById('capBox').style.display     = (t==='percent') ? 'block' : 'none';
  }
  document.addEventListener('DOMContentLoaded', toggleDiscountInputs);
</script>

<style>
  .grid-2{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
  .hint{ color:#64748b; font-size:12px; }
</style>



                    <h3>üß© Nh√≥m hi·ªÉn th·ªã</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Nh√≥m CTKM (v√≠ d·ª•: ƒê·ªîI ƒêI·ªÇM THI)</label>
                            <input name="group_name" placeholder="Nh·∫≠p nh√≥m (theo h√†ng ƒë·∫ßu c·ªßa file Excel)">
                        </div>

                    </div>


                    </div>

                    <h3>üìã B·∫£ng chi ti·∫øt (ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã)</h3>

                    <style>
                        .rte-toolbar {
                            display: flex;
                            gap: 6px;
                            flex-wrap: wrap;
                            margin: 6px 0 10px;
                            align-items: center;
                        }

                        .rte-btn {
                            padding: 6px 10px;
                            border: 1px solid #e5e7eb;
                            background: #fff;
                            border-radius: 8px;
                            font-size: 12px;
                            cursor: pointer;
                        }

                        .rte-color {
                            width: 26px;
                            height: 26px;
                            padding: 0;
                        }

                        .detail-grid {
                            width: 100%;
                            border: 1px solid #e5e7eb;
                            border-radius: 12px;
                            border-collapse: separate;
                            border-spacing: 0;
                            table-layout: fixed;
                        }

                        .detail-grid colgroup col:first-child {
                            width: 34%;
                        }

                        /* ti√™u ƒë·ªÅ */
                        .detail-grid colgroup col:last-child {
                            width: 66%;
                        }

                        /* √¥ nh·∫≠p */
                        .detail-grid th,
                        .detail-grid td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #eef2f7;
                            vertical-align: top;
                        }

                        .detail-grid th {
                            background: #f8fafc;
                            font-weight: 600;
                            color: #0f172a;
                            text-align: left;
                        }

                        .detail-grid tr:last-child th,
                        .detail-grid tr:last-child td {
                            border-bottom: none;
                        }

                        .rte-field {
                            display: block;
                            width: 100%;
                            min-height: 90px;
                            padding: 10px;
                            border: 1px solid #e5e7eb;
                            border-radius: 10px;
                            background: #fff;
                            overflow: auto;
                        }

                        .rte-field:focus {
                            outline: 2px solid #93c5fd;
                            outline-offset: 2px;
                        }

                        .rte-field:empty:before {
                            content: attr(data-placeholder);
                            color: #94a3b8;
                        }

                        textarea[hidden] {
                            display: none !important;
                        }

                        @media (max-width: 768px) {
                            .detail-grid colgroup col:first-child {
                                width: 42%;
                            }

                            .detail-grid colgroup col:last-child {
                                width: 58%;
                            }

                            .rte-field {
                                min-height: 72px;
                            }
                        }
                    </style>


                    <div class="rte-toolbar" id="rteToolbar" aria-label="ƒê·ªãnh d·∫°ng">
                        <button type="button" class="rte-btn" data-cmd="bold"><b>B</b></button>
                        <button type="button" class="rte-btn" data-cmd="italic"><i>I</i></button>
                        <button type="button" class="rte-btn" data-cmd="underline"><u>U</u></button>
                        <input type="color" class="rte-btn rte-color" id="rteColor">
                        <button type="button" class="rte-btn" id="rteEmoji">üòä</button>
                        <button type="button" class="rte-btn" id="rteLink">üîó Link</button>
                        <small class="muted">Ch·ªçn √¥ c·∫ßn nh·∫≠p, r·ªìi b·∫•m c√°c n√∫t ƒë·ªÉ ƒë·ªãnh d·∫°ng.</small>
                    </div>
                    <% // B·∫¢NG CHI TI·∫æT ‚Äì ƒë√£ b·ªè c√°c tr∆∞·ªùng tr√πng v·ªõi ‚ÄúTh√¥ng tin c∆° b·∫£n‚Äù const
                        DETAIL_ROWS=[ 'N·ªôi dung / Link b√°o c√°o/ Lu·ªìng v·∫≠n h√†nh' , 'ƒê·ªëi t∆∞·ª£ng lo·∫°i tr·ª´'
                        , 'ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng' , 'Gi·ªõi h·∫°n l∆∞·ª£t √°p d·ª•ng' , 'Y√™u c·∫ßu ƒë·∫∑c bi·ªát' , 'Tr·∫£ tr∆∞·ªõc (Tr·∫£ g√≥p)'
                        , 'Gi√° tr·ªã gi·∫£m (% ho·∫∑c ti·ªÅn)' , 'Gi√° tr·ªã gi·∫£m t·ªëi ƒëa (N·∫øu l√† %)' , 'Gi√° tr·ªã t·ªëi thi·ªÉu'
                        , 'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng coupon' , 'SKU qu√† t·∫∑ng (C√≥ th·ªÉ ch·ªçn theo option v√† ch·ªâ ch·ªçn ƒë∆∞·ª£c 1)'
                        , '√Åp d·ª•ng c√πng CTKM kh√°c ?' , 'Kh√¥ng √°p d·ª•ng c√πng CTKM' , 'Link n·ªôi b·ªô/ b√°o c√°o' ]; %>

                        <table class="detail-grid">
                            <colgroup>
                                <col />
                                <col />
                            </colgroup>
                            <tbody>
                                <% DETAIL_ROWS.forEach(function(label, idx){ %>
                                    <tr>
                                        <th>
                                            <%= label %>
                                        </th>
                                        <td>
                                            <!-- tr∆∞·ªùng hi·ªÉn th·ªã -->
                                            <div class="rte-field" contenteditable="true"
                                            data-name="detail[<%= label %>]" data-index="<%= idx %>">
                                            <%- (promotion.detail_fields && promotion.detail_fields[label]) ? promotion.detail_fields[label] : '' %>
                                            </div>
                                            <!-- textarea ·∫©n ƒë·ªÉ submit -->
                                            <textarea name="detail[<%= label %>]" hidden></textarea>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>


                        <!-- Script RTE (ƒë·∫∑t TRONG form, tr∆∞·ªõc n√∫t L∆∞u) -->
                        <script>
                            (function () {
                                function exec(cmd) { document.execCommand(cmd, false, null); }
                                var b = document.getElementById('rteBold');
                                var i = document.getElementById('rteItalic');
                                var u = document.getElementById('rteUnderline');
                                var l = document.getElementById('rteLink');
                                if (b) b.addEventListener('click', function () { exec('bold'); });
                                if (i) i.addEventListener('click', function () { exec('italic'); });
                                if (u) u.addEventListener('click', function () { exec('underline'); });
                                if (l) l.addEventListener('click', function () {
                                    var el = document.activeElement;
                                    if (!el || el.getAttribute('contenteditable') !== 'true') return;
                                    var url = prompt('Nh·∫≠p URL:', 'https://');
                                    if (!url) return;
                                    var sel = window.getSelection ? String(window.getSelection()) : '';
                                    var text = sel && sel.trim() ? sel : url;
                                    var safe = url.replace(/"/g, '&quot;');
                                    document.execCommand('insertHTML', false, '<a href="' + safe + '" target="_blank" rel="noopener noreferrer">' + text + '</a>');
                                });

                                // copy n·ªôi dung c√°c div.rte-field v√†o textarea khi submit
                                var form = document.currentScript.closest('form');
                                if (form) {
                                    form.addEventListener('submit', function () {
                                        var fields = form.querySelectorAll('.rte-field');
                                        fields.forEach(function (div) {
                                            var name = div.getAttribute('data-name');
                                            var ta = form.querySelector('textarea[name="' + name + '"]');
                                            if (ta) ta.value = div.innerHTML.trim();
                                        });
                                    });
                                }
                            })();
                        </script>
                        <div class="form-section">
                <h3>üéØ Ph·∫°m vi √°p d·ª•ng</h3>
                <div class="form-group">
                    <label>√Åp d·ª•ng cho</label>
                    <select name="apply_to_type" id="applyToTypeSelect">
                        <option value="all" <%= promotion.apply_to_all_skus ? 'selected' : '' %>>T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                        <option value="sku" <%= promotion.promotion_skus && promotion.promotion_skus.length > 0 && !promotion.apply_to_all_skus ? 'selected' : '' %>>Theo danh s√°ch SKU</option>
                        <option value="brand" <%= promotion.apply_to_brands && promotion.apply_to_brands.length > 0 ? 'selected' : '' %>>Theo Brand</option>
                        <option value="category" <%= promotion.apply_to_categories && promotion.apply_to_categories.length > 0 ? 'selected' : '' %>>Theo Category</option>
                        <option value="subcat" <%= promotion.apply_to_subcats && promotion.apply_to_subcats.length > 0 ? 'selected' : '' %>>Theo Subcat</option>
                    </select>
                </div>
                <div class="form-group scope-field" id="skuField" style="display:none;">
                    <label>SKU √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng)</label>
                    <textarea name="skus" rows="4"><%= (promotion.promotion_skus || []).map(x => x.sku).join(', ') %></textarea>
                </div>
                <div class="form-group scope-field" id="brandField" style="display:none;">
                    <label>Brand √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                    <input type="text" name="apply_brands" value="<%= (promotion.apply_to_brands || []).join(', ') %>" placeholder="VD: Apple, Samsung, Dell">
                </div>
                <div class="form-group scope-field" id="categoryField" style="display:none;">
                    <label>Category √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                    <input type="text" name="apply_categories" value="<%= (promotion.apply_to_categories || []).join(', ') %>" placeholder="VD: NH01, NH02">
                </div>
                <div class="form-group scope-field" id="subcatField" style="display:none;">
                    <label>Subcat √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                    <input type="text" name="apply_subcats" value="<%= (promotion.apply_to_subcats || []).join(', ') %>" placeholder="VD: NH01-01-98-05">
                </div>
                <div class="form-group">
                    <label>SKU lo·∫°i tr·ª´ (lu√¥n √°p d·ª•ng, t√πy ch·ªçn)</label>
                    <textarea name="excluded_skus" rows="3" placeholder="Nh·∫≠p SKU, c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng"><%= (promotion.promotion_excluded_skus || []).map(x=> x.sku).join(', ') %></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>üîó Quan h·ªá v·ªõi CTKM kh√°c</h3>
                <% const grouped = {}; (allPromosForCompat || []).forEach(p=>{ const g = p.group_name || 'Kh√°c'; (grouped[g] = grouped[g] || []).push(p); }); const groupNames = Object.keys(grouped).sort((a,b)=> a.localeCompare(b,'vi')); %>
                <div class="form-group">
                    <label>√Åp d·ª•ng c√πng CTKM</label>
                    <div style="display:flex; gap:8px; margin-bottom:6px;">
                        <select id="applyWithGroupPicker" style="flex:1; padding:8px 10px; border:1px solid #dee2e6; border-radius:8px;">
                            <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                        </select>
                        <button type="button" class="btn btn-primary" id="btnSelectGroupAW" style="padding: 8px 12px;">Ch·ªçn</button>
                        <button type="button" class="btn btn-secondary" id="btnUnselectGroupAW" style="padding: 8px 12px;">B·ªè ch·ªçn</button>
                    </div>
                    <select name="apply_with[]" multiple class="multi-select" id="applyWithSelect">
                        <% groupNames.forEach(g => { %>
                            <optgroup label="<%= g %>">
                                <% grouped[g].forEach(function(p){ var label = p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name || p.name)) : p.name; %>
                                    <option data-group="<%= g %>" value="<%= p.id %>" <%= (compatAllowIds||[]).includes(String(p.id)) ? 'selected' : '' %>><%= label %></option>
                                <% }) %>
                            </optgroup>
                        <% }) %>
                    </select>
                    <div class="hint">Gi·ªØ Ctrl/Command ƒë·ªÉ ch·ªçn th√™m CTKM; ho·∫∑c d√πng ‚ÄúCh·ªçn nh√≥m‚Äù.</div>
                </div>
                <div class="form-group">
                    <label>Kh√¥ng √°p d·ª•ng c√πng CTKM</label>
                     <div style="display:flex; gap:8px; margin-bottom:6px;">
                        <select id="excludeWithGroupPicker" style="flex:1; padding:8px 10px; border:1px solid #dee2e6; border-radius:8px;">
                            <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                        </select>
                        <button type="button" class="btn btn-primary" id="btnSelectGroupEX" style="padding: 8px 12px;">Ch·ªçn</button>
                        <button type="button" class="btn btn-secondary" id="btnUnselectGroupEX" style="padding: 8px 12px;">B·ªè ch·ªçn</button>
                    </div>
                    <select name="exclude_with[]" multiple class="multi-select" id="excludeWithSelect">
                         <% groupNames.forEach(g => { %>
                            <optgroup label="<%= g %>">
                                <% grouped[g].forEach(function(p){ var label = p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name || p.name)) : p.name; %>
                                    <option data-group="<%= g %>" value="<%= p.id %>" <%= (compatExclIds||[]).includes(String(p.id)) ? 'selected' : '' %>><%= label %></option>
                                <% }) %>
                            </optgroup>
                        <% }) %>
                    </select>
                </div>
            </div>



    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ---- Script 1: ·∫®n/hi·ªán c√°c tr∆∞·ªùng Ph·∫°m vi √°p d·ª•ng ----
        const typeSelect = document.getElementById('applyToTypeSelect');
        if (typeSelect) {
            const fields = {
                sku: document.getElementById('skuField'),
                brand: document.getElementById('brandField'),
                category: document.getElementById('categoryField'),
                subcat: document.getElementById('subcatField')
            };
            function toggleScopeFields() {
                const selectedType = typeSelect.value;
                for (const key in fields) {
                    if (fields[key]) fields[key].style.display = 'none';
                }
                if (fields[selectedType]) {
                    fields[selectedType].style.display = 'block';
                }
            }
            typeSelect.addEventListener('change', toggleScopeFields);
            toggleScopeFields();
        }

        // ---- Script 2: Helper cho vi·ªác ch·ªçn nh√≥m CTKM t∆∞∆°ng th√≠ch ----
        function selectByGroup(selectEl, group, on = true) {
            if (!selectEl) return;
            [...selectEl.options].forEach(o => {
                if (o.dataset.group === group) { o.selected = !!on; }
            });
        }
        document.getElementById('btnSelectGroupAW').onclick = () => selectByGroup(document.getElementById('applyWithSelect'), document.getElementById('applyWithGroupPicker').value, true);
        document.getElementById('btnUnselectGroupAW').onclick = () => selectByGroup(document.getElementById('applyWithSelect'), document.getElementById('applyWithGroupPicker').value, false);
        document.getElementById('btnSelectGroupEX').onclick = () => selectByGroup(document.getElementById('excludeWithSelect'), document.getElementById('excludeWithGroupPicker').value, true);
        document.getElementById('btnUnselectGroupEX').onclick = () => selectByGroup(document.getElementById('excludeWithSelect'), document.getElementById('excludeWithGroupPicker').value, false);

        // ---- Script 3: Script cho Rich Text Editor ----
        const toolbar = document.getElementById('rteToolbar');
        if (toolbar) {
            const color = document.getElementById('rteColor');
            const emoji = document.getElementById('rteEmoji');
            const linkBtn = document.getElementById('rteLink');
            function exec(cmd, val = null) { document.execCommand(cmd, false, val); }
            toolbar.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-cmd]');
                if (btn) exec(btn.getAttribute('data-cmd'));
            });
            if(color) color.addEventListener('input', (e) => exec('foreColor', e.target.value));
            if(emoji) emoji.addEventListener('click', () => exec('insertText', 'üòä'));
            if(linkBtn) linkBtn.addEventListener('click', () => {
                const el = document.activeElement;
                if (!el || el.getAttribute('contenteditable') !== 'true') return;
                const url = prompt('Nh·∫≠p URL:', 'https://');
                if (!url) return;
                const sel = window.getSelection ? String(window.getSelection()) : '';
                const text = sel && sel.trim() ? sel : url;
                const safe = url.replace(/"/g, '&quot;');
                exec('insertHTML', `<a href="${safe}" target="_blank" rel="noopener noreferrer">${text}</a>`);
            });
        }
    });
    </script>

<script>
  // Helpers ch·ªçn/b·ªè theo nh√≥m cho 2 select
  function selectByGroup(selectEl, group, on=true){
    [...selectEl.options].forEach(o=>{
      if(o.dataset.group === group){ o.selected = !!on; }
    });
  }
  document.getElementById('btnSelectGroupAW').onclick = () =>
    selectByGroup(document.getElementById('applyWithSelect'),
                  document.getElementById('applyWithGroupPicker').value, true);
  document.getElementById('btnUnselectGroupAW').onclick = () =>
    selectByGroup(document.getElementById('applyWithSelect'),
                  document.getElementById('applyWithGroupPicker').value, false);

  document.getElementById('btnSelectGroupEX').onclick = () =>
    selectByGroup(document.getElementById('excludeWithSelect'),
                  document.getElementById('excludeWithGroupPicker').value, true);
  document.getElementById('btnUnselectGroupEX').onclick = () =>
    selectByGroup(document.getElementById('excludeWithSelect'),
                  document.getElementById('excludeWithGroupPicker').value, false);
</script>

                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const sel = document.querySelector('select[name="apply_to"]');
                                            const skuField = document.getElementById('skuField');
                                            if (!sel || !skuField) return;
                                            function toggle() { skuField.style.display = (sel.value === 'sku') ? 'block' : 'none'; }
                                            sel.addEventListener('change', toggle);
                                            toggle(); // ch·∫°y ngay khi m·ªü trang
                                        });
                                    </script>

                                    <script>
                                        // Toolbar: B / I / U / Link

                                        
  (function () {
    const toolbar = document.getElementById('rteToolbar');
    const color = document.getElementById('rteColor');
    const emoji = document.getElementById('rteEmoji');
    const linkBtn = document.getElementById('rteLink');

    function exec(cmd, val = null) {
      document.execCommand(cmd, false, val);
    }

    // B/I/U d√πng data-cmd
    toolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-cmd]');
      if (!btn) return;
      const cmd = btn.getAttribute('data-cmd');
      exec(cmd);
    });

    // M√†u ch·ªØ
    color.addEventListener('input', (e) => exec('foreColor', e.target.value));

    // Emoji
    emoji.addEventListener('click', () => exec('insertText', 'üòä'));

    // Link
    linkBtn.addEventListener('click', () => {
      const el = document.activeElement;
      if (!el || el.getAttribute('contenteditable') !== 'true') return;
      const url = prompt('Nh·∫≠p URL:', 'https://');
      if (!url) return;
      const sel = window.getSelection ? String(window.getSelection()) : '';
      const text = sel && sel.trim() ? sel : url;
      const safe = url.replace(/"/g, '&quot;');
      document.execCommand(
        'insertHTML',
        false,
        `<a href="${safe}" target="_blank" rel="noopener noreferrer">${text}</a>`
      );
    });

    // Khi submit: copy n·ªôi dung c√°c div.rte-field v√†o textarea ·∫©n
    const form = document.currentScript.closest('form');
    if (form) {
      form.addEventListener('submit', function () {
        form.querySelectorAll('.rte-field').forEach((div) => {
          const name = div.getAttribute('data-name');
          const ta = form.querySelector(`textarea[name="${name}"]`);
          if (ta) ta.value = div.innerHTML.trim();
        });
      });
    }
  })();

                                    </script>


                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                                        <a href="/promo-management" class="btn-secondary">‚ùå H·ªßy</a>
                                    </div>
                </form>
    </div>

    <script>
        // Hi·ªÉn th·ªã c√°c field ph√π h·ª£p khi trang load
        document.addEventListener('DOMContentLoaded', function () {
            toggleApplyTo();
        });

        function toggleApplyTo() {
            const applyTo = document.querySelector('select[name="apply_to"]').value;
            document.getElementById('categoryField').style.display = applyTo === 'category' ? 'block' : 'none';
            document.getElementById('brandField').style.display = applyTo === 'brand' ? 'block' : 'none';
            document.getElementById('skuField').style.display = applyTo === 'sku' ? 'block' : 'none';
        }

    // --- Script cho Coupon List Builder ---
const hasCouponListCheckbox = document.getElementById('hasCouponListCheckbox');
const couponListBuilder = document.getElementById('couponListBuilder');
const couponListContainer = document.getElementById('couponListContainer');
const addCouponRowBtn = document.getElementById('addCouponRowBtn');
let couponIndex = 0;

// H√†m t·∫°o m·ªôt d√≤ng nh·∫≠p li·ªáu m·ªõi
function createCouponRow(data = {}) {
    const index = couponIndex++;
    const row = document.createElement('div');
    row.className = 'form-row';
    row.style.marginBottom = '10px';
    row.innerHTML = `
        <input type="text" name="coupons[${index}][name]" placeholder="T√™n/Nh√≥m SP" value="${data.name || ''}">
        <input type="text" name="coupons[${index}][code]" placeholder="M√£ coupon" value="${data.code || ''}">
        <input type="text" name="coupons[${index}][discount]" placeholder="M·ª©c gi·∫£m" value="${data.discount || ''}">
        <input type="text" name="coupons[${index}][note]" placeholder="Ghi ch√∫ ƒëi·ªÅu ki·ªán" value="${data.note || ''}">
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">X√≥a</button>
    `;
    couponListContainer.appendChild(row);
}

// ·∫®n/hi·ªán kh·ªëi nh·∫≠p li·ªáu
hasCouponListCheckbox.addEventListener('change', function() {
    couponListBuilder.style.display = this.checked ? 'block' : 'none';
});

// N√∫t th√™m d√≤ng
addCouponRowBtn.addEventListener('click', () => createCouponRow());

// Kh·ªüi t·∫°o form v·ªõi d·ªØ li·ªáu c√≥ s·∫µn (n·∫øu c√≥)
const existingCoupons = <%- JSON.stringify(promotion.coupon_list || []) %>;
if (existingCoupons.length > 0) {
    hasCouponListCheckbox.checked = true;
    couponListBuilder.style.display = 'block';
    existingCoupons.forEach(coupon => createCouponRow(coupon));
}    
    </script>

    
    <%- include('partials/footer') %>
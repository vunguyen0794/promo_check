<%- include('partials/header', {title: 'S·ª≠a CTKM' , currentPage: 'edit-promotion' , time: time}) %>

    <style>
        .edit-promotion-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .back-button {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .promo-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            margin-bottom: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .dynamic-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .add-item {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .remove-item {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
    </style>

    <div class="edit-promotion-container">
        <a href="/promo-management" class="back-button">‚Üê Quay l·∫°i</a>

        <div class="page-header">
            <h1>‚úèÔ∏è S·ª≠a CTKM: <%= promotion.name %>
            </h1>
            <p>ID: <%= promotion.id %>
            </p>
        </div>

        <% if (typeof error !=='undefined' && error) { %>
            <div class="error-message">
                ‚ö†Ô∏è <%= error %>
            </div>
            <% } %>

                <form action="/edit-promotion/<%= promotion.id %>" method="POST" class="promo-form" id="promoForm">
                    <div class="form-section">
                        <h3>üìã Th√¥ng tin c∆° b·∫£n</h3>

                        <div class="form-group">
                            <label>T√™n CTKM *</label>
                            <input type="text" name="name" value="<%= promotion.name || '' %>" required>
                            <input type="hidden" name="subgroup_name" value="<%= promotion.name || '' %>">
                        </div>
                        <div class="form-group">
                            <label>M√¥ t·∫£</label>
                            <textarea name="description" rows="3"><%= promotion.description || '' %></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>üìÖ Ng√†y b·∫Øt ƒë·∫ßu *</label>
                                <input type="date" name="start_date" value="<%= promotion.start_date %>" required>
                            </div>

                            <div class="form-group">
                                <label>üìÖ Ng√†y k·∫øt th√∫c *</label>
                                <input type="date" name="end_date" value="<%= promotion.end_date %>" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>üîÑ Channel √°p d·ª•ng</label>
                                <select name="channel">
                                    <option value="All" <%=promotion.channel==='All' ? 'selected' : '' %>>T·∫•t c·∫£
                                    </option>
                                    <option value="Online" <%=promotion.channel==='Online' ? 'selected' : '' %>>Online
                                    </option>
                                    <option value="Offline" <%=promotion.channel==='Offline' ? 'selected' : '' %>
                                        >Offline</option>
                                </select>
                            </div>
                                
                            <div class="form-group">
                                <label>üéÅ Lo·∫°i CTKM *</label>
                                <select name="promo_type" required>
                                    <option value="Kh√¥ng c√≥ m√£" <%=promotion.promo_type==='Kh√¥ng c√≥ m√£' ? 'selected'
                                        : '' %>>Kh√¥ng c√≥ m√£</option>
                                    <option value="Coupon" <%=promotion.promo_type==='Coupon' ? 'selected' : '' %>
                                        >Coupon</option>
                                    <option value="Voucher" <%=promotion.promo_type==='Voucher' ? 'selected' : '' %>
                                        >Voucher</option>
                                    <option value="∆Øu ƒë√£i thanh to√°n" <%=promotion.promo_type==='∆Øu ƒë√£i thanh to√°n'
                                        ? 'selected' : '' %>>∆Øu ƒë√£i thanh to√°n</option>
                                    <option value="Gift" <%=promotion.promo_type==='Gift' ? 'selected' : '' %>>Qu√† t·∫∑ng
                                        (Gift)</option>
                                    <option value="Combo" <%=promotion.promo_type==='Combo' ? 'selected' : '' %>>Combo</option>
    <option value="Tr·∫£ g√≥p 0%" <%=promotion.promo_type==='Tr·∫£ g√≥p 0%' ? 'selected' : '' %>>Tr·∫£ g√≥p 0%</option>
                                    <option value="Tr·∫£ g√≥p 0%" <%=promotion.promo_type==='Tr·∫£ g√≥p 0%' ? 'selected' : '' %>>Tr·∫£ g√≥p 0%</option>
<option value="Thi ƒëua n·ªôi b·ªô" <%=promotion.promo_type==='Thi ƒëua n·ªôi b·ªô' ? 'selected' : '' %>>Thi ƒëua n·ªôi b·ªô (Banner)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>üîë M√£ gi·∫£m gi√° (n·∫øu c√≥)</label>
                            <input type="text" name="coupon_code" value="<%= promotion.coupon_code || '' %>">
                        </div>


                        <div class="form-group">
    <label style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" name="has_coupon_list" id="hasCouponListCheckbox" style="width: auto;">
        Hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng danh s√°ch coupon/voucher
    </label>
</div>

<div class="form-section" id="couponListBuilder" style="display: none;">
    <h3>üìù Danh s√°ch Coupon</h3>
    <div id="couponListContainer">
        </div>
    <button type="button" class="btn btn-secondary" id="addCouponRowBtn" style="margin-top: 10px;">+ Th√™m d√≤ng</button>
</div>

                    <div class="form-group">
  <label>Gi√° tr·ªã gi·∫£m</label>
  <div class="grid-2">
    <div>
      <select name="discount_value_type" id="discount_value_type" onchange="toggleDiscountInputs()">
        <option value="">-- Ch·ªçn ki·ªÉu --</option>
        <option value="amount">Gi·∫£m ti·ªÅn (‚Ç´)</option>
        <option value="percent">Gi·∫£m theo %</option>
      </select>
    </div>
    <div id="amountBox" style="display:none;">
      <input type="number" name="discount_amount" placeholder="S·ªë ti·ªÅn gi·∫£m (‚Ç´)" min="0" step="1000">
    </div>
    <div id="percentBox" style="display:none;">
      <input type="number" name="discount_percent" placeholder="% gi·∫£m (0‚Äì100)" min="0" max="100" step="0.1">
    </div>
    <div id="capBox" style="display:none;">
      <input type="number" name="max_discount_amount" placeholder="Gi·∫£m t·ªëi ƒëa (‚Ç´)" min="0" step="1000">
    </div>
    <div>
      <input type="number" name="min_order_value" placeholder="ƒê∆°n t·ªëi thi·ªÉu (‚Ç´, ƒë·ªÉ tr·ªëng = 0)" min="0" step="1000">
    </div>
  </div>
  <small class="hint">Ch·ªçn ‚ÄúGi·∫£m ti·ªÅn‚Äù ‚Üí nh·∫≠p ‚ÄúS·ªë ti·ªÅn gi·∫£m‚Äù. Ch·ªçn ‚Äú%‚Äù ‚Üí nh·∫≠p ‚Äú% gi·∫£m‚Äù + ‚ÄúGi·∫£m t·ªëi ƒëa‚Äù.</small>
</div>

<script>
  function toggleDiscountInputs(){
    const t = document.getElementById('discount_value_type').value;
    document.getElementById('amountBox').style.display  = (t==='amount') ? 'block' : 'none';
    document.getElementById('percentBox').style.display = (t==='percent') ? 'block' : 'none';
    document.getElementById('capBox').style.display     = (t==='percent') ? 'block' : 'none';
  }
  document.addEventListener('DOMContentLoaded', toggleDiscountInputs);
</script>

<style>
  .grid-2{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
  .hint{ color:#64748b; font-size:12px; }
</style>



                    <h3>üß© Nh√≥m hi·ªÉn th·ªã</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Nh√≥m CTKM (v√≠ d·ª•: ƒê·ªîI ƒêI·ªÇM THI)</label>
                            <input name="group_name" placeholder="Nh·∫≠p nh√≥m" value="<%= promotion.group_name || '' %>">
                        </div>

                    </div>


                    </div>

                    <h3>üìã B·∫£ng chi ti·∫øt (ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã)</h3>

                    <style>
                        .rte-toolbar {
                            display: flex;
                            gap: 6px;
                            flex-wrap: wrap;
                            margin: 6px 0 10px;
                            align-items: center;
                        }

                        .rte-btn {
                            padding: 6px 10px;
                            border: 1px solid #e5e7eb;
                            background: #fff;
                            border-radius: 8px;
                            font-size: 12px;
                            cursor: pointer;
                        }

                        .rte-color {
                            width: 26px;
                            height: 26px;
                            padding: 0;
                        }

                        .detail-grid {
                            width: 100%;
                            border: 1px solid #e5e7eb;
                            border-radius: 12px;
                            border-collapse: separate;
                            border-spacing: 0;
                            table-layout: fixed;
                        }

                        .detail-grid colgroup col:first-child {
                            width: 34%;
                        }

                        /* ti√™u ƒë·ªÅ */
                        .detail-grid colgroup col:last-child {
                            width: 66%;
                        }

                        /* √¥ nh·∫≠p */
                        .detail-grid th,
                        .detail-grid td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #eef2f7;
                            vertical-align: top;
                        }

                        .detail-grid th {
                            background: #f8fafc;
                            font-weight: 600;
                            color: #0f172a;
                            text-align: left;
                        }

                        .detail-grid tr:last-child th,
                        .detail-grid tr:last-child td {
                            border-bottom: none;
                        }

                        .rte-field {
                            display: block;
                            width: 100%;
                            min-height: 90px;
                            padding: 10px;
                            border: 1px solid #e5e7eb;
                            border-radius: 10px;
                            background: #fff;
                            overflow: auto;
                        }

                        .rte-field:focus {
                            outline: 2px solid #93c5fd;
                            outline-offset: 2px;
                        }

                        .rte-field:empty:before {
                            content: attr(data-placeholder);
                            color: #94a3b8;
                        }

                        textarea[hidden] {
                            display: none !important;
                        }

                        @media (max-width: 768px) {
                            .detail-grid colgroup col:first-child {
                                width: 42%;
                            }

                            .detail-grid colgroup col:last-child {
                                width: 58%;
                            }

                            .rte-field {
                                min-height: 72px;
                            }
                        }
                    </style>


                    <div class="rte-toolbar" id="rteToolbar" aria-label="ƒê·ªãnh d·∫°ng">
                        <button type="button" class="rte-btn" data-cmd="bold"><b>B</b></button>
                        <button type="button" class="rte-btn" data-cmd="italic"><i>I</i></button>
                        <button type="button" class="rte-btn" data-cmd="underline"><u>U</u></button>
                        <input type="color" class="rte-btn rte-color" id="rteColor">
                        <button type="button" class="rte-btn" id="rteEmoji">üòä</button>
                        <button type="button" class="rte-btn" id="rteLink">üîó Link</button>
                        <small class="muted">Ch·ªçn √¥ c·∫ßn nh·∫≠p, r·ªìi b·∫•m c√°c n√∫t ƒë·ªÉ ƒë·ªãnh d·∫°ng.</small>
                    </div>
                    <% // B·∫¢NG CHI TI·∫æT ‚Äì ƒë√£ b·ªè c√°c tr∆∞·ªùng tr√πng v·ªõi ‚ÄúTh√¥ng tin c∆° b·∫£n‚Äù const
                        DETAIL_ROWS=[ 'N·ªôi dung / Link b√°o c√°o/ Lu·ªìng v·∫≠n h√†nh' , 'ƒê·ªëi t∆∞·ª£ng lo·∫°i tr·ª´'
                        , 'ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng' , 'Gi·ªõi h·∫°n l∆∞·ª£t √°p d·ª•ng' , 'Y√™u c·∫ßu ƒë·∫∑c bi·ªát' , 'Tr·∫£ tr∆∞·ªõc (Tr·∫£ g√≥p)'
                        , 'Gi√° tr·ªã gi·∫£m (% ho·∫∑c ti·ªÅn)' , 'Gi√° tr·ªã gi·∫£m t·ªëi ƒëa (N·∫øu l√† %)' , 'Gi√° tr·ªã t·ªëi thi·ªÉu'
                        , 'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng coupon' , 'SKU qu√† t·∫∑ng (C√≥ th·ªÉ ch·ªçn theo option v√† ch·ªâ ch·ªçn ƒë∆∞·ª£c 1)'
                        , '√Åp d·ª•ng c√πng CTKM kh√°c ?' , 'Kh√¥ng √°p d·ª•ng c√πng CTKM' , 'Link n·ªôi b·ªô/ b√°o c√°o' ]; %>

                        <table class="detail-grid">
                            <colgroup>
                                <col />
                                <col />
                            </colgroup>
                            <tbody>
                                <% DETAIL_ROWS.forEach(function(label, idx){ %>
                                    <tr>
                                        <th>
                                            <%= label %>
                                        </th>
                                        <td>
                                            <div class="rte-field" contenteditable="true"
                                            data-name="detail[<%= label %>]" data-index="<%= idx %>">
                                            <%- (promotion.detail_fields && promotion.detail_fields[label]) ? promotion.detail_fields[label] : '' %>
                                            </div>
                                            <textarea name="detail[<%= label %>]" hidden></textarea>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>

                        <div class="form-section">
                <h3>üéØ Ph·∫°m vi √°p d·ª•ng</h3>
                                            <% let bs_brands=[];
                                            let bs_subcats=[]; if (promotion.apply_brand_subcats && promotion.apply_brand_subcats.length> 0) {
                                            bs_brands = Array.from(new Set((promotion.apply_brand_subcats || []).map(x => x.brand)));
                                            bs_subcats = Array.from(new Set((promotion.apply_brand_subcats || []).map(x => x.subcat_id)));
                                            }
                                            %>
                <div class="form-group">
                    <label>√Åp d·ª•ng cho</label>
                    <select name="apply_to_type" id="applyToTypeSelect" onchange="toggleScopeFields()">
                        <option value="all" <%= promotion.apply_to_all_skus ? 'selected' : '' %>>T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                        <option value="sku" <%= promotion.promotion_skus && promotion.promotion_skus.length > 0 && !promotion.apply_to_all_skus ? 'selected' : '' %>>Theo danh s√°ch SKU</option>
                        <option value="brand" <%= promotion.apply_to_brands && promotion.apply_to_brands.length > 0 ? 'selected' : '' %>>Theo Brand</option>
                        <option value="category" <%= promotion.apply_to_categories && promotion.apply_to_categories.length > 0 ? 'selected' : '' %>>Theo Category</option>
                        <option value="subcat" <%= promotion.apply_to_subcats && promotion.apply_to_subcats.length > 0 ? 'selected' : '' %>>Theo Subcat</option>
                        <option value="brand_subcat" <%= (promotion.apply_brand_subcats && promotion.apply_brand_subcats.length > 0) ? 'selected' : '' %>>Theo Brand + Subcat</option>

                    </select>
                </div>
                <div class="form-group scope-field" id="skuField" style="display:none;">
                    <label>SKU √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng)</label>
                    <textarea name="skus" rows="4"><%= (promotion.promotion_skus || []).map(x => x.sku).join(', ') %></textarea>
                </div>
                <div class="form-group scope-field" id="brandField" style="display:none;">
                    <label>Brand √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                    <input type="text" name="apply_brands" value="<%= (promotion.apply_to_brands || bs_brands).join(', ') %>" placeholder="VD: Apple, Samsung, Dell">
                </div>
                <div class="form-group scope-field" id="categoryField" style="display:none;">
                    <label>Category √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                    <input type="text" name="apply_categories" value="<%= (promotion.apply_to_categories || []).join(', ') %>" placeholder="VD: NH01, NH02">
                </div>
                <div class="form-group scope-field" id="subcatField" style="display:none;">
                    <label>Subcat √°p d·ª•ng (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                    <input type="text" name="apply_subcats" value="<%= (promotion.apply_to_subcats || bs_subcats).join(', ') %>" placeholder="VD: NH01-01-98-05">
                </div>
                <div class="form-group">
                    <label>SKU lo·∫°i tr·ª´ (lu√¥n √°p d·ª•ng, t√πy ch·ªçn)</label>
                    <textarea name="excluded_skus" rows="3" placeholder="Nh·∫≠p SKU, c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng"><%= (promotion.promotion_excluded_skus || []).map(x=> x.sku).join(', ') %></textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h3>üîó Quan h·ªá v·ªõi CTKM kh√°c</h3>
                <% const grouped = {}; (allPromosForCompat || []).forEach(p=>{ const g = p.group_name || 'Kh√°c'; (grouped[g] = grouped[g] || []).push(p); }); const groupNames = Object.keys(grouped).sort((a,b)=> a.localeCompare(b,'vi'));
                %>
                <div class="form-group">
                    <label>√Åp d·ª•ng c√πng CTKM</label>
                    <div style="display:flex; gap:8px; margin-bottom:6px;">
                        <select id="applyWithGroupPicker" style="flex:1; padding:8px 10px; border:1px solid #dee2e6; border-radius:8px;">
                            <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                        </select>
                        <button type="button" class="btn btn-primary" id="btnSelectGroupAW" style="padding: 8px 12px;">Ch·ªçn</button>
                        <button type="button" class="btn btn-secondary" id="btnUnselectGroupAW" style="padding: 8px 12px;">B·ªè ch·ªçn</button>
                    </div>
                    <select name="apply_with[]" multiple class="multi-select" id="applyWithSelect">
                        <% groupNames.forEach(g => { %>
                            <optgroup label="<%= g %>">
                                <% grouped[g].forEach(function(p){ var label = p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name || p.name)) : p.name;
                                %>
                                    <option data-group="<%= g %>" value="<%= p.id %>" <%= (compatAllowIds||[]).includes(String(p.id)) ? 'selected' : '' %>><%= label %></option>
                                <% }) %>
                            </optgroup>
                        <% }) %>
                    </select>
                    <div class="hint">Gi·ªØ Ctrl/Command ƒë·ªÉ ch·ªçn th√™m CTKM; ho·∫∑c d√πng ‚ÄúCh·ªçn nh√≥m‚Äù.</div>
                </div>
                <div class="form-group">
                    <label>Kh√¥ng √°p d·ª•ng c√πng CTKM</label>
                     <div style="display:flex; gap:8px; margin-bottom:6px;">
                        <select id="excludeWithGroupPicker" style="flex:1; padding:8px 10px; border:1px solid #dee2e6; border-radius:8px;">
                            <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                        </select>
                        <button type="button" class="btn btn-primary" id="btnSelectGroupEX" style="padding: 8px 12px;">Ch·ªçn</button>
                        <button type="button" class="btn btn-secondary" id="btnUnselectGroupEX" style="padding: 8px 12px;">B·ªè ch·ªçn</button>
                    </div>
                    <select name="exclude_with[]" multiple class="multi-select" id="excludeWithSelect">
                        <% groupNames.forEach(g => { %>
                            <optgroup label="<%= g %>">
                                <% grouped[g].forEach(function(p){ var label = p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name || p.name)) : p.name;
                                %>
                                    <option data-group="<%= g %>" value="<%= p.id %>" <%= (compatExclIds||[]).includes(String(p.id)) ? 'selected' : '' %>><%= label %></option>
                                <% }) %>
                            </optgroup>
                        <% }) %>
                    </select>
                </div>
            </div>



    <script>
    function toggleScopeFields() {
    const typeSelect = document.getElementById('applyToTypeSelect');
    if (!typeSelect) return; // Th√™m ki·ªÉm tra

    const selectedType = typeSelect.value;
    const fields = {
        sku: document.getElementById('skuField'),
        brand: document.getElementById('brandField'),
        category: document.getElementById('categoryField'),
        subcat: document.getElementById('subcatField')
    };
    // ·∫®n t·∫•t c·∫£ tr∆∞·ªõc
    for (const key in fields) {
        if (fields[key]) fields[key].style.display = 'none';
    }

    // Hi·ªÉn th·ªã d·ª±a tr√™n l·ª±a ch·ªçn
    if (selectedType === 'brand_subcat') { 
        if (fields.brand) fields.brand.style.display = 'block';
        if (fields.subcat) fields.subcat.style.display = 'block';
    } else if (fields[selectedType]) {
        fields[selectedType].style.display = 'block';
    }
}

    document.addEventListener('DOMContentLoaded', function() {
        // ---- Script 1: ·∫®n/hi·ªán c√°c tr∆∞·ªùng Ph·∫°m vi √°p d·ª•ng ----
        toggleScopeFields();

        // ---- Script 1b: X·ª≠ l√Ω Checkbox Coupon List (FIXED) ----
        try {
            const couponCheckbox = document.getElementById('hasCouponListCheckbox');
            const couponBuilder = document.getElementById('couponListBuilder');
            // L·∫•y d·ªØ li·ªáu promotion ƒë√£ ƒë∆∞·ª£c truy·ªÅn v√†o t·ª´ EJS
            const promoData = <%- JSON.stringify(promotion) %>;

            // H√†m ƒë·ªÉ b·∫≠t/t·∫Øt
            function toggleCouponBuilder() {
                if (couponCheckbox && couponBuilder) {
                    couponBuilder.style.display = couponCheckbox.checked ? 'block' : 'none';
                }
            }

            // 1. ƒê·∫∑t tr·∫°ng th√°i ban ƒë·∫ßu khi t·∫£i trang
            // N·∫øu promotion c√≥ coupon_list, t·ª± ƒë·ªông tick v√†o √¥ checkbox
            if (couponCheckbox && promoData && promoData.coupon_list && promoData.coupon_list.length > 0) {
                couponCheckbox.checked = true;
            }

            // 2. Th√™m s·ª± ki·ªán 'change' ƒë·ªÉ b·∫≠t/t·∫Øt builder khi click
            if (couponCheckbox) {
                couponCheckbox.addEventListener('change', toggleCouponBuilder);
            }

            // 3. Ch·∫°y h√†m n√†y 1 l·∫ßn khi t·∫£i trang ƒë·ªÉ ·∫©n/hi·ªán ch√≠nh x√°c
            toggleCouponBuilder();

        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o Coupon Builder Checkbox:", e);
        }

        // ---- Script 2: Helper cho vi·ªác ch·ªçn nh√≥m CTKM t∆∞∆°ng th√≠ch ----
        function selectByGroup(selectEl, group, on = true) {
            if (!selectEl) return;
            [...selectEl.options].forEach(o => {
                if (o.dataset.group === group) { o.selected = !!on; }
            });
        }
        document.getElementById('btnSelectGroupAW').onclick = () => selectByGroup(document.getElementById('applyWithSelect'), document.getElementById('applyWithGroupPicker').value, true);
        document.getElementById('btnUnselectGroupAW').onclick = () => selectByGroup(document.getElementById('applyWithSelect'), document.getElementById('applyWithGroupPicker').value, false);
        document.getElementById('btnSelectGroupEX').onclick = () => selectByGroup(document.getElementById('excludeWithSelect'), document.getElementById('excludeWithGroupPicker').value, true);
        document.getElementById('btnUnselectGroupEX').onclick = () => selectByGroup(document.getElementById('excludeWithSelect'), document.getElementById('excludeWithGroupPicker').value, false);

        // ---- Script 3: Script cho Rich Text Editor (KH·ªêI TR√ôNG L·∫∂P ƒê√É B·ªä X√ìA) ----
        // Kh·ªëi m√£ t·ª´ ƒë·∫øn ƒë√£ ƒë∆∞·ª£c x√≥a
       
        (function() {
            const promo = <%- JSON.stringify(promotion) %>;
            if (!promo) return;

            const type = promo.discount_value_type;
            const value = promo.discount_value;
            const max = promo.max_discount_amount;
            const min = promo.min_order_value;

            const typeSelect = document.querySelector('select[name="discount_value_type"]');
            const amountInput = document.querySelector('input[name="discount_amount"]');
            const percentInput = document.querySelector('input[name="discount_percent"]');
            const maxInput = document.querySelector('input[name="max_discount_amount"]');
            const minInput = document.querySelector('input[name="min_order_value"]');

            if (type && typeSelect) {
                typeSelect.value = type;
            }
            if (type === 'amount' && value && amountInput) {
                amountInput.value = value;
            }
            if (type === 'percent' && value && percentInput) {
                percentInput.value = value;
            }
            if (max && maxInput) {
                maxInput.value = max;
            }
            if (min && minInput) {
                minInput.value = min;
            }
            
            // Quan tr·ªçng: G·ªçi l·∫°i h√†m toggle ƒë·ªÉ hi·ªán/·∫©n ƒë√∫ng √¥ input
            if (typeof toggleDiscountInputs === 'function') {
                toggleDiscountInputs();
            }
        })();

        // ---- Script 4: X·ª≠ l√Ω Th√™m/X√≥a/T·∫£i Coupon List (FIXED) ----
        try {
            const container = document.getElementById('couponListContainer');
            const addBtn = document.getElementById('addCouponRowBtn');
            // L·∫•y d·ªØ li·ªáu promotion ƒë√£ ƒë∆∞·ª£c truy·ªÅn v√†o t·ª´ EJS
            const promoData = <%- JSON.stringify(promotion) %>;
            let couponIdx = 0; // B·ªô ƒë·∫øm ƒë·ªÉ ƒë·∫£m b·∫£o t√™n input l√† duy nh·∫•t

            // H√†m t·∫°o 1 d√≤ng HTML
            function createCouponRow(data = {}) {
                const idx = couponIdx++; // TƒÉng b·ªô ƒë·∫øm
                const row = document.createElement('div');
                // S·ª≠ d·ª•ng class 'dynamic-item' ƒë√£ c√≥ style
                row.className = 'dynamic-item'; 
                
                // C·∫ßn 4 √¥ input + 1 n√∫t x√≥a.
                // Ch√∫ng ta s·∫Ω t·ª± ƒë·ªãnh nghƒ©a style grid ·ªü ƒë√¢y ƒë·ªÉ kh·ªõp v·ªõi 4 c·ªôt + n√∫t x√≥a
                row.style.display = 'grid';
                // 1.5fr 1fr 1fr 1fr auto
                row.style.gridTemplateColumns = '1.5fr 1fr 1fr 1fr auto';
                row.style.gap = '10px';
                row.style.marginBottom = '10px';

                // D√πng .replace(/"/g, '&quot;') ƒë·ªÉ tr√°nh l·ªói HTML n·∫øu t√™n/m√£ c√≥ d·∫•u nh√°y k√©p
                row.innerHTML = `
                    <input type="text" name="coupons[${idx}][name]" 
                           placeholder="T√™n/Nh√≥m SP (v√≠ d·ª•: iPhone 15)" 
                           value="${(data.name || '').replace(/"/g, '&quot;')}">
                    <input type="text" name="coupons[${idx}][code]" 
                           placeholder="M√£ coupon *" 
                           value="${(data.code || '').replace(/"/g, '&quot;')}" required>
                    <input type="text" name="coupons[${idx}][discount]" 
                           placeholder="M·ª©c gi·∫£m (v√≠ d·ª•: 500000)" 
                           value="${data.discount || ''}">
                    <input type="text" name="coupons[${idx}][note]" 
                           placeholder="ƒêi·ªÅu ki·ªán (n·∫øu c√≥)" 
                           value="${(data.note || '').replace(/"/g, '&quot;')}">
                    <button type="button" class="remove-item" 
                            onclick="this.parentElement.remove()">X√≥a</button>
                `;
                
                if (container) {
                    container.appendChild(row);
                }
            }

            // 1. T·∫£i c√°c coupon ƒë√£ c√≥ khi t·∫£i trang
            if (promoData && promoData.coupon_list && Array.isArray(promoData.coupon_list)) {
                promoData.coupon_list.forEach(item => {
                    createCouponRow(item);
                });
            }

            // 2. X·ª≠ l√Ω n√∫t "+ Th√™m d√≤ng"
            if (addBtn) {
                addBtn.addEventListener('click', function() {
                    createCouponRow(); // Th√™m d√≤ng m·ªõi
                });
            }

        } catch (e) {
            console.error("L·ªói kh·ªüi t·∫°o Coupon List Add/Remove:", e);
        }

    }); // <-- ƒê√≥ng th·∫ª document.addEventListener('DOMContentLoaded')

    // D√°n m√£ n√†y v√†o <script> trong file edit-promotion.ejs
(function () {
    let activeField = null;

    // B·∫Øt focus ƒë·ªÉ bi·∫øt ƒëang ch·ªânh √¥ n√†o
    document.querySelectorAll('.rte-field').forEach(el => {
        el.addEventListener('focus', () => activeField = el);
    });

    // Toolbar: bold/italic/underline
    const rteToolbar = document.getElementById('rteToolbar');
    if (rteToolbar) {
        rteToolbar.addEventListener('click', (e) => {
            const btn = e.target.closest('.rte-btn');
            if (!btn) return;
            const cmd = btn.dataset.cmd;
            if (!cmd) return;
            document.execCommand(cmd, false, null);
        });
    }

    // X·ª≠ l√Ω n√∫t LINK (ƒê√É S·ª¨A)
    const rteLinkBtn = document.getElementById('rteLink');
    if (rteLinkBtn) {
        rteLinkBtn.addEventListener('click', () => {
            if (!activeField) { 
                alert('L·ªói: B·∫°n ph·∫£i b·∫•m v√†o m·ªôt √¥ n·ªôi dung TR∆Ø·ªöC KHI b·∫•m n√∫t "Link".');
                return;
            }

            const url = prompt('Nh·∫≠p URL (c√≥ th·ªÉ link r√∫t g·ªçn):', 'https://');
            if (!url) return; // D·ª´ng n·∫øu user b·∫•m "H·ªßy"

            // ƒê·∫£m b·∫£o focus
            activeField.focus();
            
            // S·ª¨ D·ª§NG L·ªÜNH G·ªêC 'createLink'
            // L·ªánh n√†y t·ª± ƒë·ªông s·ª≠ d·ª•ng vƒÉn b·∫£n ƒëang ƒë∆∞·ª£c b√¥i ƒëen.
            document.execCommand('createLink', false, url);
        });
    }
    // ƒê·ªïi m√†u ch·ªØ
    const rteColorInput = document.getElementById('rteColor');
    if (rteColorInput) {
        rteColorInput.addEventListener('input', (e) => {
            if (!activeField) return; // Th√™m ki·ªÉm tra
            activeField.focus();
            document.execCommand('foreColor', false, e.target.value);
        });
    }

    // Emoji ƒë∆°n gi·∫£n
    const rteEmojiBtn = document.getElementById('rteEmoji');
    if (rteEmojiBtn) {
        rteEmojiBtn.addEventListener('click', () => {
            if (!activeField) {
                alert('L·ªói: B·∫°n ph·∫£i b·∫•m v√†o m·ªôt √¥ n·ªôi dung TR∆Ø·ªöC KHI b·∫•m n√∫t "Emoji".');
                return;
            }
            const emoji = prompt('Nh·∫≠p emoji / icon:', 'üî•');
            if (emoji) {
                activeField.focus();
                document.execCommand('insertText', false, emoji);
            }
        });
    }

    // Tr∆∞·ªõc khi submit: copy innerHTML => textarea ·∫©n
    // ƒê·∫£m b·∫£o form c·ªßa b·∫°n c√≥ id="promoForm" (n·∫øu l√† trang S·ª≠a)
    const promoForm = document.getElementById('promoForm'); 
    if (promoForm) {
        promoForm.addEventListener('submit', () => {
            document.querySelectorAll('.rte-field').forEach((div) => {
                const name = div.getAttribute('data-name');
                const ta = div.parentElement.querySelector('textarea[name="' + name + '"]');
                if (ta) ta.value = div.innerHTML;  // l∆∞u HTML
            });
            
            // V√¥ hi·ªáu h√≥a c√°c input coupon n·∫øu checkbox kh√¥ng ƒë∆∞·ª£c ch·ªçn
            const couponCheckbox = document.getElementById('hasCouponListCheckbox');
            const couponBuilder = document.getElementById('couponListBuilder');
            if (couponCheckbox && couponBuilder && !couponCheckbox.checked) {
                couponBuilder.querySelectorAll('input, select, textarea').forEach(el => {
                    el.disabled = true;
                });
            }
        });
    }
})();
    </script>                                 

                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                                        <a href="/promo-management" class="btn-secondary">‚ùå H·ªßy</a>
                                    </div>
                </form>
    </div>

    <script>



    
    <%- include('partials/footer') %>
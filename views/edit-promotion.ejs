<%- include('partials/header', {title: 'S·ª≠a CTKM' , currentPage: 'edit-promotion' , time: time}) %>

    <style>
        .edit-promotion-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .back-button {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .promo-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            margin-bottom: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }

        .dynamic-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .add-item {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .remove-item {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
    </style>

    <div class="edit-promotion-container">
        <a href="/promo-management" class="back-button">‚Üê Quay l·∫°i</a>

        <div class="page-header">
            <h1>‚úèÔ∏è S·ª≠a CTKM: <%= promotion.name %>
            </h1>
            <p>ID: <%= promotion.id %>
            </p>
        </div>

        <% if (typeof error !=='undefined' && error) { %>
            <div class="error-message">
                ‚ö†Ô∏è <%= error %>
            </div>
            <% } %>

                <form action="/edit-promotion/<%= promotion.id %>" method="POST" class="promo-form">
                    <div class="form-section">
                        <h3>üìã Th√¥ng tin c∆° b·∫£n</h3>

                        <div class="form-group">
                            <label>T√™n CTKM *</label>
                            <input type="text" name="name" value="<%= promotion.name || '' %>" required>
                            <!-- Bi·∫øn th·ªÉ = T√™n CTKM -->
                            <input type="hidden" name="subgroup_name" value="<%= promotion.name || '' %>">
                        </div>
                        <div class="form-group">
                            <label>M√¥ t·∫£</label>
                            <textarea name="description" rows="3"><%= promotion.description || '' %></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>üìÖ Ng√†y b·∫Øt ƒë·∫ßu *</label>
                                <input type="date" name="start_date" value="<%= promotion.start_date %>" required>
                            </div>

                            <div class="form-group">
                                <label>üìÖ Ng√†y k·∫øt th√∫c *</label>
                                <input type="date" name="end_date" value="<%= promotion.end_date %>" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>üîÑ Channel √°p d·ª•ng</label>
                                <select name="channel">
                                    <option value="All" <%=promotion.channel==='All' ? 'selected' : '' %>>T·∫•t c·∫£
                                    </option>
                                    <option value="Online" <%=promotion.channel==='Online' ? 'selected' : '' %>>Online
                                    </option>
                                    <option value="Offline" <%=promotion.channel==='Offline' ? 'selected' : '' %>
                                        >Offline</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>üéÅ Lo·∫°i CTKM *</label>
                                <select name="promo_type" required>
                                    <option value="Kh√¥ng c√≥ m√£" <%=promotion.promo_type==='Kh√¥ng c√≥ m√£' ? 'selected'
                                        : '' %>>Kh√¥ng c√≥ m√£</option>
                                    <option value="Coupon" <%=promotion.promo_type==='Coupon' ? 'selected' : '' %>
                                        >Coupon</option>
                                    <option value="Voucher" <%=promotion.promo_type==='Voucher' ? 'selected' : '' %>
                                        >Voucher</option>
                                    <option value="∆Øu ƒë√£i thanh to√°n" <%=promotion.promo_type==='∆Øu ƒë√£i thanh to√°n'
                                        ? 'selected' : '' %>>∆Øu ƒë√£i thanh to√°n</option>
                                    <option value="Gift" <%=promotion.promo_type==='Gift' ? 'selected' : '' %>>Qu√† t·∫∑ng
                                        (Gift)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>üîë M√£ coupon (n·∫øu c√≥)</label>
                            <input type="text" name="coupon_code" value="<%= promotion.coupon_code || '' %>">
                        </div>
                    </div>
                    <h3>üìã B·∫£ng chi ti·∫øt (ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã)</h3>

                    <style>
                        .rte-toolbar {
                            display: flex;
                            gap: 6px;
                            flex-wrap: wrap;
                            margin: 6px 0 10px;
                            align-items: center;
                        }

                        .rte-btn {
                            padding: 6px 10px;
                            border: 1px solid #e5e7eb;
                            background: #fff;
                            border-radius: 8px;
                            font-size: 12px;
                            cursor: pointer;
                        }

                        .rte-color {
                            width: 26px;
                            height: 26px;
                            padding: 0;
                        }

                        .detail-grid {
                            width: 100%;
                            border: 1px solid #e5e7eb;
                            border-radius: 12px;
                            border-collapse: separate;
                            border-spacing: 0;
                            table-layout: fixed;
                        }

                        .detail-grid colgroup col:first-child {
                            width: 34%;
                        }

                        /* ti√™u ƒë·ªÅ */
                        .detail-grid colgroup col:last-child {
                            width: 66%;
                        }

                        /* √¥ nh·∫≠p */
                        .detail-grid th,
                        .detail-grid td {
                            padding: 10px 12px;
                            border-bottom: 1px solid #eef2f7;
                            vertical-align: top;
                        }

                        .detail-grid th {
                            background: #f8fafc;
                            font-weight: 600;
                            color: #0f172a;
                            text-align: left;
                        }

                        .detail-grid tr:last-child th,
                        .detail-grid tr:last-child td {
                            border-bottom: none;
                        }

                        .rte-field {
                            display: block;
                            width: 100%;
                            min-height: 90px;
                            padding: 10px;
                            border: 1px solid #e5e7eb;
                            border-radius: 10px;
                            background: #fff;
                            overflow: auto;
                        }

                        .rte-field:focus {
                            outline: 2px solid #93c5fd;
                            outline-offset: 2px;
                        }

                        .rte-field:empty:before {
                            content: attr(data-placeholder);
                            color: #94a3b8;
                        }

                        textarea[hidden] {
                            display: none !important;
                        }

                        @media (max-width: 768px) {
                            .detail-grid colgroup col:first-child {
                                width: 42%;
                            }

                            .detail-grid colgroup col:last-child {
                                width: 58%;
                            }

                            .rte-field {
                                min-height: 72px;
                            }
                        }
                    </style>


                    <div class="rte-toolbar" id="rteToolbar" aria-label="ƒê·ªãnh d·∫°ng">
                        <button type="button" class="rte-btn" data-cmd="bold"><b>B</b></button>
                        <button type="button" class="rte-btn" data-cmd="italic"><i>I</i></button>
                        <button type="button" class="rte-btn" data-cmd="underline"><u>U</u></button>
                        <input type="color" class="rte-btn rte-color" id="rteColor">
                        <button type="button" class="rte-btn" id="rteEmoji">üòä</button>
                        <button type="button" class="rte-btn" id="rteLink">üîó Link</button>
                        <small class="muted">Ch·ªçn √¥ c·∫ßn nh·∫≠p, r·ªìi b·∫•m c√°c n√∫t ƒë·ªÉ ƒë·ªãnh d·∫°ng.</small>
                    </div>
                    <% // B·∫¢NG CHI TI·∫æT ‚Äì ƒë√£ b·ªè c√°c tr∆∞·ªùng tr√πng v·ªõi ‚ÄúTh√¥ng tin c∆° b·∫£n‚Äù const
                        DETAIL_ROWS=[ 'N·ªôi dung / Link b√°o c√°o/ Lu·ªìng v·∫≠n h√†nh' , 'ƒê·ªëi t∆∞·ª£ng lo·∫°i tr·ª´'
                        , 'ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng' , 'Gi·ªõi h·∫°n l∆∞·ª£t √°p d·ª•ng' , 'Y√™u c·∫ßu ƒë·∫∑c bi·ªát' , 'Tr·∫£ tr∆∞·ªõc (Tr·∫£ g√≥p)'
                        , 'Gi√° tr·ªã gi·∫£m (% ho·∫∑c ti·ªÅn)' , 'Gi√° tr·ªã gi·∫£m t·ªëi ƒëa (N·∫øu l√† %)' , 'Gi√° tr·ªã t·ªëi thi·ªÉu'
                        , 'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng coupon' , 'SKU qu√† t·∫∑ng (C√≥ th·ªÉ ch·ªçn theo option v√† ch·ªâ ch·ªçn ƒë∆∞·ª£c 1)'
                        , '√Åp d·ª•ng c√πng CTKM kh√°c ?' , 'Kh√¥ng √°p d·ª•ng c√πng CTKM' , 'Link n·ªôi b·ªô/ b√°o c√°o' ]; %>

                        <table class="detail-grid">
                            <colgroup>
                                <col />
                                <col />
                            </colgroup>
                            <tbody>
                                <% DETAIL_ROWS.forEach(function(label, idx){ %>
                                    <tr>
                                        <th>
                                            <%= label %>
                                        </th>
                                        <td>
                                            <!-- tr∆∞·ªùng hi·ªÉn th·ªã -->
                                            <div class="rte-field" contenteditable="true"
                                                data-name="detail[<%= label %>]" data-index="<%= idx %>"></div>
                                            <!-- textarea ·∫©n ƒë·ªÉ submit -->
                                            <textarea name="detail[<%= label %>]" hidden></textarea>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>


                        <!-- Script RTE (ƒë·∫∑t TRONG form, tr∆∞·ªõc n√∫t L∆∞u) -->
                        <script>
                            (function () {
                                function exec(cmd) { document.execCommand(cmd, false, null); }
                                var b = document.getElementById('rteBold');
                                var i = document.getElementById('rteItalic');
                                var u = document.getElementById('rteUnderline');
                                var l = document.getElementById('rteLink');
                                if (b) b.addEventListener('click', function () { exec('bold'); });
                                if (i) i.addEventListener('click', function () { exec('italic'); });
                                if (u) u.addEventListener('click', function () { exec('underline'); });
                                if (l) l.addEventListener('click', function () {
                                    var el = document.activeElement;
                                    if (!el || el.getAttribute('contenteditable') !== 'true') return;
                                    var url = prompt('Nh·∫≠p URL:', 'https://');
                                    if (!url) return;
                                    var sel = window.getSelection ? String(window.getSelection()) : '';
                                    var text = sel && sel.trim() ? sel : url;
                                    var safe = url.replace(/"/g, '&quot;');
                                    document.execCommand('insertHTML', false, '<a href="' + safe + '" target="_blank" rel="noopener noreferrer">' + text + '</a>');
                                });

                                // copy n·ªôi dung c√°c div.rte-field v√†o textarea khi submit
                                var form = document.currentScript.closest('form');
                                if (form) {
                                    form.addEventListener('submit', function () {
                                        var fields = form.querySelectorAll('.rte-field');
                                        fields.forEach(function (div) {
                                            var name = div.getAttribute('data-name');
                                            var ta = form.querySelector('textarea[name="' + name + '"]');
                                            if (ta) ta.value = div.innerHTML.trim();
                                        });
                                    });
                                }
                            })();
                        </script>
                        <div class="form-section">
                            <h3>üéØ Ph·∫°m vi √°p d·ª•ng</h3>

                            <div class="form-group">
                                <label>√Åp d·ª•ng cho</label>
                                <select name="apply_to" onchange="toggleApplyTo()">
                                    <option value="all" <%=promotion.apply_to_all_skus ? 'selected' : '' %>>T·∫•t c·∫£ s·∫£n
                                        ph·∫©m</option>
                                    <option value="sku" <%=promotion.apply_to_all_skus ? '' : 'selected' %>>Theo danh
                                        s√°ch SKU ch·ªâ ƒë·ªãnh</option>
                                </select>
                            </div>

                            <% const included=(promotion.promotion_skus || []).map(x=> x.sku).join(', '); %>
                                <div class="form-group <%= promotion.apply_to_all_skus ? 'is-hidden' : '' %>"
                                    id="skuField">
                                    <label>SKU √°p d·ª•ng</label>
                                    <textarea name="skus" rows="3"
                                        placeholder="Nh·∫≠p SKU, c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng"><%= included %></textarea>
                                </div>

                                <% const excluded=(promotion.promotion_excluded_skus || []).map(x=> x.sku).join(', ');
                                    %>
                                    <div class="form-group">
                                        <label>SKU lo·∫°i tr·ª´ (t√πy ch·ªçn)</label>
                                        <textarea name="excluded_skus" rows="3"
                                            placeholder="Nh·∫≠p SKU, c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng"><%= excluded %></textarea>
                                    </div>

                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const sel = document.querySelector('select[name="apply_to"]');
                                            const skuField = document.getElementById('skuField');
                                            if (!sel || !skuField) return;

                                            function toggle() {
                                                // ·∫©n khi ch·ªçn 'all', hi·ªán khi 'sku'
                                                skuField.classList.toggle('is-hidden', sel.value !== 'sku');
                                            }
                                            sel.addEventListener('change', toggle);
                                            toggle(); // ch·∫°y khi m·ªü trang
                                        });
                                    </script>


                                    <div class="form-section">
                                        <h3 class="section-title">Quan h·ªá v·ªõi CTKM kh√°c</h3>

                                        <div class="form-group">
                                            <label>√Åp d·ª•ng c√πng CTKM</label>
                                            <select name="apply_with[]" multiple class="multi-select">
                                                <% (allPromosForCompat || []).forEach(function(p){ var
                                                    label=p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name ||
                                                    p.name)) : p.name; %>
                                                    <option value="<%= p.id %>" <%=(compatAllowIds ||
                                                        []).includes(String(p.id)) ? 'selected' : '' %>>
                                                        <%= label %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                            <div class="hint">Gi·ªØ Ctrl/Command ƒë·ªÉ ch·ªçn nhi·ªÅu CTKM.</div>
                                        </div>

                                        <div class="form-group">
                                            <label>Kh√¥ng √°p d·ª•ng c√πng CTKM</label>
                                            <select name="exclude_with" multiple class="multi-select">
                                                <% (allPromosForCompat || []).forEach(function(p){ var
                                                    label=p.group_name ? (p.group_name + ' ‚Äî ' + (p.subgroup_name ||
                                                    p.name)) : p.name; %>
                                                    <option value="<%= p.id %>" <%=(compatExclIds ||
                                                        []).includes(String(p.id)) ? 'selected' : '' %>>
                                                        <%= label %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                        </div>
                                    </div>
                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            const sel = document.querySelector('select[name="apply_to"]');
                                            const skuField = document.getElementById('skuField');
                                            if (!sel || !skuField) return;
                                            function toggle() { skuField.style.display = (sel.value === 'sku') ? 'block' : 'none'; }
                                            sel.addEventListener('change', toggle);
                                            toggle(); // ch·∫°y ngay khi m·ªü trang
                                        });
                                    </script>

                                    <script>
                                        // Toolbar: B / I / U / Link
                                        const cmd = (c) => document.execCommand(c, false, null);
                                        document.getElementById('rteBold').onclick = () => cmd('bold');
                                        document.getElementById('rteItalic').onclick = () => cmd('italic');
                                        document.getElementById('rteUnderline').onclick = () => cmd('underline');
                                        document.getElementById('rteLink').onclick = () => {
                                            const el = document.activeElement;
                                            if (!el || el.getAttribute('contenteditable') !== 'true') return;
                                            const url = prompt('Nh·∫≠p URL:', 'https://');
                                            if (!url) return;
                                            const text = document.getSelection()?.toString() || url;
                                            const html = `<a href="${url.replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer">${text}</a>`;
                                            document.execCommand('insertHTML', false, html);
                                        };

                                        // Khi submit form: copy innerHTML t·ª´ div.rte-field sang textarea hidden
                                        (function () {
                                            const form = document.currentScript.closest('form');
                                            form.addEventListener('submit', () => {
                                                document.querySelectorAll('.rte-field').forEach(div => {
                                                    const ta = div.parentElement.querySelector('textarea[name="' + div.dataset.name + '"]');
                                                    if (ta) ta.value = div.innerHTML.trim();
                                                });
                                            });
                                        })();
                                    </script>


                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                                        <a href="/promo-management" class="btn-secondary">‚ùå H·ªßy</a>
                                    </div>
                </form>
    </div>

    <script>
        // Hi·ªÉn th·ªã c√°c field ph√π h·ª£p khi trang load
        document.addEventListener('DOMContentLoaded', function () {
            toggleApplyTo();
        });

        function toggleApplyTo() {
            const applyTo = document.querySelector('select[name="apply_to"]').value;
            document.getElementById('categoryField').style.display = applyTo === 'category' ? 'block' : 'none';
            document.getElementById('brandField').style.display = applyTo === 'brand' ? 'block' : 'none';
            document.getElementById('skuField').style.display = applyTo === 'sku' ? 'block' : 'none';
        }
    </script>

    <%- include('partials/footer') %>
<%- include('partials/header', { title: 'T·∫°o B√°o gi√° Nhanh', currentPage: 'quote-builder' }) %>

<style>
  /* === CSS G·ªêC === */
  .pc-builder-layout { display: flex; flex-direction: column; gap: 20px; }
  .price-summary-sticky { position: sticky; top: 80px; }
  
  .summary-item {
    display: flex; flex-direction: column; padding: 12px; 
    border-bottom: 1px dashed #e2e8f0; background: #fff;
    transition: background 0.2s;
  }
  .summary-item:hover { background: #f8fafc; }
  
  .summary-item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .summary-item-name { font-weight: 600; color: #1e293b; font-size: 14px; line-height: 1.4; }
  .summary-item-sku { font-size: 11px; color: #64748b; display: block; margin-top: 2px; }
  
  .summary-item-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
  
  .quantity-controls { display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 2px; border-radius: 6px; }
  .qty-btn {
    width: 24px; height: 24px; border: 1px solid #cbd5e1; background-color: #fff; color: #475569;
    border-radius: 4px; cursor: pointer; font-weight: 700; line-height: 1; display: flex; align-items: center; justify-content: center;
  }
  .qty-btn:hover { background-color: #e2e8f0; color: #0f172a; }
  .qty-display { font-weight: 600; padding: 0 6px; min-width: 20px; text-align: center; font-size: 13px; }

  .item-discount-wrapper { display: flex; align-items: center; gap: 4px; margin-left: 10px; }
  .item-discount-label { font-size: 10px; color: #e53935; font-weight: 600; text-transform: uppercase; }
  .item-discount-input {
    width: 70px; padding: 3px 6px; font-size: 12px; text-align: right; color: #e53935; font-weight: 600;
    border: 1px solid #fca5a5; border-radius: 4px; background: #fef2f2; outline: none;
  }
  .item-discount-input:focus { border-color: #e53935; box-shadow: 0 0 0 2px rgba(229,57,53,0.1); }

  .price-column { text-align: right; }
  .final-line-price { font-weight: 700; color: #2563eb; font-size: 14px; }

  .action-buttons { display: flex; gap: 2px; }
  .btn-icon { background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6; transition: 0.2s; font-size: 14px; }
  .btn-icon:hover { opacity: 1; transform: scale(1.1); }
  .price-edit-input { width: 90px; padding: 4px; border: 1px solid #2563eb; border-radius: 4px; font-size: 13px; }

  .order-settings { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 15px; }
  .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 13px; }
  .setting-label { font-weight: 600; color: #475569; }
  
  .global-discount-group { display: flex; gap: 0; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; }
  .global-discount-input { border: none; padding: 6px 10px; width: 80px; text-align: right; outline: none; font-size: 13px; }
  .global-discount-select { border: none; border-left: 1px solid #cbd5e1; background: #f1f5f9; padding: 0 8px; font-size: 12px; font-weight: 600; color: #475569; outline: none; cursor: pointer;}

  .template-selector { display: flex; flex-direction: column; gap: 6px; }
  .radio-option { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #334155; }
  .radio-option input { accent-color: #2563eb; cursor: pointer; }

  /* === [M·ªöI] CSS CHO AUTOCOMPLETE SEARCH === */
  .quick-search-wrapper { position: relative; margin-bottom: 20px; }
  .quick-search-input {
      width: 100%; padding: 12px 15px; font-size: 14px; 
      border: 1px solid #cbd5e1; border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.02); outline: none;
      transition: border 0.2s;
  }
  .quick-search-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
  
  .autocomplete-results {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 100;
      background: white; border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-height: 350px; overflow-y: auto;
      display: none;
  }
  .ac-item {
      padding: 10px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
  }
  .ac-item:hover { background-color: #f8fafc; }
  .ac-item:last-child { border-bottom: none; }
  
  .ac-info { display: flex; flex-direction: column; }
  .ac-sku { font-size: 12px; color: #64748b; font-weight: 600; }
  .ac-name { font-size: 14px; color: #1e293b; font-weight: 600; }
  .ac-meta { font-size: 11px; color: #94a3b8; }
  .ac-price { font-weight: 700; color: #e53935; font-size: 13px; }

  .ac-add-new {
      padding: 12px 15px; background-color: #f0fdfa; color: #0d9488;
      font-weight: 700; cursor: pointer; text-align: center;
      border-top: 1px dashed #ccfbf1;
  }
  .ac-add-new:hover { background-color: #ccfbf1; }

  /* Responsive */
  @media (min-width: 992px) {
    .pc-builder-layout { flex-direction: row; align-items: flex-start; }
    .builder-main { flex: 2; }
    .builder-sidebar { flex: 1; }
  }
</style>

<div class="pc-builder-layout">
  
  <div class="builder-main">
    <div class="dash-card">
      <div class="dash-title">T·∫°o b√°o gi√° nhanh</div>
      
      <div class="quick-search-wrapper">
          <input type="text" id="quickSearchInput" class="quick-search-input" placeholder="üîç Nh·∫≠p m√£ SKU ho·∫∑c t√™n s·∫£n ph·∫©m ƒë·ªÉ th√™m nhanh..." autocomplete="off">
          <div id="quickSearchResults" class="autocomplete-results"></div>
      </div>

      <div id="empty-cart-msg" class="dash-muted" style="text-align: center; padding: 40px; border: 2px dashed #e2e8f0; border-radius: 8px;">
        <div style="font-size: 40px; margin-bottom: 10px;">üõí</div>
        Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.<br>
        H√£y nh·∫≠p t·ª´ kh√≥a v√†o √¥ t√¨m ki·∫øm ·ªü tr√™n.
      </div>

      <div id="summary-list" style="display:none;"></div>
    </div>
  </div>
  
  <div class="builder-sidebar">
    <div class="dash-card price-summary-sticky">
      <div class="dash-title">C·∫•u h√¨nh ƒë∆°n h√†ng</div>
      
      <div class="order-settings">
        <div class="setting-row">
            <span class="setting-label">Gi·∫£m th√™m (To√†n ƒë∆°n):</span>
            <div class="global-discount-group">
                <input type="number" id="globalDiscountVal" class="global-discount-input" placeholder="0" value="0" min="0">
                <select id="globalDiscountType" class="global-discount-select">
                    <option value="amount">VNƒê</option>
                    <option value="percent">%</option>
                </select>
            </div>
        </div>
        
        <div class="setting-row">
            <span class="setting-label">Hi·ªáu l·ª±c b√°o gi√°:</span>
            <div style="display:flex; align-items:center; gap:5px;">
                <input type="number" id="quoteValidity" value="3" min="1" style="width:40px; text-align:center; border:1px solid #cbd5e1; border-radius:4px; padding:4px;">
                <span>ng√†y</span>
            </div>
        </div>

        <div style="margin: 10px 0; border-top: 1px dashed #e2e8f0;"></div>

        <div class="setting-row" style="align-items: flex-start; flex-direction: column; gap: 8px;">
            <span class="setting-label">Ch·ªçn m·∫´u in PDF:</span>
            <div class="template-selector">
                <label class="radio-option">
                    <input type="radio" name="printTemplate" value="consumer" checked>
                    <span><b>Kh√°ch l·∫ª:</b> ƒê∆°n gi√° g·ªôp VAT (G·ªçn)</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="printTemplate" value="b2b">
                    <span><b>C√¥ng ty (B2B):</b> T√°ch VAT & Gi·∫£m gi√°</span>
                </label>
            </div>
        </div>
      </div>

      <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #f1f5f9;">
        <div class="setting-row">
          <span>T·ªïng ti·ªÅn h√†ng:</span>
          <span style="font-weight: 600;" id="sub-total-price">0 VNƒê</span>
        </div>
        <div class="setting-row" style="color: #e53935;">
          <span>Gi·∫£m gi√° th√™m:</span>
          <span style="font-weight: 600;" id="discount-amount">-0 VNƒê</span>
        </div>
        <div class="setting-row" style="margin-top: 10px; align-items: flex-end;">
          <span style="font-weight: 800; font-size: 16px;">THANH TO√ÅN:</span>
          <span style="font-weight: 800; font-size: 22px; color: #2563eb;" id="final-total-price">0 VNƒê</span>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 12px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);" id="mainQuoteButton">
          XU·∫§T B√ÅO GI√Å
        </button>
      </div>
      
    </div>
  </div>
</div> 

<div id="priceHistoryModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 600px;">
    <span id="phClose" class="close">&times;</span>
    <h3>L·ªãch s·ª≠ s·ª≠a gi√° <span id="phSku" style="color:#2563eb"></span></h3>
    <table class="detail-table" id="phTable" style="width: 100%; margin-top: 15px;">
      <thead><tr><th>Th·ªùi gian</th><th>Gi√° c≈©</th><th>Gi√° m·ªõi</th><th>Ng∆∞·ªùi s·ª≠a</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="quoteModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 500px;">
    <span id="quoteClose" class="close">&times;</span>
    <h3>Th√¥ng tin b√°o gi√°</h3>
    <p style="margin-bottom: 15px; color: #64748b; font-size: 13px;">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ in l√™n file PDF.</p>
    
    <form id="quoteForm">
      <div class="form-group" style="margin-bottom: 12px;">
        <label style="font-weight: 600; font-size: 13px; color: #334155;">T√™n Kh√°ch h√†ng / C√¥ng ty:</label>
        <input type="text" id="quoteCustomerName" required style="width: 100%; padding: 8px 10px; margin-top: 4px; border: 1px solid #cbd5e1; border-radius: 6px;">
      </div>
      <div class="form-group" style="margin-bottom: 12px;">
        <label style="font-weight: 600; font-size: 13px; color: #334155;">SƒêT Kh√°ch h√†ng:</label>
        <input type="text" id="quoteCustomerPhone" required style="width: 100%; padding: 8px 10px; margin-top: 4px; border: 1px solid #cbd5e1; border-radius: 6px;">
      </div>
      <div class="form-group" style="margin-bottom: 20px;">
        <label style="font-weight: 600; font-size: 13px; color: #334155;">Th√¥ng tin li√™n h·ªá c·ªßa b·∫°n (SƒêT/Zalo):</label>
        <input type="text" id="quoteContactInfo" required style="width: 100%; padding: 8px 10px; margin-top: 4px; border: 1px solid #cbd5e1; border-radius: 6px;">
      </div>
      
      <button type="button" class="btn btn-primary" style="width: 100%; padding: 12px; font-weight: 700;" id="btnDownloadPDF">
        <i class="fas fa-file-pdf"></i> X√°c nh·∫≠n & T·∫£i PDF
      </button>
      
      <div id="downloadError" style="color: #ef4444; text-align: center; margin-top: 10px; font-size: 13px; display: none;"></div>
      <div id="quoteLoading" class="dash-muted" style="text-align: center; padding: 15px; display: none;">
        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o file PDF...
      </div>
    </form>
  </div>
</div>
<%- include('partials/toast') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // BI·∫æN TO√ÄN C·ª§C
  let currentBuildConfig = {}; 

  // L·∫§Y ELEMENTS
  const summaryList = document.getElementById('summary-list');
  const emptyCartMsg = document.getElementById('empty-cart-msg');
  const subTotalPriceEl = document.getElementById('sub-total-price');
  const discountAmountEl = document.getElementById('discount-amount');
  const finalTotalPriceEl = document.getElementById('final-total-price');
  
  // Inputs m·ªõi
  const globalDiscountVal = document.getElementById('globalDiscountVal');
  const globalDiscountType = document.getElementById('globalDiscountType');
  const quoteValidity = document.getElementById('quoteValidity');
  
  // Elements t√¨m ki·∫øm
  const searchInput = document.getElementById('quickSearchInput');
  const resultsContainer = document.getElementById('quickSearchResults');
  
  // Helpers
  const formatVND = (n) => new Intl.NumberFormat('vi-VN').format(Number(n || 0)) + ' VNƒê';
  const debounce = (fn, delay) => { let id; return (...args) => { clearTimeout(id); id = setTimeout(() => fn(...args), delay); }; };

  // ==========================================
  // 1. T√åM KI·∫æM & TH√äM SKU M·ªöI (T√çCH H·ª¢P)
  // ==========================================
  searchInput.addEventListener('input', debounce(async (e) => {
      const value = e.target.value.trim();
      if (!value) { 
          resultsContainer.style.display = 'none'; 
          return; 
      }

      try {
          // G·ªçi API t√¨m ki·∫øm
          const response = await fetch(`/api/skus?q=${encodeURIComponent(value)}`);
          const data = await response.json(); 
          
          resultsContainer.innerHTML = '';
          let exactMatch = false;

          // A. Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c
          if (data && data.length > 0) {
              data.forEach(item => {
                  if (String(item.sku).toLowerCase() === value.toLowerCase()) exactMatch = true;

                  const div = document.createElement('div');
                  div.className = 'ac-item';
                  div.innerHTML = `
                      <div class="ac-info">
                          <div class="ac-name">${item.product_name || 'Kh√¥ng t√™n'}</div>
                          <div class="ac-sku">SKU: ${item.sku}</div>
                          <div class="ac-meta">${item.brand || ''} | ${item.category || ''}</div>
                      </div>
                      <div class="ac-price">${item.list_price ? formatVND(item.list_price) : 'Li√™n h·ªá'}</div>
                  `;
                  
                  div.addEventListener('click', () => {
                      addItemToCart(item);
                      clearSearch();
                  });
                  resultsContainer.appendChild(div);
              });
          }

          // B. T√πy ch·ªçn TH√äM SKU M·ªöI (n·∫øu kh√¥ng tr√πng kh·ªõp ho√†n to√†n)
          if (!exactMatch && value.length > 0) {
              const addNewDiv = document.createElement('div');
              addNewDiv.className = 'ac-add-new';
              addNewDiv.innerHTML = `‚ûï Th√™m SKU m·ªõi: <strong>${value}</strong>`;
              
              addNewDiv.addEventListener('click', async () => {
                  await createNewSku(value);
              });
              resultsContainer.appendChild(addNewDiv);
          }

          resultsContainer.style.display = 'block';
      } catch (err) {
          console.error('L·ªói t√¨m ki·∫øm:', err);
      }
  }, 300));

  function clearSearch() {
      searchInput.value = '';
      resultsContainer.style.display = 'none';
      searchInput.focus();
  }

  // H√†m t·∫°o SKU m·ªõi
  async function createNewSku(skuCode) {
      resultsContainer.style.display = 'none';
      
      const name = prompt(`Nh·∫≠p t√™n s·∫£n ph·∫©m cho m√£ [${skuCode}]:`, skuCode);
      if (name === null) return; 

      const priceRaw = prompt('Nh·∫≠p gi√° ni√™m y·∫øt (VNƒê):', '0');
      if (priceRaw === null) return;
      const price = Number(priceRaw.replace(/\D/g, '')) || 0;

      const brand = prompt('Nh·∫≠p Th∆∞∆°ng hi·ªáu (Brand):', '') || null;
      const category = prompt('Nh·∫≠p Ng√†nh h√†ng (VD: NH01):', '') || null;
      const subcat = prompt('Nh·∫≠p Nh√≥m h√†ng (VD: M√°y in):', '') || null;

      try {
          const res = await fetch('/api/skus/upsert', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  sku: skuCode,
                  product_name: name,
                  list_price: price,
                  brand: brand,
                  category: category,
                  subcat: subcat
              })
          });

          const js = await res.json();
          
          if (js.ok) {
              // D·ªØ li·ªáu item m·ªõi
              const newItem = js.sku || {
                  sku: skuCode,
                  product_name: name,
                  list_price: price,
                  brand: brand,
                  category: category,
                  subcat: subcat
              };
              
              // Th√™m ngay v√†o gi·ªè
              addItemToCart(newItem);
              clearSearch();
              if(typeof showToast === 'function') showToast('ƒê√£ t·∫°o & th√™m s·∫£n ph·∫©m m·ªõi!', 'success');
          } else {
              alert('L·ªói t·∫°o s·∫£n ph·∫©m: ' + js.error);
          }
      } catch (e) {
          console.error(e);
          alert('L·ªói k·∫øt n·ªëi server!');
      }
  }

  // H√†m th√™m v√†o gi·ªè (Local)
  function addItemToCart(item) {
      const sku = item.sku;
      // N·∫øu ƒë√£ c√≥ -> TƒÉng s·ªë l∆∞·ª£ng
      if (currentBuildConfig[sku]) {
          currentBuildConfig[sku].quantity = (currentBuildConfig[sku].quantity || 1) + 1;
      } else {
          // N·∫øu ch∆∞a c√≥ -> Th√™m m·ªõi
          currentBuildConfig[sku] = { ...item, quantity: 1, item_discount: 0 };
      }
      updateSummaryAndTotal();
  }

  // ƒê√≥ng dropdown khi click ra ngo√†i
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.quick-search-wrapper')) resultsContainer.style.display = 'none';
  });


  // ==========================================
  // 2. LOGIC RENDER & T√çNH TO√ÅN GI√Å
  // ==========================================
  function updateSummaryAndTotal() {
    let sumItemTotal = 0; 
    let html = '';
    
    const skus = Object.keys(currentBuildConfig).sort();
    
    if (skus.length === 0) {
        summaryList.style.display = 'none';
        emptyCartMsg.style.display = 'block';
        subTotalPriceEl.textContent = '0 VNƒê';
        discountAmountEl.textContent = '0 VNƒê';
        finalTotalPriceEl.textContent = '0 VNƒê';
        return;
    }

    summaryList.style.display = 'block';
    emptyCartMsg.style.display = 'none';

    for (const sku of skus) {
      const item = currentBuildConfig[sku];
      const qty = item.quantity || 1;
      
      const originalPrice = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
      const itemDiscount = item.item_discount || 0;
      const lineTotal = (originalPrice - itemDiscount) * qty;
      sumItemTotal += lineTotal;

      let priceHtml = '';
      if (item.isEditingPrice) {
          priceHtml = `
            <div style="display:flex; gap:2px; align-items:center;">
                <input type="number" class="price-edit-input" value="${originalPrice}" id="price-input-${sku}">
                <button class="btn-icon" data-sku="${sku}" data-action="save-price" title="L∆∞u">‚úÖ</button>
                <button class="btn-icon" data-sku="${sku}" data-action="cancel-price" title="H·ªßy">‚ùå</button>
            </div>`;
      } else {
          let priceDisplay = formatVND(originalPrice);
          if (item.edited_price !== undefined && item.edited_price !== item.list_price) {
              priceDisplay = `<strong style="color:#10b981">${formatVND(item.edited_price)}</strong>`;
          }
          priceHtml = `
            <div style="display:flex; align-items:center; gap:2px;">
                <span>${priceDisplay}</span>
                <button class="btn-icon btn-edit-price" data-sku="${sku}" title="S·ª≠a gi√° g·ªëc">‚úèÔ∏è</button>
                <button class="btn-icon btn-history-price" data-sku="${sku}" title="L·ªãch s·ª≠">üïò</button>
            </div>`;
      }

      html += `
      <div class="summary-item">
        <div class="summary-item-top">
            <div style="flex:1; margin-right:10px;">
                <div class="summary-item-name">${item.product_name}</div>
                <div class="summary-item-sku">SKU: ${item.sku}</div>
            </div>
            <button class="btn-icon" onclick="removeItem('${sku}')" title="X√≥a" style="color:#ef4444; background:#fee2e2; border-radius:4px; padding:2px 6px;">‚úñÔ∏è</button>
        </div>
        
        <div class="summary-item-controls">
            <div class="quantity-controls">
                <button class="qty-btn" onclick="changeQty('${sku}', -1)">-</button>
                <span class="qty-display">${qty}</span>
                <button class="qty-btn" onclick="changeQty('${sku}', 1)">+</button>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                ${priceHtml}
                <div class="item-discount-wrapper">
                    <span class="item-discount-label">Gi·∫£m:</span>
                    <input type="number" class="item-discount-input" 
                           value="${itemDiscount}" min="0" placeholder="0"
                           onchange="changeItemDiscount('${sku}', this.value)">
                </div>
                <div class="final-line-price">${formatVND(lineTotal)}</div>
            </div>
        </div>
      </div>`;
    }
    
    summaryList.innerHTML = html;

    const gVal = Number(globalDiscountVal.value) || 0;
    const gType = globalDiscountType.value;
    let globalDiscountAmt = 0;

    if (gType === 'percent') {
        globalDiscountAmt = Math.round(sumItemTotal * (gVal / 100));
    } else {
        globalDiscountAmt = gVal;
    }
    
    if (globalDiscountAmt > sumItemTotal) globalDiscountAmt = sumItemTotal;
    const finalTotal = sumItemTotal - globalDiscountAmt;

    subTotalPriceEl.textContent = formatVND(sumItemTotal);
    discountAmountEl.textContent = globalDiscountAmt > 0 ? `-${formatVND(globalDiscountAmt)}` : '0 VNƒê';
    finalTotalPriceEl.textContent = formatVND(finalTotal);
  }

  // ==========================================
  // 3. C√ÅC H√ÄM TI·ªÜN √çCH (Window Scope)
  // ==========================================
  window.changeQty = (sku, delta) => {
    if (currentBuildConfig[sku]) {
        currentBuildConfig[sku].quantity = Math.max(1, (currentBuildConfig[sku].quantity || 1) + delta);
        updateSummaryAndTotal();
    }
  };
  window.removeItem = (sku) => {
    if (confirm('X√≥a s·∫£n ph·∫©m n√†y kh·ªèi b√°o gi√°?')) {
        delete currentBuildConfig[sku];
        updateSummaryAndTotal();
    }
  };
  window.changeItemDiscount = (sku, val) => {
    if (currentBuildConfig[sku]) {
        currentBuildConfig[sku].item_discount = Math.max(0, Number(val));
        updateSummaryAndTotal();
    }
  };

  globalDiscountVal.addEventListener('input', updateSummaryAndTotal);
  globalDiscountType.addEventListener('change', updateSummaryAndTotal);

  // X·ª≠ l√Ω n√∫t S·ª≠a/L·ªãch s·ª≠ gi√°
  summaryList.addEventListener('click', async (e) => {
    const btn = e.target.closest('button'); 
    if (!btn) return;
    const sku = btn.dataset.sku;
    const action = btn.dataset.action;

    if (btn.classList.contains('btn-edit-price')) { 
        currentBuildConfig[sku].isEditingPrice = true; 
        updateSummaryAndTotal(); 
    }
    
    if (btn.classList.contains('btn-history-price')) {
        showPriceHistoryModal(sku); 
    }
    
    if (action === 'save-price') { 
        const input = document.getElementById(`price-input-${sku}`);
        const newP = Number(input.value);
        if (newP < 0) return alert('Gi√° kh√¥ng h·ª£p l·ªá');
        
        try {
            const res = await fetch(`/api/sku/${sku}/price`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ new_price: newP })
            });
            const d = await res.json();
            if(!d.ok) throw new Error(d.error);
            
            currentBuildConfig[sku].edited_price = newP; 
            currentBuildConfig[sku].isEditingPrice = false; 
            if(typeof showToast === 'function') showToast('ƒê√£ c·∫≠p nh·∫≠t gi√° g·ªëc!', 'success');
        } catch(err) { alert(err.message); }
        updateSummaryAndTotal();
    }
    
    if (action === 'cancel-price') { 
        currentBuildConfig[sku].isEditingPrice = false; 
        updateSummaryAndTotal(); 
    }
  });

  // Modal L·ªãch s·ª≠ gi√°
  const priceHistoryModal = document.getElementById('priceHistoryModal');
  const phTbody = document.querySelector('#phTable tbody');
  const phSku = document.getElementById('phSku');
  
  async function showPriceHistoryModal(sku) {
      phSku.textContent = sku;
      phTbody.innerHTML = '<tr><td colspan="4" style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
      priceHistoryModal.style.display = 'flex';
      try {
          const res = await fetch(`/api/sku/${sku}/price-history`);
          const d = await res.json();
          if(!d.ok) throw new Error(d.error);
          phTbody.innerHTML = d.history.map(r => `
            <tr>
                <td>${new Date(r.changed_at).toLocaleString('vi-VN')}</td>
                <td align="right" style="color:#64748b">${formatVND(r.old_price)}</td>
                <td align="right" style="font-weight:bold">${formatVND(r.new_price)}</td>
                <td>${r.user||'-'}</td>
            </tr>`).join('') || '<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ l·ªãch s·ª≠ thay ƒë·ªïi gi√°</td></tr>';
      } catch(e) { phTbody.innerHTML = `<tr><td colspan="4" class="error-message">${e.message}</td></tr>`; }
  }
  document.getElementById('phClose').onclick = () => priceHistoryModal.style.display = 'none';

  // ==========================================
  // 4. X·ª¨ L√ù T·∫†O B√ÅO GI√Å & T·∫¢I PDF
  // ==========================================
  const quoteModal = document.getElementById('quoteModal');
  const quoteClose = document.getElementById('quoteClose');
  const btnDownload = document.getElementById('btnDownloadPDF');
  const quoteLoading = document.getElementById('quoteLoading');
  const downloadError = document.getElementById('downloadError');

  document.getElementById('mainQuoteButton').onclick = () => {
      if(Object.keys(currentBuildConfig).length === 0) return alert('Vui l√≤ng th√™m √≠t nh·∫•t 1 s·∫£n ph·∫©m.');
      quoteModal.style.display = 'flex';
      btnDownload.style.display = 'block'; 
      btnDownload.disabled = false;
      quoteLoading.style.display = 'none';
      downloadError.style.display = 'none';
  };
  
  if(quoteClose) quoteClose.onclick = () => quoteModal.style.display = 'none';
  window.onclick = (e) => { 
      if(e.target == priceHistoryModal) priceHistoryModal.style.display = 'none'; 
      if(e.target == quoteModal) quoteModal.style.display = 'none'; 
  };

  btnDownload.onclick = async () => {
      const name = document.getElementById('quoteCustomerName').value.trim();
      const phone = document.getElementById('quoteCustomerPhone').value.trim();
      const contact = document.getElementById('quoteContactInfo').value.trim();
      
      if(!name || !phone || !contact) {
          alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng v√† li√™n h·ªá.');
          return;
      }

      btnDownload.style.display = 'none'; 
      quoteLoading.style.display = 'block';
      downloadError.style.display = 'none';
      
      const payload = {
          buildConfig: currentBuildConfig,
          customerName: name, 
          customerPhone: phone, 
          contactInfo: contact,
          isGeneralQuote: true, 
          
          globalDiscount: { 
              value: Number(globalDiscountVal.value)||0, 
              type: globalDiscountType.value 
          },
          validityDays: Number(document.getElementById('quoteValidity').value)||3,
          templateType: document.querySelector('input[name="printTemplate"]:checked').value
      };

      try {
          const res = await fetch('/api/pc-builder/generate-quote', {
              method: 'POST', 
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
          });
          
          if(!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'L·ªói k·∫øt n·ªëi server');
          }
          
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none'; 
          a.href = url; 
          
          const safeName = name.replace(/[^a-zA-Z0-9\u00C0-\u1EF9]/g,'_');
          a.download = `BaoGia_${safeName}.pdf`;
          
          document.body.appendChild(a); 
          a.click();
          
          setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
          
          quoteModal.style.display = 'none';
          if(typeof showToast === 'function') showToast('ƒê√£ t·∫£i b√°o gi√° th√†nh c√¥ng!', 'success');

      } catch(e) {
          console.error(e);
          downloadError.innerText = 'L·ªói: ' + e.message;
          downloadError.style.display = 'block';
      } finally {
          btnDownload.style.display = 'block'; 
          quoteLoading.style.display = 'none';
      }
  };

  // Kh·ªüi t·∫°o
  updateSummaryAndTotal();
});
</script>

<%- include('partials/footer') %>
<%- include('partials/header', { title: 'T·∫°o B√°o gi√° Nhanh', currentPage: 'quote-builder' }) %>

<style>
  /* === B·∫ÆT ƒê·∫¶U CSS (Copy t·ª´ pc-builder.ejs) === */
  /* CSS ri√™ng cho trang n√†y */
  .pc-builder-layout {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* === CSS CHO C·ªòT T√ìM T·∫ÆT (B√äN PH·∫¢I) === */
  .price-summary-sticky {
    position: sticky;
    top: 80px;
  }
  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    margin-bottom: 10px;
  }
  .summary-item-info {
    flex-grow: 1; /* Cho ph√©p kh·ªëi t√™n co gi√£n */
    margin-right: 10px;
  }
  .summary-item-name {
    display: block; /* T√™n SP ·ªü 1 h√†ng */
  }
  .summary-item-price {
    font-weight: 600;
    text-align: right;
    min-width: 100px;
    flex-shrink: 0; /* Kh√¥ng co l·∫°i */
  }
  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 4px;
  }
  .qty-btn {
    width: 24px;
    height: 24px;
    border: 1px solid #cbd5e1;
    background-color: #f8fafc;
    color: #475569;
    border-radius: 999px; /* Tr√≤n */
    cursor: pointer;
    font-weight: 600;
    line-height: 1; /* CƒÉn s·ªë */
  }
  .qty-btn:hover {
    background-color: #e2e8f0;
  }
  .qty-display {
    font-weight: 600;
    padding: 0 5px;
    min-width: 20px;
    text-align: center;
  }

  /* === CSS CHO MODAL CH·ªåN LINH KI·ªÜN === */
  .component-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 10px;
    border-bottom: 1px solid #f1f5f9;
  }
  .component-item:hover {
    background-color: #f8fafc;
  }
  .component-item-main-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    gap: 10px;
  }
  .component-item-info { 
    font-size: 14px; 
    flex-grow: 1;
  }
  .component-item-info strong { color: #111827; }
  .component-item-info span { color: #64748b; font-size: 12px; }
  .component-item-action {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  .component-item-price { 
    font-weight: 700; 
    color: #e53935;
    text-align: right;
    min-width: 80px;
  }
  .btn-select-item {
    padding: 6px 12px;
    font-size: 12px;
    background-color: #10b981;
    color: white; border: none; border-radius: 6px;
    cursor: pointer;
  }
  /* N√∫t ƒë√£ ch·ªçn */
  .btn-select-item.selected {
    background-color: #64748b;
  }

  /* === B·ªê C·ª§C 2 C·ªòT DESKTOP === */
  @media (min-width: 992px) {
    .pc-builder-layout {
      flex-direction: row;
      align-items: flex-start;
    }
    .builder-main {
      flex: 2;
    }
    .builder-sidebar {
      flex: 1;
    }
  }

  /* === CSS CHO S·ª¨A GI√Å (Copy y h·ªát) === */
  .summary-item-price {
    display: flex;
    align-items: center;
    justify-content: flex-end; /* CƒÉn ph·∫£i */
  }
  
  .price-edit-controls {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .price-edit-controls input {
    width: 100px;
    padding: 5px 8px;
    border: 1px solid #2563eb;
    border-radius: 6px;
  }

  .btn-price-action {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    margin-left: 4px;
    opacity: 0.6;
  }
  .btn-price-action:hover {
    opacity: 1;
  }
  /* === K·∫æT TH√öC CSS === */
</style>

<div class="pc-builder-layout">
  
  <div class="builder-main">
    <div class="dash-card">
      <div class="dash-title">T·∫°o b√°o gi√° nhanh</div>
      
      <p style="margin: 15px 0; color: #475569;">
        Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng, sau ƒë√≥ nh·∫•n "L∆∞u c·∫•u h√¨nh & B√°o gi√°" ·ªü c·ªôt b√™n ph·∫£i ƒë·ªÉ xu·∫•t file PDF ho·∫∑c g·ª≠i email.
      </p>
      
      <button class="btn btn-primary" id="btnOpenSearchModal" style="padding: 12px 20px; font-size: 16px;">
        + Th√™m s·∫£n ph·∫©m...
      </button>

    </div>
  </div>
  
  <div class="builder-sidebar">
    <div class="dash-card price-summary-sticky">
      <div class="dash-title">T·ªïng chi ph√≠ (t·∫°m t√≠nh)</div>
      
      <div id="summary-list">
        <div class="dash-muted" style="text-align: center; padding: 20px 0;">
          Vui l√≤ng th√™m s·∫£n ph·∫©m
        </div>
      </div>

      <div style="border-top: 2px solid #f1f5f9; margin-top: 15px; padding-top: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 800; font-size: 18px;">T·ªïng c·ªông:</span>
          <span style="font-weight: 800; font-size: 22px; color: #e53935;" id="total-price">
            0 VNƒê
          </span>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 12px;" id="mainQuoteButton">
          L∆∞u c·∫•u h√¨nh & B√°o gi√°
        </button>
      </div>
      
    </div>
  </div>
  
</div> <div class="modal" id="componentModal" style="display: none;">
  <div class="modal-content" style="max-width: 800px;">
    <span class="close" id="componentModalClose">&times;</span>
    <h3 id="componentModalTitle" style="margin-top: 0;">Ch·ªçn s·∫£n ph·∫©m</h3>
    
    <input type="text" id="componentSearch" class="search-input" 
           placeholder="T√¨m theo t√™n ho·∫∑c SKU..." 
           style="width: 100%; margin-bottom: 15px;">
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <select id="filterCategory" class="info-select" style="flex: 1;">
        <option value="">-- L·ªçc theo Ng√†nh (NH) --</option>
        </select>
      <select id="filterSubcat" class="info-select" style="flex: 1;">
        <option value="">-- L·ªçc theo Nh√≥m SP --</option>
        </select>
    </div>
    <div id="componentModalList" style="max-height: 50vh; overflow-y: auto;">
      </div>
  </div>
  </div>
</div>

<div id="priceHistoryModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 600px;">
    <span id="phClose" class="close">&times;</span>
    <h3>L·ªãch s·ª≠ s·ª≠a gi√° (SKU: <span id="phSku"></span>)</h3>
    <table class="detail-table" id="phTable" style="width: 100%; margin-top: 15px;">
      <thead>
        <tr><th>Th·ªùi gian</th><th>Gi√° c≈©</th><th>Gi√° m·ªõi</th><th>Ng∆∞·ªùi s·ª≠a</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="quoteModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 500px;">
    <span id="quoteClose" class="close">&times;</span>
    <h3>Th√¥ng tin b√°o gi√°</h3>
     
    <form id="quoteForm">
      <div class="form-group" style="margin-bottom: 15px;">
        <label>T√™n Kh√°ch h√†ng / C√¥ng ty:</label>
        <input type="text" id="quoteCustomerName" class="info-input" placeholder="K√≠nh g·ª≠i..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label>SƒêT Kh√°ch h√†ng:</label>
        <input type="text" id="quoteCustomerPhone" class="info-input" placeholder="SƒêT c·ªßa kh√°ch h√†ng" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Th√¥ng tin li√™n h·ªá c·ªßa b·∫°n (SƒêT/Zalo):</label>
        <input type="text" id="quoteContactInfo" class="info-input" placeholder="090..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="quoteSendEmail" style="width: 18px; height: 18px;">
          G·ª≠i email b√°o gi√°
        </label>
      </div>
      <div class="form-group" id="quoteEmailGroup" style="display: none; margin-bottom: 20px;">
        <label>Email nh·∫≠n b√°o gi√°:</label>
        <input type="email" id="quoteCustomerEmail" class="info-input" placeholder="example@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" id="quoteCCGroup" style="display: none; margin-bottom: 20px;">
        <label>CC (Email ph·ª•, t√πy ch·ªçn):</label>
        <input type="email" id="quoteCCEmail" class="info-input" placeholder="cc@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      
      <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;" id="quoteSubmitButton">
        X√°c nh·∫≠n & T·∫°o b√°o gi√°
      </button>
      <div id="quoteLoading" class="dash-muted" style="text-align: center; padding: 20px; display: none;">
        ƒêang t·∫°o PDF, vui l√≤ng ch·ªù...
      </div>
    </form>
    
  </div>
</div>
<%- include('partials/toast') %>


<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // ----- BI·∫æN TO√ÄN C·ª§C -----
  let currentBuildConfig = {}; // Gi·ªè h√†ng (Key l√† SKU)
  let productCache = []; // L∆∞u k·∫øt qu·∫£ t√¨m ki·∫øm

  // ----- L·∫§Y C√ÅC ELEMENT CH√çNH -----
  const summaryList = document.getElementById('summary-list');
  const totalPriceEl = document.getElementById('total-price');
  const btnOpenSearchModal = document.getElementById('btnOpenSearchModal');
  
  // Elements Modal t√¨m ki·∫øm
  const modal = document.getElementById('componentModal');
  const modalClose = document.getElementById('componentModalClose');
  const modalTitle = document.getElementById('componentModalTitle');
  const modalList = document.getElementById('componentModalList');
  const componentSearch = document.getElementById('componentSearch');
  
  // B·ªò L·ªåC M·ªöI
  const filterCategory = document.getElementById('filterCategory');
  const filterSubcat = document.getElementById('filterSubcat');
  
  // ... (C√°c element modal L·ªãch s·ª≠ v√† B√°o gi√° gi·ªØ nguy√™n) ...
  const priceHistoryModal = document.getElementById('priceHistoryModal');
  const phClose = document.getElementById('phClose');
  const phTbody = document.querySelector('#phTable tbody');
  const phSku = document.getElementById('phSku');
  const quoteModal = document.getElementById('quoteModal');
  const quoteClose = document.getElementById('quoteClose');
  const quoteForm = document.getElementById('quoteForm');
  const quoteSendEmail = document.getElementById('quoteSendEmail');
  const quoteEmailGroup = document.getElementById('quoteEmailGroup');
  const quoteCCGroup = document.getElementById('quoteCCGroup');
  const quoteCustomerEmail = document.getElementById('quoteCustomerEmail');
  const quoteSubmitButton = document.getElementById('quoteSubmitButton');
  const quoteLoading = document.getElementById('quoteLoading');
  const mainQuoteButton = document.getElementById('mainQuoteButton');

  // ----- H√ÄM H·ªñ TR·ª¢ -----
  function formatVND(n) {
    return new Intl.NumberFormat('vi-VN').format(Number(n || 0)) + ' VNƒê';
  }
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // H√ÄM C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN & GI·ªé H√ÄNG (Gi·ªØ nguy√™n)
  function updateSummaryAndTotal() {
    let totalPrice = 0;
    let summaryHtml = '';
    const sortedSkus = Object.keys(currentBuildConfig).sort();
    for (const sku of sortedSkus) {
      const item = currentBuildConfig[sku];
      if (!item) continue;
      if (!item.quantity || item.quantity < 1) item.quantity = 1;
      const currentPrice = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
      totalPrice += currentPrice * item.quantity;
      let priceHtml = '';
      if (item.isEditingPrice) {
        priceHtml = `
          <div class="price-edit-controls">
            <input type="number" value="${currentPrice}" id="price-input-${sku}" style="width: 100px;">
            <button class="btn-price-action" data-sku="${sku}" data-action="save-price">‚úîÔ∏è</button>
            <button class="btn-price-action" data-sku="${sku}" data-action="cancel-price">‚úñÔ∏è</button>
          </div>`;
      } else {
        let priceDisplay = formatVND(currentPrice);
        if (item.edited_price !== undefined && item.edited_price !== item.list_price) {
           priceDisplay = `<strong style="color: #10b981;">${formatVND(item.edited_price)}</strong>`;
        }
        priceHtml = `
          <span>${priceDisplay}</span>
          <button class="btn-price-action btn-edit-price" data-sku="${sku}" title="S·ª≠a gi√°">‚úèÔ∏è</button>
          <button class="btn-price-action btn-history-price" data-sku="${sku}" title="L·ªãch s·ª≠ gi√°">üïò</button>`;
      }
      summaryHtml += `
        <div class="summary-item">
          <div class="summary-item-info">
            <span class="summary-item-name">${item.product_name}</span>
            <span style="font-size: 12px; color: #64748b; margin-top: 2px; display: block;">SKU: ${item.sku}</span>
            <div class="quantity-controls">
              <button class="qty-btn" data-sku="${sku}" data-action="decrease" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
              <span class="qty-display">${item.quantity}</span>
              <button class="qty-btn" data-sku="${sku}" data-action="increase">+</button>
            </div>
          </div>
          <div class="summary-item-price" id="price-display-${sku}">${priceHtml}</div>
          <button class="btn-price-action" data-sku="${sku}" data-action="remove-item" title="X√≥a" style="margin-left: 5px;">‚úñÔ∏è</button>
        </div>`;
    }
    summaryList.innerHTML = summaryHtml || `<div class="dash-muted" style="text-align: center; padding: 20px 0;">Vui l√≤ng th√™m s·∫£n ph·∫©m</div>`;
    totalPriceEl.textContent = formatVND(totalPrice);
  }

  // H√ÄM TƒÇNG/GI·∫¢M/X√ìA (Gi·ªØ nguy√™n)
  function changeQuantity(sku, action) {
    const item = currentBuildConfig[sku];
    if (!item) return;
    if (action === 'increase') item.quantity += 1;
    else if (action === 'decrease' && item.quantity > 1) item.quantity -= 1;
    else if (action === 'remove-item' && confirm(`X√≥a "${item.product_name}"?`)) {
      delete currentBuildConfig[sku];
    }
    updateSummaryAndTotal();
  }

  // H√ÄM V·∫º DANH S√ÅCH SP (Gi·ªØ nguy√™n)
  function renderComponentList(products) {
    if (products.length === 0) {
      modalList.innerHTML = '<div class="dash-muted" style="text-align: center; padding: 20px;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</div>';
      return;
    }
    modalList.innerHTML = products.map(item => {
      const isInCart = !!currentBuildConfig[item.sku];
      return `
      <div class="component-item">
        <div class="component-item-main-row">
          <div class="component-item-info">
            <strong>${item.product_name}</strong><br>
            <span>SKU: ${item.sku} | Brand: ${item.brand || 'N/A'}</span>
          </div>
          <div class="component-item-action">
            <span class="component-item-price">${formatVND(item.list_price)}</span>
            <button class="btn-select-item ${isInCart ? 'selected' : ''}" data-sku="${item.sku}" ${isInCart ? 'disabled' : ''}>
              ${isInCart ? 'ƒê√£ th√™m' : 'Ch·ªçn'}
            </button>
          </div>
        </div>
      </div>`;
    }).join('');
  }
  
  // H√ÄM L·ªäCH S·ª¨ GI√Å (Gi·ªØ nguy√™n)
  async function showPriceHistoryModal(sku) {
    phSku.textContent = sku;
    phTbody.innerHTML = '<tr><td colspan="4">ƒêang t·∫£i...</td></tr>';
    priceHistoryModal.style.display = 'flex';
    try {
      const res = await fetch(`/api/sku/${sku}/price-history`);
      const js = await res.json();
      if (!js.ok) throw new Error(js.error || 'Load failed');
      const rows = (js.history || []).map(r => `
        <tr>
          <td>${new Date(r.changed_at).toLocaleString('vi-VN')}</td>
          <td style="text-align: right;">${formatVND(r.old_price)}</td>
          <td style="text-align: right;">${formatVND(r.new_price)}</td>
          <td>${r.user || '-'}</td>
        </tr>`).join('');
      phTbody.innerHTML = rows || '<tr><td colspan="4">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>';
    } catch (e) {
      phTbody.innerHTML = `<tr><td colspan="4" class="error-message">L·ªói: ${e.message}</td></tr>`;
    }
  }

  // H√ÄM T·∫¢I B·ªò L·ªåC (M·ªöI)
  let filtersLoaded = false;
  async function loadFilterOptions() {
    if (filtersLoaded) return; // Ch·ªâ t·∫£i 1 l·∫ßn
    try {
      const res = await fetch('/api/quote/filter-options');
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);

      filterCategory.innerHTML = '<option value="">-- L·ªçc theo Ng√†nh (NH) --</option>';
      data.categories.forEach(cat => {
        filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
      });

      filterSubcat.innerHTML = '<option value="">-- L·ªçc theo Nh√≥m SP --</option>';
      data.subcats.forEach(sub => {
        filterSubcat.innerHTML += `<option value="${sub}">${sub}</option>`;
      });
      filtersLoaded = true;
    } catch (err) {
      console.error("L·ªói t·∫£i b·ªô l·ªçc:", err.message);
    }
  }

  // H√ÄM T√åM KI·∫æM S·∫¢N PH·∫®M (S·ª¨A L·∫†I)
  async function searchProducts() {
    const query = componentSearch.value.trim();
    const category = filterCategory.value;
    const subcat = filterSubcat.value;
    
    // N·∫øu kh√¥ng g√µ g√¨ v√† kh√¥ng l·ªçc g√¨ -> API s·∫Ω t·ª± tr·∫£ v·ªÅ SP m·∫∑c ƒë·ªãnh
    modalList.innerHTML = '<div class="dash-muted" style="text-align: center; padding: 20px;">ƒêang t·∫£i...</div>';
    
    try {
      const params = new URLSearchParams({ q: query, category, subcat });
      const res = await fetch(`/api/quote/search-products?${params.toString()}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);
      
      productCache = data.products;
      renderComponentList(productCache);
      
    } catch (err) {
      modalList.innerHTML = `<div class="error-message">L·ªói: ${err.message}</div>`;
    }
  }
  const debouncedSearchProducts = debounce(searchProducts, 300);

  // ----- G·∫ÆN C√ÅC B·ªò L·∫ÆNG NGHE S·ª∞ KI·ªÜN -----

  // 1. M·ªû MODAL T√åM KI·∫æM (S·ª¨A L·∫†I)
  btnOpenSearchModal.addEventListener('click', () => {
    modal.style.display = 'flex';
    componentSearch.focus();
    loadFilterOptions(); // T·∫£i b·ªô l·ªçc (n·∫øu ch∆∞a c√≥)
    
    // S·ª¨A L·ªñI: T·∫£i danh s√°ch SP m·∫∑c ƒë·ªãnh (khi ch∆∞a t√¨m g√¨)
    if (componentSearch.value === '' && filterCategory.value === '' && filterSubcat.value === '') {
      searchProducts();
    } else {
      renderComponentList(productCache); // Hi·ªÉn th·ªã l·∫°i k·∫øt qu·∫£ c≈© (n·∫øu c√≥)
    }
  });

  // 2. G√ï T√åM KI·∫æM (S·ª¨A L·∫†I)
  componentSearch.addEventListener('input', debouncedSearchProducts);
  
  // 3. THAY ƒê·ªîI B·ªò L·ªåC (M·ªöI)
  filterCategory.addEventListener('change', searchProducts);
  filterSubcat.addEventListener('change', searchProducts);
  
  // 4. CH·ªåN 1 M√ìN TRONG MODAL (Gi·ªØ nguy√™n)
  modalList.addEventListener('click', (e) => {
    const selectButton = e.target.closest('.btn-select-item');
    if (selectButton && !selectButton.disabled) {
      const sku = selectButton.dataset.sku;
      const selectedItem = productCache.find(c => c.sku === sku);
      if (selectedItem) {
        currentBuildConfig[sku] = { ...selectedItem, quantity: 1 };
        updateSummaryAndTotal();
        selectButton.textContent = 'ƒê√£ th√™m';
        selectButton.disabled = true;
        selectButton.classList.add('selected');
        if (typeof showToast === 'function') {
          showToast(`ƒê√£ th√™m: ${selectedItem.product_name}`, 'success');
        }
      }
    }
  });

  // 5. S·ª∞ KI·ªÜN TRONG GI·ªé H√ÄNG (Gi·ªØ nguy√™n)
  summaryList.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const sku = btn.dataset.sku;
    const action = btn.dataset.action;
    if (action === 'increase' || action === 'decrease' || action === 'remove-item') {
      changeQuantity(sku, action);
    }
    if (btn.classList.contains('btn-edit-price')) { /* ... logic s·ª≠a gi√° ... */
      const item = currentBuildConfig[sku];
      if (item) { item.isEditingPrice = true; updateSummaryAndTotal(); document.getElementById(`price-input-${sku}`).focus(); }
    }
    if (btn.classList.contains('btn-history-price')) { /* ... logic l·ªãch s·ª≠ ... */
      showPriceHistoryModal(sku);
    }
    if (action === 'save-price') { /* ... logic l∆∞u gi√° ... */
      const item = currentBuildConfig[sku];
      const inputEl = document.getElementById(`price-input-${sku}`);
      const newPrice = Number(inputEl.value);
      if (!item || newPrice < 0) { alert('Gi√° kh√¥ng h·ª£p l·ªá'); return; }
      btn.disabled = true;
      try {
        const res = await fetch(`/api/sku/${sku}/price`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ new_price: newPrice })
        });
        const js = await res.json();
        if (!js.ok) throw new Error(js.error || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
        item.edited_price = newPrice;
        item.isEditingPrice = false;
        showToast('ƒê√£ l∆∞u gi√° m·ªõi!', 'success');
      } catch (err) {
        alert('L·ªói: ' + err.message);
        btn.disabled = false;
      }
      updateSummaryAndTotal();
    }
    if (action === 'cancel-price') { /* ... logic h·ªßy s·ª≠a gi√° ... */
      const item = currentBuildConfig[sku];
      if (item) { item.isEditingPrice = false; updateSummaryAndTotal(); }
    }
  });

  // 6. ƒê√ìNG MODAL (Gi·ªØ nguy√™n)
  modalClose.onclick = () => { modal.style.display = 'none'; };
  if (phClose) phClose.onclick = () => { priceHistoryModal.style.display = 'none'; };
  if (quoteClose) quoteClose.onclick = () => { quoteModal.style.display = 'none'; };
  window.onclick = (e) => {
    if (e.target == modal) modal.style.display = 'none';
    if (priceHistoryModal && e.target == priceHistoryModal) priceHistoryModal.style.display = 'none';
    if (quoteModal && e.target == quoteModal) quoteModal.style.display = 'none';
  };

  // 7. S·ª∞ KI·ªÜN N√öT B√ÅO GI√Å (Gi·ªØ nguy√™n)
  mainQuoteButton.addEventListener('click', (e) => {
    e.preventDefault();
    if (Object.keys(currentBuildConfig).length === 0) {
      showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m', 'warn'); return;
    }
    quoteModal.style.display = 'flex';
    quoteLoading.style.display = 'none';
    quoteSubmitButton.style.display = 'block';
    quoteSubmitButton.disabled = false;
  });

  // 8. CHECKBOX G·ª¨I EMAIL (Gi·ªØ nguy√™n)
  quoteSendEmail.addEventListener('change', (e) => {
    quoteEmailGroup.style.display = e.target.checked ? 'block' : 'none';
    quoteCCGroup.style.display = e.target.checked ? 'block' : 'none';
    quoteCustomerEmail.required = e.target.checked;
  });
  
  // 9. SUBMIT FORM B√ÅO GI√Å (Gi·ªØ nguy√™n)
  quoteForm.addEventListener('submit', async (e) => {
    e.preventDefault(); 
    quoteLoading.style.display = 'block';
    quoteSubmitButton.style.display = 'none';
    quoteSubmitButton.disabled = true;
    const customerName = document.getElementById('quoteCustomerName').value.trim();
    const sendEmail = quoteSendEmail.checked;
    const customerEmail = document.getElementById('quoteCustomerEmail').value.trim();
    const contactInfo = document.getElementById('quoteContactInfo').value.trim();
    const customerCC = document.getElementById('quoteCCEmail').value.trim();
    const customerPhone = document.getElementById('quoteCustomerPhone').value.trim();
    if (!customerName || !contactInfo || !customerPhone) {
      alert('Vui l√≤ng nh·∫≠p ƒë·ªß T√™n, SƒêT Kh√°ch h√†ng, v√† SƒêT li√™n h·ªá c·ªßa b·∫°n.');
      quoteLoading.style.display = 'none'; quoteSubmitButton.style.display = 'block'; quoteSubmitButton.disabled = false;
      return;
    }
    try {
      const res = await fetch('/api/pc-builder/generate-quote', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          buildConfig: currentBuildConfig, customerName, sendEmail,
          customerEmail, contactInfo, customerCC, customerPhone, isGeneralQuote: true
        })
      });
      if (!res.ok) { const errData = await res.json(); throw new Error(errData.error || `L·ªói server`); }
      if (sendEmail) {
        const data = await res.json();
        showToast(data.message || 'G·ª≠i email th√†nh c√¥ng!', 'success');
        quoteModal.style.display = 'none';
      } else {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
a.style.display = 'none'; a.href = url;
        a.download = `BaoGia_${customerName.replace(/ /g, '_')}.pdf`;
        document.body.appendChild(a); a.click();
        window.URL.revokeObjectURL(url); document.body.removeChild(a);
        showToast('ƒêang t·∫£i file PDF...', 'success');
        quoteModal.style.display = 'none';
      }
    } catch (err) {
      alert('L·ªói t·∫°o b√°o gi√°: ' + err.message);
    } finally {
      quoteLoading.style.display = 'none';
      quoteSubmitButton.style.display = 'block';
      quoteSubmitButton.disabled = false;
    }
  });

  // 10. KH·ªûI T·∫†O
  updateSummaryAndTotal();
});
</script>

<%- include('partials/footer') %>

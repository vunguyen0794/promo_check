<%- include('partials/header', { title: 'T·∫°o B√°o gi√° Nhanh', currentPage: 'quote-builder' }) %>

<style>
  /* === CSS G·ªêC (GI·ªÆ NGUY√äN ƒê·ªÇ ƒê·∫¢M B·∫¢O ƒê·∫∏P) === */
  .pc-builder-layout { display: flex; flex-direction: column; gap: 20px; }
  
  /* C·ªôt b√™n ph·∫£i (Sidebar) */
  .price-summary-sticky { position: sticky; top: 80px; }
  
  /* Item trong gi·ªè h√†ng */
  .summary-item {
    display: flex; flex-direction: column; /* X·∫øp d·ªçc ƒë·ªÉ ch·ª©a nhi·ªÅu info h∆°n */
    padding: 12px; border-bottom: 1px dashed #e2e8f0; background: #fff;
    transition: background 0.2s;
  }
  .summary-item:hover { background: #f8fafc; }
  
  .summary-item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .summary-item-name { font-weight: 600; color: #1e293b; font-size: 14px; line-height: 1.4; }
  .summary-item-sku { font-size: 11px; color: #64748b; display: block; margin-top: 2px; }
  
  .summary-item-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
  
  /* N√∫t s·ªë l∆∞·ª£ng ƒë·∫πp */
  .quantity-controls { display: flex; align-items: center; gap: 4px; background: #f1f5f9; padding: 2px; border-radius: 6px; }
  .qty-btn {
    width: 24px; height: 24px; border: 1px solid #cbd5e1; background-color: #fff; color: #475569;
    border-radius: 4px; cursor: pointer; font-weight: 700; line-height: 1; display: flex; align-items: center; justify-content: center;
  }
  .qty-btn:hover { background-color: #e2e8f0; color: #0f172a; }
  .qty-display { font-weight: 600; padding: 0 6px; min-width: 20px; text-align: center; font-size: 13px; }

  /* √î nh·∫≠p gi·∫£m gi√° t·ª´ng m√≥n (M·ªöI) */
  .item-discount-wrapper { display: flex; align-items: center; gap: 4px; margin-left: 10px; }
  .item-discount-label { font-size: 10px; color: #e53935; font-weight: 600; text-transform: uppercase; }
  .item-discount-input {
    width: 70px; padding: 3px 6px; font-size: 12px; text-align: right; color: #e53935; font-weight: 600;
    border: 1px solid #fca5a5; border-radius: 4px; background: #fef2f2; outline: none;
  }
  .item-discount-input:focus { border-color: #e53935; box-shadow: 0 0 0 2px rgba(229,57,53,0.1); }

  /* Gi√° ti·ªÅn */
  .price-column { text-align: right; }
  .unit-price { font-size: 12px; color: #64748b; text-decoration: line-through; opacity: 0.8; display: none; } /* Gi√° g·ªëc ·∫©n ƒëi n·∫øu ch∆∞a gi·∫£m */
  .final-line-price { font-weight: 700; color: #2563eb; font-size: 14px; }

  /* Controls chung (S·ª≠a gi√°, L·ªãch s·ª≠, X√≥a) */
  .action-buttons { display: flex; gap: 2px; }
  .btn-icon { background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6; transition: 0.2s; font-size: 14px; }
  .btn-icon:hover { opacity: 1; transform: scale(1.1); }
  
  /* Input s·ª≠a gi√° g·ªëc */
  .price-edit-input { width: 90px; padding: 4px; border: 1px solid #2563eb; border-radius: 4px; font-size: 13px; }

  /* KHU V·ª∞C C·∫§U H√åNH ƒê∆†N H√ÄNG (M·ªöI) */
  .order-settings { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 15px; }
  .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 13px; }
  .setting-label { font-weight: 600; color: #475569; }
  
  .global-discount-group { display: flex; gap: 0; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; }
  .global-discount-input { border: none; padding: 6px 10px; width: 80px; text-align: right; outline: none; font-size: 13px; }
  .global-discount-select { border: none; border-left: 1px solid #cbd5e1; background: #f1f5f9; padding: 0 8px; font-size: 12px; font-weight: 600; color: #475569; outline: none; cursor: pointer;}

  /* Radio template */
  .template-selector { display: flex; flex-direction: column; gap: 6px; }
  .radio-option { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #334155; }
  .radio-option input { accent-color: #2563eb; cursor: pointer; }

  /* MODAL Styles (Gi·ªØ nguy√™n) */
  .component-item {
    display: flex;
    flex-direction: column; /* X·∫øp d·ªçc tr∆∞·ªõc */
    align-items: stretch; /* K√©o gi√£n ra */
    padding: 12px;
    border-bottom: 1px solid #f1f5f9;
  }
  .component-item-main-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start; /* CƒÉn tr√™n ƒë·ªÉ tr√°nh n√∫t b·ªã k√©o */
    width: 100%;
    gap: 15px;
  }
  .component-item-info { 
    font-size: 14px; 
    flex-grow: 1;
    line-height: 1.5; /* TƒÉng kho·∫£ng c√°ch d√≤ng */
  }
  .component-item-action {
    display: flex;
    flex-direction: column; /* X·∫øp gi√° v√† n√∫t d·ªçc */
    align-items: flex-end; /* CƒÉn ph·∫£i */
    gap: 8px;
    flex-shrink: 0;
    min-width: 100px;
  }
  .component-item-price { font-weight: 700; color: #e53935; text-align: right; }
  .btn-select-item { 
    padding: 6px 16px; font-size: 13px; font-weight: 600; 
    border-radius: 6px; cursor: pointer; white-space: nowrap; 
  }
  .btn-select-item { padding: 6px 14px; font-size: 12px; font-weight: 600; border-radius: 6px; border: none; cursor: pointer; background-color: #10b981; color: white; transition: 0.2s; }
  .btn-select-item:hover { background-color: #059669; }
  .btn-select-item.selected { background-color: #94a3b8; cursor: not-allowed; }
  .btn-select-item:disabled { opacity: 0.7; }

  /* Responsive */
  @media (min-width: 992px) {
    .pc-builder-layout { flex-direction: row; align-items: flex-start; }
    .builder-main { flex: 2; }
    .builder-sidebar { flex: 1; }
  }
</style>

<div class="pc-builder-layout">
  
  <div class="builder-main">
    <div class="dash-card">
      <div class="dash-title" style="display:flex; justify-content:space-between; align-items:center;">
        <span>T·∫°o b√°o gi√° nhanh</span>
        <button class="btn btn-primary" id="btnOpenSearchModal" style="padding: 8px 16px; font-size: 13px;">
          <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m
        </button>
      </div>
      
      <p style="margin: 10px 0 20px; color: #64748b; font-size: 13px;">
        Th√™m s·∫£n ph·∫©m, ƒëi·ªÅu ch·ªânh gi√°/s·ªë l∆∞·ª£ng v√† thi·∫øt l·∫≠p gi·∫£m gi√° b√™n c·ªôt ph·∫£i tr∆∞·ªõc khi xu·∫•t file.
      </p>

      <div id="empty-cart-msg" class="dash-muted" style="text-align: center; padding: 40px; border: 2px dashed #e2e8f0; border-radius: 8px;">
        <div style="font-size: 40px; margin-bottom: 10px;">üõí</div>
        Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong b√°o gi√°.<br>
        B·∫•m n√∫t "Th√™m s·∫£n ph·∫©m" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
      </div>

      <div id="summary-list" style="display:none;"></div>
    </div>
  </div>
  
  <div class="builder-sidebar">
    <div class="dash-card price-summary-sticky">
      <div class="dash-title">C·∫•u h√¨nh ƒë∆°n h√†ng</div>
      
      <div class="order-settings">
        <div class="setting-row">
            <span class="setting-label">Gi·∫£m th√™m (To√†n ƒë∆°n):</span>
            <div class="global-discount-group">
                <input type="number" id="globalDiscountVal" class="global-discount-input" placeholder="0" value="0" min="0">
                <select id="globalDiscountType" class="global-discount-select">
                    <option value="amount">VNƒê</option>
                    <option value="percent">%</option>
                </select>
            </div>
        </div>
        
        <div class="setting-row">
            <span class="setting-label">Hi·ªáu l·ª±c b√°o gi√°:</span>
            <div style="display:flex; align-items:center; gap:5px;">
                <input type="number" id="quoteValidity" value="3" min="1" style="width:40px; text-align:center; border:1px solid #cbd5e1; border-radius:4px; padding:4px;">
                <span>ng√†y</span>
            </div>
        </div>

        <div style="margin: 10px 0; border-top: 1px dashed #e2e8f0;"></div>

        <div class="setting-row" style="align-items: flex-start; flex-direction: column; gap: 8px;">
            <span class="setting-label">Ch·ªçn m·∫´u in PDF:</span>
            <div class="template-selector">
                <label class="radio-option">
                    <input type="radio" name="printTemplate" value="consumer" checked>
                    <span><b>Kh√°ch l·∫ª:</b> ƒê∆°n gi√° g·ªôp VAT (G·ªçn)</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="printTemplate" value="b2b">
                    <span><b>C√¥ng ty (B2B):</b> T√°ch VAT & Gi·∫£m gi√°</span>
                </label>
            </div>
        </div>
      </div>

      <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #f1f5f9;">
        <div class="setting-row">
          <span>T·ªïng ti·ªÅn h√†ng:</span>
          <span style="font-weight: 600;" id="sub-total-price">0 VNƒê</span>
        </div>
        <div class="setting-row" style="color: #e53935;">
          <span>Gi·∫£m gi√° th√™m:</span>
          <span style="font-weight: 600;" id="discount-amount">-0 VNƒê</span>
        </div>
        <div class="setting-row" style="margin-top: 10px; align-items: flex-end;">
          <span style="font-weight: 800; font-size: 16px;">THANH TO√ÅN:</span>
          <span style="font-weight: 800; font-size: 22px; color: #2563eb;" id="final-total-price">0 VNƒê</span>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 12px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);" id="mainQuoteButton">
          XU·∫§T B√ÅO GI√Å
        </button>
      </div>
      
    </div>
  </div>
</div> 

<div class="modal" id="componentModal" style="display: none;">
  <div class="modal-content" style="max-width: 800px;">
    <span class="close" id="componentModalClose">&times;</span>
    <h3 id="componentModalTitle" style="margin-top: 0;">Th√™m s·∫£n ph·∫©m</h3>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="componentSearch" class="search-input" placeholder="T√¨m theo T√™n ho·∫∑c SKU..." style="flex: 2; padding: 10px; border:1px solid #cbd5e1; border-radius:6px;">
        <select id="filterCategory" style="flex:1; border:1px solid #cbd5e1; border-radius:6px; padding:0 10px;"><option value="">-- Ng√†nh h√†ng --</option></select>
    </div>
    
    <div id="componentModalList" style="max-height: 55vh; overflow-y: auto; border-top: 1px solid #f1f5f9;">
        <div class="dash-muted" style="padding: 20px; text-align: center;">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm...</div>
    </div>
  </div>
</div>

<div id="priceHistoryModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 600px;">
    <span id="phClose" class="close">&times;</span>
    <h3>L·ªãch s·ª≠ s·ª≠a gi√° <span id="phSku" style="color:#2563eb"></span></h3>
    <table class="detail-table" id="phTable" style="width: 100%; margin-top: 15px;">
      <thead><tr><th>Th·ªùi gian</th><th>Gi√° c≈©</th><th>Gi√° m·ªõi</th><th>Ng∆∞·ªùi s·ª≠a</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="quoteModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 500px;">
    <span id="quoteClose" class="close">&times;</span>
    <h3>Th√¥ng tin b√°o gi√°</h3>
    <p style="margin-bottom: 15px; color: #64748b; font-size: 13px;">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ in l√™n file PDF.</p>
    
    <form id="quoteForm">
      <div class="form-group" style="margin-bottom: 12px;">
        <label style="font-weight: 600; font-size: 13px; color: #334155;">T√™n Kh√°ch h√†ng / C√¥ng ty:</label>
        <input type="text" id="quoteCustomerName" required style="width: 100%; padding: 8px 10px; margin-top: 4px; border: 1px solid #cbd5e1; border-radius: 6px;">
      </div>
      <div class="form-group" style="margin-bottom: 12px;">
        <label style="font-weight: 600; font-size: 13px; color: #334155;">SƒêT Kh√°ch h√†ng:</label>
        <input type="text" id="quoteCustomerPhone" required style="width: 100%; padding: 8px 10px; margin-top: 4px; border: 1px solid #cbd5e1; border-radius: 6px;">
      </div>
      <div class="form-group" style="margin-bottom: 20px;">
        <label style="font-weight: 600; font-size: 13px; color: #334155;">Th√¥ng tin li√™n h·ªá c·ªßa b·∫°n (SƒêT/Zalo):</label>
        <input type="text" id="quoteContactInfo" required style="width: 100%; padding: 8px 10px; margin-top: 4px; border: 1px solid #cbd5e1; border-radius: 6px;">
      </div>
      
      <button type="button" class="btn btn-primary" style="width: 100%; padding: 12px; font-weight: 700;" id="btnDownloadPDF">
        <i class="fas fa-file-pdf"></i> X√°c nh·∫≠n & T·∫£i PDF
      </button>
      
      <div id="downloadError" style="color: #ef4444; text-align: center; margin-top: 10px; font-size: 13px; display: none;"></div>
      <div id="quoteLoading" class="dash-muted" style="text-align: center; padding: 15px; display: none;">
        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o file PDF...
      </div>
    </form>
  </div>
</div>
<%- include('partials/toast') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // BI·∫æN TO√ÄN C·ª§C
  let currentBuildConfig = {}; 
  let productCache = [];

  // L·∫§Y ELEMENTS
  const summaryList = document.getElementById('summary-list');
  const emptyCartMsg = document.getElementById('empty-cart-msg');
  const subTotalPriceEl = document.getElementById('sub-total-price');
  const discountAmountEl = document.getElementById('discount-amount');
  const finalTotalPriceEl = document.getElementById('final-total-price');
  
  // Inputs m·ªõi
  const globalDiscountVal = document.getElementById('globalDiscountVal');
  const globalDiscountType = document.getElementById('globalDiscountType');
  const quoteValidity = document.getElementById('quoteValidity');
  
  // Helpers
  const formatVND = (n) => new Intl.NumberFormat('vi-VN').format(Number(n || 0)) + ' VNƒê';
  const debounce = (fn, delay) => { let id; return (...args) => { clearTimeout(id); id = setTimeout(() => fn(...args), delay); }; };

  // ==========================================
  // 1. LOGIC RENDER & T√çNH TO√ÅN (CORE)
  // ==========================================
  function updateSummaryAndTotal() {
    let sumItemTotal = 0; // T·ªïng ti·ªÅn h√†ng sau khi tr·ª´ KM t·ª´ng m√≥n
    let html = '';
    
    const skus = Object.keys(currentBuildConfig).sort();
    
    if (skus.length === 0) {
        summaryList.style.display = 'none';
        emptyCartMsg.style.display = 'block';
        subTotalPriceEl.textContent = '0 VNƒê';
        discountAmountEl.textContent = '0 VNƒê';
        finalTotalPriceEl.textContent = '0 VNƒê';
        return;
    }

    summaryList.style.display = 'block';
    emptyCartMsg.style.display = 'none';

    for (const sku of skus) {
      const item = currentBuildConfig[sku];
      const qty = item.quantity || 1;
      
      // Gi√° g·ªëc (c√≥ VAT) - ∆Øu ti√™n gi√° ƒë√£ s·ª≠a n·∫øu c√≥
      const originalPrice = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
      
      // Gi·∫£m gi√° ri√™ng cho m√≥n n√†y
      const itemDiscount = item.item_discount || 0;
      
      // Th√†nh ti·ªÅn d√≤ng = (Gi√° g·ªëc - Gi·∫£m m√≥n) * S·ªë l∆∞·ª£ng
      const lineTotal = (originalPrice - itemDiscount) * qty;
      sumItemTotal += lineTotal;

      // HTML cho Gi√° & N√∫t S·ª≠a/L·ªãch s·ª≠
      let priceHtml = '';
      if (item.isEditingPrice) {
          priceHtml = `
            <div style="display:flex; gap:2px; align-items:center;">
                <input type="number" class="price-edit-input" value="${originalPrice}" id="price-input-${sku}">
                <button class="btn-icon" data-sku="${sku}" data-action="save-price" title="L∆∞u">‚úÖ</button>
                <button class="btn-icon" data-sku="${sku}" data-action="cancel-price" title="H·ªßy">‚ùå</button>
            </div>`;
      } else {
          let priceDisplay = formatVND(originalPrice);
          if (item.edited_price !== undefined && item.edited_price !== item.list_price) {
              priceDisplay = `<strong style="color:#10b981">${formatVND(item.edited_price)}</strong>`;
          }
          priceHtml = `
            <div style="display:flex; align-items:center; gap:2px;">
                <span>${priceDisplay}</span>
                <button class="btn-icon btn-edit-price" data-sku="${sku}" title="S·ª≠a gi√° g·ªëc">‚úèÔ∏è</button>
                <button class="btn-icon btn-history-price" data-sku="${sku}" title="L·ªãch s·ª≠">üïò</button>
            </div>`;
      }

      html += `
      <div class="summary-item">
        <div class="summary-item-top">
            <div style="flex:1; margin-right:10px;">
                <div class="summary-item-name">${item.product_name}</div>
                <div class="summary-item-sku">SKU: ${item.sku}</div>
            </div>
            <button class="btn-icon" onclick="removeItem('${sku}')" title="X√≥a" style="color:#ef4444; background:#fee2e2; border-radius:4px; padding:2px 6px;">‚úñÔ∏è</button>
        </div>
        
        <div class="summary-item-controls">
            <div class="quantity-controls">
                <button class="qty-btn" onclick="changeQty('${sku}', -1)">-</button>
                <span class="qty-display">${qty}</span>
                <button class="qty-btn" onclick="changeQty('${sku}', 1)">+</button>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                ${priceHtml}
                
                <div class="item-discount-wrapper">
                    <span class="item-discount-label">Gi·∫£m:</span>
                    <input type="number" class="item-discount-input" 
                           value="${itemDiscount}" min="0" placeholder="0"
                           onchange="changeItemDiscount('${sku}', this.value)">
                </div>
                
                <div class="final-line-price">${formatVND(lineTotal)}</div>
            </div>
        </div>
      </div>`;
    }
    
    summaryList.innerHTML = html;

    // T√≠nh GI·∫¢M GI√Å TO√ÄN ƒê∆†N (Global Discount)
    const gVal = Number(globalDiscountVal.value) || 0;
    const gType = globalDiscountType.value;
    let globalDiscountAmt = 0;

    if (gType === 'percent') {
        globalDiscountAmt = Math.round(sumItemTotal * (gVal / 100));
    } else {
        globalDiscountAmt = gVal;
    }
    
    // Validate kh√¥ng gi·∫£m qu√° t·ªïng ti·ªÅn
    if (globalDiscountAmt > sumItemTotal) globalDiscountAmt = sumItemTotal;
    
    const finalTotal = sumItemTotal - globalDiscountAmt;

    // Render s·ªë li·ªáu t·ªïng
    subTotalPriceEl.textContent = formatVND(sumItemTotal);
    discountAmountEl.textContent = globalDiscountAmt > 0 ? `-${formatVND(globalDiscountAmt)}` : '0 VNƒê';
    finalTotalPriceEl.textContent = formatVND(finalTotal);
  }

  // ==========================================
  // 2. C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN (Window Scope)
  // ==========================================
  window.changeQty = (sku, delta) => {
    if (currentBuildConfig[sku]) {
        currentBuildConfig[sku].quantity = Math.max(1, (currentBuildConfig[sku].quantity || 1) + delta);
        updateSummaryAndTotal();
    }
  };
  window.removeItem = (sku) => {
    if (confirm('X√≥a s·∫£n ph·∫©m n√†y kh·ªèi b√°o gi√°?')) {
        delete currentBuildConfig[sku];
        updateSummaryAndTotal();
    }
  };
  window.changeItemDiscount = (sku, val) => {
    if (currentBuildConfig[sku]) {
        currentBuildConfig[sku].item_discount = Math.max(0, Number(val));
        updateSummaryAndTotal();
    }
  };

  // Event Listeners cho Global Inputs
  globalDiscountVal.addEventListener('input', updateSummaryAndTotal);
  globalDiscountType.addEventListener('change', updateSummaryAndTotal);

  // ==========================================
  // 3. X·ª¨ L√ù S·ª∞ KI·ªÜN N√öT S·ª¨A GI√Å / L·ªäCH S·ª¨
  // ==========================================
  summaryList.addEventListener('click', async (e) => {
    const btn = e.target.closest('button'); 
    if (!btn) return;
    const sku = btn.dataset.sku;
    const action = btn.dataset.action;

    // A. B·∫≠t ch·∫ø ƒë·ªô s·ª≠a gi√°
    if (btn.classList.contains('btn-edit-price')) { 
        currentBuildConfig[sku].isEditingPrice = true; 
        updateSummaryAndTotal(); 
        setTimeout(() => { 
            const inp = document.getElementById(`price-input-${sku}`);
            if(inp) inp.focus();
        }, 50);
    }
    
    // B. Xem l·ªãch s·ª≠
    if (btn.classList.contains('btn-history-price')) {
        showPriceHistoryModal(sku); 
    }
    
    // C. L∆∞u gi√° m·ªõi
    if (action === 'save-price') { 
        const input = document.getElementById(`price-input-${sku}`);
        const newP = Number(input.value);
        if (newP < 0) return alert('Gi√° kh√¥ng h·ª£p l·ªá');
        
        try {
            // G·ªçi API l∆∞u gi√° (Optional: N·∫øu b·∫°n mu·ªën l∆∞u v√†o DB)
            const res = await fetch(`/api/sku/${sku}/price`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ new_price: newP })
            });
            const d = await res.json();
            if(!d.ok) throw new Error(d.error);
            
            // C·∫≠p nh·∫≠t local
            currentBuildConfig[sku].edited_price = newP; 
            currentBuildConfig[sku].isEditingPrice = false; 
            if(typeof showToast === 'function') showToast('ƒê√£ c·∫≠p nh·∫≠t gi√° g·ªëc!', 'success');
        } catch(err) { alert(err.message); }
        updateSummaryAndTotal();
    }
    
    // D. H·ªßy s·ª≠a
    if (action === 'cancel-price') { 
        currentBuildConfig[sku].isEditingPrice = false; 
        updateSummaryAndTotal(); 
    }
  });

  // ==========================================
  // 4. MODAL T√åM KI·∫æM & B·ªò L·ªåC
  // ==========================================
  const btnOpenSearchModal = document.getElementById('btnOpenSearchModal');
  const modal = document.getElementById('componentModal');
  const modalClose = document.getElementById('componentModalClose');
  const modalList = document.getElementById('componentModalList');
  const componentSearch = document.getElementById('componentSearch');
  const filterCategory = document.getElementById('filterCategory');
  
  // T·∫£i b·ªô l·ªçc (Ch·ªâ t·∫£i 1 l·∫ßn)
  let filtersLoaded = false;
  async function loadFilters() {
     if(filtersLoaded) return;
     try {
         const res = await fetch('/api/quote/filter-options');
         const d = await res.json();
         if(d.ok) {
             filterCategory.innerHTML = '<option value="">-- T·∫•t c·∫£ ng√†nh h√†ng --</option>' + d.categories.map(c=>`<option value="${c}">${c}</option>`).join('');
             filtersLoaded = true;
         }
     } catch(e){}
  }
  
  // T√¨m ki·∫øm
  async function search() {
      const q = componentSearch.value.trim();
      const cat = filterCategory.value; 
      
      // N·∫øu ch∆∞a nh·∫≠p g√¨, hi·ªán 20 sp m·ªõi nh·∫•t
      modalList.innerHTML = '<div class="dash-muted" style="text-align:center; padding:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
      
      try {
          const res = await fetch(`/api/quote/search-products?q=${q}&category=${cat}`);
          const d = await res.json();
          productCache = d.products || [];
          
          if(productCache.length === 0) {
              modalList.innerHTML = '<div class="dash-muted" style="text-align:center; padding:20px;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</div>';
              return;
          }

          modalList.innerHTML = productCache.map(p => {
              const added = !!currentBuildConfig[p.sku];
              return `
              <div class="component-item">
                <div class="component-item-info">
                    <strong>${p.product_name}</strong><br>
                    <span>SKU: ${p.sku} | Brand: ${p.brand||'-'}</span>
                </div>
                <div class="component-item-action">
                    <span class="component-item-price">${formatVND(p.list_price)}</span>
                    <button class="btn-select-item ${added?'selected':''}" onclick="selectItem('${p.sku}')" ${added?'disabled':''}>
                        ${added?'ƒê√£ th√™m':'Ch·ªçn'}
                    </button>
                </div>
              </div>`;
          }).join('');
      } catch(e){ modalList.innerHTML = `<div class="error-message">L·ªói: ${e.message}</div>`; }
  }

  // Ch·ªçn s·∫£n ph·∫©m
  window.selectItem = (sku) => {
      const p = productCache.find(x => x.sku === sku);
      if(p) { 
          // Th√™m v√†o gi·ªè v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh
          currentBuildConfig[sku] = { ...p, quantity: 1, item_discount: 0 }; 
          updateSummaryAndTotal();
          
          // C·∫≠p nh·∫≠t l·∫°i n√∫t trong modal
          const btns = document.querySelectorAll(`button[onclick="selectItem('${sku}')"]`);
          btns.forEach(b => {
              b.textContent = 'ƒê√£ th√™m';
              b.classList.add('selected');
              b.disabled = true;
          });
          if(typeof showToast === 'function') showToast('ƒê√£ th√™m s·∫£n ph·∫©m!', 'success');
      }
  };

  btnOpenSearchModal.onclick = () => { modal.style.display = 'flex'; componentSearch.focus(); loadFilters(); search(); };
  modalClose.onclick = () => modal.style.display = 'none';
  componentSearch.oninput = debounce(search, 400);
  filterCategory.onchange = search;

  // ==========================================
  // 5. MODAL L·ªäCH S·ª¨ GI√Å
  // ==========================================
  const priceHistoryModal = document.getElementById('priceHistoryModal');
  const phTbody = document.querySelector('#phTable tbody');
  const phSku = document.getElementById('phSku');
  
  async function showPriceHistoryModal(sku) {
      phSku.textContent = sku;
      phTbody.innerHTML = '<tr><td colspan="4" style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
      priceHistoryModal.style.display = 'flex';
      try {
          const res = await fetch(`/api/sku/${sku}/price-history`);
          const d = await res.json();
          if(!d.ok) throw new Error(d.error);
          phTbody.innerHTML = d.history.map(r => `
            <tr>
                <td>${new Date(r.changed_at).toLocaleString('vi-VN')}</td>
                <td align="right" style="color:#64748b">${formatVND(r.old_price)}</td>
                <td align="right" style="font-weight:bold">${formatVND(r.new_price)}</td>
                <td>${r.user||'-'}</td>
            </tr>`).join('') || '<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ l·ªãch s·ª≠ thay ƒë·ªïi gi√°</td></tr>';
      } catch(e) { phTbody.innerHTML = `<tr><td colspan="4" class="error-message">${e.message}</td></tr>`; }
  }
  document.getElementById('phClose').onclick = () => priceHistoryModal.style.display = 'none';

  // ==========================================
  // 6. X·ª¨ L√ù N√öT T·∫†O B√ÅO GI√Å & T·∫¢I PDF
  // ==========================================
  const quoteModal = document.getElementById('quoteModal');
  const quoteClose = document.getElementById('quoteClose');
  const btnDownload = document.getElementById('btnDownloadPDF');
  const quoteLoading = document.getElementById('quoteLoading');
  const downloadError = document.getElementById('downloadError');

  document.getElementById('mainQuoteButton').onclick = () => {
      if(Object.keys(currentBuildConfig).length === 0) return alert('Vui l√≤ng th√™m √≠t nh·∫•t 1 s·∫£n ph·∫©m.');
      quoteModal.style.display = 'flex';
      
      // Reset form
      btnDownload.style.display = 'block'; 
      btnDownload.disabled = false;
      quoteLoading.style.display = 'none';
      downloadError.style.display = 'none';
  };
  
  if(quoteClose) quoteClose.onclick = () => quoteModal.style.display = 'none';
  window.onclick = (e) => { 
      if(e.target == modal) modal.style.display = 'none'; 
      if(e.target == priceHistoryModal) priceHistoryModal.style.display = 'none'; 
      if(e.target == quoteModal) quoteModal.style.display = 'none'; 
  };

  btnDownload.onclick = async () => {
      const name = document.getElementById('quoteCustomerName').value.trim();
      const phone = document.getElementById('quoteCustomerPhone').value.trim();
      const contact = document.getElementById('quoteContactInfo').value.trim();
      
      if(!name || !phone || !contact) {
          alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng v√† li√™n h·ªá.');
          return;
      }

      // UI Loading
      btnDownload.style.display = 'none'; 
      quoteLoading.style.display = 'block';
      downloadError.style.display = 'none';
      
      // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi
      const payload = {
          buildConfig: currentBuildConfig,
          customerName: name, 
          customerPhone: phone, 
          contactInfo: contact,
          isGeneralQuote: true, // ƒê√°nh d·∫•u l√† b√°o gi√° nhanh
          sendEmail: false,     // Ch·ªâ t·∫£i PDF
          
          // D·ªØ li·ªáu m·ªõi
          globalDiscount: { 
              value: Number(globalDiscountVal.value)||0, 
              type: globalDiscountType.value 
          },
          validityDays: Number(document.getElementById('quoteValidity').value)||3,
          templateType: document.querySelector('input[name="printTemplate"]:checked').value
      };

      try {
          const res = await fetch('/api/pc-builder/generate-quote', {
              method: 'POST', 
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify(payload)
          });
          
          if(!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'L·ªói k·∫øt n·ªëi server');
          }
          
          // X·ª≠ l√Ω File Blob
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none'; 
          a.href = url; 
          
          // T√™n file an to√†n
          const safeName = name.replace(/[^a-zA-Z0-9\u00C0-\u1EF9]/g,'_');
          a.download = `BaoGia_${safeName}.pdf`;
          
          document.body.appendChild(a); 
          a.click();
          
          // Cleanup
          setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
          
          quoteModal.style.display = 'none';
          if(typeof showToast === 'function') showToast('ƒê√£ t·∫£i b√°o gi√° th√†nh c√¥ng!', 'success');

      } catch(e) {
          console.error(e);
          downloadError.innerText = 'L·ªói: ' + e.message;
          downloadError.style.display = 'block';
      } finally {
          btnDownload.style.display = 'block'; 
          quoteLoading.style.display = 'none';
      }
  };

  // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
  updateSummaryAndTotal();
});
</script>

<%- include('partials/footer') %>
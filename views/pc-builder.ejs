<%- include('partials/header', { title: 'X√¢y d·ª±ng c·∫•u h√¨nh PC', currentPage: 'pc-builder' }) %>

<style>
  /* CSS ri√™ng cho trang n√†y */
  .pc-builder-layout {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* === CSS CHO SLOT CH√çNH (B√äN TR√ÅI) === */
  .component-list .component-slot {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    border: 1px dashed #e5e7eb;
    border-radius: 12px;
    margin-bottom: 12px;
  }
  
  /* Th√¥ng tin (T√™n + Gi√°) */
  .component-list .component-info {
    flex-grow: 1;
    margin-right: 15px; /* Kho·∫£ng c√°ch v·ªõi n√∫t */
  }

  /* T√™n slot (VD: 1. CPU: ... ) */
  .component-list .component-name {
    font-size: 16px;
    font-weight: 400; /* Ch·ªØ th∆∞·ªùng */
    color: #111827;
  }
  .component-list .component-name strong {
    font-weight: 800; /* Ch·ªØ ƒë·∫≠m cho ti√™u ƒë·ªÅ */
  }
  .component-list .component-name .placeholder {
    font-weight: 400;
    color: #64748b;
    font-style: italic;
    margin-left: 5px;
  }
  
  /* Gi√° (s·∫Ω ƒë∆∞·ª£c JS ƒëi·ªÅn v√†o) */
  .component-list .component-price-display {
    font-size: 14px;
    color: #e53935; /* M√†u gi√° */
    font-weight: 700;
    margin-top: 4px;
    height: 1.2em; /* Gi·ªØ 1 kho·∫£ng tr·ªëng nh·ªè */
  }

  /* N√∫t (D√πng class g·ªëc 'btn' t·ª´ style.css) */
  .component-list .btn {
    padding: 8px 14px;
    font-weight: 600;
    flex-shrink: 0; /* Kh√¥ng b·ªã co n√∫t */
  }
  
  /* === CSS CHO C·ªòT T√ìM T·∫ÆT (B√äN PH·∫¢I) === */
  .price-summary-sticky {
    position: sticky;
    top: 80px;
  }
  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center; /* CƒÉn gi·ªØa t√™n/n√∫t v√† gi√° */
    font-size: 14px;
    margin-bottom: 10px;
  }
  .summary-item-info {
    flex-grow: 1; /* Cho ph√©p kh·ªëi t√™n co gi√£n */
    margin-right: 10px;
  }
  .summary-item-name {
    display: block; /* T√™n SP ·ªü 1 h√†ng */
  }
  .summary-item-price {
    font-weight: 600;
    text-align: right;
    min-width: 100px;
    flex-shrink: 0; /* Kh√¥ng co l·∫°i */
  }
  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 4px;
  }
  .qty-btn {
    width: 24px;
    height: 24px;
    border: 1px solid #cbd5e1;
    background-color: #f8fafc;
    color: #475569;
    border-radius: 999px; /* Tr√≤n */
    cursor: pointer;
    font-weight: 600;
    line-height: 1; /* CƒÉn s·ªë */
  }
  .qty-btn:hover {
    background-color: #e2e8f0;
  }
  .qty-display {
    font-weight: 600;
    padding: 0 5px;
    min-width: 20px;
    text-align: center;
  }

  /* === CSS CHO MODAL CH·ªåN LINH KI·ªÜN === */
  .component-item {
    display: flex;
    flex-direction: column; /* X·∫æP D·ªåC: H√†ng 1 (Info/Gi√°) v√† H√†ng 2 (T·ªìn) */
    align-items: flex-start;
    padding: 10px;
    border-bottom: 1px solid #f1f5f9;
  }
  .component-item:hover {
    background-color: #f8fafc;
  }
  .component-item-main-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    gap: 10px;
  }
  .component-item-info { 
    font-size: 14px; 
    flex-grow: 1;
  }
  .component-item-info strong { color: #111827; }
  .component-item-info span { color: #64748b; font-size: 12px; }
  .component-item-action {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  .component-item-price { 
    font-weight: 700; 
    color: #e53935;
    text-align: right;
    min-width: 80px;
  }
  .btn-select-item {
    padding: 6px 12px;
    font-size: 12px;
    background-color: #10b981;
    color: white; border: none; border-radius: 6px; cursor: pointer;
  }
  .component-item-stock {
    font-size: 12px;
    color: #475569;
    margin-top: 8px;
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 2px;
    scrollbar-width: none;
  }
  .component-item-stock::-webkit-scrollbar { display: none; }
  .component-item-stock .stock-total {
    font-weight: 700;
    color: #059669;
    padding-right: 5px;
  }
  .component-item-stock .stock-branch {
    color: #475569;
    padding: 0 5px;
    border-left: 1px solid #e5e7eb;
  }
  .component-item-stock .my-branch {
    font-weight: 700;
    color: #2563eb;
  }

  /* === B·ªê C·ª§C 2 C·ªòT DESKTOP === */
  @media (min-width: 992px) {
    .pc-builder-layout {
      flex-direction: row;
      align-items: flex-start;
    }
    .builder-main {
      flex: 2;
    }
    .builder-sidebar {
      flex: 1;
    }
  }

  /* === B·∫ÆT ƒê·∫¶U CSS CHO S·ª¨A GI√Å === */
  .summary-item-price {
    display: flex;
    align-items: center;
    justify-content: flex-end; /* CƒÉn ph·∫£i */
  }
  
  .price-edit-controls {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .price-edit-controls input {
    width: 100px;
    padding: 5px 8px;
    border: 1px solid #2563eb;
    border-radius: 6px;
  }

  /* N√∫t S·ª≠a / L·ªãch s·ª≠ */
  .btn-price-action {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    margin-left: 4px;
    opacity: 0.6;
  }
  .btn-price-action:hover {
    opacity: 1;
  }

  /* === B·∫ÆT ƒê·∫¶U CSS CHO KH·ªêI CTKM === */
  .promo-item-card {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 12px 15px;
    margin-bottom: 10px;
    background: #f8fafc;
  }
  .promo-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .promo-item-name {
    font-weight: 700;
    color: #111827;
  }
  .promo-item-discount {
    font-weight: 800;
    font-size: 16px;
    color: #e53935;
  }
  .promo-item-desc {
    font-size: 13px;
    color: #475569;
    margin-top: 4px;
  }
</style>

<div class="pc-builder-layout">
  
  <div class="builder-main">
  <div class="dash-card">
    <div class="dash-title">Ch·ªçn linh ki·ªán</div>
    
    <div class="component-list">
  
  <div class="component-slot" id="slot-cpu">
    <div class="component-info">
      <div class="component-name" data-original-title="1. B·ªô vi x·ª≠ l√Ω (CPU)">
        <strong>1. B·ªô vi x·ª≠ l√Ω (CPU):</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="cpu" data-subcat="NH03-01-01-01">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-mainboard">
    <div class="component-info">
      <div class="component-name" data-original-title="2. Bo m·∫°ch ch·ªß (Mainboard)">
        <strong>2. Bo m·∫°ch ch·ªß (Mainboard):</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="mainboard" data-subcat="NH03-01-02-01">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-ram">
    <div class="component-info">
      <div class="component-name" data-original-title="3. B·ªô nh·ªõ trong (RAM)">
        <strong>3. B·ªô nh·ªõ trong (RAM):</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="ram" data-subcat="NH03-01-04-01">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-vga">
    <div class="component-info">
      <div class="component-name" data-original-title="4. Card m√†n h√¨nh (VGA)">
        <strong>4. Card m√†n h√¨nh (VGA):</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="vga" data-subcat="NH03-01-03-01">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-ssd">
    <div class="component-info">
      <div class="component-name" data-original-title="5. ·ªî c·ª©ng SSD">
        <strong>5. ·ªî c·ª©ng SSD:</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="ssd" data-subcat="NH03-01-05-01">Ch·ªçn</button>
  </div>
  
  <div class="component-slot" id="slot-hdd">
    <div class="component-info">
      <div class="component-name" data-original-title="6. ·ªî c·ª©ng HDD">
        <strong>6. ·ªî c·ª©ng HDD:</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="hdd" data-subcat="NH03-01-05-02">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-psu">
    <div class="component-info">
      <div class="component-name" data-original-title="7. Ngu·ªìn m√°y t√≠nh (PSU)">
        <strong>7. Ngu·ªìn m√°y t√≠nh (PSU):</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="psu" data-subcat="NH03-01-07-01">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-case">
    <div class="component-info">
      <div class="component-name" data-original-title="8. Th√πng m√°y (Case)">
        <strong>8. Th√πng m√°y (Case):</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="case" data-subcat="NH03-01-06-01">Ch·ªçn</button>
  </div>
  
  <div class="component-slot" id="slot-cpu-fan">
    <div class="component-info">
      <div class="component-name" data-original-title="9. Qu·∫°t CPU">
        <strong>9. Qu·∫°t CPU:</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="cpu-fan" data-subcat="NH03-01-08-01">Ch·ªçn</button>
  </div>

  <div class="component-slot" id="slot-case-fan">
    <div class="component-info">
      <div class="component-name" data-original-title="10. Qu·∫°t case">
        <strong>10. Qu·∫°t case:</strong>
        <span class="placeholder">Ch∆∞a ch·ªçn</span>
      </div>
      <div class="component-price-display"></div>
    </div>
    <button class="btn btn-primary btn-choose" data-type="case-fan" data-subcat="NH03-01-09-01">Ch·ªçn</button>
  </div>
  
  </div>

  <div class="builder-sidebar">
    <div class="dash-card price-summary-sticky">
      <div class="dash-title">T·ªïng chi ph√≠ (t·∫°m t√≠nh)</div>
      
      <div id="summary-list">
        <div class="dash-muted" style="text-align: center; padding: 20px 0;">
          Vui l√≤ng ch·ªçn linh ki·ªán
        </div>
      </div>

      <div style="border-top: 2px solid #f1f5f9; margin-top: 15px; padding-top: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 800; font-size: 18px;">T·ªïng c·ªông:</span>
          <span style="font-weight: 800; font-size: 22px; color: #e53935;" id="total-price">
            0 VNƒê
          </span>
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 12px;">
          L∆∞u c·∫•u h√¨nh & B√°o gi√°
        </button>
      </div>
      
    </div>
  </div>
  </div> <div class="builder-main" id="promo-results-container" style="display: none; width: 100%;">
    <div class="dash-card">
      <div class="dash-title">Khuy·∫øn m√£i √°p d·ª•ng</div>
      <div id="promo-results-list">
        </div>
    </div>
  </div>
  </div>
</div>



<div class="modal" id="componentModal" style="display: none;">
  <div class="modal-content" style="max-width: 800px;">
    <span class="close" id="componentModalClose">&times;</span>
    <h3 id="componentModalTitle" style="margin-top: 0;">Ch·ªçn linh ki·ªán</h3>
    
    <input type="text" id="componentSearch" class="search-input" 
           placeholder="T√¨m theo t√™n ho·∫∑c SKU..." 
           style="width: 100%; margin-bottom: 15px;">
    
    <div id="componentModalList" style="max-height: 60vh; overflow-y: auto;">
      <div class="dash-muted" style="text-align: center; padding: 20px;">ƒêang t·∫£i...</div>
    </div>
  </div>
</div>
<style>
  .component-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #f1f5f9;
  }
  .component-item:hover {
    background-color: #f8fafc;
  }
  .component-item-info { font-size: 14px; }
  .component-item-info strong { color: #111827; }
  .component-item-info span { color: #64748b; font-size: 12px; }
  .component-item-price { font-weight: 700; color: #e53935; }
  .btn-select-item {
    padding: 6px 12px;
    font-size: 12px;
    background-color: #10b981; /* xanh l√° */
    color: white; border: none; border-radius: 6px; cursor: pointer;
  }
</style>

<script>
  // ===== B·∫ÆT ƒê·∫¶U CODE JAVASCRIPT BUILD PC (ƒê√É S·ª¨A L·ªñI C·∫§U TR√öC) =====
  document.addEventListener('DOMContentLoaded', function() {
  // L·∫•y th√¥ng tin user t·ª´ EJS
  const currentUser = {
    role: "<%= user ? user.role : 'guest' %>",
    branch: "<%= user ? user.branch_code : '' %>"
  };

  // ----- BI·∫æN TO√ÄN C·ª§C -----
  let currentBuildConfig = {}; 
  let currentSlotType = null;
  let allComponentsCache = [];

  // ----- L·∫§Y C√ÅC ELEMENT -----
  const modal = document.getElementById('componentModal');
  const modalClose = document.getElementById('componentModalClose');
  const modalTitle = document.getElementById('componentModalTitle');
  const modalList = document.getElementById('componentModalList');
  const componentSearch = document.getElementById('componentSearch');
  const summaryList = document.getElementById('summary-list');
  const totalPriceEl = document.getElementById('total-price');
  const mainComponentList = document.querySelector('.component-list');
  const promoContainer = document.getElementById('promo-results-container');
  const promoList = document.getElementById('promo-results-list');
  
  // (M·ªöI) Elements cho Modal L·ªãch s·ª≠
  const priceHistoryModal = document.getElementById('priceHistoryModal');
  const phClose = document.getElementById('phClose');
  const phTbody = document.querySelector('#phTable tbody');
  const phSku = document.getElementById('phSku');
  const quoteModal = document.getElementById('quoteModal');
  const quoteClose = document.getElementById('quoteClose');
  const quoteForm = document.getElementById('quoteForm');
  const quoteSendEmail = document.getElementById('quoteSendEmail');
  const quoteEmailGroup = document.getElementById('quoteEmailGroup');
  const quoteCustomerEmail = document.getElementById('quoteCustomerEmail');
  const quoteSubmitButton = document.getElementById('quoteSubmitButton');
  const quoteLoading = document.getElementById('quoteLoading');
  const mainQuoteButton = document.querySelector('.builder-sidebar .btn-primary'); // N√∫t "L∆∞u c·∫•u h√¨nh & B√°o gi√°"

  // ----- H√ÄM H·ªñ TR·ª¢ -----
  function formatVND(n) {
    return new Intl.NumberFormat('vi-VN').format(Number(n || 0)) + ' VNƒê';
  }

  function buildStockHtml(stockByBranch, userRole, userBranch) {
    if (!stockByBranch || Object.keys(stockByBranch).length === 0) {
      return '<span class="stock-total">T·ªïng t·ªìn: 0</span>';
    }
    let totalStock = 0;
    const branchEntries = [];
    for (const [branch, qty] of Object.entries(stockByBranch)) {
      if (qty > 0) {
        totalStock += qty;
        branchEntries.push([branch, qty]);
      }
    }
    if (totalStock === 0) { return '<span class="stock-total">T·ªïng t·ªìn: 0</span>'; }
    branchEntries.sort((a, b) => a[0].localeCompare(b[0]));
    const isManager = (userRole === 'manager' || userRole === 'admin' || userBranch === 'HCM.BD');
    if (!isManager && userBranch) {
      const userBranchIndex = branchEntries.findIndex(entry => entry[0] === userBranch);
      if (userBranchIndex > 0) {
        const userBranchEntry = branchEntries.splice(userBranchIndex, 1)[0];
        branchEntries.unshift(userBranchEntry);
      }
    }
    let html = `<span class="stock-total">T·ªïng t·ªìn: ${totalStock}</span>`;
    const branchHtml = branchEntries.map(([branch, qty]) => {
      const isMyBranch = (!isManager && branch === userBranch);
      return `<span class="stock-branch ${isMyBranch ? 'my-branch' : ''}">${branch}: ${qty}</span>`;
    }).join(' ');
    html += `${branchHtml}`;
    return html;
  }

  // ===== H√ÄM M·ªöI: G·ªåI API KI·ªÇM TRA CTKM (C√ì C·∫¢NH B√ÅO) =====
  async function checkPromotions() {
    const totalPrice = Object.values(currentBuildConfig).reduce((sum, item) => {
      const price = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
      return sum + (price * item.quantity);
    }, 0);

    // Lu√¥n hi·ªÉn th·ªã card
    promoContainer.style.display = 'block';

    if (totalPrice === 0) {
      promoList.innerHTML = `<div class="dash-muted" style="padding: 10px;">Vui l√≤ng ch·ªçn linh ki·ªán ƒë·ªÉ ki·ªÉm tra KM.</div>`;
      return;
    }

    try {
      const res = await fetch('/api/pc-builder/check-promos', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          buildConfig: currentBuildConfig,
          totalPrice: totalPrice
        })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);

      if (data.success) {
        // TH√ÄNH C√îNG: Hi·ªÉn th·ªã CTKM v√† n√∫t copy
        const p = data.promo;
        promoList.innerHTML = `
          <div class="promo-item-card" style="background: #ecfdf5; border-color: #10b981;">
            <div class="promo-item-header">
              <span class="promo-item-name" style="color: #065f46;">${p.name}</span>
              <span class="promo-item-discount" style="color: #10b981;">-${formatVND(p.discount_amount)}</span>
            </div>
            <div class="promo-item-desc" style="color: #065f46; margin-top: 5px;">${p.description}</div>
            
            <button type="button" class="code-badge" onclick="copyCode(this)" data-code="${p.coupon}" style="margin-top: 10px;">
              üîë <span>${p.coupon}</span> <small>(B·∫•m ƒë·ªÉ copy)</small>
            </button>
          </div>
        `;
      } else {
        // TH·∫§T B·∫†I: Hi·ªÉn th·ªã l√Ω do (C·∫£nh b√°o)
        promoList.innerHTML = `
          <div class="promo-item-card" style="background: #fffbeb; border-color: #f59e0b;">
            <div class="promo-item-header">
              <span class="promo-item-name" style="color: #b45309;">C·∫•u h√¨nh ch∆∞a ƒë·∫°t KM</span>
            </div>
            <div class="promo-item-desc" style="color: #b45309; font-weight: 600; margin-top: 5px;">
              L√Ω do: ${data.reason || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}
            </div>
          </div>
        `;
      }

    } catch (err) {
      console.error("L·ªói khi check CTKM:", err.message);
      promoList.innerHTML = `<div class="error-message">L·ªói t·∫£i CTKM: ${err.message}</div>`;
    }
  }

  // H√ÄM C·∫¨P NH·∫¨T T·ªîNG TI·ªÄN & T√ìM T·∫ÆT
  function updateSummaryAndTotal() {
    let totalPrice = 0;
    let summaryHtml = '';
    const orderedKeys = Array.from(mainComponentList.querySelectorAll('.component-slot')).map(s => s.id.replace('slot-', ''));
    
    for (const type of orderedKeys) {
      const item = currentBuildConfig[type];
      if (item) {
        if (!item.quantity || item.quantity < 1) {
            item.quantity = 1;
        }
        const currentPrice = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
        const itemPrice = currentPrice * (item.quantity);
        totalPrice += itemPrice;
        
        let priceHtml = '';
        if (item.isEditingPrice) {
          priceHtml = `
            <div class="price-edit-controls">
              <input type="number" value="${currentPrice}" id="price-input-${type}" style="width: 100px;">
              <button class="btn-price-action" data-type="${type}" data-action="save-price">‚úîÔ∏è</button>
              <button class="btn-price-action" data-type="${type}" data-action="cancel-price">‚úñÔ∏è</button>
            </div>
          `;
        } else {
          let priceDisplay = formatVND(currentPrice);
          if (item.edited_price !== undefined && item.edited_price !== item.list_price) {
             priceDisplay = `<strong style="color: #10b981;">${formatVND(item.edited_price)}</strong>`;
          }
          priceHtml = `
            <span>${priceDisplay}</span>
            <button class="btn-price-action btn-edit-price" data-type="${type}" title="S·ª≠a gi√°">‚úèÔ∏è</button>
            <button class="btn-price-action btn-history-price" data-sku="${item.sku}" title="L·ªãch s·ª≠ gi√°">üïò</button>
          `;
        }

        summaryHtml += `
          <div class="summary-item">
            <div class="summary-item-info">
              <span class="summary-item-name">${item.product_name}</span>
              <span style="font-size: 12px; color: #64748b; margin-top: 2px; display: block;">
                SKU: ${item.sku}
              </span>
              <div class="quantity-controls">
                <button class="qty-btn" data-type="${type}" data-action="decrease" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                <span class="qty-display">${item.quantity}</span>
                <button class="qty-btn" data-type="${type}" data-action="increase">+</button>
              </div>
            </div>
            <div class="summary-item-price" id="price-display-${type}">
              ${priceHtml}
            </div>
          </div>
        `;
      }
    }

    if (summaryHtml === '') {
      summaryList.innerHTML = `<div class="dash-muted" style="text-align: center; padding: 20px 0;">Vui l√≤ng ch·ªçn linh ki·ªán</div>`;
    } else {
      summaryList.innerHTML = summaryHtml;
    }
    totalPriceEl.textContent = formatVND(totalPrice);
    checkPromotions();
  }

  // H√ÄM X·ª¨ L√ù TƒÇNG/GI·∫¢M S·ªê L∆Ø·ª¢NG
  function changeQuantity(type, action) {
    const item = currentBuildConfig[type];
    if (!item) return;
    if (action === 'increase') {
      item.quantity += 1;
    } else if (action === 'decrease') {
      if (item.quantity > 1) {
        item.quantity -= 1;
      }
    }
    updateSummaryAndTotal();
  }

  // H√ÄM V·∫º DANH S√ÅCH LINH KI·ªÜN TRONG MODAL
  function renderComponentList(components) {
    if (components.length === 0) {
      modalList.innerHTML = '<div class="dash-muted" style="text-align: center; padding: 20px;">Kh√¥ng t√¨m th·∫•y linh ki·ªán n√†o.</div>';
      return;
    }
    modalList.innerHTML = components.map(item => {
      const stockHtml = buildStockHtml(item.stock_by_branch, currentUser.role, currentUser.branch);
      return `
      <div class="component-item">
        <div class="component-item-main-row">
          <div class="component-item-info">
            <strong>${item.product_name}</strong><br>
            <span>SKU: ${item.sku} | Brand: ${item.brand || 'N/A'}</span>
          </div>
          <div class="component-item-action">
            <span class="component-item-price">${formatVND(item.list_price)}</span>
            <button class="btn-select-item" data-sku="${item.sku}">Ch·ªçn</button>
          </div>
        </div>
        <div class="component-item-stock">
          ${stockHtml}
        </div>
      </div>
      `;
    }).join('');
  }
  
  // H√ÄM HI·ªÇN TH·ªä MODAL L·ªäCH S·ª¨ GI√Å
  async function showPriceHistoryModal(sku) {
    phSku.textContent = sku;
    phTbody.innerHTML = '<tr><td colspan="4">ƒêang t·∫£i...</td></tr>';
    priceHistoryModal.style.display = 'flex';
    try {
      const res = await fetch(`/api/sku/${sku}/price-history`);
      const js = await res.json();
      if (!js.ok) throw new Error(js.error || 'Load history failed');
      const rows = (js.history || []).map(r => `
        <tr>
          <td>${new Date(r.changed_at).toLocaleString('vi-VN')}</td>
          <td style="text-align: right;">${formatVND(r.old_price)}</td>
          <td style="text-align: right;">${formatVND(r.new_price)}</td>
          <td>${r.user || '-'}</td>
        </tr>
      `).join('');
      phTbody.innerHTML = rows || '<tr><td colspan="4">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>';
    } catch (e) {
      phTbody.innerHTML = `<tr><td colspan="4" class="error-message">L·ªói: ${e.message}</td></tr>`;
    }
  }

  // ----- G·∫ÆN C√ÅC B·ªò L·∫ÆNG NGHE S·ª∞ KI·ªÜN -----

  // 1. S·ª∞ KI·ªÜN CHO C√ÅC SLOT (N√öT CH·ªåN / X√ìA)
  mainComponentList.addEventListener('click', async (e) => {
    // A. B·∫§M N√öT "CH·ªåN"
    if (e.target.classList.contains('btn-choose')) {
      const btn = e.target;
      
      // === S·ª¨A L·ªñI THEO √ù B·∫†N (L·∫•y 3 ph·∫ßn ƒë·∫ßu) ===
      let subcat = btn.dataset.subcat; // V√≠ d·ª•: 'NH03-01-02-01'
      // T√°ch 3 ph·∫ßn ƒë·∫ßu ('NH03', '01', '02') r·ªìi join l·∫°i
      const subcatPrefix = subcat.split('-').slice(0, 3).join('-'); 
      // subcatPrefix gi·ªù l√† 'NH03-01-02'
      // ========================================

      currentSlotType = btn.dataset.type;
      const slotNameEl = btn.closest('.component-slot').querySelector('.component-name');
      const slotName = slotNameEl.dataset.originalTitle;
      modalTitle.textContent = `Ch·ªçn - ${slotName}`;
 
      modal.style.display = 'flex';
      componentSearch.value = '';
      modalList.innerHTML = '<div class="dash-muted" style="text-align: center; padding: 20px;">ƒêang t·∫£i...</div>';
      try {
        // G·ª≠i ID ƒë√£ ƒë∆∞·ª£c r√∫t g·ªçn (3 ph·∫ßn)
        const res = await fetch(`/api/components?subcat=${subcatPrefix}`); 
        const data = await res.json();
        if (!data.ok) throw new Error(data.error);
        allComponentsCache = data.components;
        renderComponentList(allComponentsCache);
      } catch (err) {
        modalList.innerHTML = `<div class="error-message">L·ªói: ${err.message}</div>`;
      }
    }
    
    // B. B·∫§M N√öT "X√ìA"
    if (e.target.classList.contains('btn-remove')) {
      const btn = e.target;
      const slotType = btn.dataset.type;
      delete currentBuildConfig[slotType];
      const slotEl = document.getElementById(`slot-${slotType}`);
      const infoEl = slotEl.querySelector('.component-info');
      const originalTitle = infoEl.querySelector('.component-name').dataset.originalTitle;
      infoEl.innerHTML = `
        <div class="component-name" data-original-title="${originalTitle}">
          <strong>${originalTitle}:</strong>
          <span class="placeholder">Ch∆∞a ch·ªçn</span>
        </div>
        <div class="component-price-display"></div>
      `;
      btn.textContent = 'Ch·ªçn';
      btn.classList.remove('btn-danger', 'btn-remove');
      btn.classList.add('btn-primary', 'btn-choose');
      updateSummaryAndTotal();
    }
  });

  // 2. S·ª∞ KI·ªÜN CHO C·ªòT T√ìM T·∫ÆT (N√öT +/- V√Ä S·ª¨A GI√Å)
  summaryList.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const type = btn.dataset.type;
    const action = btn.dataset.action;
    
    // A. B·∫§M N√öT +/-
    if (action === 'increase' || action === 'decrease') {
      changeQuantity(type, action);
    }
    
    // B. B·∫§M N√öT S·ª¨A GI√Å (‚úèÔ∏è)
    if (btn.classList.contains('btn-edit-price')) {
      const item = currentBuildConfig[type];
      if (item) {
        item.isEditingPrice = true;
        updateSummaryAndTotal();
        document.getElementById(`price-input-${type}`).focus();
      }
    }
    
    // C. B·∫§M N√öT L·ªäCH S·ª¨ (üïò)
    if (btn.classList.contains('btn-history-price')) {
      const sku = btn.dataset.sku;
      showPriceHistoryModal(sku);
    }
    
    // D. B·∫§M N√öT L∆ØU GI√Å (‚úîÔ∏è)
    if (action === 'save-price') {
      const item = currentBuildConfig[type];
      const inputEl = document.getElementById(`price-input-${type}`);
      const newPrice = Number(inputEl.value);
      
      if (!item || newPrice < 0) {
         alert('Gi√° kh√¥ng h·ª£p l·ªá');
         return;
      }
      
      btn.disabled = true;
      
      try {
        const res = await fetch(`/api/sku/${item.sku}/price`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ new_price: newPrice })
        });
        const js = await res.json();
        if (!js.ok) throw new Error(js.error || 'C·∫≠p nh·∫≠t gi√° th·∫•t b·∫°i');
        
        item.edited_price = newPrice;
        item.isEditingPrice = false;
        showToast('ƒê√£ l∆∞u gi√° m·ªõi th√†nh c√¥ng!', 'success'); // G·ªçi h√†m toast
        
      } catch (err) {
        alert('L·ªói l∆∞u gi√°: ' + err.message);
        btn.disabled = false;
      }
      
      updateSummaryAndTotal();
    }
    
    // E. B·∫§M N√öT H·ª¶Y S·ª¨A GI√Å (‚úñÔ∏è)
    if (action === 'cancel-price') {
      const item = currentBuildConfig[type];
      if (item) {
        item.isEditingPrice = false;
        updateSummaryAndTotal();
      }
    }
  });

  // 3. S·ª∞ KI·ªÜN KHI CH·ªåN 1 M√ìN TRONG MODAL
  modalList.addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-select-item')) {
      const sku = e.target.dataset.sku;
      const selectedItem = allComponentsCache.find(c => c.sku === sku);
      if (selectedItem && currentSlotType) {
        currentBuildConfig[currentSlotType] = { 
          ...selectedItem, 
          quantity: 1 
        };
        const slotEl = document.getElementById(`slot-${currentSlotType}`);
        const infoEl = slotEl.querySelector('.component-info');
        const originalTitle = infoEl.querySelector('.component-name').dataset.originalTitle;
        infoEl.innerHTML = `
          <div class="component-name" data-original-title="${originalTitle}">
            <strong>${originalTitle}:</strong>
            <span style="font-weight: 400; margin-left: 5px;">${selectedItem.product_name}</span>
          </div>
          <div class="component-price-display">
            ${formatVND(selectedItem.list_price)}
          </div>
        `;
        const btnEl = slotEl.querySelector('button');
        btnEl.textContent = 'X√≥a';
        btnEl.classList.remove('btn-primary', 'btn-choose');
        btnEl.classList.add('btn-danger', 'btn-remove');
        updateSummaryAndTotal();
        modal.style.display = 'none';
        currentSlotType = null;
      }
    }
  });

  // 4. S·ª∞ KI·ªÜN T√åM KI·∫æM TRONG MODAL
  componentSearch.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    const filtered = allComponentsCache.filter(c => 
      c.product_name.toLowerCase().includes(query) ||
      c.sku.toLowerCase().includes(query)
    );
    renderComponentList(filtered);
  });

  // 5. S·ª∞ KI·ªÜN ƒê√ìNG MODAL (N√ÇNG C·∫§P)
  modalClose.onclick = () => { modal.style.display = 'none'; };
  // Ki·ªÉm tra phClose c√≥ t·ªìn t·∫°i kh√¥ng
  if (phClose) {
    phClose.onclick = () => { priceHistoryModal.style.display = 'none'; };
  }
  window.onclick = (e) => {
    if (e.target == modal) {
      modal.style.display = 'none';
    }
    // Ki·ªÉm tra priceHistoryModal c√≥ t·ªìn t·∫°i kh√¥ng
    if (priceHistoryModal && e.target == priceHistoryModal) {
      priceHistoryModal.style.display = 'none';
    }
  };

  mainQuoteButton.addEventListener('click', (e) => {
    e.preventDefault(); // NgƒÉn form submit
    
    // Ki·ªÉm tra xem c√≥ SP n√†o kh√¥ng
    if (Object.keys(currentBuildConfig).length === 0) {
      showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 linh ki·ªán', 'warn');
      return;
    }
    
    // M·ªü modal b√°o gi√°
    quoteModal.style.display = 'flex';
    quoteLoading.style.display = 'none';
    quoteSubmitButton.style.display = 'block';
    quoteSubmitButton.disabled = false;
  });

  // 2. B·∫•m tick v√†o checkbox "G·ª≠i email"
quoteSendEmail.addEventListener('change', (e) => {
    if (e.target.checked) {
      quoteEmailGroup.style.display = 'block';
      quoteCCGroup.style.display = 'block'; // <-- TH√äM D√íNG N√ÄY
      quoteCustomerEmail.required = true; 
    } else {
      quoteEmailGroup.style.display = 'none';
      quoteCCGroup.style.display = 'none'; // <-- TH√äM D√íNG N√ÄY
      quoteCustomerEmail.required = false;
    }
  });

  // 3. B·∫•m n√∫t "X√°c nh·∫≠n & T·∫°o b√°o gi√°" (b√™n trong modal)
  quoteForm.addEventListener('submit', async (e) => {
    e.preventDefault(); 
    
    quoteLoading.style.display = 'block';
    quoteSubmitButton.style.display = 'none';
    quoteSubmitButton.disabled = true;

    // L·∫•y d·ªØ li·ªáu
    const customerName = document.getElementById('quoteCustomerName').value.trim();
    const sendEmail = quoteSendEmail.checked;
    const customerEmail = document.getElementById('quoteCustomerEmail').value.trim();
    const contactInfo = document.getElementById('quoteContactInfo').value.trim();
    const customerCC = document.getElementById('quoteCCEmail').value.trim();
    const customerPhone = document.getElementById('quoteCustomerPhone').value.trim();
    if (!customerName || !contactInfo || !customerPhone) {
      alert('Vui l√≤ng nh·∫≠p ƒë·ªß T√™n kh√°ch h√†ng, SƒêT kh√°ch h√†ng, v√† SƒêT li√™n h·ªá c·ªßa b·∫°n.');
      return; // D·ª´ng l·∫°i, kh√¥ng g·ª≠i
    }
    
    if (sendEmail && !customerEmail) {
      alert('Vui l√≤ng nh·∫≠p Email c·ªßa kh√°ch h√†ng ƒë·ªÉ g·ª≠i.');
      return; // D·ª´ng l·∫°i, kh√¥ng g·ª≠i
    }
    try {
      const res = await fetch('/api/pc-builder/generate-quote', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          buildConfig: currentBuildConfig,
          customerName,
          sendEmail,

          customerEmail,
          contactInfo,
          customerCC,
          customerPhone: customerPhone,
        })
      });

      if (!res.ok) {
        // L·ªói (v√≠ d·ª• 500)
        const errData = await res.json();
        throw new Error(errData.error || `L·ªói server: ${res.statusText}`);
      }

      if (sendEmail) {
        // 1. N·∫æU G·ª¨I MAIL TH√ÄNH C√îNG
        const data = await res.json();
        showToast(data.message || 'G·ª≠i email th√†nh c√¥ng!', 'success');
        quoteModal.style.display = 'none';
      } else {
        // 2. N·∫æU DOWNLOAD PDF
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `BaoGia_${customerName.replace(/ /g, '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('ƒêang t·∫£i file PDF...', 'success');
        quoteModal.style.display = 'none';
      }
      
    } catch (err) {
      alert('L·ªói t·∫°o b√°o gi√°: ' + err.message);
    } finally {
      // Lu√¥n reset l·∫°i n√∫t
      quoteLoading.style.display = 'none';
      quoteSubmitButton.style.display = 'block';
      quoteSubmitButton.disabled = false;
    }
  });
  // 4. ƒê√≥ng modal b√°o gi√°
  quoteClose.onclick = () => { quoteModal.style.display = 'none'; };
  
  // 5. C·∫≠p nh·∫≠t h√†m ƒë√≥ng modal chung
  window.onclick = (e) => {
    if (e.target == modal) {
      modal.style.display = 'none';
    }
    if (priceHistoryModal && e.target == priceHistoryModal) {
      priceHistoryModal.style.display = 'none';
    }
    // (M·ªöI)
    if (quoteModal && e.target == quoteModal) {
      quoteModal.style.display = 'none';
    }
  };

  // 6. KH·ªûI T·∫†O T√ìM T·∫ÆT L·∫¶N ƒê·∫¶U
  updateSummaryAndTotal();
});
  // ===== K·∫æT TH√öC CODE JAVASCRIPT =====
</script>

<div id="priceHistoryModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 600px;">
    <span id="phClose" class="close">&times;</span>
    <h3>L·ªãch s·ª≠ s·ª≠a gi√° (SKU: <span id="phSku"></span>)</h3>
    <table class="detail-table" id="phTable" style="width: 100%; margin-top: 15px;">
      <thead>
        <tr><th>Th·ªùi gian</th><th>Gi√° c≈©</th><th>Gi√° m·ªõi</th><th>Ng∆∞·ªùi s·ª≠a</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


<div id="quoteModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width: 500px;">
    <span id="quoteClose" class="close">&times;</span>
    <h3>Th√¥ng tin b√°o gi√°</h3>
    
    <form id="quoteForm">
      <div class="form-group" style="margin-bottom: 15px;">
        <label>T√™n Kh√°ch h√†ng / C√¥ng ty:</label>
        <input type="text" id="quoteCustomerName" class="info-input" placeholder="K√≠nh g·ª≠i..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label>SƒêT Kh√°ch h√†ng:</label>
        <input type="text" id="quoteCustomerPhone" class="info-input" placeholder="SƒêT c·ªßa kh√°ch h√†ng" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Th√¥ng tin li√™n h·ªá c·ªßa b·∫°n (SƒêT/Zalo):</label>
        <input type="text" id="quoteContactInfo" class="info-input" placeholder="090..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="quoteSendEmail" style="width: 18px; height: 18px;">
          G·ª≠i email b√°o gi√°
        </label>
      </div>
      
      <div class="form-group" id="quoteEmailGroup" style="display: none; margin-bottom: 20px;">
        <label>Email nh·∫≠n b√°o gi√°:</label>
        <input type="email" id="quoteCustomerEmail" class="info-input" placeholder="example@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <div class="form-group" id="quoteCCGroup" style="display: none; margin-bottom: 20px;">
        <label>CC (Email ph·ª•, t√πy ch·ªçn):</label>
        <input type="email" id="quoteCCEmail" class="info-input" placeholder="cc@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;" id="quoteSubmitButton">
        X√°c nh·∫≠n & T·∫°o b√°o gi√°
      </button>
      <div id="quoteLoading" class="dash-muted" style="text-align: center; padding: 20px; display: none;">
        ƒêang t·∫°o PDF, vui l√≤ng ch·ªù...
      </div>
    </form>
    
  </div>
</div>
<%- include('partials/toast') %>
<%- include('partials/footer') %>
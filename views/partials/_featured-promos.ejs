<%
    // Helper để tính toán thông tin ngày hết hạn
    function getExpiryInfo(endDateString) {
        if (!endDateString) {
            return { badgeClass: '', formattedDate: '' };
        }
        
        const endDate = new Date(endDateString);
        endDate.setHours(23, 59, 59, 999); 

        const diffTime = endDate.getTime() - new Date().getTime();
        const diffDays = diffTime / (1000 * 60 * 60 * 24);

        let badgeClass = '';
        if (diffDays > 3) {
            badgeClass = 'promo-expiry-badge--safe'; 
        } else if (diffDays >= 0) {
            badgeClass = 'promo-expiry-badge--urgent'; 
        } else {
            badgeClass = 'promo-expiry-badge--urgent'; 
        }

        const formattedDate = new Date(endDateString).toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        return { badgeClass, formattedDate };
    }

    
%>

<div class="promo-list">
    <% featuredPromos.forEach(function(p){ %>
        <% 
            // 1. Tính toán ngày hết hạn
            const expiry = (typeof getExpiryInfo === 'function') ? getExpiryInfo(p.end_date) : { badgeClass: '', formattedDate: '' };
            
            // 2. Kiểm tra xem có phải là KFI không
            const isKFI = (p.promo_type === 'KFI');

            // ================================================================
            // === [LOGIC MỚI] CHECK QUYỀN MANAGER CHO KFI ===
            // Nếu là KFI và Role KHÔNG PHẢI là 'manager' -> Bỏ qua (Không vẽ thẻ này)
            // ================================================================
            if (isKFI) {
                // Lưu ý: Nếu muốn admin cũng thấy thì dùng: if (userRole !== 'manager' && userRole !== 'admin')
                if (typeof userRole === 'undefined' || userRole !== 'manager') {
                    return; // Lệnh này sẽ skip qua item này trong vòng lặp forEach
                }
            }

            // 3. Xử lý Link an toàn (Tránh lỗi khi không có product)
            let linkHref = "/promotion-detail/" + p.id;
            let linkText = "Chi tiết >";
            
            if (isKFI) {
                // Kiểm tra xem biến product có tồn tại không (Trang Search vs Trang Home)
                const currentSku = (typeof product !== 'undefined' && product) ? product.sku : '';
                
                // Nếu có SKU -> Link filter theo SKU, Ngược lại -> Link trang chủ KFI
                linkHref = "/kfi-program" + (currentSku ? "?q=" + currentSku : "");
                linkText = "Xem tồn kho & Thưởng →";
            }
        %>

        <a class="promo-item" href="<%= linkHref %>" 
           style="<%= isKFI ? 'border:1px solid #fbcfe8; background:#fff0f6;' : '' %>">
            
            <div class="promo-item__content">
                <div class="promo-name" style="<%= isKFI ? 'color:#be185d;' : '' %>">
                    <%= p.name %>
                </div>

                <div class="promo-meta">
    <% 
        // Danh sách các loại CTKM KHÔNG được hiện giá tiền trực tiếp (ưu tiên hiện text mô tả)
        const HIDE_PRICE_TYPES = ['Combo', 'Gift', 'Quà tặng (Gift)', 'Trả góp', 'Ưu đãi thanh toán', 'KFI'];
        
        // Chỉ hiện giá nếu có discount VÀ không thuộc loại bị ẩn
        const shouldShowPrice = p.__display_discount && !HIDE_PRICE_TYPES.includes(p.promo_type);
    %>

    <% if (isKFI) { %>
        <div style="font-size:13px; color:#9d174d; font-weight:600; margin-top: 4px;">
            <% if (p.description && p.description.includes('Thưởng')) { %>
                <%= p.description %> 
            <% } else { %>
                Xem KFI tháng này & Tồn kho 
            <% } %>
        </div>

    <% } else if (shouldShowPrice) { %>
        <%= p.__display_prefix || '' %>: 
        <strong>
            <% if (String(p.__display_discount).includes('%')) { %>
                <%= p.__display_discount %>
            <% } else { %>
                <%= new Intl.NumberFormat('vi-VN').format(p.__display_discount) %>₫
            <% } %>
        </strong>

    <% } else { %>
        <span class="dash-muted" style="font-size:13px; color:#64748b;">
            <%= p.description ? p.description : (p.promo_type || 'Xem chi tiết') %>
        </span>
    <% } %>
</div>
            </div>

            <% if (expiry.formattedDate) { %>
                <div class="promo-expiry-badge <%= expiry.badgeClass %>">
                    Hết hạn: <%= expiry.formattedDate %>
                </div>
            <% } %>

            <% if (isKFI) { %>
                <div style="position:absolute; top:10px; right:10px; background:#db2777; color:#fff; font-size:10px; font-weight:700; padding:2px 6px; border-radius:4px;">
                    HOT
                </div>
            <% } %>
        </a>
    <% }) %>
</div>

<% if (totalPages > 1) { %>
    <div style="margin-top: 20px; display:flex; justify-content: center; gap: 8px;">
        <% if (page < totalPages) { %>
            <a class="btn-view-more" href="/?group=<%= encodeURIComponent(selectedGroup) %>&page=<%= page + 1 %>" data-ajax="true">Xem thêm →</a>
        <% } %>
    </div>
<% } %>
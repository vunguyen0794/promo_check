<% /* views/partials/header.ejs (ƒê√£ c·∫≠p nh·∫≠t) */ %>
<!DOCTYPE html>
<html lang="vi">
<head>
  <% /* ... (ph·∫ßn <head> c·ªßa b·∫°n gi·ªØ nguy√™n) ... */ %>
  <meta charset="utf-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap&subset=vietnamese"
    rel="stylesheet">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <title><%= title %></title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">
  <style>
      /* CSS ph·ª• tr·ª£ ƒë·ªÉ icon v√† ch·ªØ th·∫≥ng h√†ng ƒë·∫πp h∆°n */
      .dropdown-menu a {
          display: flex !important; /* B·∫Øt bu·ªôc flex ƒë·ªÉ cƒÉn ch·ªânh */
          align-items: center;
          gap: 8px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
          white-space: nowrap;
      }
      .menu-icon {
          width: 20px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông icon ƒë·ªÉ ch·ªØ th·∫≥ng h√†ng d·ªçc */
          text-align: center;
          font-size: 16px;
      }
  </style>
</head>
<body>

 <div class="sticky-top-bar">
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">Web Mi·ªÅn</div>
                <nav class="nav">
                    <a href="/" class="<%= currentPage === 'home' ? 'active' : '' %>">üè† Trang Ch·ªß</a>
                    <a href="/fifo-checking" class="<%= currentPage === 'fifo-checking' ? 'active' : '' %>">üì¶ FIFO</a>
                    <a href="/newsfeed" class="<%= currentPage === 'newsfeed' ? 'active' : '' %>">üì∞ B·∫£ng tin</a>
    
                    <% /* --- [UPDATE] CH·ªà HCM.BD M·ªöI TH·∫§Y QU·∫¢N L√ù CTKM --- */ %>
                    <% if (user && (user.role === 'manager' || user.role === 'admin') && user.branch_code === 'HCM.BD') { %>
                        <a href="/promo-management" class="<%= currentPage === 'promo-management' ? 'active' : '' %>">‚öôÔ∏è QL CTKM</a>
                    <% } %>  
                </nav>
                     
                <% 
                    const utilityPages = [
                        'pc-builder', 'quote-builder', 'price-battle', 
                        'bom-check', 'bom-dashboard', 'clearance-check',
                        'event-operations', 'event-orders', 'event-settings', 'customer-care',
                        'queue-admin', 'queue-tv'
                    ];
                %>
                <div class="dropdown">
                    <a href="#" id="utilitiesDropdownToggle" style="display: flex; align-items: center; gap: 4px; color: white; text-decoration: none; padding: 6px 10px;" 
                       class="<%= utilityPages.includes(currentPage) ? 'active' : '' %>">
                        Ti·ªán √≠ch
                        <span style="font-size: 10px;">‚ñº</span>
                    </a>
                  
                    <div class="dropdown-menu" id="utilitiesDropdownMenu">
                      <div class="dropdown-submenu">
        <a href="#" class="dropdown-item" style="display: flex; justify-content: space-between; align-items: center;">
            <span>üë®‚Äçüîß Technician</span>
        </a>

        <div class="dropdown-menu-child">
            <a href="/queue/admin" class="dropdown-item">
                üéõ ƒêi·ªÅu ph·ªëi (Admin)
            </a>
            <a href="/queue/tv" target="_blank" class="dropdown-item">
                üì∫ M√†n h√¨nh TV (Hi·ªÉn th·ªã tr√™n Tivi)
            </a>
            <a href="/queue/report" class="dropdown-item">
    üìä B√°o c√°o D·ªãch v·ª•
</a>
        </div>
    </div>
    
                        <a href="/customer-care" class="<%= currentPage === 'customer-care' ? 'active' : '' %>">
                            <span class="menu-icon">üìû</span> CSKH
                        </a>
                        <a href="/pc-builder">
                            <span class="menu-icon">üñ•Ô∏è</span> Build PC
                        </a>
                        <a href="/quote-builder">
                            <span class="menu-icon">üìÑ</span> B√°o gi√° nhanh
                        </a>
                        
                        <a href="/clearance-check" class="<%= currentPage === 'clearance-check' ? 'active' : '' %>">
                            <span class="menu-icon">üè∑Ô∏è</span> H√†ng thanh l√Ω
                        </a>
                        <a href="/price-battle" class="<%= currentPage === 'price-battle' ? 'active' : '' %>">
                            <span class="menu-icon">‚öîÔ∏è</span> Chi·∫øn gi√°
                        </a>
                        <a href="/bom-check">
                            <span class="menu-icon">üîç</span> Check BOM
                        </a>
                        <a href="/bom-dashboard">
                            <span class="menu-icon">üìä</span> BOM Dashboard
                        </a>
                        <% if (locals.isBranchEventActive) { %>
                            <div style="border-top: 1px solid #eee; margin: 4px 0;"></div>
                            <a href="/event-operations" class="<%= ['event-operations', 'event-orders'].includes(currentPage) ? 'active' : '' %>">
                                <span class="menu-icon">üéâ</span> V·∫≠n h√†nh Event
                            </a>
                        <% } %>
                        <% /* 2. C√†i ƒë·∫∑t Event: Ch·ªâ d√†nh cho Admin/Manager thu·ªôc HCM.BD */ %>
                        <% if (user && (user.role === 'manager' || user.role === 'admin') && user.branch_code === 'HCM.BD') { %>
                            
                            <% /* N·∫øu ch∆∞a hi·ªán d√≤ng k·∫ª (do Event ko active) th√¨ hi·ªán d√≤ng k·∫ª ·ªü ƒë√¢y cho ƒë·∫πp */ %>
                            <% if (!locals.isBranchEventActive) { %>
                                <div style="border-top: 1px solid #eee; margin: 4px 0;"></div>
                            <% } %>

                            <a href="/admin/event-settings" class="<%= currentPage === 'event-settings' ? 'active' : '' %>">
                                <span class="menu-icon">‚öôÔ∏è</span> C√†i ƒë·∫∑t Event
                            </a>
                        <% } %>
                    </div>
                </div>

                <% /* === Ch·ªâ b√°o User Online: CH·ªà Manager/Admin c·ªßa HCM.BD m·ªõi th·∫•y === */ %>
                <% if (
                    locals.user && 
                    (user.role === 'manager' || user.role === 'admin') && 
                    user.branch_code === 'HCM.BD' &&  /* <--- ƒêI·ªÄU KI·ªÜN M·ªöI */
                    locals.onlineUserCount != null
                ) { %>
                  <style>
                    .online-user-indicator {
                      display: flex; align-items: center; gap: 6px;
                      color: #2ecc71; font-size: 14px; font-weight: 600;
                      margin-right: 15px; white-space: nowrap;
                    }
                    .online-user-indicator .dot {
                      width: 10px; height: 10px; background-color: #2ecc71;
                      border-radius: 50%; animation: pulse 1.5s infinite ease-in-out;
                    }
                    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
                  </style>
                  <div class="online-user-indicator">
                    <span class="dot"></span> Online: <strong><%= onlineUserCount %></strong>
                  </div>
                <% } %>
                <% if (user) { %>
    <div class="user-nav">
        <a href="/profile" class="user-info" style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
            <div class="user-avatar">
                <%= user.full_name ? user.full_name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase() %>
            </div>
            <span style="color: white; font-weight: 600;">
                <%= user.full_name || user.email %>
            </span>
        </a>
        
        <% /* N√∫t Sync BQ gi·ªØ nguy√™n */ %>
        <% if ((user.role === 'manager' || user.role === 'admin') && user.branch_code === 'HCM.BD') { %>
            <button type="button" class="btn btn-warning" id="btnSyncBigQuery" style="padding: 5px 10px; font-size: 0.8rem;">
            Sync BQ
            </button>
        <% } %>

        <form action="/logout" method="POST" style="display: inline;">
            <button type="submit" class="logout-btn">ƒêƒÉng xu·∫•t</button>
        </form>
    </div>
<% } else { %>
                    <div class="user-nav">
                        <a href="/login" style="color: white; text-decoration: none;">ƒêƒÉng nh·∫≠p</a>
                    </div>
                <% } %>
            </div>
        </div>
    </header>

    <% if (globalTickerText) { %>
      <div class="ticker-container">
        <div class="ticker-content"><%= globalTickerText %></div>
      </div>
    <% } %>

  </div> 

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Logic dropdown "Ti·ªán √≠ch"
        const utilsToggleButton = document.getElementById('utilitiesDropdownToggle');
        const utilsDropdownMenu = document.getElementById('utilitiesDropdownMenu');
        if (utilsToggleButton && utilsDropdownMenu) {
            utilsToggleButton.addEventListener('click', function(event) {
                event.preventDefault(); 
                utilsDropdownMenu.classList.toggle('open');
            });
            document.addEventListener('click', function(event) {
                const isClickInsideToggle = utilsToggleButton.contains(event.target);
                const isClickInsideMenu = utilsDropdownMenu.contains(event.target);
                if (!isClickInsideToggle && !isClickInsideMenu) {
                    utilsDropdownMenu.classList.remove('open');
                }
            });
        }
    });

    // Logic ·∫©n header khi cu·ªôn
    document.addEventListener('DOMContentLoaded', () => {
      const stickyBar = document.querySelector('.sticky-top-bar');
      if (stickyBar) {
        let lastScrollTop = 0;
        const scrollThreshold = 100; 
        window.addEventListener('scroll', () => {
          let st = window.pageYOffset || document.documentElement.scrollTop;
          if (st > lastScrollTop && st > scrollThreshold) {
            stickyBar.classList.add('sticky-top-bar--hidden');
          } else if (st < lastScrollTop) {
            stickyBar.classList.remove('sticky-top-bar--hidden');
          }
          lastScrollTop = st <= 0 ? 0 : st;
        }, { passive: true });
      }
    });

    const syncButton = document.getElementById('btnSyncBigQuery');
    if (syncButton) {
        syncButton.addEventListener('click', async () => {
          if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªìng b·ªô SKUs t·ª´ BigQuery?\nVi·ªác n√†y s·∫Ω ch√®n c√°c SKU m·ªõi v√†o h·ªá th·ªëng.')) return;
          
          syncButton.disabled = true;
          syncButton.textContent = 'ƒêang sync...';
          try {
            const res = await fetch('/api/admin/sync-bq-skus', { method: 'POST' });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
            alert(`ƒê·ªìng b·ªô th√†nh c√¥ng!\nƒê√£ th√™m m·ªõi: ${data.new_skus} SKU.`);
          } catch (err) {
            alert('L·ªói ƒë·ªìng b·ªô: ' + err.message);
          } finally {
            syncButton.disabled = false;
            syncButton.textContent = 'Sync BQ';
          }
        });
    }
  </script>
  <main class="main-content">
    <div class="container">
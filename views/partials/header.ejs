<% /* views/partials/header.ejs (ƒê√£ c·∫≠p nh·∫≠t) */ %>
<!DOCTYPE html>
<html lang="vi">
<head>
  <% /* ... (ph·∫ßn <head> c·ªßa b·∫°n gi·ªØ nguy√™n) ... */ %>
  <meta charset="utf-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap&subset=vietnamese"
    rel="stylesheet">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <title><%= title %></title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">
</head>
<body>

  <% /* === B∆Ø·ªöC 1: TH√äM WRAPPER M·ªöI === */ %>
  <div class="sticky-top-bar">

    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">H·ªá th·ªëng CTKM</div>
                  <nav class="nav">
    <a href="/" class="<%= currentPage === 'home' ? 'active' : '' %>">Trang Ch·ªß</a>
    <a href="/fifo-checking" class="<%= currentPage === 'fifo-checking' ? 'active' : '' %>">FIFO Checking</a>
    <a href="/newsfeed" class="<%= currentPage === 'newsfeed' ? 'active' : '' %>">B·∫£ng tin</a>
    
    <% if (user && (user.role === 'manager' || user.role === 'admin')) { %>
        <a href="/promo-management" class="<%= currentPage === 'promo-management' ? 'active' : '' %>">Qu·∫£n l√Ω CTKM</a>
    <% } %>  
                    </nav>
                     
                <% 
    // M·∫£ng n√†y ch·ª©a T·∫§T C·∫¢ c√°c trang con thu·ªôc "Ti·ªán √≠ch"
    const utilityPages = [
        'pc-builder', 'quote-builder', 'price-battle', 
        'bom-check', 'bom-dashboard', 'clearance-check',
        'event-operations', 'event-orders', 'event-settings'
    ];
%>
<div class="dropdown">
    
    <a href="#" id="utilitiesDropdownToggle" style="display: flex; align-items: center; gap: 4px; color: white; text-decoration: none; padding: 6px 10px;" 
       class="<%= utilityPages.includes(currentPage) ? 'active' : '' %>">
        Ti·ªán √≠ch
        <span style="font-size: 10px;">‚ñº</span>
    </a>
                  
    <div class="dropdown-menu" id="utilitiesDropdownMenu">
        <a href="/customer-care" class="<%= currentPage === 'customer-care' ? 'active' : '' %>">
        üìû ChƒÉm s√≥c kh√°ch h√†ng
      </a>
        <a href="/pc-builder">Build PC (Linh ki·ªán)</a>
        <a href="/quote-builder">B√°o gi√° nhanh (SKU)</a>
        <a href="/price-battle" class="<%= currentPage === 'price-battle' ? 'active' : '' %>">Chi·∫øn gi√°</a>
        <a href="/bom-check">Check BOM (Tra c·ª©u)</a>
        <a href="/bom-dashboard">BOM Dashboard (T·ªïng h·ª£p)</a>
        
        <a href="/clearance-check" class="<%= currentPage === 'clearance-check' ? 'active' : '' %>">Tra c·ª©u H√†ng thanh l√Ω</a>

        <% if (user && (user.role === 'manager' || user.role === 'admin')) { %>
            <a href="/event-operations" class="<%= ['event-operations', 'event-orders'].includes(currentPage) ? 'active' : '' %>">V·∫≠n h√†nh Event</a>
            <a href="/admin/event-settings" class="<%= currentPage === 'event-settings' ? 'active' : '' %>">C√†i ƒë·∫∑t Event</a>
        <% } %>
    </div>
</div>

                    
                <% /* === B·∫ÆT ƒê·∫¶U: Ch·ªâ b√°o User Online === */ %>
<% if (
    locals.user && 
    (user.role === 'manager' || user.role === 'admin') && 
    locals.onlineUserCount != null 
) { %>

  <style>
    /* Th√™m CSS n√†y ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp h∆°n */
    .online-user-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #2ecc71; /* M√†u xanh l√° */
      font-size: 14px;
      font-weight: 600;
      margin-right: 15px; /* ƒêi·ªÅu ch·ªânh kho·∫£ng c√°ch */
      white-space: nowrap; /* Tr√°nh v·ª° d√≤ng */
    }
    .online-user-indicator .dot {
      width: 10px;
      height: 10px;
      background-color: #2ecc71;
      border-radius: 50%;
      animation: pulse 1.5s infinite ease-in-out;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
  </style>

  <div class="online-user-indicator">
    <span class="dot"></span>
    Online: <strong><%= onlineUserCount %></strong>
  </div>

<% } %>
                <% if (user) { %>
                    <div class="user-nav">
                        <div class="user-info">
                            <div class="user-avatar"><%= user.full_name ? user.full_name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase() %></div>
                            <span><%= user.full_name || user.email %></span>
                        </div>
                     
                       <% if (user.role === 'manager' || user.role === 'admin') { %>
                          <button type="button" class="btn btn-warning" id="btnSyncBigQuery" style="padding: 5px 10px; font-size: 0.8rem;">
                            Sync BQ
                          </button>
                        <% } %>

                        <form action="/logout" method="POST" style="display: inline;">
                            <button type="submit" class="logout-btn">ƒêƒÉng xu·∫•t</button>
                        </form>
                    </div>
                <% } else { %>
                    <div class="user-nav">
                        <a href="/login" style="color: white; text-decoration: none;">ƒêƒÉng nh·∫≠p</a>
                    </div>
                <% } %>
            </div>
        </div>
    </header>

    <% if (globalTickerText) { %>
      <div class="ticker-container">
        <div class="ticker-content">
          <%= globalTickerText %>
        </div>
      </div>
    <% } %>

  </div> 
  <% /* === K·∫æT TH√öC WRAPPER M·ªöI === */ %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Logic for "Ti·ªán √≠ch"
    const utilsToggleButton = document.getElementById('utilitiesDropdownToggle');
    const utilsDropdownMenu = document.getElementById('utilitiesDropdownMenu');
    if (utilsToggleButton && utilsDropdownMenu) {
        utilsToggleButton.addEventListener('click', function(event) {
            event.preventDefault(); 
            utilsDropdownMenu.classList.toggle('open');
        });
        document.addEventListener('click', function(event) {
            const isClickInsideToggle = utilsToggleButton.contains(event.target);
            const isClickInsideMenu = utilsDropdownMenu.contains(event.target);
            if (!isClickInsideToggle && !isClickInsideMenu) {
                utilsDropdownMenu.classList.remove('open');
            }
        });
    }
    
    // (M·ªöI) Logic for "Qu·∫£n tr·ªã"
    const adminToggleButton = document.getElementById('adminDropdownToggle');
    const adminDropdownMenu = document.getElementById('adminDropdownMenu');
    if (adminToggleButton && adminDropdownMenu) {
        adminToggleButton.addEventListener('click', function(event) {
            event.preventDefault(); 
            adminDropdownMenu.classList.toggle('open');
            
            // (M·ªöI) ƒê√≥ng menu "Ti·ªán √≠ch" n·∫øu n√≥ ƒëang m·ªü
            if (utilsDropdownMenu) utilsDropdownMenu.classList.remove('open');
        });
        document.addEventListener('click', function(event) {
            const isClickInsideToggle = adminToggleButton.contains(event.target);
            const isClickInsideMenu = adminDropdownMenu.contains(event.target);
            if (!isClickInsideToggle && !isClickInsideMenu) {
                adminDropdownMenu.classList.remove('open');
            }
        });
    }
    
    // (M·ªöI) ƒê·∫£m b·∫£o 2 dropdown kh√¥ng m·ªü c√πng l√∫c
    if (utilsToggleButton) {
      utilsToggleButton.addEventListener('click', () => {
        if (adminDropdownMenu) adminDropdownMenu.classList.remove('open');
      });
    }

});
</script>

  <script>
    (function tick(){
      var el = document.getElementById('local-time');
      if (el) {
        var now = new Date();
        el.textContent = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
      }
      setTimeout(tick, 60 * 1000);
    })();

    /* === B∆Ø·ªöC 3: TH√äM JAVASCRIPT ·∫®N HEADER === */
    document.addEventListener('DOMContentLoaded', () => {
      const stickyBar = document.querySelector('.sticky-top-bar');
      if (stickyBar) {
        let lastScrollTop = 0;
        const scrollThreshold = 100; // Ph·∫£i cu·ªôn 100px m·ªõi ·∫©n

        window.addEventListener('scroll', () => {
          let st = window.pageYOffset || document.documentElement.scrollTop;

          if (st > lastScrollTop && st > scrollThreshold) {
            // Cu·ªôn XU·ªêNG
            stickyBar.classList.add('sticky-top-bar--hidden');
          } else if (st < lastScrollTop) {
            // Cu·ªôn L√äN
            stickyBar.classList.remove('sticky-top-bar--hidden');
          }
          lastScrollTop = st <= 0 ? 0 : st;
        }, { passive: true }); // passive: true ƒë·ªÉ cu·ªôn m∆∞·ª£t h∆°n
      }
    });
    /* === H·∫æT SCRIPT ·∫®N HEADER === */

    const syncButton = document.getElementById('btnSyncBigQuery');
  if (syncButton) {
    syncButton.addEventListener('click', async () => {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªìng b·ªô SKUs t·ª´ BigQuery?\nVi·ªác n√†y s·∫Ω ch√®n c√°c SKU m·ªõi v√†o h·ªá th·ªëng.')) {
        return;
      }
      syncButton.disabled = true;
  syncButton.textContent = 'ƒêang sync...';
  try {
    const res = await fetch('/api/admin/sync-bq-skus', { method: 'POST' });
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
    }
    alert(`ƒê·ªìng b·ªô th√†nh c√¥ng!\nƒê√£ th√™m m·ªõi: ${data.new_skus} SKU.`);
    
  } catch (err) {
    alert('L·ªói ƒë·ªìng b·ªô: ' + err.message);
  } finally {
    syncButton.disabled = false;
    syncButton.textContent = 'Sync BQ';
  }
});
}
  </script>

  <main class="main-content">
    <div class="container">
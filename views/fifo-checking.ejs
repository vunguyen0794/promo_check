<%- include('partials/header', { title, currentPage }) %>

<div class="container">
    <div class="dash-card" style="max-width: 1100px; margin: 0 auto 20px;">
        <div class="dash-title">FIFO Checking (Branch: <%= userBranch %>)</div>

        <div style="font-size:14px; color:#64748b; margin-bottom:12px;">
    D·ªØ li·ªáu t·ªìn kho T-1 ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o ng√†y: <strong><%= todayDate %></strong>.
Vui l√≤ng tick v√†o "ƒê√£ xu·∫•t" ƒë·ªÉ ghi nh·∫≠n Serial ƒë√£ b√°n trong ng√†y.
</div>

<style>
    #filterSerial {
        display: none;
    }
    .fifo-filters {
        display: flex;
        flex-wrap: wrap; 
        gap: 10px;
        align-items: center;
    }
    .fifo-filters .master-input {
        flex: 1 1 250px;
    }
    .fifo-filters .btn, .fifo-filters .info-select {
        flex: 1 1 auto;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .filter-group {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .filter-group .info-select, .filter-group .search-input {
        flex: 1 1 150px;
    }
    .gift-filter-label { /* D√πng chung cho c√°c checkbox label */
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        color: #334155;
        flex-shrink: 0;
        padding: 5px;
        cursor: pointer; /* Th√™m con tr·ªè */
    }

    /* Gi·ªõi h·∫°n chi·ªÅu cao v√† cu·ªôn b·∫£ng */
    .table-scroll-wrapper {
        overflow: auto; /* Cu·ªôn c·∫£ ngang v√† d·ªçc */
        max-height: 65vh; /* Gi·ªõi h·∫°n chi·ªÅu cao */
        position: relative; /* C·∫ßn cho header sticky */
        border: 1px solid #e5e7eb; /* Th√™m vi·ªÅn */
        border-radius: 12px; /* Bo g√≥c */
    }
    .dash-table thead th {
        /* Header c·ªë ƒë·ªãnh khi cu·ªôn d·ªçc */
        position: sticky;
        top: 0; 
        z-index: 10;
        background-color: #f8fafc;
        border-bottom: 1px solid #e5e7eb; /* Th√™m border d∆∞·ªõi */
    }
    /* C·ªë ƒë·ªãnh c·ªôt STT (c·ªôt ƒë·∫ßu ti√™n) khi cu·ªôn ngang */
    .dash-table th:first-child,
    .dash-table td:first-child {
        position: sticky;
        left: 0;
        z-index: 9;
        background-color: #ffffff; /* N·ªÅn tr·∫Øng cho TD */
        border-right: 1px solid #f1f5f9; 
    }
    .dash-table th:first-child {
        z-index: 11; /* N·ªïi l√™n tr√™n header kh√°c */
        background-color: #f8fafc; /* N·ªÅn gi·ªëng header */
    }
    
    /* CSS cho Wrap Text Toggle */
    .dash-table.no-wrap td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông khi kh√¥ng wrap */
    }
    /* ∆Øu ti√™n wrap cho n√∫t Serial/SKU ngay c·∫£ khi no-wrap */
    .dash-table.no-wrap td button.serial-cell-btn,
    .dash-table.no-wrap td button.sku-cell-btn {
         white-space: nowrap; 
         overflow: hidden;
         text-overflow: ellipsis;
         display: block; /* ƒê·ªÉ ellipsis ho·∫°t ƒë·ªông */
         width: 100%; /* Chi·∫øm h·∫øt √¥ */
    }
    /* ‚≠ê M·ªöI: ƒê·∫∑t min-width cho c·ªôt Serial (th·ª© 2) */
    .dash-table th:nth-child(2), 
    .dash-table td:nth-child(2) {
        min-width: 100px; /* TƒÉng chi·ªÅu r·ªông t·ªëi thi·ªÉu */
    }
    .dash-table td button.serial-cell-btn { /* N√∫t serial */
        white-space: normal;
        word-break: break-all; 
        /* Reset style n√∫t */
        display: inline-block; text-align: left; padding: 4px 6px;
        font-weight: 700; line-height: 1.4; background: none; border: none;
        color: #0f172a; cursor: pointer; min-height: 0;
        /* ƒê·∫£m b·∫£o n√∫t chi·∫øm ƒë·ªß chi·ªÅu r·ªông */
        width: 100%; 
    }
     .dash-table td button.sku-cell-btn { /* Style cho n√∫t SKU */
        padding: 4px 10px; font-size: 13px; font-weight: 600;
        /* K·∫ø th·ª´a t·ª´ .btn-primary */
        background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .serial-cell-btn:hover { background: #eef2ff; color: #3730a3; }
    .sku-cell-btn:hover { background-color: #1557b0; }


    /* CSS cho Modal Qu√©t */
    #scanModal { display: none; align-items: center; justify-content: center; }
    #qr-reader { width: 90%; max-width: 400px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
</style>

<div class="fifo-filters" style="border-bottom:1px solid #e5e7eb; padding-bottom:15px; margin-bottom:15px;">
    
    <input type="text" id="masterInput" name="master_query" placeholder="Nh·∫≠p SKU, Serial, T√™n SP, Brand, BIN (Location)"
           class="search-input master-input">
    
    <button class="btn btn-info" id="btnScan" type="button">
        üì∑ Qu√©t
    </button>
    
    <button class="btn btn-primary" id="btnSearchSku" type="button">
        Tra c·ª©u
    </button>
    
 
   <button class="btn btn-secondary" type="button" id="btnReset">
        T·∫£i l·∫°i t·ªìn
    </button>
    
    <label for="filterGift" class="gift-filter-label">
        <input type="checkbox" id="filterGift" style="width:16px; height:16px;" checked>
        Bao g·ªìm qu√† t·∫∑ng
    </label>

    <label for="filterCheckedOut" class="gift-filter-label">
        <input type="checkbox" id="filterCheckedOut" style="width:16px; height:16px;">
        ·∫®n Serial ƒë√£ xu·∫•t
    </label>
    
    <label for="toggleWrap" class="gift-filter-label">
        <input type="checkbox" id="toggleWrap" style="width:16px; height:16px;" checked>
        Wrap Text
    </label>
</div>

<div class="fifo-filters filter-group">
    <input type="text" id="filterSerial" class="search-input" placeholder="L·ªçc theo Serial">
    <select id="filterSubcategory" class="info-select"><option value="">-- SubCategory --</option></select>
    <select id="filterBrand" class="info-select"><option value="">-- Brand --</option></select>
    <select id="filterLocation" class="info-select"><option value="">-- Location --</option></select>
   
 <select id="filterBinZone" class="info-select"><option value="">-- Bin Zone --</option></select>
</div>

<div id="rankInfoCard" class="dash-card" style="margin-top: 15px; background-color: #e0f2fe; border-color: #7dd3fc;
display: none;">
    {/* N·ªôi dung rank s·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t v√†o ƒë√¢y */}
</div>

<div id="resultsContainer">
    </div>

<div id="paginationContainer" style="margin-top: 15px; text-align: center;">
    </div>

<div id="historyModal" class="modal" onclick="if(event.target.id === 'historyModal') hideHistoryModal()">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="hideHistoryModal()">&times;</span>
        <h3 class="section-title" style="border-bottom:none;
margin-top:10px;">L·ªãch s·ª≠ Serial: <span id="historySerial"></span></h3>
        <div id="historyBody">ƒêang t·∫£i...</div>
    </div>
</div>

<div id="scanModal" class="modal" onclick="if(event.target.id === 'scanModal') hideScanModal()">
    <div id="scanModalBody">
    <div id="qr-reader" style="width: 90%; max-width: 400px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    </div>

    <div id="scanResultContainer" style="display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center;">
        <h4 style="margin-top: 0; font-size: 16px;">K·∫øt qu·∫£ qu√©t:</h4>
        <strong id="scanResultText" style="font-size: 18px; color: #1a73e8; word-break: break-all; margin-bottom: 20px; display: block;"></strong>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button type="button" class="btn btn-secondary" id="btnRescan">Qu√©t l·∫°i</button>
            <button type="button" class="btn btn-primary" id="btnConfirmScan">D√πng m√£ n√†y</button>
        </div>
    </div>
</div>
</div>


<%- include('partials/toast') %>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>

<%- include('partials/footer') %>


<script>
    const userBranch = '<%= userBranch %>';
    const checkDate = '<%= todayDate %>';
    const resultsContainer = document.getElementById('resultsContainer');
    const historyModal = document.getElementById('historyModal');
    const rankInfoCard = document.getElementById('rankInfoCard');
    const paginationContainer = document.getElementById('paginationContainer');

    let allSerials = []; 
    const isAdminBranch = '<%= isGlobalAdmin ? "true" : "false" %>';

    let currentPage = 1;
    const pageSize = 50;
    
    let currentTotalBranchCount = 0;
    let countError = false;

    function formatCurrency(n) {
        return new Intl.NumberFormat('vi-VN', { maximumFractionDigits: 0 }).format(Number(n ||
 0)) + '‚Ç´';
    }
   
    function getHeatmapColor(days) {
        if (days > 90) return '#fecaca';
        if (days > 60) return '#fee2e2'; 
        if (days > 45) return '#ffedd5'; 
        if (days > 30) return '#fef3c7';  
        return 'transparent';
    }

    // === H√ÄM M·ªöI: T·∫£i t·∫•t c·∫£ c√°c t√πy ch·ªçn cho b·ªô l·ªçc ===
    async function populateDropdowns() {
        const giftFilter = document.getElementById('filterGift').checked ? 'all' : 'no';
        const selects = {
            filterSubcategory: document.getElementById('filterSubcategory'),
            filterBrand: document.getElementById('filterBrand'),
            filterLocation: document.getElementById('filterLocation'),
            filterBinZone: document.getElementById('filterBinZone'),
        };
        
        // Gi·ªØ l·∫°i gi√° tr·ªã ƒëang ch·ªçn
        const currentValues = {
            subcategory: selects.filterSubcategory.value,
            brand: selects.filterBrand.value,
            location: selects.filterLocation.value,
            bin_zone: selects.filterBinZone.value,
        };

        // Reset HTML v·ªÅ m·∫∑c ƒë·ªãnh
        selects.filterSubcategory.innerHTML = '<option value="">-- SubCategory --</option>';
        selects.filterBrand.innerHTML = '<option value="">-- Brand --</option>';
        selects.filterLocation.innerHTML = '<option value="">-- Location --</option>';
        selects.filterBinZone.innerHTML = '<option value="">-- Bin Zone --</option>';
        
        try {
            const response = await fetch(`/api/fifo/filters?giftFilter=${giftFilter}`);
            const data = await response.json();
            if (!data.ok) throw new Error(data.error || 'L·ªói t·∫£i b·ªô l·ªçc');

            const { subcategories, brands, locations, bin_zones } = data.filters;

            subcategories.forEach(opt => selects.filterSubcategory.innerHTML += `<option value="${opt}">${opt}</option>`);
            brands.forEach(opt => selects.filterBrand.innerHTML += `<option value="${opt}">${opt}</option>`);
            locations.forEach(opt => selects.filterLocation.innerHTML += `<option value="${opt}">${opt}</option>`);
            bin_zones.forEach(opt => selects.filterBinZone.innerHTML += `<option value="${opt}">${opt}</option>`);

            // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn (n·∫øu c√≤n t·ªìn t·∫°i)
            selects.filterSubcategory.value = currentValues.subcategory;
            selects.filterBrand.value = currentValues.brand;
            selects.filterLocation.value = currentValues.location;
            selects.filterBinZone.value = currentValues.bin_zone;

        } catch (error) {
            console.error("L·ªói khi t·∫£i b·ªô l·ªçc:", error);
            showToast('L·ªói khi t·∫£i danh s√°ch b·ªô l·ªçc.', 'error');
        }
    }


    // H√ÄM CH√çNH: T·∫£i d·ªØ li·ªáu
    async function loadSerials(masterQuery = '', targetPage = 1) {
        
        currentPage = targetPage;
        const includeGifts = document.getElementById('filterGift')?.checked ?? false;
        const hideCheckedOut = document.getElementById('filterCheckedOut')?.checked ?? false;
        const subcategory = document.getElementById('filterSubcategory').value;
        const brand = document.getElementById('filterBrand').value;
        const location = document.getElementById('filterLocation').value;
        const binZone = document.getElementById('filterBinZone').value;

        const params = new URLSearchParams();
        params.append('q', masterQuery);
        params.append('giftFilter', includeGifts ? 'all' : 'no'); 
        params.append('hideCheckedOut', hideCheckedOut ? 'true' : 'false');
        params.append('page', targetPage);

        if (subcategory) params.append('subcategory', subcategory);
        if (brand) params.append('brand', brand);
        if (location) params.append('location', location);
        if (binZone) params.append('bin_zone', binZone);

        const url = `/api/fifo/serials?${params.toString()}`;
        
        resultsContainer.innerHTML = '<div class="dash-muted" style="text-align:center;padding:20px;">ƒêang t·∫£i...</div>';
        paginationContainer.innerHTML = '';
        if (rankInfoCard) rankInfoCard.style.display = 'none';
        
        if (targetPage === 1) {
            countError = false;
            currentTotalBranchCount = 0;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.status} (${response.statusText})`);
            
            const data = await response.json();
            if (!data.ok) throw new Error(data.error || 'L·ªói t·∫£i d·ªØ li·ªáu.');
            
            allSerials = data.serials;
            const totalItems = data.total; 
            const rankInfo = data.rankInfo;
            
            if (data.totalBranchCount !== -1) {
                currentTotalBranchCount = data.totalBranchCount;
            } else {
                countError = true;
                currentTotalBranchCount = 0;
            }

            if (masterQuery && allSerials.length === 0 && typeof showToast === 'function') {
                showToast('Kh√¥ng t√¨m th·∫•y serial n√†o kh·ªõp.', 'info');
            }

            if (rankInfo && rankInfoCard) {
                 rankInfoCard.innerHTML = `‚≠ê Serial <strong>${rankInfo.serial}</strong> (SKU: ${rankInfo.sku}) l√† h√†ng t·ªìn kho c≈© th·ª© <strong>${rankInfo.rank}</strong> trong t·ªïng s·ªë <strong>${rankInfo.total}</strong> serial 
 c√πng lo·∫°i (ch∆∞a xu·∫•t) t·∫°i ${isAdminBranch === 'true' ? 't·∫•t c·∫£ chi nh√°nh' : 'chi nh√°nh n√†y'}.`;
                 rankInfoCard.style.display = 'block';
            }

            // === B·ªé H√ÄM updateFilters(allSerials); ===
            
            renderSerials(allSerials, totalItems); 
            renderPagination(currentPage, totalItems, pageSize);
        } catch (error) {
            console.error("Error in loadSerials:", error);
            countError = true; 
            currentTotalBranchCount = 0;
            if (resultsContainer) resultsContainer.innerHTML = `<div class="error-message">L·ªói: ${error.message}</div>`;
            if (rankInfoCard) rankInfoCard.style.display = 'none';
        }
    }

    // === H√ÄM updateFilters B·ªä X√ìA (ƒë√£ thay b·∫±ng populateDropdowns) ===

    // H√†m l·ªçc theo SKU
    function filterBySku(sku) {
        document.getElementById('masterInput').value = sku;
        loadSerials(sku, 1);
    }
    
    // H√†m l·ªçc theo Serial
    function filterBySerial(serial) {
        document.getElementById('masterInput').value = serial;
        loadSerials(serial, 1);
    }

    function handleWrapToggle() {
        const isWrapEnabled = document.getElementById('toggleWrap').checked;
        const table = resultsContainer.querySelector('.dash-table');
        if (table) {
            if (isWrapEnabled) {
                table.classList.remove('no-wrap');
            } else {
                table.classList.add('no-wrap');
            }
        }
    }

    function renderSerials(serials, totalItems) {
        if (!serials || serials.length === 0) {
             if (totalItems > 0) {
                 resultsContainer.innerHTML = `<div class="dash-muted" style="text-align:center;padding:20px;">Kh√¥ng c√≥ serial n√†o tr√™n trang n√†y.
 T·ªïng c·ªông: ${totalItems}.</div>`;
             } else {
                 resultsContainer.innerHTML = `<div class="dash-muted" style="text-align:center;padding:20px;">Kh√¥ng t√¨m th·∫•y Serial t·ªìn kho n√†o theo b·ªô l·ªçc.</div>`;
             }
            return;
        }

        const isWrapEnabled = document.getElementById('toggleWrap').checked;
        const tableWrapClass = isWrapEnabled ? '' : 'no-wrap';
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + serials.length;

        let html = `
            <div style="margin-bottom: 12px; font-weight: 600;">
                Hi·ªÉn th·ªã ${startIndex + 1} - ${endIndex} tr√™n t·ªïng s·ªë ${totalItems} serial:
            </div>
            <div class="table-scroll-wrapper">
                <table class="dash-table ${tableWrapClass}" style="min-width: 1200px;"> <thead>
                       <tr>
                            <th style="width: 50px;">STT</th>
                            <th style="width: 160px; min-width: 160px;">Serial</th> <th style="width: 100px;">Ng√†y nh·∫≠p kho</th>
                            <th style="width: 80px;">S·ªë ng√†y t·ªìn</th>
                            <th style="width: 80px;">ƒê√£ xu·∫•t</th>
                            <th style="width: 100px;">Location</th>
                            <th style="width: 100px;">Bin Zone</th>
                            <th style="width: 120px;">SKU</th>
                            <th>T√™n SP</th>
                            <th style="width: 80px;">Brand</th>
                            <th style="width: 120px;">Subcat</th>
                            <th style="width: 80px;">Branch</th> 
                            <th style="width: 60px;">L.S·ª≠</th> 
                       </tr>
                    </thead>
                    <tbody>
        `;
        
        serials.forEach((item, index) => {
            let dateIn = '-';
            if (item.date_in) {
                const parts = item.date_in.split('-'); 
                if (parts.length === 3) {
                    dateIn = `${parts[2]}/${parts[1]}/${parts[0]}`; 
                }
            }
            
            const daysOld = item.days_old || 0; 
            const isChecked = item.is_checked_out;
            const heatmapColor = getHeatmapColor(daysOld);
 
            html += `
                <tr>
                    <td>${startIndex + index + 1}</td>
                    <td>
                        <button type="button" class="serial-cell-btn" 
                                onclick="filterBySerial('${item.serial}')" 
                                title="L·ªçc theo Serial n√†y">
                            ${item.serial}
                        </button>
                    </td>
                    <td>${dateIn}</td>
                    <td style="font-weight:700; background-color:${heatmapColor};">${daysOld > 0 ? daysOld : '-'}</td>
                    <td>
                        <input type="checkbox" id="check-${item.serial}" 
                               data-serial="${item.serial}" 
                               data-sku="${item.sku}"
                               data-branch="${item.branch_id}"
                               onchange="toggleCheck(this)"
                               ${isChecked ? 'checked' : ''}>
                        <label for="check-${item.serial}">${isChecked ? 'ƒê√£ xu·∫•t' : 'C√≤n t·ªìn'}</label>
                    </td>
                    <td>${item.location || '-'}</td>
                    <td>${item.bin_zone || '-'}</td>
                    <td>
                        <button type="button" class="sku-cell-btn" 
                                onclick="filterBySku('${item.sku}')" title="L·ªçc theo SKU n√†y">
                            ${item.sku}
                        </button>
                    </td>
                    <td>${item.sku_name || '-'}</td>
                    <td>${item.brand || '-'}</td>
                    <td>${item.subcategory_name || '-'}</td>
                    <td>${item.branch_id || '-'}</td> 
                    <td>
                        <button type="button" class="btn btn-info" style="padding:3px 8px; font-size:12px; line-height: 1.2;"
                                onclick="showHistoryModal('${item.serial}')" title="L·ªãch s·ª≠ Serial">
                            üïò
                        </button>
                    </td>
                </tr>
            `;
        });
        html += `</tbody></table></div>`;
        resultsContainer.innerHTML = html;
    }

    function renderPagination(page, totalItems, size) {
         const totalPages = Math.ceil(totalItems / size);
         paginationContainer.innerHTML = ''; 
         if (totalPages <= 1) return; 

         let paginationHTML = `
             <div class="pagination-controls">
                 <button class="btn btn-secondary" id="prevPage" ${page === 1 ? 'disabled' : ''}>&lt; Tr∆∞·ªõc</button>
                 <span class="page-info">Trang ${page} / ${totalPages}</span>
                 <button class="btn btn-secondary" id="nextPage" ${page === totalPages ? 'disabled' : ''}>Sau &gt;</button>
             </div>
         `;
         paginationContainer.innerHTML = paginationHTML;

         const prevButton = document.getElementById('prevPage');
         const nextButton = document.getElementById('nextPage');
         const masterQueryValue = document.getElementById('masterInput').value.trim();

         if (prevButton) {
             prevButton.addEventListener('click', () => {
                 if (currentPage > 1) {
                     loadSerials(masterQueryValue, currentPage - 1);
                 }
             });
         }
         if (nextButton) {
             nextButton.addEventListener('click', () => {
                 if (currentPage < totalPages) {
                     loadSerials(masterQueryValue, currentPage + 1);
                 }
             });
         }
    }

    async function toggleCheck(checkbox) {
        const serial = checkbox.dataset.serial;
        const sku = checkbox.dataset.sku;
        const branch = checkbox.dataset.branch;
        const is_checked_out = checkbox.checked;
        const label = checkbox.nextElementSibling;
        checkbox.disabled = true;
        try {
            const response = await fetch('/api/fifo/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    serial, sku, branch_code: branch,
                    check_date: checkDate, is_checked_out
                })
            });
            const data = await response.json();
            if (!data.ok) throw new Error(data.error || 'L·ªói l∆∞u log.');
            label.textContent = is_checked_out ? 'ƒê√£ xu·∫•t' : 'C√≤n t·ªìn';
            showToast('L∆∞u tr·∫°ng th√°i th√†nh c√¥ng!', 'success');

            const item = allSerials.find(s => s.serial === serial);
            if(item) item.is_checked_out = is_checked_out;
            
            if (document.getElementById('filterCheckedOut').checked) {
                triggerLoad(currentPage); 
            }

        } catch (error) {
            checkbox.checked = !is_checked_out;
            label.textContent = is_checked_out ? 'C√≤n t·ªìn' : 'ƒê√£ xu·∫•t';
            showToast('L·ªói: ' + error.message, 'error');
        } finally {
            checkbox.disabled = false;
        }
    }
    
    function triggerLoad(targetPage = 1) { 
        const masterQuery = document.getElementById('masterInput').value.trim();
        loadSerials(masterQuery, targetPage); 
    }

    async function showHistoryModal(serial) {
        document.getElementById('historySerial').textContent = serial;
        document.getElementById('historyBody').innerHTML = 'ƒêang t·∫£i...';
        historyModal.style.display = 'flex';
        try {
            const response = await fetch(`/api/fifo/history/${serial}`);
            const data = await response.json();
            if (!data.ok) throw new Error(data.error || 'L·ªói t·∫£i l·ªãch s·ª≠.');
            if (!data.history.length) {
                document.getElementById('historyBody').innerHTML = '<div class="dash-muted" style="text-align:center;padding:20px;">Ch∆∞a c√≥ l·ªãch s·ª≠ xu·∫•t kho.</div>';
                return;
            }
            let html = '<ul style="list-style:none;padding:0;">';
            data.history.forEach(log => {
                const date = new Date(log.checked_at).toLocaleDateString('vi-VN');
                const time = new Date(log.checked_at).toLocaleTimeString('vi-VN');
                html += `
                    <li style="padding:8px 0; border-bottom:1px solid #eee; font-size:14px;">
                         <strong>${date} ${time}</strong>: ƒê√£ xu·∫•t t·∫°i Branch <strong>${log.branch_code}</strong> b·ªüi 
                         <span class="pill">${log.checked_by_name}</span> (T·ªìn kho ng√†y: ${log.check_date})
                    </li>
                `;
            });
            html += '</ul>';
            document.getElementById('historyBody').innerHTML = html;
        } catch (error) {
            document.getElementById('historyBody').innerHTML = `<div class="error-message">L·ªói: ${error.message}</div>`;
        }
    }

    function hideHistoryModal() {
        historyModal.style.display = 'none';
    }


    // === G√ÅN S·ª∞ KI·ªÜN CHO C√ÅC N√öT B·∫§M (C·∫¨P NH·∫¨T) ===
    
    document.getElementById('btnSearchSku').addEventListener('click', () => triggerLoad(1));

    // N√∫t "T·∫£i l·∫°i t·ªìn" (Reset)
    document.getElementById('btnReset').addEventListener('click', async function() {
        document.getElementById('masterInput').value = '';
        
        // === S·ª¨A: Ch·ªâ reset gi√° tr·ªã, kh√¥ng x√≥a option ===
        document.getElementById('filterSubcategory').value = '';
        document.getElementById('filterBrand').value = '';
        document.getElementById('filterLocation').value = '';
        document.getElementById('filterBinZone').value = '';
        // ===============================================

        document.getElementById('filterGift').checked = true; // M·∫∑c ƒë·ªãnh true
        document.getElementById('filterCheckedOut').checked = false;
        document.getElementById('toggleWrap').checked = true; // M·∫∑c ƒë·ªãnh wrap
        
        // T·∫£i l·∫°i b·ªô l·ªçc (v√¨ filterGift c√≥ th·ªÉ ƒë√£ thay ƒë·ªïi)
        await populateDropdowns();
        
        // Trigger wrap toggle ƒë·ªÉ √°p d·ª•ng l·∫°i class
        handleWrapToggle();
        loadSerials('', 1); // T·∫£i l·∫°i trang 1
    });


    // X·ª≠ l√Ω N√∫t "Qu√©t" v√† Modal
    const scanModal = document.getElementById('scanModal');
    let html5QrcodeScanner;
    document.getElementById('btnScan').addEventListener('click', function() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            showToast('Ch·ª©c nƒÉng qu√©t ch·ªâ ho·∫°t ƒë·ªông tr√™n HTTPS!', 'error');
            return;
        }
        scanModal.style.display = 'flex';
        
        if (!html5QrcodeScanner) {
           html5QrcodeScanner = // D√°n kh·ªëi code n√†y thay th·∫ø cho kh·ªëi new Html5QrcodeScanner(...) ·ªü c·∫£ 2 n∆°i
            // D√°n kh·ªëi code n√†y thay th·∫ø cho kh·ªëi new Html5QrcodeScanner(...) ·ªü s·ª± ki·ªán 'btnScan'
new Html5QrcodeScanner(
    "qr-reader", 
    { 
        fps: 25, 
        qrbox: (viewfinderWidth, viewfinderHeight) => {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            let size = Math.floor(minEdge * 0.75);
            return { width: size, height: size };
        },
        rememberLastUsedCamera: false,
        formatsToSupport: [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ],

        // === C·∫§U H√åNH CAMERA ƒê√É S·ª¨A L·∫†I ===
        videoConstraints: {
            facingMode: { 
                ideal: "environment" // 1. ∆Øu ti√™n camera "m√¥i tr∆∞·ªùng" (sau)
            },
            focusMode: {
                ideal: "continuous" // 2. Y√™u c·∫ßu t·ª± ƒë·ªông l·∫•y n√©t li√™n t·ª•c
            }
        }
        // ===================================
    }
)
        }
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    });
    
    function onScanSuccess(decodedText, decodedResult) {
    console.log(`Scan result: ${decodedText}`, decodedResult);
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.clear(); // üëà D√πng .stop() ƒë·ªÉ t·∫Øt camera
            html5QrcodeScanner = null;    // üëà H·ªßy ƒë·ªëi t∆∞·ª£ng
        } catch(e) {
            console.error("L·ªói stop scanner:", e);
        }
    }

    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    document.getElementById('qr-reader').style.display = 'none';
    document.getElementById('scanResultContainer').style.display = 'block';
    document.getElementById('scanResultText').textContent = decodedText;
}


    function onScanFailure(error) {
        // B·ªè qua
    }

    function hideScanModal() {
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.clear(); // üëà D√πng .stop() ƒë·ªÉ t·∫Øt camera
            html5QrcodeScanner = null;    // üëà H·ªßy ƒë·ªëi t∆∞·ª£ng
        } catch(e) {
            console.error("L·ªói stop scanner:", e);
        }
    }
    scanModal.style.display = 'none';
    
    // Reset l·∫°i UI modal v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
    document.getElementById('qr-reader').style.display = 'block';
    document.getElementById('scanResultContainer').style.display = 'none';
    document.getElementById('scanResultText').textContent = '';
}

    // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng x√°c nh·∫≠n m√£
function handleScanConfirm() {
    const decodedText = document.getElementById('scanResultText').textContent;
    if (decodedText) {
        document.getElementById('masterInput').value = decodedText;
        triggerLoad(1); // K√≠ch ho·∫°t t√¨m ki·∫øm
        hideScanModal(); // ƒê√≥ng modal sau khi x√°c nh·∫≠n
    }
}

function handleRescan() {
    // ·∫®n k·∫øt qu·∫£, hi·ªán l·∫°i camera
    document.getElementById('qr-reader').style.display = 'block';
    document.getElementById('scanResultContainer').style.display = 'none';
    document.getElementById('scanResultText').textContent = '';
    
    try {
        // V√¨ html5QrcodeScanner ƒë√£ b·ªã set = null, ch√∫ng ta ph·∫£i t·∫°o M·ªöI
        if (!html5QrcodeScanner) {
            html5QrcodeScanner = 
           new Html5QrcodeScanner(
    "qr-reader", 
    { 
        fps: 25, 
        qrbox: (viewfinderWidth, viewfinderHeight) => {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            let size = Math.floor(minEdge * 0.75);
            return { width: size, height: size };
        },
        rememberLastUsedCamera: false, // V·∫´n gi·ªØ false
        formatsToSupport: [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ],

        // === THAY ƒê·ªîI C√ÅCH Y√äU C·∫¶U CAMERA ===
        // X√≥a d√≤ng 'facingMode: "environment",' ·ªü ƒë√¢y
        videoConstraints: {
            facingMode: { 
                ideal: "environment" // 1. Y√™u c·∫ßu camera "m√¥i tr∆∞·ªùng" (sau)
            },
            focusMode: {
                ideal: "continuous" // 2. Y√™u c·∫ßu t·ª± ƒë·ªông l·∫•y n√©t
            }
        }
        // ======================================
    }
)
        }
        // Kh·ªüi ch·∫°y l·∫°i
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    } catch (e) {
        console.error("L·ªói render l·∫°i scanner:", e);
        showToast('L·ªói kh·ªüi ƒë·ªông l·∫°i camera', 'error');
    }
}

// G√°n s·ª± ki·ªán cho 2 n√∫t m·ªõi (ƒë·∫∑t ·ªü cu·ªëi file, g·∫ßn c√°c `addEventListener` kh√°c)
document.getElementById('btnConfirmScan').addEventListener('click', handleScanConfirm);
document.getElementById('btnRescan').addEventListener('click', handleRescan);

    // X·ª≠ l√Ω Enter
    document.getElementById('masterInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') { 
            e.preventDefault(); 
            triggerLoad(1); 
        }
    });
    
    // G√°n s·ª± ki·ªán cho L·ªçc (Dropdowns v√† Checkboxes)
    // === S·ª¨A: filterGift c·∫ßn t·∫£i l·∫°i dropdowns ===
    document.getElementById('filterGift').addEventListener('change', async () => {
        await populateDropdowns(); // T·∫£i l·∫°i danh s√°ch l·ªçc
        triggerLoad(1); // T·∫£i l·∫°i d·ªØ li·ªáu
    });
    document.getElementById('filterCheckedOut').addEventListener('change',() => triggerLoad(1));
    document.getElementById('filterSubcategory').addEventListener('change', () => triggerLoad(1));
    document.getElementById('filterBrand').addEventListener('change', () => triggerLoad(1));
    document.getElementById('filterLocation').addEventListener('change', () => triggerLoad(1));
    document.getElementById('filterBinZone').addEventListener('change', () => triggerLoad(1));
    document.getElementById('toggleWrap').addEventListener('change', handleWrapToggle);
    
    // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu khi v√†o trang
    // === S·ª¨A: T·∫£i b·ªô l·ªçc TR∆Ø·ªöC, sau ƒë√≥ t·∫£i d·ªØ li·ªáu ===
    async function initPage() {
        await populateDropdowns(); // T·∫£i b·ªô l·ªçc tr∆∞·ªõc
        await loadSerials("", 1); // T·∫£i d·ªØ li·ªáu trang 1
    }
    
    initPage(); // Ch·∫°y h√†m kh·ªüi t·∫°o

</script>
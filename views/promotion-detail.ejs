<%- include('partials/header', { title: 'Chi ti·∫øt CTKM', currentPage: 'promotion-detail', time: time }) %>

<style>





    /* --- VOUCHER TICKET STYLE (BLUE THEME) --- */
.voucher-ticket {
    background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); /* Xanh r·∫•t nh·∫°t sang tr·∫Øng */
    border: 1px solid #3b82f6; /* Vi·ªÅn xanh d∆∞∆°ng chu·∫©n */
    border-radius: 12px;
    padding: 0;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
    display: flex;
    flex-direction: column;
}

/* D·∫£i m√†u trang tr√≠ b√™n tr√°i - Xanh ƒë·∫≠m */
.voucher-ticket::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 6px;
    height: 100%;
    background: #2563eb; 
}

.voucher-header {
    background: #dbeafe; /* Xanh nh·∫°t (Header) */
    padding: 10px 15px;
    border-bottom: 1px dashed #93c5fd;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1e40af; /* Ch·ªØ xanh ƒë·∫≠m */
    font-weight: 700;
    font-size: 13px;
    text-transform: uppercase;
}

.voucher-body {
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.voucher-value-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.voucher-label {
    font-size: 12px;
    color: #64748b; /* M√†u x√°m trung t√≠nh */
    margin-bottom: 2px;
    font-weight: 500;
}

.voucher-big-value {
    font-size: 24px;
    font-weight: 800;
    color: #1d4ed8; /* M√†u xanh gi√° tr·ªã (ƒë·∫≠m h∆°n border) */
    font-family: 'Segoe UI', sans-serif;
    letter-spacing: -0.5px;
}

.voucher-code-box {
    background: #f0f9ff; /* N·ªÅn xanh si√™u nh·∫°t */
    border: 2px dashed #60a5fa; /* Vi·ªÅn n√©t ƒë·ª©t xanh s√°ng */
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.voucher-code-text {
    font-family: monospace;
    font-size: 16px;
    font-weight: 700;
    color: #1e3a8a; /* M√£ code m√†u xanh t·ªëi */
    letter-spacing: 1px;
}

.voucher-method {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #334155;
    background: #f8fafc;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
}




    /* --- HIERARCHY TREE STYLE (PH√ÇN C·∫§P R√ï R√ÄNG) --- */
    .tree-group {
        margin-bottom: 15px;
    }
    
    /* 1. T√™n Nh√≥m (Parent) */
    .tree-group-label {
        font-size: 13px;
        font-weight: 800; /* R·∫•t ƒë·∫≠m */
        color: #1e293b;
        background: #f1f5f9;
        padding: 4px 10px;
        border-radius: 6px;
        display: inline-block;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
    }

    /* 2. Khung ch·ª©a danh s√°ch con (C√≥ ƒë∆∞·ªùng k·∫ª d·ªçc b√™n tr√°i) */
    .tree-children {
        margin-left: 10px;          /* Th·ª•t v√†o so v·ªõi l·ªÅ tr√°i */
        padding-left: 15px;         /* Kho·∫£ng c√°ch t·ª´ ƒë∆∞·ªùng k·∫ª ƒë·∫øn ch·ªØ */
        border-left: 2px solid #e2e8f0; /* ƒê∆∞·ªùng k·∫ª d·ªçc ƒë·ªãnh h∆∞·ªõng */
    }

    /* 3. T·ª´ng m·ª•c con (Child Item) */
    .tree-item {
        font-size: 13px;
        color: #334155;
        margin-bottom: 8px;
        position: relative;
        line-height: 1.5;
    }

    /* T·∫°o d·∫•u ch·∫•m tr√≤n ·ªü ƒë·∫ßu m·ªói m·ª•c con */
    .tree-item::before {
        content: "";
        position: absolute;
        top: 8px;
        left: -20px; /* ƒê·∫©y d·∫•u ch·∫•m n·∫±m ƒë√® l√™n ƒë∆∞·ªùng k·∫ª d·ªçc */
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #cbd5e1;
        border: 2px solid #fff; /* Vi·ªÅn tr·∫Øng ƒë·ªÉ c·∫Øt ƒë∆∞·ªùng k·∫ª d·ªçc */
    }

    /* --- CSS CHO COMBO/GIFT CHI TI·∫æT --- */
    .combo-item-row {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: #fff; 
        border: 1px solid #cbd5e1; 
        padding: 6px 10px; 
        border-radius: 6px; 
        margin-top: 5px; 
        font-size: 13px;
    }
    .combo-sku-name {
        flex: 1;
        font-weight: 500;
        color: #334155;
        display: flex; flex-direction: column;
    }
    .combo-stock-badge {
        font-size: 11px;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 12px;
        white-space: nowrap;
        margin-left: 10px;
    }
    .stock-has { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .stock-zero { background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; }



    /* --- MINIMALIST STYLE (TR·∫ÆNG ƒêEN) --- */
    .detail-minimal-list {
        display: flex; 
        flex-direction: column;
    }
    
    .detail-item {
        padding: 20px 0;
        border-bottom: 1px solid #e2e8f0; /* ƒê∆∞·ªùng k·∫ª x√°m nh·∫°t */
    }
    
    .detail-item:first-child { padding-top: 0; }
    .detail-item:last-child { border-bottom: none; }

    /* Ti√™u ƒë·ªÅ m·ª•c: ƒê·∫≠m, m√†u x√°m ƒëen, KH√îNG m√†u m√® */
    .detail-item-title {
        font-size: 14px;
        font-weight: 700;
        color: #334155; /* X√°m ƒë·∫≠m (Slate-700) */
        margin-bottom: 8px;
        text-transform: uppercase; /* Vi·∫øt hoa ƒë·ªÉ ph√¢n bi·ªát r√µ ƒë·∫ßu m·ª•c */
        letter-spacing: 0.5px;
    }

    /* N·ªôi dung: M√†u ƒëen d·ªãu, d·ªÖ ƒë·ªçc */
    .detail-item-content {
        font-size: 14px;
        line-height: 1.6;
        color: #0f172a; /* G·∫ßn nh∆∞ ƒëen (Slate-900) */
    }

    /* ·∫®n c√°c th·∫ª p r·ªóng do b·ªô so·∫°n th·∫£o sinh ra th·ª´a */
    .detail-item-content p:empty {
        display: none;
    }
    
    /* X·ª≠ l√Ω ·∫£nh trong n·ªôi dung n·∫øu c√≥ */
    .detail-item-content img { max-width: 100%; height: auto; }

    :root {
        --primary-color: #0f172a;
        --secondary-color: #475569;
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --border-color: #e2e8f0;
    }

    body { background-color: var(--bg-page); color: var(--primary-color); }
    .promo-container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* --- COMMON CARDS --- */
    .modern-card {
        background: var(--bg-card); border: 1px solid var(--border-color);
        border-radius: 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        padding: 20px; margin-bottom: 20px;
    }
    .card-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
    }
    .card-title { font-size: 16px; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }

    /* --- HERO & GRID --- */
    .hero-section { display: flex; flex-direction: column; gap: 8px; }
    .promo-title { font-size: 24px; font-weight: 800; line-height: 1.3; color: #1e293b; }
    .promo-meta { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; font-size: 13px; color: var(--secondary-color); }
    
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 992px) { .details-grid { grid-template-columns: 1fr; } }

    /* --- INFO ROWS --- */
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border-color); font-size: 14px; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--secondary-color); font-weight: 500; }
    .info-value { font-weight: 600; text-align: right; max-width: 60%; }

    /* --- CONFIG BLOCKS --- */
    .config-block { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .config-block.gift { background: #fff7ed; border-color: #fdba74; }
    .config-block.combo { background: #eff6ff; border-color: #93c5fd; }
    .config-block.coupon { background: #f0fdf4; border-color: #86efac; }
    .config-block.installment { background: #faf5ff; border-color: #d8b4fe; }
    
    .config-title { font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed rgba(0,0,0,0.1); }
    .config-title.gift { color: #c2410c; } .config-title.combo { color: #1e40af; }

    /* --- CONTENT BOX --- */
    .content-box { font-size: 14px; line-height: 1.6; color: #334155; overflow-wrap: break-word; }
    .content-box img { max-width: 100%; height: auto; border-radius: 8px; }
    .content-box ul { padding-left: 20px; }

    /* --- SKU TABLE --- */
    .sku-table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
    .sku-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .sku-table th { background: #f1f5f9; padding: 10px; text-align: left; font-weight: 700; white-space: nowrap; }
    .sku-table td { padding: 10px; border-top: 1px solid var(--border-color); }
    .sku-table tr:hover { background: #f8fafc; }

    /* --- PILLS & BADGES --- */
    .pill { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 4px; margin-bottom: 4px; border: 1px solid transparent; }
    .pill-sku { background: #fff; border-color: #cbd5e1; color: #334155; font-family: monospace; }
    .pill-brand { background: #e0e7ff; color: #3730a3; }
    .pill-cat { background: #fae8ff; color: #86198f; }

    .status-badge { padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    .status-active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-expired { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    /* --- BUTTONS --- */
    .btn-action { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 13px; text-decoration: none; transition: all 0.2s; }
    .btn-edit { background: #f59e0b; color: #000; }
    .btn-edit:hover { background: #d97706; }
    
    .copy-btn { background: #fff; border: 1px solid #cbd5e1; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 11px; color: #475569; display: inline-flex; align-items: center; gap: 4px; }
    .copy-btn:hover { background: #f1f5f9; color: #0f172a; border-color: #94a3b8; }
    
    .inventory-cell { text-align: center; font-weight: 700; }
    .inventory-zero { color: #cbd5e1; font-weight: 400; }
    .inventory-has { color: #166534; }
</style>

<div class="promo-container">

    <% if (typeof error !== 'undefined' && error) { %>
        <div class="modern-card" style="border-left: 5px solid #ef4444; background: #fef2f2;">
            <div style="color: #991b1b; font-weight: 700; margin-bottom: 5px;">‚ö†Ô∏è L·ªói h·ªá th·ªëng</div>
            <div style="color: #b91c1c; font-size: 14px;"><%= error %></div>
        </div>
    <% } %>

    <% if (promotion) { %>

    <div class="modern-card">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div class="hero-section">
                <div class="promo-meta">
                    <span style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">ID: #<%= promotion.id %></span>
                    <% 
                        const endDate = new Date(promotion.end_date);
                        const isActive = (promotion.status === 'active' && endDate >= new Date());
                        const statusClass = isActive ? 'status-active' : 'status-expired';
                        const statusLabel = isActive ? 'ƒêang ho·∫°t ƒë·ªông' : 'H·∫øt hi·ªáu l·ª±c / ƒê√£ t·∫Øt';
                    %>
                    <span class="status-badge <%= statusClass %>"><%= statusLabel %></span>
                    <span>|</span>
                    <span>C·∫≠p nh·∫≠t: <%= promotion.updated_at ? new Date(promotion.updated_at).toLocaleString('vi-VN') : '-' %></span>
                </div>
                <h1 class="promo-title"><%= promotion.name %></h1>
                <div class="promo-meta">
                    <% if (promotion.group_name) { %>
                        <span class="pill pill-brand">Group: <%= promotion.group_name %></span>
                    <% } %>
                    <% if (promotion.show_multiple_in_group) { %>
                        <span style="color: #166534; font-weight: 600;">‚úÖ Cho ph√©p hi·ªÉn th·ªã tr√πng trong nh√≥m</span>
                    <% } else { %>
                        <span style="color: #b45309; font-weight: 600;">‚ö° L·∫•y ∆∞u ƒë√£i t·ªët nh·∫•t nh√≥m</span>
                    <% } %>
                </div>
            </div>

            <% if (typeof currentUser !== 'undefined' && (currentUser.role === 'manager' || currentUser.role === 'admin')) { %>
                <a href="/edit-promotion/<%= promotion.id %>" class="btn-action btn-edit">
                    ‚úèÔ∏è S·ª≠a CTKM
                </a>
            <% } %>
        </div>
    </div>

    <div class="details-grid">
        
        <div class="col-left">
            <div class="modern-card">
                <div class="card-header">
                    <div class="card-title">‚ÑπÔ∏è Th√¥ng tin chung</div>
                </div>
                
                <div class="info-row">
                    <span class="info-label">M√¥ t·∫£ ng·∫Øn</span>
                    <span class="info-value"><%= promotion.description || '-' %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Th·ªùi gian √°p d·ª•ng</span>
                    <span class="info-value">
                        <%= new Date(promotion.start_date).toLocaleDateString('vi-VN') %> 
                        <span style="color:#94a3b8">‚Üí</span> 
                        <%= new Date(promotion.end_date).toLocaleDateString('vi-VN') %>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">K√™nh b√°n (Channel)</span>
                    <span class="info-value"><%= promotion.channel || 'All' %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Lo·∫°i CTKM</span>
                    <span class="info-value"><%= promotion.promo_type %></span>
                </div>
                
                <div style="margin-top: 15px;">
                    <span class="info-label" style="display:block; margin-bottom:5px;">üè¢ Chi nh√°nh √°p d·ª•ng:</span>
                    <% if (promotion.apply_branches && promotion.apply_branches.length > 0) { %>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <% promotion.apply_branches.forEach(br => { %>
                                <span style="background:#f1f5f9; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600;"><%= br %></span>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <span style="font-weight:700; color:#0369a1;">üåç To√†n qu·ªëc</span>
                    <% } %>
                </div>

                <div style="margin-top: 15px; padding-top:15px; border-top:1px solid #e2e8f0;">
                    <div class="info-label" style="margin-bottom:8px;">üéØ Ph·∫°m vi s·∫£n ph·∫©m:</div>
                    
                    <% if (promotion.apply_to_all_skus) { %>
                        <div class="status-badge status-active" style="display:inline-block;">T·∫•t c·∫£ s·∫£n ph·∫©m</div>
                    <% } else { %>
                        <% if(promotion.apply_to_brands && promotion.apply_to_brands.length > 0) { %>
                            <div style="margin-bottom:5px;">
                                <small>Brand:</small> 
                                <% promotion.apply_to_brands.forEach(b => { %><span class="pill pill-brand"><%= b %></span><% }) %>
                            </div>
                        <% } %>
                        <% if(promotion.apply_to_categories && promotion.apply_to_categories.length > 0) { %>
                            <div style="margin-bottom:5px;">
                                <small>Cat:</small> 
                                <% promotion.apply_to_categories.forEach(c => { %><span class="pill pill-cat"><%= c %></span><% }) %>
                            </div>
                        <% } %>
                         <% if(promotion.apply_to_subcats && promotion.apply_to_subcats.length > 0) { %>
                            <div style="margin-bottom:5px;">
                                <small>Subcat:</small> 
                                <% promotion.apply_to_subcats.forEach(s => { %>
                                    <span class="pill pill-cat" style="background:#f0f9ff; color:#0369a1; border-color:#bae6fd;"><%= s %></span>
                                <% }) %>
                            </div>
                        <% } %>   

                        <% if(promotion.apply_brand_subcats && promotion.apply_brand_subcats.length > 0) { %>
                             <div style="margin-bottom:5px;">
                                <small>Brand + Subcat:</small><br>
                                <% promotion.apply_brand_subcats.forEach(item => { %>
                                    <span class="pill pill-brand"><%= item.brand %></span>+<span class="pill pill-cat"><%= item.subcat_id %></span> &nbsp;
                                <% }) %>
                             </div>
                        <% } %>
                        <% if(promotion.promotion_skus && promotion.promotion_skus.length > 0) { %>
                             <div>
                                <small>SKU:</small> 
                                <span class="pill pill-sku"><%= promotion.promotion_skus.length %> SKU c·ª• th·ªÉ</span>
                                <a href="#skuTableSection" style="font-size:12px; margin-left:5px;">(Xem d∆∞·ªõi)</a>
                             </div>
                        <% } %>
                    <% } %>

                    <% if ((promotion.exclude_brands && promotion.exclude_brands.length) || (promotion.promotion_excluded_skus && promotion.promotion_excluded_skus.length)) { %>
                        <div style="margin-top:10px; background:#fff1f2; padding:8px; border-radius:6px; border:1px dashed #fca5a5;">
                            <div style="font-weight:700; color:#991b1b; font-size:12px; margin-bottom:4px;">‚õî Lo·∫°i tr·ª´:</div>
                            <% if (promotion.exclude_brands) { %>
                                <% promotion.exclude_brands.forEach(b => { %><span class="pill" style="background:#fff; border-color:#fca5a5; color:#991b1b;"><%= b %></span><% }) %>
                            <% } %>
                            <% if (promotion.promotion_excluded_skus && promotion.promotion_excluded_skus.length) { %>
                                <span class="pill" style="background:#fff; border-color:#fca5a5; color:#991b1b;"><%= promotion.promotion_excluded_skus.length %> SKU</span>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="col-right">
            
            <div class="modern-card">
                <div class="card-header">
                    <div class="card-title" style="color:#0f172a;">üí∞ Gi√° tr·ªã gi·∫£m & ∆Øu ƒë√£i</div>
                </div>

                      <% 
    // [FIX] Ki·ªÉm tra n·∫øu l√† Combo ho·∫∑c Gift th√¨ KH√îNG hi·ªÉn th·ªã kh·ªëi gi√° tr·ªã c∆° b·∫£n n√†y
    // V√¨ Combo/Gift ƒë√£ c√≥ kh·ªëi hi·ªÉn th·ªã chi ti·∫øt ri√™ng b√™n d∆∞·ªõi r·ªìi.
    const isSpecialType = [
        'Combo', 
        'Gift', 
        'Qu√† t·∫∑ng (Gift)', 
        'T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau' 
    ].includes(promotion.promo_type);
%>

<% if ((promotion.discount_value_type || promotion.coupon_list) && !isSpecialType) { %>
    <div class="config-block coupon">
                        <div class="config-title" style="color:#15803d;">üí∞ Gi√° tr·ªã gi·∫£m & Coupon</div>
                        
                        <div style="font-size:16px; font-weight:700; color:#166534; margin-bottom:8px;">
                            <% if (promotion.discount_value_type === 'amount') { %>
                                Gi·∫£m <%= new Intl.NumberFormat('vi-VN').format(promotion.discount_value) %> ƒë
                            <% } else if (promotion.discount_value_type === 'percent') { %>
                                Gi·∫£m <%= promotion.discount_value %>% 
                                <% if(promotion.max_discount_amount) { %>
                                    <span style="font-size:13px; font-weight:400; color:#15803d;">(T·ªëi ƒëa <%= new Intl.NumberFormat('vi-VN').format(promotion.max_discount_amount) %>)</span>
                                <% } %>
                            <% } else if (promotion.max_coupon_discount) { %>
                                Gi·∫£m t·ªõi <%= new Intl.NumberFormat('vi-VN').format(promotion.max_coupon_discount) %> ƒë
                            <% } else { %>
                                (C·∫•u h√¨nh trong danh s√°ch m√£)
                            <% } %>
                        </div>

                        <% if (promotion.min_order_value) { %>
                             <div style="font-size:13px;">üõí ƒê∆°n t·ªëi thi·ªÉu: <strong><%= new Intl.NumberFormat('vi-VN').format(promotion.min_order_value) %> ƒë</strong></div>
                        <% } %>

                        <% if (promotion.coupon_list && promotion.coupon_list.length > 0) { %>
                            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #86efac;">
                                <div style="font-size:12px; font-weight:600; margin-bottom:5px;">M√£ √°p d·ª•ng:</div>
                                <% if (promotion.coupon_list.length === 1) { %>
                                    <div style="display:flex; align-items:center; gap:5px;">
                                        <code style="background:#fff; padding:4px 8px; border-radius:4px; border:1px solid #bbf7d0; font-weight:700;"><%= promotion.coupon_list[0].code %></code>
                                        <button class="copy-btn" onclick="copyCode(this)" data-code="<%= promotion.coupon_list[0].code %>">üìã Copy</button>
                                    </div>
                                <% } else { %>
                                    <button onclick="showCouponListModal(this)" data-coupons='<%- JSON.stringify(promotion.coupon_list) %>' class="btn-action" style="background:#fff; border:1px solid #166534; color:#166534; padding:4px 10px; font-size:12px;">
                                        üìú Xem <%= promotion.coupon_list.length %> m√£ coupon
                                    </button>
                                <% } %>
                            </div>
                        <% } else if (promotion.coupon_code) { %>
                             <div style="margin-top:8px; display:flex; align-items:center; gap:5px;">
                                 Code: <strong><%= promotion.coupon_code %></strong>
                                 <button class="copy-btn" onclick="copyCode(this)" data-code="<%= promotion.coupon_code %>">üìã Copy</button>
                             </div>
                        <% } %>
                    </div>
                <% } %>

                <% if (promotion.promo_type === 'Gift' && promotion.detail_fields && promotion.detail_fields.gift_options) { %>
                    <div class="config-block gift">
                        <div class="config-title gift">üéÅ Qu√† t·∫∑ng (Options)</div>
                        <% Object.values(promotion.detail_fields.gift_options).forEach((opt, idx) => { %>
                            <div style="background:#fff; border:1px dashed #fdba74; padding:10px; border-radius:6px; margin-bottom:8px;">
                                <div style="font-weight:700; color:#c2410c; font-size:13px;">L·ª±a ch·ªçn <%= idx + 1 %></div>
                                <% if(opt.code) { %> 
                                    <div style="font-size:12px; margin-bottom:2px;">
                                        Code: <code><%= opt.code %></code>
                                        <button class="copy-btn" onclick="copyCode(this)" data-code="<%= opt.code %>" style="font-size:10px; padding:1px 4px;">Copy</button>
                                    </div> 
                                <% } %>
                                <div style="margin-top:4px;">
                                    <% if(opt.skus) { %>
                                        <div style="display: flex; flex-direction: column; gap: 6px;">
                                            <% (Array.isArray(opt.skus) ? opt.skus : [opt.skus]).forEach(skuCode => { %>
                                                <div class="gift-row-compact js-combo-item" data-sku="<%= skuCode %>" 
                                                     style="display: flex; align-items: center; justify-content: space-between; gap: 12px; background: #fff; border: 1px solid #e2e8f0; padding: 8px 10px; border-radius: 6px;">
                                                    
                                                    <span style="flex: 1; font-size: 12px; color: #334155; line-height: 1.5;">
                                                        <strong style="color: #0f172a; white-space: nowrap;"><%= skuCode %></strong> - 
                                                        <span class="js-name" style="color:#94a3b8;">‚è≥ ƒêang t·∫£i...</span>
                                                    </span>
                                                    
                                                    <span class="stock-badge zero js-stock" 
                                                          style="font-size: 11px; font-weight: 600; padding: 4px 8px; line-height: 1; white-space: nowrap; border-radius: 20px; display: flex; align-items: center; height: fit-content; flex-shrink: 0;">
                                                        --
                                                    </span>
                                                </div>
                                            <% }) %>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } %>

                <% if (promotion.promo_type === 'Combo' && promotion.detail_fields && promotion.detail_fields.combos) { %>
                    <div class="config-block combo">
                        <div class="config-title combo">üß© Combo ∆∞u ƒë√£i</div>
                        
                        <% Object.values(promotion.detail_fields.combos).forEach((combo, idx) => { %>
                            <div style="background:#fff; border:1px dashed #93c5fd; padding:10px; border-radius:6px; margin-bottom:8px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom: 8px; border-bottom: 1px solid #eff6ff; padding-bottom: 5px;">
                                    <span style="font-weight:700; color:#1e40af; font-size:13px;">
                                        <%= combo.name || ('Combo ' + (idx + 1)) %>
                                    </span>
                                    <span style="font-weight:700; color:#dc2626;">
                                        Gi·∫£m <%= new Intl.NumberFormat('vi-VN').format(combo.discount_val) %> <%= combo.discount_type=='percent'?'%':'ƒë' %>
                                    </span>
                                </div>

                                <div style="margin-top:4px;">
                                    <% if(combo.skus) { %>
                                        <% (Array.isArray(combo.skus) ? combo.skus : [combo.skus]).forEach(skuCode => { %>
                                            <div class="combo-item-row js-combo-item" data-sku="<%= skuCode %>">
                                                <div class="combo-sku-name">
                                                    <span style="font-size: 11px; color:#64748b; font-family: monospace;">SKU: <%= skuCode %></span>
                                                    <span class="js-name" style="font-size:13px; color:#94a3b8;">
                                                        <span class="spinner-border">‚è≥</span> ƒêang t·∫£i...
                                                    </span>
                                                </div>
                                                <span class="combo-stock-badge stock-zero js-stock">
                                                    --
                                                </span>
                                            </div>
                                        <% }) %>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
                
                <% 
                   const isInstallment = (promotion.promo_type || '').toLowerCase().includes('tr·∫£ g√≥p');
                   if (isInstallment && promotion.detail_fields && promotion.detail_fields.installment_type) { 
                %>
                    <div class="config-block installment">
                         <div class="config-title" style="color:#7e22ce;">üè¶ Tr·∫£ g√≥p</div>
                         <div class="info-row">
                             <span class="info-label">H√¨nh th·ª©c:</span>
                             <strong><%= promotion.detail_fields.installment_type %></strong>
                         </div>
                         <div class="info-row">
                             <span class="info-label">ƒê·ªëi t√°c:</span>
                             <strong><%= promotion.detail_fields.installment_partner || 'T·∫•t c·∫£' %></strong>
                         </div>
                         <div style="margin-top:5px; font-size:13px;">
                             <% if(promotion.detail_fields.installment_prepay) { %>Tr·∫£ tr∆∞·ªõc: <b><%= promotion.detail_fields.installment_prepay %></b> | <% } %>
                             <% if(promotion.detail_fields.installment_interest) { %>L√£i su·∫•t: <b><%= promotion.detail_fields.installment_interest %></b><% } %>
                         </div>
                    </div>
                <% } %>
                   <% if (promotion.promo_type === 'T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau' && promotion.detail_fields) { %>
                    <div class="config-block" style="background: transparent; border: none; padding: 0;">
                        <div class="voucher-ticket">
                            <div class="voucher-header">
                                <span>üé´</span> M√É T·∫∂NG ƒê∆†N SAU
                            </div>

                            <div class="voucher-body">
                                <div class="voucher-value-row">
                                    <div>
                                        <div class="voucher-label">Gi√° tr·ªã ∆∞u ƒë√£i</div>
                                        <div class="voucher-big-value">
                                            <% 
                                                let rawVal = promotion.detail_fields.next_order_value;
                                                let displayVal = rawVal;
                                                if (rawVal && !isNaN(String(rawVal).replace(/\D/g, ''))) {
                                                    displayVal = new Intl.NumberFormat('vi-VN').format(Number(String(rawVal).replace(/\D/g, ''))) + ' ƒë';
                                                }
                                            %>
                                            <%= displayVal || '---' %>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div class="voucher-label">M√£ Coupon</div>
                                    <div class="voucher-code-box">
                                        <% if (promotion.detail_fields.next_order_code) { %>
                                            <span class="voucher-code-text"><%= promotion.detail_fields.next_order_code %></span>
                                            <button type="button" onclick="window.forceCopy('<%= promotion.detail_fields.next_order_code %>', this)" style="border:none; background:#2563eb; color:white; padding:6px 14px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:600;">Copy</button>
                                        <% } else { %>
                                            <span style="font-style: italic; color: #64748b; font-size: 13px;">(M√£ ng·∫´u nhi√™n / H·ªá th·ªëng t·ª± g·ª≠i)</span>
                                        <% } %>
                                    </div>
                                </div>
                                <% if(promotion.detail_fields.receive_method) { %>
                                <div class="voucher-method">
                                    <span style="font-size:16px;">üì≤</span>
                                    <div><span style="font-weight:600; color: #475569;">Nh·∫≠n qua:</span> <%= promotion.detail_fields.receive_method %></div>
                                </div>
                                <% } %>
                                <% 
                                    let targetSkusStr = promotion.detail_fields.next_order_target_skus || '';
                                    let targetSkus = targetSkusStr.split(/[,\n\r\s]+/).map(s => s.trim()).filter(Boolean);
                                %>
                                <% if (targetSkus.length > 0) { %>
                                    <div style="margin-top: 5px;">
                                        <div class="voucher-label" style="margin-bottom: 5px;">üî• √Åp d·ª•ng cho c√°c s·∫£n ph·∫©m:</div>
                                        <div style="display: flex; flex-direction: column; gap: 6px;">
                                        <% targetSkus.forEach(skuCode => { %>
                                            <div class="gift-row-compact js-combo-item" data-sku="<%= skuCode %>" 
                                                 style="display: flex; align-items: center; justify-content: space-between; gap: 12px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 10px; border-radius: 6px;">
                                                
                                                <span style="flex: 1; font-size: 12px; color: #334155; line-height: 1.5;">
                                                    <strong style="color: #0f172a; white-space: nowrap;"><%= skuCode %></strong> - 
                                                    <span class="js-name" style="color:#94a3b8;">‚è≥ ƒêang t·∫£i...</span>
                                                </span>
                                                
                                                <span class="stock-badge zero js-stock" 
                                                      style="font-size: 11px; font-weight: 600; padding: 4px 8px; line-height: 1; white-space: nowrap; border-radius: 20px; display: flex; align-items: center; height: fit-content; flex-shrink: 0;">
                                                    --
                                                </span>
                                            </div>
                                        <% }) %>
                                    </div>
                                    </div>
                                <% } %>

                                
                            </div>
                        </div>
                    </div>
                <% } %>
                
                <% 
                    const hasConfig = promotion.discount_value_type || promotion.coupon_list || 
                                     (promotion.detail_fields && Object.keys(promotion.detail_fields).length > 0);
                %>
                <% if(!hasConfig) { %>
                    <div style="text-align:center; padding:20px; color:#94a3b8; font-style:italic;">
                        Kh√¥ng c√≥ c·∫•u h√¨nh chi ti·∫øt
                    </div>
                <% } %>
            </div>
        </div> 
    </div> 

  <% 
        // Danh s√°ch c√°c m·ª•c c·∫ßn hi·ªÉn th·ªã
        const plainFields = [
            'N·ªôi dung',
            'ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng √°p d·ª•ng', 
            'ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng lo·∫°i tr·ª´', 
            'Gi·ªõi h·∫°n l∆∞·ª£t √°p d·ª•ng', 
            'Y√™u c·∫ßu ƒë·∫∑c bi·ªát', 
            'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng coupon'
        ];

        // H√†m ki·ªÉm tra nhanh: C√≥ d·ªØ li·ªáu th·ª±c s·ª± hay kh√¥ng?
        // (Lo·∫°i b·ªè tr∆∞·ªùng h·ª£p ch·ªâ c√≥ d·∫•u c√°ch ho·∫∑c null)
        const hasRealData = (val) => val && typeof val === 'string' && val.trim().length > 0;

        // Ki·ªÉm tra xem c√≥ √≠t nh·∫•t 1 tr∆∞·ªùng n√†o c√≥ d·ªØ li·ªáu kh√¥ng ƒë·ªÉ hi·ªán khung
        const showCard = promotion.detail_fields && (
    plainFields.some(key => hasRealData(promotion.detail_fields[key])) ||
    hasRealData(promotion.detail_fields['Link n·ªôi b·ªô/ b√°o c√°o'])
);
    %>

    <% if (showCard) { %>
        <div class="modern-card">
            <div class="card-header">
                <div class="card-title" style="color:#0f172a;">üìù Chi ti·∫øt & Quy ƒë·ªãnh</div>
            </div>
            
            <div class="detail-minimal-list">
                <% plainFields.forEach(function(key) { %>
                    <% 
                       // L·∫•y gi√° tr·ªã
                       const content = promotion.detail_fields[key]; 
                    %>
                    
                    <% if (hasRealData(content)) { %>
                        <div class="detail-item">
                            <div class="detail-item-title"><%= key %></div>
                            
                            <div class="detail-item-content">
                                <%- content %>
                            </div>
                        </div>
                    <% } %>
                <% }); %>

                <% if (promotion.detail_fields && hasRealData(promotion.detail_fields['Link n·ªôi b·ªô/ b√°o c√°o'])) { %>
                    <div class="detail-item">
                        <div class="detail-item-title">LINK B√ÅO C√ÅO / N·ªòI B·ªò</div>
                        <div class="detail-item-content">
    <% 
        let linkVal = promotion.detail_fields['Link n·ªôi b·ªô/ b√°o c√°o'] || '';
        // Lo·∫°i b·ªè th·∫ª HTML th·ª´a n·∫øu user ch·ªâ paste link tr·∫ßn (ƒë·ªÉ l·∫•y URL s·∫°ch)
        let rawUrl = linkVal.replace(/<[^>]*>?/gm, '').trim(); 
    %>
    
    <% if (rawUrl.startsWith('http')) { %>
        <a href="<%= rawUrl %>" target="_blank" style="display:inline-flex; align-items:center; gap:5px; background:#eff6ff; color:#2563eb; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:600; border:1px solid #dbeafe;">
            üîó Xem b√°o c√°o chi ti·∫øt ‚Üó
        </a>
    <% } else { %>
        <%- linkVal %>
    <% } %>
</div>
                    </div>
                <% } %>
            </div>
        </div>
    <% } %>
    
    <% 
        const isBySkuList = !promotion.apply_to_all_skus && 
                            (!promotion.apply_to_brands || promotion.apply_to_brands.length === 0) && 
                            (!promotion.apply_to_categories || promotion.apply_to_categories.length === 0);
    %>
    
    <% 
           const hasAllows = promotion.compat_allows && promotion.compat_allows.length > 0;
           const hasExcludes = promotion.compat_excludes && promotion.compat_excludes.length > 0;

           // H√†m helper: Gom nh√≥m
           const groupByGroup = (list) => {
               if (!list) return {};
               return list.reduce((groups, item) => {
                   const gName = item.group_name || 'Kh√°c';
                   if (!groups[gName]) groups[gName] = [];
                   groups[gName].push(item);
                   return groups;
               }, {});
           };
        %>

        <% if (hasAllows || hasExcludes) { %>
            <div class="modern-card">
                <div class="card-header">
                    <div class="card-title" style="color:#0f172a;">üîó Quan h·ªá CTKM</div>
                </div>
                
                <div class="detail-minimal-list" style="padding-top:10px;">
                    
                    <% if (hasAllows) { %>
                        <div class="detail-item" style="border:none; padding-bottom:0;">
                            <div class="detail-item-title" style="color:#166534; margin-bottom:15px;">
                                ‚úÖ √Åp d·ª•ng c√πng (C·ªông d·ªìn)
                            </div>
                            
                            <% 
                               const groupedAllows = groupByGroup(promotion.compat_allows);
                               Object.keys(groupedAllows).sort().forEach(gName => { 
                            %>
                                <div class="tree-group">
                                    <div class="tree-group-label"><%= gName %></div>
                                    
                                    <div class="tree-children">
                                        <% groupedAllows[gName].forEach(p => { %>
                                            <div class="tree-item">
                                                <%= p.name %>
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>

                    <% if (hasAllows && hasExcludes) { %><hr style="border:0; border-top:1px dashed #e2e8f0; margin: 10px 0 20px 0;"><% } %>

                    <% if (hasExcludes) { %>
                        <div class="detail-item" style="border:none; padding-top:0;">
                            <div class="detail-item-title" style="color:#991b1b; margin-bottom:15px;">
                                ‚õî Kh√¥ng √°p d·ª•ng c√πng (Lo·∫°i tr·ª´)
                            </div>
                            
                            <% 
                               const groupedExcludes = groupByGroup(promotion.compat_excludes);
                               Object.keys(groupedExcludes).sort().forEach(gName => { 
                            %>
                                <div class="tree-group">
                                    <div class="tree-group-label" style="background:#fff1f2; color:#991b1b; border-color:#fecaca;">
                                        <%= gName %>
                                    </div>
                                    <div class="tree-children" style="border-left-color:#fecaca;">
                                        <% groupedExcludes[gName].forEach(p => { %>
                                            <div class="tree-item" style="color:#7f1d1d;">
                                                <%= p.name %>
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>
                    
                </div>
            </div>
        <% } %>

    <% if (isBySkuList && includedSkuDetails && includedSkuDetails.length > 0) { %>
    <div class="modern-card" id="skuTableSection">
        <div class="card-header">
            <div class="card-title">
                üì¶ Danh s√°ch SKU & T·ªìn kho 
                <span style="background:#e2e8f0; font-size:12px; padding:2px 8px; border-radius:10px; margin-left:8px;">
                    <%= includedSkuDetails.length %>
                </span>
            </div>
            <input type="text" id="skuSearchInput" placeholder="üîç T√¨m SKU / T√™n..." style="padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px; font-size:13px; width:200px;">
        </div>

        <div class="sku-table-wrapper">
            <table class="sku-table" id="skuTableMain">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Gi√° ni√™m y·∫øt</th>
                        
                        <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin && allBranchNames && allBranchNames.length > 0) { %>
                            <% allBranchNames.forEach(branchName => { %>
                                <th style="text-align: center;"><%= branchName %></th>
                            <% }); %>
                        <% } else if (typeof userBranch !== 'undefined' && userBranch && !isGlobalAdmin) { %>
                            <th style="text-align: center;">T·ªìn <%= userBranch %></th>
                        <% } %>
                    </tr>
                </thead>
                <tbody>
                    <% includedSkuDetails.forEach(function(r) { %>
                        <tr>
                            <td><span class="pill pill-sku"><%= r.sku %></span></td>
                            <td><%= r.product_name || '-' %></td>
                            <td><%= (r.list_price != null) ? new Intl.NumberFormat('vi-VN').format(r.list_price) : '-' %></td>
                            
                            <% 
                                const inventoryForSku = r.inventory || new Map();
                            %>
                            
                            <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin && allBranchNames && allBranchNames.length > 0) { %>
                                <% allBranchNames.forEach(branchName => { 
                                    const counts = inventoryForSku.get(branchName);
                                    const ton_moi = (counts ? counts.hang_ban_moi : 0);
                                %>
                                    <td class="inventory-cell <%= ton_moi > 0 ? 'inventory-has' : 'inventory-zero' %>"><%= ton_moi %></td>
                                <% }); %>
                            <% } else if (typeof userBranch !== 'undefined' && userBranch && !isGlobalAdmin) { 
                                const counts = inventoryForSku.get(userBranch);
                                const ton_moi = (counts ? counts.hang_ban_moi : 0);
                            %>
                                <td class="inventory-cell <%= ton_moi > 0 ? 'inventory-has' : 'inventory-zero' %>"><%= ton_moi %></td>
                            <% } %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
    <% } %>


    <div class="modern-card">
        <div class="card-header">
            <div class="card-title">üïí L·ªãch s·ª≠ thay ƒë·ªïi</div>
        </div>
        <% var _revs=(typeof revisions==='undefined' || !Array.isArray(revisions)) ? [] : revisions; %>
        
        <% if (_revs.length === 0) { %>
            <div style="color:#94a3b8; font-style:italic;">Ch∆∞a c√≥ l·ªãch s·ª≠ c·∫≠p nh·∫≠t.</div>
        <% } else { %>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="sku-table">
                    <thead>
                        <tr>
                            <th style="width: 150px;">Th·ªùi gian</th>
                            <th style="width: 100px;">H√†nh ƒë·ªông</th>
                            <th>Chi ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% _revs.forEach(function(rv){ %>
                            <tr>
                                <td style="color:#64748b; font-size:12px;">
                                    <%= new Date(rv.created_at).toLocaleString('vi-VN') %>
                                </td>
                                <td>
                                    <% if(rv.action==='create') { %> <span class="status-badge status-active">T·∫°o m·ªõi</span>
                                    <% } else { %> <span class="status-badge" style="background:#e0f2fe; color:#0284c7;">C·∫≠p nh·∫≠t</span> <% } %>
                                </td>
                                <td style="font-size:12px;">
                                    <% var d=rv.diff || {}; var keys=Object.keys(d); %>
                                    <% if (keys.length===0) { %> 
                                        <span>Kh√¥ng c√≥ thay ƒë·ªïi</span>
                                    <% } else { %>
                                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                            <% keys.forEach(k => { %>
                                                <span style="background:#f8fafc; border:1px solid #e2e8f0; padding:2px 6px; border-radius:4px;">
                                                    <b><%= k %></b>: 
                                                    <% if (k === 'detail_fields') { %>
                                                        (Chi ti·∫øt c·∫•u h√¨nh)
                                                    <% } else { %>
                                                        <% 
                                                            var valFrom = JSON.stringify(d[k].from);
                                                            if (valFrom === undefined) valFrom = '';
                                                            var valTo = JSON.stringify(d[k].to);
                                                            if (valTo === undefined) valTo = '';
                                                        %>
                                                        <code style="color:#dc2626;"><%= valFrom.substring(0,20) %>...</code> 
                                                        ‚Üí 
                                                        <code style="color:#166534;"><%= valTo.substring(0,20) %>...</code>
                                                    <% } %>
                                                </span>
                                            <% }) %>
                                        </div>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>

    <% } else { %>
        <div class="modern-card" style="text-align:center; padding:40px;">
            <h3>üì≠ Kh√¥ng t√¨m th·∫•y CTKM</h3>
            <a href="/promo-management" class="btn-action btn-edit" style="margin-top:10px;">Quay l·∫°i danh s√°ch</a>
        </div>
    <% } %>

</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. X·ª¨ L√ù ƒê√ìNG MODAL ---
        const couponModal = document.getElementById('couponListModal');
        const historyModal = document.getElementById('priceHistoryModal');

        // H√†m ƒë√≥ng chung
        function closeModal(modal) {
            if (modal) modal.style.display = 'none';
        }

        // B·∫Øt s·ª± ki·ªán click v√†o n√∫t ƒë√≥ng (class .close-modal-btn)
        document.querySelectorAll('.close-modal-btn, .close').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                closeModal(modal);
            });
        });

        // B·∫Øt s·ª± ki·ªán click ra v√πng t·ªëi (Backdrop)
        window.addEventListener('click', function(e) {
            if (e.target === couponModal) closeModal(couponModal);
            if (e.target === historyModal) closeModal(historyModal);
        });

        // Expose h√†m ƒë√≥ng ra window ƒë·ªÉ d√πng n·∫øu c·∫ßn
        window.closeCouponModal = function() { closeModal(couponModal); };

        // --- 2. X·ª¨ L√ù COPY CODE (H·ªó tr·ª£ c·∫£ trong Modal) ---
        window.copyCode = function(btn) {
            const code = btn.getAttribute('data-code');
            if (!code) return;

            const onCopySuccess = () => {
                const originalContent = btn.innerHTML;
                
                // Hi·ªáu ·ª©ng ph·∫£n h·ªìi
                if (btn.tagName === 'BUTTON' && (btn.innerHTML.includes('üìã') || btn.title === 'Copy m√£')) {
                    btn.innerHTML = '<span style="color:#16a34a; font-weight:bold;">‚úî</span>';
                } else {
                    btn.innerHTML = '‚úÖ ƒê√£ copy';
                }

                // Tr·∫£ l·∫°i tr·∫°ng th√°i c≈© sau 1.5s
                setTimeout(() => { 
                    btn.innerHTML = originalContent; 
                }, 1500);
            };

            // ∆Øu ti√™n API Clipboard hi·ªán ƒë·∫°i
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(code).then(onCopySuccess).catch(() => fallbackCopy(code, onCopySuccess));
            } else {
                fallbackCopy(code, onCopySuccess);
            }
        };

        function fallbackCopy(text, onSuccess) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Style ƒë·ªÉ ·∫©n kh·ªèi m·∫Øt ng∆∞·ªùi d√πng nh∆∞ng v·∫´n t∆∞∆°ng t√°c ƒë∆∞·ª£c
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) onSuccess();
                else alert('Kh√¥ng th·ªÉ copy m√£ n√†y (Tr√¨nh duy·ªát ch·∫∑n).');
            } catch (err) {
                console.error('Copy failed', err);
            }
            document.body.removeChild(textArea);
        }

        // --- 3. HI·ªÇN TH·ªä MODAL COUPON ---
       window.showCouponListModal = function(button) {
    const modal = document.getElementById('uniqueCouponModal');
    const titleEl = document.getElementById('uniqueModalTitle');
    const container = document.getElementById('uniqueModalContent');
    
    if (!modal || !titleEl || !container) return;

    // L·∫•y d·ªØ li·ªáu
    const promoName = (button.dataset && button.dataset.promoName) ? button.dataset.promoName : '';
    let coupons = [];
    try { 
        coupons = JSON.parse(button.dataset.coupons || '[]');
    } catch (e) { coupons = []; }

    const fmt = (n) => new Intl.NumberFormat('vi-VN').format(n);
    
    // S·∫Øp x·∫øp gi·∫£m d·∫ßn
    const sorted = coupons.slice().sort((a, b) => {
        const valA = parseFloat(String(a.discount).replace(/\D/g,'')) || 0;
        const valB = parseFloat(String(b.discount).replace(/\D/g,'')) || 0;
        return valB - valA;
    });

    if (sorted.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center;">Kh√¥ng c√≥ coupon n√†o.</div>';
    } else {
        const rows = sorted.map(c => {
            const disc = parseFloat(String(c.discount).replace(/\D/g,'')) || 0;
            // N√∫t copy d√πng onclick inline ƒë·ªÉ ch·∫Øc ch·∫Øn b·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán
            return `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:12px 15px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <code style="font-weight:700; color:#c2410c; background:#fff7ed; padding:4px 8px; border-radius:4px; border:1px solid #ffedd5; user-select: text;">${c.code||'-'}</code>
                            <button type="button" onclick="window.forceCopy('${c.code||''}', this)" 
                                style="border:1px solid #cbd5e1; background:#fff; cursor:pointer; padding:2px 6px; border-radius:4px; font-size:12px;" 
                                title="Copy">
                                üìã Copy
                            </button>
                        </div>
                    </td>
                    <td style="padding:12px 15px; color:#334155;">${c.name||'-'}</td>
                    <td style="padding:12px 15px; color:#16a34a; font-weight:700;">${disc ? fmt(disc)+'ƒë' : '-'}</td>
                    <td style="padding:12px 15px; color:#64748b;">${c.note||''}</td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <table style="width:100%; border-collapse:collapse; font-size:14px;">
                <thead style="background:#f8fafc; color:#475569; position:sticky; top:0; z-index:1;">
                    <tr>
                        <th style="padding:12px 15px; text-align:left;">M√£</th>
                        <th style="padding:12px 15px; text-align:left;">T√™n</th>
                        <th style="padding:12px 15px; text-align:left;">Gi·∫£m</th>
                        <th style="padding:12px 15px; text-align:left;">Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    titleEl.textContent = promoName ? `Coupon: ${promoName}` : 'Danh s√°ch Coupon';
    
    // √âp hi·ªÉn th·ªã flex ƒë·ªÉ ƒë√® c√°c style ·∫©n kh√°c
    modal.style.display = 'flex';
};

        // --- 4. LOGIC T·ªíN KHO COMBO/GIFT (Gi·ªØ nguy√™n) ---
        const comboItems = document.querySelectorAll('.js-combo-item');
        if (comboItems.length > 0) {
            comboItems.forEach(async (el) => {
                const sku = el.getAttribute('data-sku');
                const nameEl = el.querySelector('.js-name');
                const stockEl = el.querySelector('.js-stock');
                if (!sku) return;

                try {
                    const res = await fetch(`/api/admin/search-sku-stock?q=${encodeURIComponent(sku)}`);
                    const json = await res.json();
                    
                    if (json.ok && json.results && json.results.length > 0) {
                        const product = json.results.find(p => p.sku == sku) || json.results[0];
                        nameEl.style.color = '#334155';
                        nameEl.textContent = product.product_name;
                        
                        const stock = product.stock || 0;
                        stockEl.textContent = `T·ªìn: ${stock}`;
                        if (stock > 0) {
                            stockEl.className = 'combo-stock-badge stock-has js-stock';
                        } else {
                            stockEl.className = 'combo-stock-badge stock-zero js-stock';
                        }
                    } else {
                        nameEl.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y SP';
                        nameEl.style.color = '#ef4444';
                    }
                } catch (e) {
                    console.error(e);
                    nameEl.textContent = '‚ö†Ô∏è L·ªói t·∫£i';
                }
            });
        }

        // --- 5. LOGIC L·ªäCH S·ª¨ GI√Å (Gi·ªØ nguy√™n ph·∫ßn g·ªçi API) ---
        const btnHistory = document.getElementById('btnHistoryPrice');
        const historyTbody = document.querySelector('#phTable tbody');
        const searchInput = document.getElementById('skuSearchInput'); // ID input t√¨m ki·∫øm ·ªü tr√™n b·∫£ng SKU
        // N·∫øu trang n√†y ko c√≥ input id ƒë√≥ th√¨ l·∫•y t·ª´ bi·∫øn logic kh√°c, ·ªü ƒë√¢y t√¥i gi·∫£ ƒë·ªãnh logic c≈©
        
        if (btnHistory) {
            btnHistory.onclick = async (e) => {
                e.preventDefault();
                // Logic l·∫•y SKU t·ª´ ng·ªØ c·∫£nh trang edit, nh∆∞ng ·ªü trang detail n√†y th∆∞·ªùng ko c√≥ n√∫t n√†y. 
                // T√¥i gi·ªØ l·∫°i structure ƒë·ªÉ tr√°nh l·ªói JS n·∫øu b·∫°n copy paste t·ª´ trang edit sang.
            };
        }
    });



    window.forceCloseModal = function() {
    const modal = document.getElementById('uniqueCouponModal');
    if (modal) modal.style.display = 'none';
};

// ƒê√≥ng khi click ra ngo√†i v√πng ƒëen (Backdrop)
window.onclick = function(event) {
    const modal = document.getElementById('uniqueCouponModal');
    if (event.target == modal) {
        modal.style.display = "none";
    }
};

// H√†m copy ƒë·ªôc l·∫≠p
window.forceCopy = function(text, btn) {
    if (!text) return;
    
    // T·∫°o textarea t·∫°m ƒë·ªÉ copy
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        // Hi·ªáu ·ª©ng n√∫t
        const oldText = btn.innerHTML;
        btn.innerHTML = '‚úî ƒê√£ ch√©p';
        btn.style.color = 'green';
        setTimeout(() => {
            btn.innerHTML = oldText;
            btn.style.color = '';
        }, 1500);
    } catch (err) {
        alert('Kh√¥ng copy ƒë∆∞·ª£c: ' + text);
    }
    document.body.removeChild(textArea);
};

// --- 7. LOGIC T√åM KI·∫æM TRONG B·∫¢NG SKU (Client-side) ---
    const tableSearchInput = document.getElementById('skuSearchInput');
    const skuTable = document.getElementById('skuTableMain');

    if (tableSearchInput && skuTable) {
        tableSearchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase().trim();
            const rows = skuTable.querySelectorAll('tbody tr');

            rows.forEach(row => {
                // L·∫•y n·ªôi dung c·ªßa SKU (c·ªôt 1) v√† T√™n s·∫£n ph·∫©m (c·ªôt 2)
                // Ho·∫∑c ƒë∆°n gi·∫£n l√† l·∫•y to√†n b·ªô text c·ªßa d√≤ng ƒë√≥
                const textContent = row.textContent.toLowerCase();
                
                // N·∫øu t√¨m th·∫•y t·ª´ kh√≥a -> Hi·ªán, ng∆∞·ª£c l·∫°i -> ·∫®n
                if (textContent.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
</script>


<div id="couponListModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:99999; align-items:center; justify-content:center;">
    <div style="background:#fff; width:90%; max-width:700px; padding:0; border-radius:12px; position:relative; max-height:85vh; display:flex; flex-direction:column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow:hidden;">
        
        <div style="padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
            <h3 id="couponModalTitle" style="margin:0; font-size:16px; font-weight:700; color:#0f172a;">Danh s√°ch Coupon</h3>
            <span class="close-modal-btn" style="cursor:pointer; font-size:24px; color:#64748b; line-height: 1; padding: 0 5px;">&times;</span>
        </div>
        
        <div id="couponModalTableContainer" style="overflow-y:auto; flex:1; padding: 0;">
            </div>

        <div style="padding: 10px 20px; border-top: 1px solid #e2e8f0; text-align: right; background: #fff;">
            <button class="close-modal-btn" style="background: #e2e8f0; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; color: #475569; cursor: pointer;">ƒê√≥ng</button>
        </div>
    </div>
</div>

<div id="uniqueCouponModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:2147483647; align-items:center; justify-content:center; pointer-events: auto;">
    
    <div style="background:#fff; width:90%; max-width:700px; max-height:85vh; border-radius:12px; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); pointer-events: auto !important; position: relative;">
        
        <div style="padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 12px 12px 0 0;">
            <h3 id="uniqueModalTitle" style="margin:0; font-size:16px; font-weight:700; color:#0f172a;">Danh s√°ch Coupon</h3>
            <div onclick="window.forceCloseModal()" style="cursor:pointer; padding: 5px 10px; font-size: 24px; color: #64748b; font-weight: bold;">&times;</div>
        </div>
        
        <div id="uniqueModalContent" style="overflow-y:auto; flex:1; padding: 0; background: #fff; user-select: text !important; -webkit-user-select: text !important;">
            </div>

        <div style="padding: 10px 20px; border-top: 1px solid #e2e8f0; text-align: right; background: #fff; border-radius: 0 0 12px 12px;">
            <button onclick="window.forceCloseModal()" style="background: #e2e8f0; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; font-weight: 600; color: #475569; cursor: pointer;">ƒê√≥ng l·∫°i</button>
        </div>
    </div>
</div>
<%- include('partials/toast') %>
<%- include('partials/footer') %>
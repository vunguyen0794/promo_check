<%- include('partials/header', { title: 'Chi ti·∫øt CTKM' , currentPage: 'promotion-detail' , time: time }) %>

  <style>
    .promotion-page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
    }

    .promotion-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, .06);
      padding: 18px;
    }

    .headline {
      font-size: 20px;
      font-weight: 800;
      margin: 0 0 12px 0;
      letter-spacing: .2px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      margin: 0 6px 8px 0;
    }

    .badge-blue {
      background: #e0f2fe;
      color: #0369a1;
    }

    .badge-gray {
      background: #eef2f7;
      color: #475569;
    }

    .badge-green {
      background: #dcfce7;
      color: #166534;
      font-weight: 700;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 18px 0 10px 0;
      color: #0f172a;
    }

    .detail-grid {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }

    .detail-grid th,
    .detail-grid td {
      padding: 10px 12px;
      vertical-align: top;
      border-bottom: 1px solid #eef2f7;
    }

    .detail-grid th {
      width: 30%;
      background: #f8fafc;
      font-weight: 600;
      color: #0f172a;
      text-align: left;
    }

    .detail-grid tr:nth-child(even) td {
      background: #fcfcfd;
    }

    .kv {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 10px;
      margin: 8px 0;
    }

    .pill {
      display: inline-block;
      background: #eef2f7;
      color: #334155;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      margin: 2px 6px 2px 0;
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, #e5e7eb, transparent);
      margin: 16px 0;
    }

    .empty {
      color: #94a3b8;
      font-style: italic;
    }
  </style>
  <style>
    /* L√†m n·ªïi card ph√≠a tr√™n */
    .promotion-card.hero {
      background: #ffffff;
      border: 1px solid #dbe3f0;
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(2, 6, 23, .08);
      padding: 18px;
    }

    .headline {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }


    /* L√†m nh·∫π ph·∫ßn b·∫£ng chi ti·∫øt */
    /* ƒê√öNG */
    .detail-card {
      background: transparent;
      border: 0;
      box-shadow: none;
      padding: 0;
      margin-top: 10px;
    }

    .detail-grid {
      border: 1px solid #f1f5f9;
      border-radius: 12px;
      table-layout: fixed;
    }

    .detail-grid colgroup col:first-child {
      width: 30%;
    }

    .detail-grid colgroup col:last-child {
      width: 70%;
    }

    .detail-grid th {
      background: #f8fafc;
      color: #0f172a;
    }

    .detail-grid tr:nth-child(even) td {
      background: #fcfcfd;
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, #e5e7eb, transparent);
      margin: 14px 0;
    }

    /* Badge tr·∫°ng th√°i n·ªïi b·∫≠t */
    .badge.badge-green {
      background: #dcfce7;
      color: #166534;
      font-weight: 700;
    }

    /* Mobile tinh ch·ªânh */
    @media (max-width: 768px) {
      .detail-grid colgroup col:first-child {
        width: 42%;
      }

      .detail-grid colgroup col:last-child {
        width: 58%;
      }
    }

    .section-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, .04);
      padding: 14px;
      margin: 14px 0;
    }

    .section-card .detail-grid {
      margin-top: 6px;
    }

    .detail-grid td {
    height: auto !important; /* Cho ph√©p chi·ªÅu cao t·ª± ƒë·ªông co gi√£n */
    overflow: visible !important; /* Hi·ªÉn th·ªã to√†n b·ªô n·ªôi dung, kh√¥ng ·∫©n ƒëi */
    display: table-cell !important; /* Tr·∫£ v·ªÅ hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh c·ªßa √¥ trong b·∫£ng */
    -webkit-line-clamp: unset !important; /* T·∫Øt gi·ªõi h·∫°n s·ªë d√≤ng (n·∫øu c√≥) */
    line-clamp: unset !important;
    white-space: normal !important; /* Cho ph√©p ch·ªØ t·ª± xu·ªëng d√≤ng */
    word-break: break-word; /* B·∫ª ch·ªØ n·∫øu c·∫ßn ƒë·ªÉ kh√¥ng v·ª° layout */
}

.table-scroll-wrapper {
    overflow-x: auto; /* T·ª± ƒë·ªông th√™m thanh tr∆∞·ª£t ngang khi c·∫ßn */
    -webkit-overflow-scrolling: touch; /* Cu·ªôn m∆∞·ª£t tr√™n iOS */
    border: 1px solid #f1f5f9; /* Di chuy·ªÉn border t·ª´ table ra div b·ªçc ngo√†i */
    border-radius: 12px; /* Di chuy·ªÉn bo g√≥c ra div b·ªçc ngo√†i */
}

.table-scroll-wrapper .detail-grid {
    width: auto; /* Cho ph√©p b·∫£ng c√≥ chi·ªÅu r·ªông t·ª± nhi√™n c·ªßa n√≥ */
    min-width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng lu√¥n r·ªông √≠t nh·∫•t b·∫±ng div b·ªçc ngo√†i */
    border: none; /* X√≥a border c·ªßa table v√¨ ƒë√£ c√≥ ·ªü div b·ªçc ngo√†i */
    border-radius: 0;
    table-layout: auto; /* ƒê·ªÉ chi·ªÅu r·ªông c·ªôt t·ª± ƒëi·ªÅu ch·ªânh theo n·ªôi dung */
}

.table-scroll-wrapper .detail-grid {
    width: auto; /* Cho ph√©p b·∫£ng c√≥ chi·ªÅu r·ªông t·ª± nhi√™n c·ªßa n√≥ */
    min-width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng lu√¥n r·ªông √≠t nh·∫•t b·∫±ng div b·ªçc ngo√†i */
    border: none; /* X√≥a border c·ªßa table v√¨ ƒë√£ c√≥ ·ªü div b·ªçc ngo√†i */
    border-radius: 0;
    table-layout: auto; /* ƒê·ªÉ chi·ªÅu r·ªông c·ªôt t·ª± ƒëi·ªÅu ch·ªânh theo n·ªôi dung */
}

.section-card {
    overflow: visible !important; /* Bu·ªôc hi·ªÉn th·ªã n·ªôi dung b·ªã tr√†n */
    height: auto !important; /* Bu·ªôc chi·ªÅu cao ph·∫£i t·ª± ƒë·ªông co gi√£n */
}
/* --- CSS M·ªöI CHO PH·∫¶N PH·∫†M VI √ÅP D·ª§NG --- */
.scope-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.scope-row {
    display: flex;
    align-items: baseline; /* CƒÉn ch√¢n ch·ªØ cho th·∫≥ng */
    gap: 8px;
    flex-wrap: wrap;
}

.scope-label {
    font-size: 13px;
    font-weight: 700;
    color: #475569;
    min-width: 60px; /* ƒê·ªô r·ªông c·ªë ƒë·ªãnh ƒë·ªÉ th·∫≥ng h√†ng */
    flex-shrink: 0;
}

.scope-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    margin-right: 6px;
    margin-bottom: 4px;
}

/* M√†u s·∫Øc cho √Åp d·ª•ng */
.badge-brand { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
.badge-cat   { background-color: #fae8ff; color: #86198f; border: 1px solid #f0abfc; }
.badge-sub   { background-color: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
.badge-sku   { background-color: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; }

/* M√†u s·∫Øc cho Lo·∫°i tr·ª´ */
.exclude-container {
    background-color: #fef2f2;
    border: 1px dashed #fca5a5;
    border-radius: 8px;
    padding: 10px;
    margin-top: 4px;
}
.exclude-header {
    color: #dc2626; 
    font-weight: 700; 
    font-size: 13px; 
    margin-bottom: 8px; 
    display:flex; 
    align-items:center; 
    gap:6px;
}
.badge-exclude { background-color: #fff; color: #b91c1c; border: 1px solid #fecaca; }
  </style>


  <div class="promotion-page">
    <% if (typeof error !=='undefined' && error) { %>
      <div class="promotion-card" style="border-left:4px solid #ef4444;">
        <div class="headline" style="color:#ef4444;">L·ªói h·ªá th·ªëng</div>
        <div>
          <%= error %>
        </div>
      </div>
      <% } %>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
    <div class="headline" style="margin: 0;">Chi ti·∫øt CTKM</div>
    
    <% if (typeof currentUser !== 'undefined' && (currentUser.role === 'manager' || currentUser.role === 'admin')) { %>
        <a href="/edit-promotion/<%= promotion.id %>" 
           style="background-color: #f59e0b; color: #000; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s;">
            ‚úèÔ∏è S·ª≠a CTKM
        </a>
    <% } %>
</div>

        <% if (promotion) { %>

          <!-- ========== 1) Th√¥ng tin c∆° b·∫£n (b·∫£ng) ========== -->
          <div class="section-card">
            <h3 class="section-title">Th√¥ng tin c∆° b·∫£n</h3>
            <div class="table-scroll-wrapper">
            <table class="detail-grid">
              <colgroup>
                <col />
                <col />
              </colgroup>
              <tbody>
    <tr>
        <th>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</th>
        <td><%= promotion.updated_at ? new Date(promotion.updated_at).toLocaleString('vi-VN') : '-' %></td>
    </tr>

    <tr>
        <th>T√™n CTKM</th>
        <td><strong><%= promotion.name || promotion.promo_name || 'CTKM' %></strong></td>
    </tr>
    
    <tr>
        <th>M√¥ t·∫£</th>
        <td><%- (promotion.description || '').replace(/\n/g, '<br>') %></td>
    </tr>
    
    <tr>
        <th>Th·ªùi gian</th>
        <td>
            <%= promotion.start_date ? new Date(promotion.start_date).toLocaleDateString('vi-VN') : '...' %>
            &nbsp;-&nbsp;
            <%= promotion.end_date ? new Date(promotion.end_date).toLocaleDateString('vi-VN') : '...' %>
        </td>
    </tr>
    
    <tr>
        <th>Channel</th>
        <td><%= promotion.channel || 'All' %></td>
    </tr>

    <tr>
        <th>Chi nh√°nh √°p d·ª•ng</th>
        <td>
            <% if (promotion.apply_branches && promotion.apply_branches.length > 0) { %>
                <div class="pill-wrap">
                    <% promotion.apply_branches.forEach(function(br) { %>
                        <span class="pill" style="background:#e0f2fe; color:#0284c7; font-weight:600;"><%= br %></span>
                    <% }) %>
                </div>
            <% } else { %>
                <strong>To√†n qu·ªëc</strong>
            <% } %>
        </td>
    </tr>

    <tr>
        <th>Lo·∫°i CTKM</th>
        <td><%= promotion.promo_type || '...' %></td>
    </tr>
    
    <tr>
        <th>M√£ gi·∫£m gi√°</th>
        <td>
            <% if (promotion.coupon_list && promotion.coupon_list.length > 1) { %>
                <button type="button" class="code-badge" onclick="showCouponListModal(this)"
                    data-promo-name="<%= promotion.name %>"
                    data-coupons='<%- JSON.stringify(promotion.coupon_list) %>'>
                    üìú Danh s√°ch coupon (B·∫•m ƒë·ªÉ xem)
                </button>
            <% } else if (promotion.coupon_list && promotion.coupon_list.length === 1) { %>
                <button type="button" class="code-badge" onclick="copyCode(this)" data-code="<%= promotion.coupon_list[0].code %>">
                    üîë <span><%= promotion.coupon_list[0].code %></span> <small>(B·∫•m ƒë·ªÉ copy)</small>
                </button>
            <% } else if (promotion.coupon_code) { %>
                <button type="button" class="code-badge" onclick="copyCode(this)" data-code="<%= promotion.coupon_code %>">
                    üîë <span><%= promotion.coupon_code %></span> <small>(B·∫•m ƒë·ªÉ copy)</small>
                </button>
            <% } else { %>
                <span class="muted">Kh√¥ng c√≥</span>
            <% } %>
        </td>
    </tr>

    <tr>
        <th>Gi√° tr·ªã gi·∫£m</th>
        <td>
            <% if (promotion.max_coupon_discount) { %>
                Gi·∫£m t·ªëi ƒëa <strong><%= new Intl.NumberFormat('vi-VN').format(promotion.max_coupon_discount) %> ‚Ç´</strong>
            <% } else if ((promotion.discount_value_type || '').toLowerCase() === 'amount') { %>
                Gi·∫£m <strong><%= (promotion.discount_value || 0).toLocaleString('vi-VN') %> ‚Ç´</strong>
                <% if (promotion.min_order_value) { %> (ƒë∆°n t·ªëi thi·ªÉu <%= (promotion.min_order_value || 0).toLocaleString('vi-VN') %> ‚Ç´) <% } %>
            <% } else if ((promotion.discount_value_type || '').toLowerCase() === 'percent') { %>
                Gi·∫£m <strong><%= promotion.discount_value %>%</strong>
                <% if (promotion.max_discount_amount) { %> (t·ªëi ƒëa <%= (promotion.max_discount_amount || 0).toLocaleString('vi-VN') %> ‚Ç´) <% } %>
            <% } else { %>
                -
            <% } %>
        </td>
    </tr>

    <% if (promotion.group_name) { %>
        <tr>
            <th>Nh√≥m</th>
            <td>
                <span class="badge badge-blue"><%= promotion.group_name %></span>
                <% if (promotion.show_multiple_in_group) { %>
                    <div style="margin-top:4px; font-size:12px; color:#166534;">
                        ‚úÖ Cho ph√©p hi·ªÉn th·ªã c√πng c√°c CTKM kh√°c trong nh√≥m
                    </div>
                <% } else { %>
                    <div style="margin-top:4px; font-size:12px; color:#64748b;">
                        ‚ö°Ô∏è Ch·ªâ l·∫•y CTKM t·ªët nh·∫•t trong nh√≥m
                    </div>
                <% } %>
            </td>
        </tr>
    <% } %>

    <tr>
        <th>Tr·∫°ng th√°i</th>
        <td>
            <% if ((promotion.status || 'active') === 'active') { %>
                <span class="badge badge-green">Active</span>
            <% } else { %>
                <span class="badge badge-gray"><%= promotion.status %></span>
            <% } %>
        </td>
    </tr>
</tbody>
            </table>
            </div>
          </div>

          <!-- ========== 2) B·∫£ng chi ti·∫øt (hi·ªÉn th·ªã) ========== -->
          <div class="section-card">
  <h3 class="section-title">B·∫£ng chi ti·∫øt (hi·ªÉn th·ªã)</h3>
  <% if (promotion.detail_fields && Object.keys(promotion.detail_fields).length) { %>
    <div class="table-scroll-wrapper">
    <table class="detail-grid">
      <colgroup>
        <col />
        <col />
      </colgroup>
      <tbody>
        <% Object.keys(promotion.detail_fields).forEach(function(k){ 
             const v = (promotion.detail_fields || {})[k]; 
             if (!v || String(v).trim() === '') return; // B·ªè qua n·∫øu gi√° tr·ªã r·ªóng
        %>
          <tr>
            <th><%= k %></th>
            
            <td><%- v %></td>

          </tr>
        <% }) %>
      </tbody>
    </table>
    </div>
  <% } else { %>
    <div class="empty">Ch∆∞a c√≥ tr∆∞·ªùng chi ti·∫øt n√†o.</div>
  <% } %>
</div>
          <!-- ========== 3) Ph·∫°m vi √°p d·ª•ng (b·∫£ng) ========== -->
          <% const included=(promotion.promotion_skus || []).map(x=> x.sku);
            const excluded = (promotion.promotion_excluded_skus || []).map(x => x.sku);
            function pillList(list){ return (list||[]).map(s=>`<span class="pill">${s}</span>`).join(''); }
            %>
            <div class="section-card">
    <h3 class="section-title">Ph·∫°m vi √°p d·ª•ng</h3>
    <tbody>
    <tr>
        <th style="vertical-align: middle;">‚úÖ √Åp d·ª•ng cho</th>
        <td>
            <div class="scope-container">
                <% if (promotion.apply_to_all_skus) { %>
                    <span class="status-badge active" style="font-size:14px; padding:6px 12px;">
                        üåç T·∫•t c·∫£ s·∫£n ph·∫©m
                    </span>

                <% } else if (promotion.apply_brand_subcats && promotion.apply_brand_subcats.length > 0) { %>
                    <% 
                        const brands = [...new Set(promotion.apply_brand_subcats.map(r => r.brand))];
                        const subcats = [...new Set(promotion.apply_brand_subcats.map(r => r.subcat_id))];
                    %>
                    <div class="scope-row">
                        <span class="scope-label">Brand:</span>
                        <div>
                            <% brands.forEach(b => { %>
                                <span class="scope-badge badge-brand"><%= b %></span>
                            <% }) %>
                        </div>
                    </div>
                    <div class="scope-row">
                        <span class="scope-label">Subcat:</span>
                        <div>
                            <% subcats.forEach(s => { %>
                                <span class="scope-badge badge-sub"><%= s %></span>
                            <% }) %>
                        </div>
                    </div>

                <% } else if (promotion.apply_to_brands && promotion.apply_to_brands.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">Brand:</span>
                        <div>
                            <% promotion.apply_to_brands.forEach(b => { %>
                                <span class="scope-badge badge-brand"><%= b %></span>
                            <% }) %>
                        </div>
                    </div>

                <% } else if (promotion.apply_to_categories && promotion.apply_to_categories.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">Category:</span>
                        <div>
                            <% promotion.apply_to_categories.forEach(c => { %>
                                <span class="scope-badge badge-cat"><%= c %></span>
                            <% }) %>
                        </div>
                    </div>

                <% } else if (promotion.apply_to_subcats && promotion.apply_to_subcats.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">Subcat:</span>
                        <div>
                            <% promotion.apply_to_subcats.forEach(s => { %>
                                <span class="scope-badge badge-sub"><%= s %></span>
                            <% }) %>
                        </div>
                    </div>

                <% } else if (promotion.promotion_skus && promotion.promotion_skus.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">Danh s√°ch:</span>
                        <span class="scope-badge badge-sku">
                            <%= promotion.promotion_skus.length %> SKU c·ª• th·ªÉ
                        </span>
                        <small class="muted">(Xem b·∫£ng b√™n d∆∞·ªõi)</small>
                    </div>

                <% } else { %>
                    <span class="muted">Ch∆∞a x√°c ƒë·ªãnh</span>
                <% } %>
            </div>
        </td>
    </tr>

    <% if ((promotion.exclude_brands && promotion.exclude_brands.length > 0) || 
           (promotion.exclude_subcats && promotion.exclude_subcats.length > 0) ||
           (promotion.promotion_excluded_skus && promotion.promotion_excluded_skus.length > 0)) { %>
    <tr>
        <th></th> <td style="padding-top: 0;">
            <div class="exclude-container">
                <div class="exclude-header">
                    ‚õîÔ∏è Danh s√°ch lo·∫°i tr·ª´
                </div>
                
                <% if (promotion.exclude_brands && promotion.exclude_brands.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">Brand:</span>
                        <div>
                            <% promotion.exclude_brands.forEach(b => { %>
                                <span class="scope-badge badge-exclude"><%= b %></span>
                            <% }) %>
                        </div>
                    </div>
                <% } %>

                <% if (promotion.exclude_subcats && promotion.exclude_subcats.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">Subcat:</span>
                        <div>
                            <% promotion.exclude_subcats.forEach(s => { %>
                                <span class="scope-badge badge-exclude"><%= s %></span>
                            <% }) %>
                        </div>
                    </div>
                <% } %>

                <% if (promotion.promotion_excluded_skus && promotion.promotion_excluded_skus.length > 0) { %>
                    <div class="scope-row">
                        <span class="scope-label">SKU l·∫ª:</span>
                        <span style="font-size:13px; color:#b91c1c;">
                            <%= promotion.promotion_excluded_skus.length %> SKU b·ªã ch·∫∑n (Xem b·∫£ng d∆∞·ªõi)
                        </span>
                    </div>
                <% } %>
            </div>
        </td>
    </tr>
    <% } %>
</tbody>
    <%# Logic ƒë·ªÉ quy·∫øt ƒë·ªãnh c√≥ hi·ªÉn th·ªã b·∫£ng SKU √°p d·ª•ng hay kh√¥ng %>
    <% const isBySkuList = !promotion.apply_to_all_skus && (!promotion.apply_to_brands || promotion.apply_to_brands.length === 0) && (!promotion.apply_to_categories || promotion.apply_to_categories.length === 0) && (!promotion.apply_to_subcats || promotion.apply_to_subcats.length === 0); %>
    
    <% if (isBySkuList && includedSkuDetails && includedSkuDetails.length > 0) { %>
        <div class="sku-table-block" id="includedSkuBlock" data-initial="10">
            <div class="sku-table-header">
                <div class="sku-table-title">SKU √°p d·ª•ng</div>
                <input type="search" class="sku-search" placeholder="T√¨m trong danh s√°ch..." oninput="filterSkuTable('includedSkuBlock')">
            </div>
            <table class="sku-table">
                <thead><tr><th>SKU</th><th>T√™n SP</th><th>Brand</th><th>Gi√°</th>
                <%# === C·ªòT T·ªíN KHO M·ªöI (H·ªñ TR·ª¢ ADMIN) === %>
                    <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin && allBranchNames && allBranchNames.length > 0) { %>
                        <%# Admin: Hi·ªÉn th·ªã NHI·ªÄU C·ªòT theo allBranchNames %>
                        <% (allBranchNames || []).forEach(branchName => { %>
                            <th style="text-align: center;">T·ªìn <%= branchName %> (M·ªõi)</th>
                        <% }); %>
                    <% } else if (typeof userBranch !== 'undefined' && userBranch && !isGlobalAdmin) { %>
                        <%# User th∆∞·ªùng: Hi·ªÉn th·ªã 1 C·ªòT %>
                        <th style="text-align: center;">T·ªìn <%= userBranch %> (M·ªõi)</th>
                    <% } %>
                    <%# === K·∫æT TH√öC === %>
                </tr></thead>
                <tbody>
                    <% includedSkuDetails.forEach(function(r){ %>
                        <tr class="sku-row">
                            <td><%= r.sku %></td>
                            <td><%= r.product_name || '-' %></td>
                            <td><%= r.brand || '-' %></td>
                            <td><%= (r.list_price != null) ? r.list_price.toLocaleString('vi-VN') : '-' %></td>
                            <%# === D·ªÆ LI·ªÜU T·ªíN KHO M·ªöI (H·ªñ TR·ª¢ ADMIN) === %>
                        <%
                            // r.inventory l√† Map<Branch, Counts> ho·∫∑c null
                            const inventoryForSku = r.inventory || new Map();
                        %>

                          <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin && allBranchNames && allBranchNames.length > 0) { %>
                            <%# Admin: L·∫∑p qua c√°c c·ªôt branch... %>
<% (allBranchNames || []).forEach(branchName => { %>
    <% const counts = inventoryForSku.get(branchName); %>
    <% const ton_moi = (counts ? counts.hang_ban_moi : 0); %>
    <td style="text-align: center; font-weight: 700;" class="<%= ton_moi === 0 ? 'zero-muted' : '' %>">
        <%= ton_moi %>
    </td>
<% }); %>
<% } else if (typeof userBranch !== 'undefined' && userBranch && !isGlobalAdmin) { %>
    <%# User th∆∞·ªùng: Ch·ªâ l·∫•y 1 c·ªôt... %>
    <% const counts = inventoryForSku.get(userBranch); %>
    <% const ton_moi = (counts ? counts.hang_ban_moi : 0); %>
    <td style="text-align: center; font-weight: 700;" class="<%= ton_moi === 0 ? 'zero-muted' : '' %>">
        <%= ton_moi %>
    </td>
<% } %>
                            
                        <%# === K·∫æT TH√öC === %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
            <div class="notfound empty" style="display:none;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</div>
            <% if (includedSkuDetails.length > 10) { %>
                <button type="button" class="btn-more" onclick="toggleMore('includedSkuBlock')">Xem th√™m‚Ä¶</button>
            <% } %>
        </div>
    <% } %>

    <% if (excludedSkuDetails && excludedSkuDetails.length > 0) { %>
        <div class="sku-table-block" id="excludedSkuBlock" data-initial="10">
            <div class="sku-table-header">
                <div class="sku-table-title">SKU lo·∫°i tr·ª´</div>
                <input type="search" class="sku-search" placeholder="T√¨m trong danh s√°ch..." oninput="filterSkuTable('excludedSkuBlock')">
            </div>
            <div class="table-scroll-wrapper"></div>
            <table class="sku-table">
                <thead><tr><th>SKU</th><th>T√™n SP</th><th>Brand</th><th>Gi√°</th></tr></thead>
                <tbody>
                    <% excludedSkuDetails.forEach(function(r){ %>
                        <tr class="sku-row">
                            <td><%= r.sku %></td>
                            <td><%= r.product_name || '-' %></td>
                            <td><%= r.brand || '-' %></td>
                            <td><%= (r.list_price != null) ? r.list_price.toLocaleString('vi-VN') : '-' %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
            </div>
             <div class="notfound empty" style="display:none;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</div>
            <% if (excludedSkuDetails.length > 10) { %>
                <button type="button" class="btn-more" onclick="toggleMore('excludedSkuBlock')">Xem th√™m‚Ä¶</button>
            <% } %>
        </div>
    <% } %>
</div>
            <!-- Quan h·ªá v·ªõi CTKM kh√°c -->
<div class="section-card">
  <h3 class="section-title">Quan h·ªá v·ªõi CTKM kh√°c</h3>

<%
const norm = s => (s || '').trim().toLowerCase();
const SG_NONE = '__none__';

// subgroup h·ª£p l·ªá: kh√°c r·ªóng, kh√°c t√™n CTKM, kh√°c t√™n group
function getSubgroupKey(p) {
  const s = (p.subgroup_name || '').trim();
  if (!s) return SG_NONE;
  if (norm(s) === norm(p.name)) return SG_NONE;
  if (norm(s) === norm(p.group_name)) return SG_NONE;
  return s;
}

function buildHierarchy(items) {
  const groups = {};
  (items || []).forEach(p => {
    const g = p.group_name || 'Kh√°c';
    const sg = getSubgroupKey(p);
    groups[g] ||= {};
    groups[g][sg] ||= [];
    // dedupe theo id
    if (!groups[g][sg].some(x => x.id === p.id)) groups[g][sg].push(p);
  });
  return groups;
}
%>

<div class="card">
  <div class="card-title">√Åp d·ª•ng c√πng (theo nh√≥m)</div>

  <%
    const allows = promotion.compat_allows || [];
    if (!allows.length) {
  %>
    <div class="empty">Kh√¥ng c√≥.</div>
  <% } else { 
      const grouped = buildHierarchy(allows);
      const groupNames = Object.keys(grouped).sort();
  %>
    <% groupNames.forEach(g => { 
         const submap = grouped[g];
         const subNames = Object.keys(submap);
         const onlyOne = (subNames.length === 1);
         const onlyKey = onlyOne ? subNames[0] : null;
         const onlyList = onlyOne ? submap[onlyKey] : null;
    %>
      <div class="group-box">
        <div class="group-title"><span class="dot"></span><%= g %></div>

        <% // N·∫øu ch·ªâ c√≥ 1 ‚Äúbucket‚Äù v√† (bucket ƒë√≥ l√† NONE ho·∫∑c ch·ªâ c√≥ 1 item) => flatten, kh√¥ng in ti√™u ƒë·ªÅ subgroup %>
        <% if (onlyOne && (onlyKey === SG_NONE || (onlyList && onlyList.length === 1))) { %>
          <div class="group-items">
            <% (onlyList || []).forEach(item => { if (item.id !== promotion.id) { %>
              <span class="pill"><%= item.name %></span>
            <% } }) %>
          </div>
        <% } else { %>
          <% // In t·ª´ng subgroup; bucket NONE in nh∆∞ 1 nh√≥m kh√¥ng ti√™u ƒë·ªÅ %>
          <% subNames.sort().forEach(sg => { 
               const items = submap[sg] || []; 
               const showTitle = (sg !== SG_NONE);
          %>
            <div class="subgroup-box">
              <% if (showTitle) { %>
                <div class="subgroup-title">‚Ä¢ <%= sg %></div>
              <% } %>
              <div class="group-items">
                <% items.forEach(item => { if (item.id !== promotion.id) { %>
                  <span class="pill"><%= item.name %></span>
                <% } }) %>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    <% }) %>
  <% } %>
</div>

<div class="card">
  <div class="card-title">Kh√¥ng √°p d·ª•ng c√πng (theo nh√≥m)</div>

  <%
    const excludes = promotion.compat_excludes || [];
    if (!excludes.length) {
  %>
    <div class="empty">Kh√¥ng c√≥.</div>
  <% } else { 
      const groupedX = buildHierarchy(excludes);
      const groupNamesX = Object.keys(groupedX).sort();
  %>
    <% groupNamesX.forEach(g => { 
         const submap = groupedX[g];
         const subNames = Object.keys(submap);
         const onlyOne = (subNames.length === 1);
         const onlyKey = onlyOne ? subNames[0] : null;
         const onlyList = onlyOne ? submap[onlyKey] : null;
    %>
      <div class="group-box warn">
        <div class="group-title"><span class="dot"></span><%= g %></div>

        <% if (onlyOne && (onlyKey === SG_NONE || (onlyList && onlyList.length === 1))) { %>
          <div class="group-items">
            <% (onlyList || []).forEach(item => { if (item.id !== promotion.id) { %>
              <span class="pill pill-warn"><%= item.name %></span>
            <% } }) %>
          </div>
        <% } else { %>
          <% subNames.sort().forEach(sg => { 
               const items = submap[sg] || []; 
               const showTitle = (sg !== SG_NONE);
          %>
            <div class="subgroup-box">
              <% if (showTitle) { %>
                <div class="subgroup-title">‚Ä¢ <%= sg %></div>
              <% } %>
              <div class="group-items">
                <% items.forEach(item => { if (item.id !== promotion.id) { %>
                  <span class="pill pill-warn"><%= item.name %></span>
                <% } }) %>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    <% }) %>
  <% } %>
</div>



                </tbody>
              </table>
            </div>



            <% var _revs=(typeof revisions==='undefined' || !Array.isArray(revisions)) ? [] : revisions; %>
              <!-- L·ªãch s·ª≠ c·∫≠p nh·∫≠t -->
              <div class="section-card">
                <h3 class="section-title">L·ªãch s·ª≠ c·∫≠p nh·∫≠t</h3>

                <% if (!_revs || _revs.length===0) { %>
                  <div class="empty">Ch∆∞a c√≥ l·ªãch s·ª≠.</div>
                  <% } else { %>
                    <table class="detail-grid">
                      <colgroup>
                        <col style="width:220px">
                        <col style="width:120px">
                        <col>
                      </colgroup>
                      <thead>
                        <tr>
                          <th>Th·ªùi gian</th>
                          <th>H√†nh ƒë·ªông</th>
                          <th>Thay ƒë·ªïi</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% _revs.forEach(function(rv){ %>
                          <tr>
                            <td>
                              <%= new Date(rv.created_at).toLocaleString('vi-VN') %>
                            </td>
                            <td>
                              <%= rv.action==='create' ? 'T·∫°o' : 'C·∫≠p nh·∫≠t' %>
                            </td>
                            <td>
                              <% var d=rv.diff || {}; var keys=Object.keys(d); %>
                                <% if (keys.length===0) { %>
                                  <span class="empty">Kh√¥ng c√≥ thay ƒë·ªïi</span>
                                  <% } else { %>
                                    <ul class="change-list">
  <% keys.forEach(function(k){ %>
    <li>
      <strong><%= k %></strong>:
      <% if (k === 'detail_fields') { %>
        <div style="padding-left: 15px;">
          <% const detailFrom = d[k].from || {}; %>
          <% const detailTo = d[k].to || {}; %>
          <% const allDetailKeys = [...new Set([...Object.keys(detailFrom), ...Object.keys(detailTo)])]; %>
          
          <% allDetailKeys.forEach(dk => { %>
            <% const fromValue = detailFrom[dk] || ''; %>
            <% const toValue = detailTo[dk] || ''; %>
            <% if (fromValue !== toValue) { %>
              <div style="margin-top: 5px;">
                <em style="color: #64748b;"><%= dk %>:</em>
                <div><span class="muted">t·ª´</span> <code><%- fromValue || '(tr·ªëng)' %></code></div>
                <div><span class="muted">‚Üí</span> <code><%- toValue || '(tr·ªëng)' %></code></div>
              </div>
            <% } %>
          <% }); %>
        </div>
      <% } else { %>
        <span class="muted">t·ª´</span>
        <code><%- JSON.stringify(d[k].from) %></code>
        <span class="muted">‚Üí</span>
        <code><%- JSON.stringify(d[k].to) %></code>
      <% } %>
    </li>
  <% }) %>
</ul>
                                    <% } %>
                            </td>
                          </tr>
                          <% }) %>
                      </tbody>
                    </table>
                    <% } %>
              </div>

              <style>
                .change-list {
                  margin: 0;
                  padding-left: 18px;
                }

                .change-list li {
                  margin: 4px 0;
                }

                .muted {
                  color: #64748b;
                }

                code {
                  background: #f8fafc;
                  border: 1px solid #e5e7eb;
                  border-radius: 6px;
                  padding: 1px 4px;
                }
              </style>

              <% } else { %>
                <div class="empty">Kh√¥ng t√¨m th·∫•y CTKM.</div>
                <% } %>

  </div>

  <style>
    .sku-table-block {
      margin-top: 14px;
      overflow-x: auto;
    }

    .sku-table-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin: 8px 0 6px;
    }

    .sku-table-title {
      font-weight: 700;
    }

    .sku-search {
      flex: 1;
      max-width: 360px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .sku-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }

    .sku-table thead th {
      background: #f8fafc;
      font-size: 13px;
      font-weight: 700;
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .sku-table tbody td {
      padding: 10px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 13px;
    }

    .sku-table tbody tr:last-child td {
      border-bottom: none;
    }

    .is-hidden {
      display: none;
    }

    .btn-more {
      margin-top: 8px;
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>

  <script>
    // B·ªè d·∫•u ti·∫øng Vi·ªát + lowercase ƒë·ªÉ so kh·ªõp ·ªïn ƒë·ªãnh
    function _norm(s) {
      return (s || '')
        .toString()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove diacritics
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    }

    // Debounce cho input (tr√°nh l·ªçc qu√° d√†y)
    function _debounce(fn, wait = 120) {
      let t; return function (...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); };
    }

    function filterSkuTable(blockId) {
      const block = document.getElementById(blockId);
      if (!block) return;

      const qRaw = block.querySelector('.sku-search')?.value || '';
      const q = _norm(qRaw);
      const terms = q ? q.split(' ') : [];
      const rows = Array.from(block.querySelectorAll('tbody .sku-row'));
      const moreBtn = block.querySelector('.btn-more');
      const notfound = block.querySelector('.notfound');
      const N = Number(block.dataset.initial || 10);

      let matched = 0;

      rows.forEach((tr, idx) => {
        // text ngu·ªìn ƒë·ªÉ so kh·ªõp (SKU + t√™n + brand + gi√°)
        const txt = _norm(tr.innerText);
        const ok = !q || terms.every(t => txt.includes(t));

        // Khi c√≥ query: hi·ªán ƒë√∫ng d√≤ng match, ·∫©n d√≤ng kh√¥ng match
        // Khi r·ªóng: t·∫°m ·∫©n c√°c d√≤ng > N (gi·ªõi h·∫°n ban ƒë·∫ßu)
        if (q) {
          tr.style.display = ok ? '' : 'none';
        } else {
          tr.style.display = (idx < N) ? '' : 'none';
        }

        if (ok) matched++;
      });

      // X·ª≠ l√Ω n√∫t "Xem th√™m"
      if (moreBtn) {
        if (q) {
          // Khi ƒëang t√¨m ki·∫øm: b·ªè n√∫t Xem th√™m
          moreBtn.style.display = 'none';
          moreBtn.dataset.expanded = '1';
          moreBtn.textContent = 'Thu g·ªçn';
        } else {
          // Kh√¥i ph·ª•c tr·∫°ng th√°i ban ƒë·∫ßu
          const total = rows.length;
          moreBtn.style.display = (total > N) ? 'inline-block' : 'none';
          moreBtn.dataset.expanded = '0';
          moreBtn.textContent = 'Xem th√™m‚Ä¶';
        }
      }

      // Hi·ªán/·∫©n th√¥ng b√°o kh√¥ng t√¨m th·∫•y
      if (notfound) {
        notfound.style.display = (q && matched === 0) ? 'block' : 'none';
      }
    }

    const filterSkuTableDebounced = _debounce(filterSkuTable, 120);

    function toggleMore(blockId) {
      const block = document.getElementById(blockId);
      const rows = Array.from(block.querySelectorAll('tbody .sku-row'));
      const btn = block.querySelector('.btn-more');
      const expanded = btn.dataset.expanded === '1';
      const N = Number(block.dataset.initial || 10);

      if (!expanded) {
        rows.forEach(tr => tr.style.display = ''); // show all
        btn.dataset.expanded = '1';
        btn.textContent = 'Thu g·ªçn';
      } else {
        rows.forEach((tr, idx) => tr.style.display = (idx < N) ? '' : 'none');
        btn.dataset.expanded = '0';
        btn.textContent = 'Xem th√™m‚Ä¶';
      }
    }

    // G√°n handler khi trang load (ƒë·ªÉ g√µ l√† l·ªçc ngay)
    document.addEventListener('DOMContentLoaded', () => {
      ['includedSkuBlock', 'excludedSkuBlock'].forEach(id => {
        const block = document.getElementById(id);
        if (!block) return;
        const input = block.querySelector('.sku-search');
        if (input) {
          input.addEventListener('input', () => filterSkuTableDebounced(id));
          // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu (gi·ªõi h·∫°n N d√≤ng)
          filterSkuTable(id);
        }
      });
    });
  </script>


<div id="couponListModal" class="modal" style="display:none; z-index: 1001;">
    <div class="modal-content">
        <span class="close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
        <h2 id="couponModalTitle" style="margin-top: 0;"></h2>
        <div id="couponModalTableContainer" style="overflow-x: auto;"></div>
    </div>
</div>

<script>

window.showCouponListModal = function (button) {
  var modal     = document.getElementById('couponListModal');
  var titleEl   = document.getElementById('couponModalTitle');
  var container = document.getElementById('couponModalTableContainer');
  if (!modal || !titleEl || !container) return;

  var promoName = (button && button.dataset && button.dataset.promoName) ? button.dataset.promoName : '‚Äî';

  // Parse JSON an to√†n
  var coupons = [];
  try {
    coupons = JSON.parse((button && button.dataset && button.dataset.coupons) ? button.dataset.coupons : '[]');
  } catch (e) {
    console.warn('data-coupons kh√¥ng ph·∫£i JSON h·ª£p l·ªá:', e);
    coupons = [];
  }

  function toNumber(v) {
    if (typeof v === 'number') return v;
    if (v == null || v === '') return 0;
    return parseFloat(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }
  function fmt(n) {
    return new Intl.NumberFormat('vi-VN').format(toNumber(n));
  }
  function esc(s) { return (s == null ? '' : String(s)); }

  // S·∫Øp x·∫øp GI·∫¢M D·∫¶N theo discount
  var sorted = coupons.slice().sort(function(a, b) {
    return toNumber(b && b.discount) - toNumber(a && a.discount);
  });

  // Render b·∫£ng (kh√¥ng d√πng backtick)
  var rows = '';
  sorted.forEach(function(c) {
    rows += '<tr>'
      + '<td>' + (esc(c && c.name) || '-') + '</td>'
      + '<td><button class="code-badge" onclick="copyCode(this)" data-code="' + (esc(c && c.code) || '') + '">'
      + '<span>' + (esc(c && c.code) || '') + '</span> <small>(copy)</small>'
      + '</button></td>'
      + '<td>' + (toNumber(c && c.discount) ? fmt(c.discount) : '-') + '</td>'
      + '<td>' + (esc(c && c.note) || '-') + '</td>'
      + '</tr>';
  });

  titleEl.textContent = 'Danh s√°ch coupon cho: ' + promoName;
  container.innerHTML =
      '<div class="table-scroll-wrapper">'
    +   '<table class="info-table" style="margin-top:15px">'
    +     '<thead>'
    +       '<tr>'
    +         '<th>T√™n/Nh√≥m SP</th>'
    +         '<th>M√£ Voucher</th>'
    +         '<th>M·ª©c gi·∫£m</th>'
    +         '<th>ƒêi·ªÅu ki·ªán</th>'
    +       '</tr>'
    +     '</thead>'
    +     '<tbody>' + rows + '</tbody>'
    +   '</table>'
    + '</div>';

  modal.style.display = 'block';
};
</script>
<%- include('partials/toast') %>
<%- include('partials/footer') %>
<%- include('partials/header', {title: 'Chi ti·∫øt CTKM', currentPage: 'promotion-detail', time: time}) %>

<div class="promotion-card">
    <% if (promotion) { %>
        <h1 class="section-title">Chi ti·∫øt CTKM: <%= promotion.name %></h1>
        
        <h2 class="section-title">Th√¥ng tin CTKM</h2>
        
        <table class="detail-table">
            <tr>
                <th>T√™n CTKM</th>
                <td><%= promotion.name %></td>
            </tr>
            <tr>
                <th>M√¥ t·∫£</th>
                <td><%= promotion.description || 'Kh√¥ng c√≥ m√¥ t·∫£' %></td>
            </tr>
            <tr>
                <th>Th·ªùi gian √°p d·ª•ng</th>
                <td><%= new Date(promotion.start_date).toLocaleDateString('vi-VN') %> - <%= new Date(promotion.end_date).toLocaleDateString('vi-VN') %></td>
            </tr>
            <tr>
                <th>Lo·∫°i CTKM</th>
                <td><%= promotion.promo_type %></td>
            </tr>
            <tr>
                <th>Channel √°p d·ª•ng</th>
                <td><%= promotion.channel %></td>
            </tr>
            <% if (promotion.coupon_code) { %>
            <tr>
                <th>M√£ coupon</th>
                <td><%= promotion.coupon_code %></td>
            </tr>
            <% } %>
        </table>
        
        <h2 class="section-title">Ph·∫°m vi √°p d·ª•ng</h2>
        
        <% if (promotion.apply_to_all_skus) { %>
            <p>√Åp d·ª•ng cho t·∫•t c·∫£ s·∫£n ph·∫©m</p>
        <% } else { %>
            <% if (promotion.promotion_categories && promotion.promotion_categories.length > 0) { %>
                <h3>Danh m·ª•c √°p d·ª•ng:</h3>
                <ul>
                    <% promotion.promotion_categories.forEach(cat => { %>
                        <li><%= cat.category %></li>
                    <% }); %>
                </ul>
            <% } %>
            
            <% if (promotion.promotion_brands && promotion.promotion_brands.length > 0) { %>
                <h3>Brand √°p d·ª•ng:</h3>
                <ul>
                    <% promotion.promotion_brands.forEach(brand => { %>
                        <li><%= brand.brand %></li>
                    <% }); %>
                </ul>
            <% } %>
            
            <% if (promotion.promotion_skus && promotion.promotion_skus.length > 0) { %>
                <h3>SKU √°p d·ª•ng:</h3>
                <ul>
                    <% promotion.promotion_skus.forEach(sku => { %>
                        <li><%= sku.sku %></li>
                    <% }); %>
                </ul>
            <% } %>
        <% } %>
        
        <% if (promotion.promotion_gifts && promotion.promotion_gifts.length > 0) { %>
            <h2 class="section-title">Qu√† t·∫∑ng</h2>
            <ul>
                <% promotion.promotion_gifts.forEach(gift => { %>
                    <li>SKU qu√†: <%= gift.gift_sku %>, S·ªë l∆∞·ª£ng: <%= gift.gift_quantity %></li>
                <% }); %>
            </ul>
        <% } %>
        
        <% if (promotion.special_promotion_rules && promotion.special_promotion_rules.length > 0) { %>
            <h2 class="section-title">Quy t·∫Øc ƒë·∫∑c bi·ªát</h2>
            <table class="discount-table">
                <tr>
                    <th>Brand</th>
                    <th>Subcat</th>
                    <th>M·ª©c gi·∫£m</th>
                    <th>ƒêi·ªÅu ki·ªán</th>
                </tr>
                <% promotion.special_promotion_rules.forEach(rule => { %>
                <tr>
                    <td><%= rule.brand || 'T·∫•t c·∫£' %></td>
                    <td><%= rule.subcat || 'T·∫•t c·∫£' %></td>
                    <td><%= new Intl.NumberFormat('vi-VN').format(rule.discount_value) %> VNƒê</td>
                    <td><%= rule.condition_description || 'Kh√¥ng c√≥ ƒëi·ªÅu ki·ªán' %></td>
                </tr>
                <% }); %>
            </table>
        <% } %>
        
        <div class="promo-actions" style="margin-top: 20px;">
  <a href="/promo-management" class="btn btn-info">‚Üê Quay l·∫°i</a>
  <% if (user && user.role === 'manager') { %>
    <button class="btn btn-warning" onclick="location.href='/edit-promotion/<%= promotion.id %>'">‚úèÔ∏è S·ª≠a CTKM</button>
    <button class="btn btn-danger" onclick="deletePromo(<%= promotion.id %>)">üóëÔ∏è X√≥a CTKM</button>
    <script>
      async function deletePromo(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a CTKM n√†y?')) return;
        const res = await fetch(`/api/promotions/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
          alert('‚úÖ ƒê√£ x√≥a CTKM');
          location.href = '/promo-management';
        } else {
          alert('‚ùå ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
        }
      }
    </script>
  <% } %>
</div>
    <% } else { %>
        <div class="error-message">
            Kh√¥ng t√¨m th·∫•y th√¥ng tin CTKM
        </div>
        <a href="/promo-management" class="btn btn-info">‚Üê Quay l·∫°i</a>
    <% } %>
</div>

<%- include('partials/footer') %>
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>In phi·∫øu #<%= (data && data.ID) ? data.ID : 'Print' %></title>
  <style>
    /* --- C·∫§U H√åNH TRANG IN --- */
    @page { size: landscape; margin: 5mm; }
    
    body {
        font-family: 'Times New Roman', Times, serif;
        font-size: 13px;
        color: #000;
        background: #fff;
        padding: 20px;
    }
    .wrap { max-width: 100%; margin: 0 auto; }

    /* --- TABLE STYLING --- */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid #000; }
    th, td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; }
    
    /* Header m√†u h·ªìng nh·∫°t */
    thead th {
        background-color: #ffe6f2 !important; 
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
        text-align: center;
        font-weight: bold;
        white-space: nowrap;
        height: 30px;
    }

    /* Utilities */
    .right { text-align: right; }
    .center { text-align: center; }
    .bold { font-weight: bold; }
    .text-red { color: #d32f2f; font-weight: bold; }
    .text-blue { color: #1a73e8; font-weight: bold; }

    .toolbar { margin-bottom: 20px; display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; font-weight: 600; }
    .btn-primary { background: #1a73e8; color: white; border-color: #1a73e8; }

    @media print { .toolbar { display: none; } body { padding: 0; } }
  </style>
</head>
<body>

<% if (!data || !data.ID) { %>
    <div style="text-align:center; color:red; padding:50px;"><h2>KH√îNG C√ì D·ªÆ LI·ªÜU</h2></div>
<% } else { %>
    <% 
        // --- X·ª¨ L√ù DATA ---
        const isOffset = String(data.OffsetToNewOrder).toLowerCase() === 'true';
        const isCash = String(data.RefundMethod).toLowerCase() === 'ti·ªÅn m·∫∑t';
        const fmt = (n) => n ? Number(n).toLocaleString('vi-VN') : '0';
        const fmtDate = (d) => d ? new Date(d).toLocaleDateString('vi-VN') : '';
        const bankInfo = data.Bank || [data.BankName, data.Branch, data.AccountNumber, data.AccountName].filter(Boolean).join(' - ');

        // --- X·ª¨ L√ù C·ªòT HI·ªÇN TH·ªä ---
        var activeCols = (typeof cols !== 'undefined' && Array.isArray(cols)) ? cols : [];
        const showApprover = activeCols.includes('ApprovedBy') || activeCols.includes('SRApprover');
        const showBank = activeCols.includes('Bank') && !isCash;
    %>

    <div class="wrap">
        <div class="toolbar">
            <button class="btn" onclick="window.print()">üñ® In Phi·∫øu</button>
            <button class="btn btn-primary" onclick="copyTable()">üìã Copy b·∫£ng</button>
        </div>

        <h1 style="font-size:18px; margin:0 0 5px; text-transform:uppercase; color:#1a73e8;">
            Phi·∫øu <%= isOffset ? 'C·∫•n Tr·ª´ C√¥ng N·ª£' : 'Y√™u C·∫ßu Ho√†n Ti·ªÅn' %> #<%= data.ID %>
        </h1>
        <div style="font-style: italic; color: #555;">
            Ng√†y: <strong><%= fmtDate(data.RequestDate) %></strong> ‚Äî Tr·∫°ng th√°i: <strong><%= data.Status %></strong>
        </div>

        <% if (isOffset) { %>
            <table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse; width:100%; font-size:12px;">
                <thead>
                    <tr style="background-color: #ffccff; font-weight: bold; text-align: center;">
                        <th style="background-color:#ffccff;">Lo·∫°i ƒë∆°n</th>
                        <th style="background-color:#ffccff;">M√£ ƒë∆°n h√†ng</th>
                        <th style="background-color:#ffccff;">Ng∆∞·ªùi duy·ªát (SM)</th>
                        <th style="background-color:#ffccff;">Gi√° tr·ªã ƒë∆°n h√†ng</th>
                        <th style="background-color:#ffccff;">Tr∆∞·ªõc KM</th> <th style="background-color:#ffccff;">Ti·ªÅn KM</th>   <th style="background-color:#ffccff;">Sau KM</th>    <th style="background-color:#ffccff;">L√Ω do</th>
                        <th style="background-color:#ffccff;">Ph∆∞∆°ng th·ª©c</th>
                        <th style="background-color:#ffccff;">Th√¥ng tin NH</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="font-weight:bold; text-align:center;">ƒê∆°n c≈©</td>
                        <td style="text-align:center;"><%= data.OrderID %></td>
                        
                        <td rowspan="2" style="text-align:center; vertical-align:middle;">
                            <%= data.SRApprover || data.ApprovedBy %>
                        </td>

                        <td style="text-align:right;"><%= fmt(data.OrderTotal) %></td>
                        <td style="text-align:right;"><%= fmt(data.OldBeforeKM || data.OrderTotal) %></td>
                        <td style="text-align:right;"><%= fmt(data.OldKM || 0) %></td>
                        <td style="text-align:right;"><%= fmt(data.OldAfterKM || data.OrderTotal) %></td>

                        <td rowspan="2" style="text-align:center; vertical-align:middle;"><%= data.Reason %></td>
                        <td rowspan="2" style="text-align:center; vertical-align:middle;"><%= data.RefundMethod %></td>
                        <td rowspan="2" style="text-align:center; vertical-align:middle;"><%= bankInfo %></td>
                    </tr>

                    <tr>
                        <td style="font-weight:bold; text-align:center;">ƒê∆°n m·ªõi</td>
                        <td style="text-align:center;"><%= data.NewOrderID %></td>
                        
                        <td style="text-align:right;"><%= fmt(data.NewOrderValue) %></td>
                        <td style="text-align:right;"><%= fmt(data.NewBeforeKM || data.NewOrderValue) %></td>
                        <td style="text-align:right;"><%= fmt(data.NewKM || 0) %></td>
                        <td style="text-align:right;"><%= fmt(data.NewAfterKM || data.NewAfterKM) %></td>
                    </tr>

                    <tr style="background-color: #f0f0f0;">
                        <td colspan="6" style="text-align: right; font-weight: bold; padding-right: 10px;">
                            S·ªê TI·ªÄN HO√ÄN L·∫†I (ƒê∆°n c≈© - ƒê∆°n m·ªõi):
                        </td>
                        <td style="text-align: right; font-weight: bold; font-size: 14px; color: #d93025;">
                            <%= fmt(data.RefundAmount) %>
                        </td>
                        <td colspan="3"></td>
                    </tr>
                </tbody>
            </table>

        <% } else { %>

            <table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse; width:100%;">
                <thead>
                    <tr>
                        <% activeCols.forEach(function(col) { %>
                            <th style="background-color:#ffe6f2;">
                                <%= (typeof colNames !== 'undefined' && colNames[col]) ? colNames[col] : col %>
                            </th>
                        <% }); %>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <% activeCols.forEach(function(col) { %>
                            <td style="text-align: center;">
                                <% 
                                    let val = data[col];
                                    if (col.includes('Date') || col.includes('At')) val = fmtDate(val);
                                    else if (['RefundAmount', 'OrderTotal'].includes(col)) val = fmt(val);
                                    else if (col === 'Bank') val = bankInfo; 
                                %>
                                <%= val %>
                            </td>
                        <% }); %>
                    </tr>
                </tbody>
            </table>

        <% } %>
    </div>
<% } %>

<script>
    function copyTable() {
        // 1. T√¨m b·∫£ng g·ªëc
        const originalTable = document.querySelector('table');
        if (!originalTable) return;
√ü
        // 2. T·∫°o b·∫£n sao c·ªßa b·∫£ng ƒë·ªÉ x·ª≠ l√Ω (tr√°nh l√†m h·ªèng giao di·ªán hi·ªán t·∫°i)
        const cloneTable = originalTable.cloneNode(true);

        // 3. TH√äM STYLE C·ª®NG CHO EMAIL (ƒê√¢y l√† ph·∫ßn quan tr·ªçng nh·∫•t)
        // Th√™m thu·ªôc t√≠nh border="1" ƒë·ªÉ email hi·ªÉu l√† b·∫£ng c√≥ khung
        cloneTable.setAttribute('border', '1');
        cloneTable.setAttribute('cellpadding', '5');
        cloneTable.setAttribute('cellspacing', '0');
        
        // √âp style d√≠nh li·ªÅn v√†o b·∫£ng
        cloneTable.style.borderCollapse = 'collapse';
        cloneTable.style.border = '1px solid #000';
        cloneTable.style.width = '100%';

        // √âp style d√≠nh li·ªÅn v√†o t·ª´ng √¥ (th/td)
        const cells = cloneTable.querySelectorAll('th, td');
        cells.forEach(cell => {
            cell.style.border = '1px solid #000'; // ƒê∆∞·ªùng vi·ªÅn ƒëen
            cell.style.padding = '6px 8px';       // Kho·∫£ng c√°ch ch·ªØ
            cell.style.verticalAlign = 'middle';
            
            // Gi·ªØ m√†u n·ªÅn cho ti√™u ƒë·ªÅ (n·∫øu l√† th)
            if (cell.tagName === 'TH') {
                cell.style.backgroundColor = '#ffe6f2'; 
                cell.style.fontWeight = 'bold';
            }
        });

        // 4. T·∫°o m·ªôt khung ·∫©n ƒë·ªÉ ch·ª©a b·∫£ng v·ª´a s·ª≠a
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px'; // Gi·∫•u kh·ªèi m√†n h√¨nh
        tempDiv.appendChild(cloneTable);
        document.body.appendChild(tempDiv);

        // 5. Th·ª±c hi·ªán b√¥i ƒëen v√† copy t·ª´ khung ·∫©n n√†y
        const range = document.createRange();
        range.selectNode(cloneTable);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                alert('‚úÖ ƒê√£ copy b·∫£ng! (ƒê√£ fix l·ªói m·∫•t khung khi d√°n v√†o Email)');
            } else {
                alert('‚ùå Kh√¥ng th·ªÉ copy, vui l√≤ng th·ª≠ l·∫°i.');
            }
        } catch (err) {
            console.error('L·ªói copy:', err);
            alert('‚ùå L·ªói tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ copy.');
        }

        // 6. D·ªçn d·∫πp: X√≥a khung ·∫©n v√† b·ªè b√¥i ƒëen
        document.body.removeChild(tempDiv);
        selection.removeAllRanges();
    }
</script>
</body>
</html>
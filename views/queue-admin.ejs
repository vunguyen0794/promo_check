<!DOCTYPE html>
<html lang="vi">
<head>
    <%- include('partials/header', {title: 'ƒêi·ªÅu ph·ªëi K·ªπ thu·∫≠t', currentPage: 'queue-admin', time: ''}) %>
    <style>
        body { background: #f0f2f5; overflow: hidden; }
        .admin-layout { display: flex; gap: 20px; padding: 20px; height: calc(100vh - 80px); }
        .col-panel { flex: 1; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .col-header { padding: 15px 20px; color: white; font-weight: 800; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .list-wrap { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }
        
        /* M√†u s·∫Øc c·ªôt */
        .col-service .col-header { background: #1a73e8; }
        .col-sales .col-header { background: #0d9488; }

        /* Card v√© */
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card.serving { border: 2px solid; background: #f0f9ff; transform: scale(1.01); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .col-service .card.serving { border-color: #1a73e8; }
        .col-sales .card.serving { border-color: #0d9488; }

        .tag-type { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-left: 5px; }
        .tag-repair { background: #e0f2fe; color: #0369a1; }
        .tag-warranty { background: #ffedd5; color: #c2410c; }

        .btn-call-header { background: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 700; cursor: pointer; color: #333; display: flex; align-items: center; gap: 5px; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer; margin-top: 10px; }
        .btn-done { background: #10b981; } .btn-done:hover { background: #059669; }
        .btn-recall { background: #f59e0b; color: white; } .btn-recall:hover { background: #d97706; }
        .btn-skip { background: #ef4444; margin-top: 5px; opacity: 0.8; }

        .wf-steps { display: flex; gap: 5px; margin-top: 15px; }
        .wf-btn { flex: 1; padding: 8px 0; font-size: 11px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .wf-btn.active { background: #0d9488; color: white; border-color: #0d9488; }
        
        /* === MODAL POPUP STYLES === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal-box {
            background: white; width: 90%; max-width: 400px;
            padding: 25px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: transform 0.2s;
        }
        .modal-overlay.open .modal-box { transform: translateY(0); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-select, .form-input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 8px; font-size: 16px; outline: none; 
        }
        .form-select:focus, .form-input:focus { border-color: #1a73e8; }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; }
        .btn-confirm { background: #1a73e8; color: white; }
        .btn-cancel { background: #f3f4f6; color: #333; }
        
        /* ·∫®n TVC Bar theo y√™u c·∫ßu */
        .tvc-bar { display: none; } 
    </style>
</head>
<body>
    <div class="admin-layout">
        
        <div class="col-panel col-service">
            <div class="col-header">
                <span>üõ† S·ª¨A CH·ªÆA / B·∫¢O H√ÄNH</span>
                <button class="btn-call-header" onclick="openCallModal('SERVICE_MIX')">
                    üìû G·ªåI KH√ÅCH
                </button>
            </div>
            <div class="list-wrap">
                <% 
                   const serviceList = tickets.filter(t => t.service_type === 'REPAIR' || t.service_type === 'WARRANTY'); 
                   serviceList.sort((a,b) => (a.status === 'SERVING' ? -1 : 1));
                %>
                <% if(serviceList.length===0) { %><div style="text-align:center;color:#999;margin-top:30px">üì≠ Tr·ªëng</div><% } %>

                <% serviceList.forEach(t => { %>
                    <div class="card <%= t.status==='SERVING'?'serving':'' %>">
                        <% if(t.status === 'SERVING') { %><div style="font-weight:700; color:#1a73e8; margin-bottom:5px;">üìç <%= t.counter_name %></div><% } %>
                        
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:20px; font-weight:800; color:#1a73e8;"><%= t.ticket_number %></span>
                            <span class="tag-type <%= t.service_type==='REPAIR'?'tag-repair':'tag-warranty' %>">
                                <%= t.service_type==='REPAIR'?'S·ª¨A CH·ªÆA':'B·∫¢O H√ÄNH' %>
                            </span>
                        </div>
                        <div style="font-weight:700;"><%= t.customer_name %></div>
                        <% if(t.error_description) { %><div style="font-style:italic; font-size:13px; color:#c00;">"<%= t.error_description %>"</div><% } %>

                        <% if(t.status === 'SERVING') { %>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <button class="btn-action btn-done" onclick="control('COMPLETE', '<%= t.id %>', '<%= t.service_type %>')">‚úÖ Xong</button>
                                <button class="btn-action" style="background:#f59e0b;" onclick="control('RECALL', '<%= t.id %>', '<%= t.service_type %>')">üîä G·ªçi l·∫°i</button>
                            </div>
                            <button class="btn-action btn-skip" style="padding: 8px; font-size: 12px;" onclick="control('SKIP', '<%= t.id %>', '<%= t.service_type %>')">‚ùå Kh√°ch v·∫Øng</button>
                        <% } else { %>
                            <div style="font-size:12px; color:#1a73e8; margin-top:5px; font-weight:600; text-align:right;">ƒêang ch·ªù...</div>
                        <% } %>
                    </div>
                <% }) %>
            </div>
        </div>

        <div class="col-panel col-sales">
            <div class="col-header">
                <span>üì¶ L·∫ÆP M√ÅY M·ªöI</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <a href="/queue/warehouse" target="_blank" style="color:white; font-size:12px; text-decoration:underline;">
                        Trang Kho ‚Üó
                    </a>
                    <button class="btn-call-header" onclick="openCallModal('SALES')">
                        üìû NH·∫¨N ƒê∆†N
                    </button>
                </div>
            </div>
            
            <div class="list-wrap">
                <% const salesList = tickets.filter(t => t.service_type === 'SALES'); 
                   salesList.sort((a,b) => (a.status === 'SERVING' ? -1 : 1)); %>
                
                <% if(salesList.length===0) { %><div style="text-align:center;color:#999;margin-top:30px">üì¶ Ch∆∞a c√≥ ƒë∆°n</div><% } %>

                <% salesList.forEach(t => { %>
                    <div class="card <%= t.status==='SERVING'?'serving':'' %>">
                         <% if(t.status === 'SERVING') { %><div style="font-weight:700; color:#0d9488; margin-bottom:5px;">üìç <%= t.counter_name %></div><% } %>
                        <div style="font-size:20px; font-weight:800; color:#0d9488;"><%= t.ticket_number %></div>
                        <div style="font-weight:700;"><%= t.customer_name %></div>
                        <div style="font-size:13px;"><%= t.product_name %></div>

                        <% if(t.status === 'SERVING') { %>
                            <div class="wf-steps">
                                <button class="wf-btn <%= t.process_status==='ASSEMBLING'?'active':'' %>" onclick="updateProcess('<%= t.id %>', 'ASSEMBLING')">1. L·∫Øp</button>
                                <button class="wf-btn <%= t.process_status==='INSTALLING'?'active':'' %>" onclick="updateProcess('<%= t.id %>', 'INSTALLING')">2. C√†i</button>
                                <button class="wf-btn <%= t.process_status==='HANDOVER'?'active':'' %>" onclick="updateProcess('<%= t.id %>', 'HANDOVER')">3. Giao</button>
                            </div>
                            <% if(t.process_status === 'HANDOVER') { %>
                                <button class="btn-action btn-done" onclick="control('COMPLETE', '<%= t.id %>', 'SALES')">‚úÖ HO√ÄN TH√ÄNH</button>
                            <% } %>
                        <% } %>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>
    
   <div id="callModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#1a73e8;">Ch·ªçn Ng∆∞·ªùi / Qu·∫ßy ph·ª•c v·ª•</h3>
            
            <div class="form-group">
                <label class="form-label">K·ªπ thu·∫≠t vi√™n:</label>
                
                <select id="ktvSelect" class="form-select" onchange="checkKtvOther(this)">
                    <option value="" disabled selected>-- Ch·ªçn t√™n KTV --</option>
                    
                    <% if(staffList && staffList.length > 0) { %>
                        <% staffList.forEach(user => { %>
                            <option value="<%= user.full_name || user.email %>">
                                <%= user.full_name || user.email %>
                            </option>
                        <% }) %>
                    <% } %>

                    <option value="other" style="font-weight:bold; color:#d93025;">‚úèÔ∏è Nh·∫≠p t√™n kh√°c...</option>
                </select>

                <input id="ktvInput" class="form-input" placeholder="Nh·∫≠p t√™n KTV..." style="display:none; margin-top:10px;">
            </div>

            <div class="form-group">
                <label class="form-label">T·∫°i Qu·∫ßy / B√†n s·ªë:</label>
                <select id="counterSelect" class="form-select">
                    <option value="">-- Kh√¥ng ch·ªçn --</option>
                    <option value="B√†n 1">B√†n s·ªë 1</option>
                    <option value="B√†n 2">B√†n s·ªë 2</option>
                    <option value="B√†n 3">B√†n s·ªë 3</option>
                    <option value="B√†n 4">B√†n s·ªë 4</option>
                    <option value="B√†n 5">B√†n s·ªë 5</option>
                    <option value="B√†n 6">B√†n s·ªë 6</option>
                    <option value="Qu·∫ßy A">Qu·∫ßy A</option>
                    <option value="Qu·∫ßy B">Qu·∫ßy B</option>
                </select>
            </div>

            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal()">H·ªßy</button>
                <button class="btn-modal btn-confirm" onclick="confirmCall()">üìû G·ªåI NGAY</button>
            </div>
        </div>
    </div>

    <script>
       let currentCallType = ''; 

        // M·ªü Modal & T·ª± ƒë·ªông ƒëi·ªÅn t√™n c≈© ƒë√£ l∆∞u
        function openCallModal(type) {
            currentCallType = type;
            const modal = document.getElementById('callModal');
            modal.classList.add('open');

            // 1. L·∫•y d·ªØ li·ªáu ƒë√£ l∆∞u trong tr√¨nh duy·ªát (LocalStorage)
            const savedKtv = localStorage.getItem('last_ktv') || '';
            const savedCounter = localStorage.getItem('last_counter') || '';

            const ktvSelect = document.getElementById('ktvSelect');
            const ktvInput = document.getElementById('ktvInput');
            
            // 2. Logic "Nh·ªõ" th√¥ng minh
            let foundInList = false;
            
            // Duy·ªát qua danh s√°ch ƒë·ªÉ xem t√™n ƒë√£ l∆∞u c√≥ kh·ªõp v·ªõi ai trong DB kh√¥ng
            for(let i=0; i<ktvSelect.options.length; i++){
                if(ktvSelect.options[i].value === savedKtv) {
                    ktvSelect.selectedIndex = i; // C√≥ trong list -> Ch·ªçn lu√¥n
                    foundInList = true;
                    break;
                }
            }

            // 3. X·ª≠ l√Ω hi·ªÉn th·ªã
            if(savedKtv && !foundInList) {
                // N·∫øu c√≥ t√™n l∆∞u m√† KH√îNG n·∫±m trong list DB -> Ch·ªçn "Nh·∫≠p kh√°c" v√† ƒëi·ªÅn v√†o input
                ktvSelect.value = 'other';
                ktvInput.style.display = 'block';
                ktvInput.value = savedKtv;
            } else if (foundInList) {
                // N·∫øu c√≥ trong list -> ·∫®n input nh·∫≠p tay
                ktvInput.style.display = 'none';
            } else {
                // L·∫ßn ƒë·∫ßu ch∆∞a l∆∞u g√¨ -> Reset v·ªÅ m·∫∑c ƒë·ªãnh
                ktvSelect.selectedIndex = 0; 
                ktvInput.style.display = 'none';
            }

            // 4. Set l·∫°i b√†n/qu·∫ßy ƒë√£ l∆∞u
            document.getElementById('counterSelect').value = savedCounter;
        }

        function closeModal() {
            document.getElementById('callModal').classList.remove('open');
        }

        // X·ª≠ l√Ω khi ch·ªçn "Nh·∫≠p t√™n kh√°c"
        function checkKtvOther(select) {
            const input = document.getElementById('ktvInput');
            if(select.value === 'other') {
                input.style.display = 'block';
                input.focus();
                input.value = ''; // Reset ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p m·ªõi
            } else {
                input.style.display = 'none';
            }
        }

        async function confirmCall() {
            const ktvSelect = document.getElementById('ktvSelect');
            const ktvInput = document.getElementById('ktvInput');
            const counterSelect = document.getElementById('counterSelect');

            // L·∫•y t√™n KTV (t·ª´ dropdown ho·∫∑c t·ª´ input nh·∫≠p tay)
            let ktvName = ktvSelect.value === 'other' ? ktvInput.value.trim() : ktvSelect.value;
            
            if(!ktvName || (ktvSelect.value === 'other' && !ktvName)) {
                alert("Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p t√™n KTV!");
                return;
            }

            let counterVal = counterSelect.value;
            
            // Gh√©p chu·ªói hi·ªÉn th·ªã: "V≈© (B√†n 1)"
            let finalName = ktvName;
            if (counterVal) finalName = `${ktvName} (${counterVal})`;

            // === L∆ØU L·∫†I L·ª∞A CH·ªåN V√ÄO TR√åNH DUY·ªÜT ===
            localStorage.setItem('last_ktv', ktvName);
            localStorage.setItem('last_counter', counterVal);

            // G·ª≠i API
            try {
                const btn = document.querySelector('.btn-confirm');
                btn.innerText = "ƒêang g·ªçi..."; btn.disabled = true;

                const res = await fetch('/api/queue/control', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'CALL_NEXT', 
                        service_type: currentCallType, 
                        counter_name: finalName 
                    })
                });
                const data = await res.json();
                
                if(data.ok) window.location.reload();
                else {
                    alert(data.message);
                    btn.innerText = "üìû G·ªåI NGAY"; btn.disabled = false;
                    closeModal();
                }
            } catch(e) { 
                alert('L·ªói k·∫øt n·ªëi'); 
                closeModal();
            }
        }

        async function control(action, id, type) {
            if(action==='COMPLETE' && !confirm('X√°c nh·∫≠n ho√†n th√†nh?')) return;
            await fetch('/api/queue/control', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action, ticket_id: id, service_type: type}) });
            window.location.reload();
        }
        async function updateProcess(id, step) {
            await fetch('/api/queue/control', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'UPDATE_PROCESS', ticket_id: id, process_step: step}) });
            window.location.reload();
        }
        
        setTimeout(() => window.location.reload(), 15000);
    </script>
</body>
</html>
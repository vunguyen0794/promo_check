<!DOCTYPE html>
<html lang="vi">
<head>
    <%- include('partials/header', {title: 'ƒêi·ªÅu ph·ªëi K·ªπ thu·∫≠t', currentPage: 'queue-admin', time: ''}) %>
    <style>
        body { background: #f0f2f5; overflow-y: auto; }
        .admin-layout { display: flex; gap: 20px; padding: 20px; min-height: 500px; height: auto; }
        .col-panel { flex: 1; background: white; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 600px; /* Th√™m chi·ªÅu cao cho panel con */ }
        .col-header { padding: 15px 20px; color: white; font-weight: 800; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .list-wrap { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }
        
        /* M√†u s·∫Øc c·ªôt */
        .col-service .col-header { background: #1a73e8; }
        .col-sales .col-header { background: #0d9488; }

        /* Card v√© */
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card.serving { border: 2px solid; background: #f0f9ff; transform: scale(1.01); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .col-service .card.serving { border-color: #1a73e8; }
        .col-sales .card.serving { border-color: #0d9488; }

        .tag-type { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-left: 5px; }
        .tag-repair { background: #e0f2fe; color: #0369a1; }
        .tag-warranty { background: #ffedd5; color: #c2410c; }

        .btn-call-header { background: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 700; cursor: pointer; color: #333; display: flex; align-items: center; gap: 5px; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer; margin-top: 10px; }
        .btn-done { background: #10b981; } .btn-done:hover { background: #059669; }
        .btn-recall { background: #f59e0b; color: white; } .btn-recall:hover { background: #d97706; }
        .btn-skip { background: #ef4444; margin-top: 5px; opacity: 0.8; }

        .wf-steps { display: flex; gap: 5px; margin-top: 15px; }
        .wf-btn { flex: 1; padding: 8px 0; font-size: 11px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .wf-btn.active { background: #0d9488; color: white; border-color: #0d9488; }
        
        /* === MODAL POPUP STYLES === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal-box {
            background: white; width: 90%; max-width: 400px;
            padding: 25px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: transform 0.2s;
        }
        .modal-overlay.open .modal-box { transform: translateY(0); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-select, .form-input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 8px; font-size: 16px; outline: none; 
        }
        .form-select:focus, .form-input:focus { border-color: #1a73e8; }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; }
        .btn-confirm { background: #1a73e8; color: white; }
        .btn-cancel { background: #f3f4f6; color: #333; }
        
        /* ·∫®n TVC Bar theo y√™u c·∫ßu */
        .tvc-bar { display: none; } 
        .action-list { display: flex; flex-direction: column; gap: 8px; border: 1px solid #eee; padding: 10px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
    .action-item { display: flex; align-items: flex-start; gap: 10px; cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; }
    .action-item:hover { background: #f9fafb; }
    .action-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; margin-top: 2px; }
    .action-item span { font-size: 14px; color: #333; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <% 
       // 1. L·ªçc v√† S·∫Øp x·∫øp danh s√°ch S·ª≠a ch·ªØa / B·∫£o h√†nh
       const serviceList = tickets.filter(t => t.service_type === 'REPAIR' || t.service_type === 'WARRANTY'); 
       serviceList.sort((a,b) => (a.status === 'SERVING' ? -1 : 1));

       // 2. L·ªçc v√† S·∫Øp x·∫øp danh s√°ch L·∫Øp r√°p
       const salesList = tickets.filter(t => t.service_type === 'SALES'); 
       salesList.sort((a,b) => (a.status === 'SERVING' ? -1 : 1));
    %>
        <div class="col-panel col-service">
            <div class="col-header">
                <span>üõ† S·ª¨A CH·ªÆA / B·∫¢O H√ÄNH (<%= serviceList.length %>)</span>
                <button class="btn-call-header" onclick="openCallModal('SERVICE_MIX')">
                    G·ªåI T√äN KH√ÅCH
                </button>
            </div>
            <div class="list-wrap">
            
                <% if(serviceList.length===0) { %><div style="text-align:center;color:#999;margin-top:30px">üì≠ Tr·ªëng</div><% } %>

                <% serviceList.forEach(t => { %>
                    <div class="card <%= t.status==='SERVING'?'serving':'' %>">
                        <% if(t.status === 'SERVING') { %><div style="font-weight:700; color:#1a73e8; margin-bottom:5px;">üìç <%= t.counter_name %></div><% } %>
                        
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:20px; font-weight:800; color:#1a73e8;"><%= t.ticket_number %></span>
                            <span class="tag-type <%= t.service_type==='REPAIR'?'tag-repair':'tag-warranty' %>">
                                <%= t.service_type==='REPAIR'?'S·ª¨A CH·ªÆA':'B·∫¢O H√ÄNH' %>
                            </span>
                        </div>
                        <div style="font-weight:700;"><%= t.customer_name %></div>
                        <div style="font-size:12px; color:#555; margin-top:4px; display:flex; justify-content:space-between;">
    <span><%= t.customer_phone || '---' %></span>
    <span><%= new Date(t.created_at).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}) %></span>
</div>
                        <% if(t.error_description) { %><div style="font-style:italic; font-size:13px; color:#c00;">"<%= t.error_description %>"</div><% } %>

                        <% if(t.status === 'SERVING') { %>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <button class="btn-action btn-done" onclick="openLogModal('<%= t.id %>', '<%= t.customer_name %>')">
    ‚úÖ Xong
</button>
                                <button class="btn-action" style="background:#f59e0b;" onclick="control('RECALL', '<%= t.id %>', '<%= t.service_type %>')">üîä G·ªçi l·∫°i</button>
                            </div>
                            <button class="btn-action btn-skip" style="padding: 8px; font-size: 12px;" onclick="control('SKIP', '<%= t.id %>', '<%= t.service_type %>')">‚ùå Kh√°ch v·∫Øng</button>
                        <% } else { %>
                            <div style="font-size:12px; color:#1a73e8; margin-top:5px; font-weight:600; text-align:right;">ƒêang ch·ªù...</div>
                        <% } %>
                        <div style="margin-top: 10px; border-top: 1px dashed #eee; padding-top: 5px; text-align: right;">
                            
                            <button onclick="deleteTicket('<%= t.id %>')" style="background: none; border: none; color: #d93025; font-size: 12px; cursor: pointer; text-decoration: underline;">
        üóë X√≥a v√© n√†y
    </button>
</div>
                    </div>
                <% }) %>
            </div>
        </div>

        <div class="col-panel col-sales">
            <div class="col-header">
                <span>üì¶ L·∫ÆP R√ÅP/ C√ÄI ƒê·∫∂T M√ÅY M·ªöI (<%= salesList.length %>)</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <a href="/queue/warehouse" target="_blank" style="color:white; font-size:12px; text-decoration:underline;">
                        Trang Kho ‚Üó
                    </a>
                    <button class="btn-call-header" onclick="openCallModal('SALES')">
                        TI·∫æP NH·∫¨N ƒê∆†N
                    </button>
                </div>
            </div>
            
            <div class="list-wrap">
                
                
                <% if(salesList.length===0) { %><div style="text-align:center;color:#999;margin-top:30px">üì¶ Ch∆∞a c√≥ ƒë∆°n</div><% } %>

                <% salesList.forEach(t => { %>
                    <div class="card <%= t.status==='SERVING'?'serving':'' %>">
                         <% if(t.status === 'SERVING') { %><div style="font-weight:700; color:#0d9488; margin-bottom:5px;">üìç <%= t.counter_name %></div><% } %>
                        <div style="font-size:20px; font-weight:800; color:#0d9488;"><%= t.ticket_number %></div>

                        <div style="font-weight:700;"><%= t.customer_name %></div>
                        
                        <div style="font-size:13px;"><%= t.product_name %></div>
                        
                        <% if(t.status === 'SERVING') { %>
                            <div class="wf-steps">
                                <button class="wf-btn <%= t.process_status==='ASSEMBLING'?'active':'' %>" onclick="updateProcess('<%= t.id %>', 'ASSEMBLING')">1. L·∫Øp</button>
                                <button class="wf-btn <%= t.process_status==='INSTALLING'?'active':'' %>" onclick="updateProcess('<%= t.id %>', 'INSTALLING')">2. C√†i</button>
                                <button class="wf-btn <%= t.process_status==='HANDOVER'?'active':'' %>" onclick="updateProcess('<%= t.id %>', 'HANDOVER')">3. Giao</button>
                            </div>
                            <% if(t.process_status === 'HANDOVER') { %>
                                <button class="btn-action btn-done" onclick="openLogModal('<%= t.id %>', '<%= t.customer_name %> / <%= t.product_name %>')">
    ‚úÖ HO√ÄN TH√ÄNH
</button>
                                <% } %>
                        <% } %>
                        <div style="margin-top: 10px; border-top: 1px dashed #eee; padding-top: 5px; text-align: right;">
    <button onclick="deleteTicket('<%= t.id %>')" style="background: none; border: none; color: #d93025; font-size: 12px; cursor: pointer; text-decoration: underline;">
        üóë X√≥a v√© n√†y
    </button>
</div>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>
    
   <div id="callModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#1a73e8;">Ch·ªçn Ng∆∞·ªùi / Qu·∫ßy ph·ª•c v·ª•</h3>
            
            <div class="form-group">
                <label class="form-label">K·ªπ thu·∫≠t vi√™n:</label>
                
                <select id="ktvSelect" class="form-select" onchange="checkKtvOther(this)">
                    <option value="" disabled selected>-- Ch·ªçn t√™n KTV --</option>
                    
                    <% if(staffList && staffList.length > 0) { %>
                        <% staffList.forEach(user => { %>
                            <option value="<%= user.full_name || user.email %>">
                                <%= user.full_name || user.email %>
                            </option>
                        <% }) %>
                    <% } %>

                    <option value="other" style="font-weight:bold; color:#d93025;">‚úèÔ∏è Nh·∫≠p t√™n kh√°c...</option>
                </select>

                <input id="ktvInput" class="form-input" placeholder="Nh·∫≠p t√™n KTV..." style="display:none; margin-top:10px;">
            </div>

            <div class="form-group">
                <label class="form-label">T·∫°i Qu·∫ßy / B√†n s·ªë:</label>
                <select id="counterSelect" class="form-select">
                    <option value="">-- Kh√¥ng ch·ªçn --</option>
                    <option value="B√†n 1">B√†n s·ªë 1</option>
                    <option value="B√†n 2">B√†n s·ªë 2</option>
                    <option value="B√†n 3">B√†n s·ªë 3</option>
                    <option value="B√†n 4">B√†n s·ªë 4</option>
                    <option value="B√†n 5">B√†n s·ªë 5</option>
                    <option value="B√†n 6">B√†n s·ªë 6</option>
                    <option value="Qu·∫ßy A">Qu·∫ßy A</option>
                    <option value="Qu·∫ßy B">Qu·∫ßy B</option>
                </select>
            </div>

            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal()">H·ªßy</button>
                <button class="btn-modal btn-confirm" onclick="confirmCall()"> G·ªåI T√äN NGAY</button>
            </div>
        </div>
    </div>
    <div class="history-panel" style="margin: 0 20px 20px 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
    <h3 style="margin-top:0; color:#333; display:flex; justify-content:space-between; align-items:center;">
        üìã DANH S√ÅCH KH√ÅCH ƒê√É PH·ª§C V·ª§ H√îM NAY
        <button onclick="loadHistory(1)" style="font-size:12px; padding:5px 10px; cursor:pointer;">üîÑ L√†m m·ªõi</button>
    </h3>
    
    <div style="overflow-x: auto;">
        <table style="width:100%; border-collapse: collapse; font-size:14px;">
            <thead>
                <tr style="background:#f8fafc; color:#555; text-align:left; border-bottom:2px solid #eee;">
                    <th style="padding:12px;">STT</th>
                    <th style="padding:12px;">Th·ªùi gian</th>
                    <th style="padding:12px;">Lo·∫°i DV</th>
                    <th style="padding:12px;">Kh√°ch h√†ng</th>
                    <th style="padding:12px;">SƒêT / ƒê∆°n h√†ng</th>
                    <th style="padding:12px;">KTV Ph·ª•c v·ª•</th>
                    <th style="padding:12px;">T·ªïng th·ªùi gian</th>
                    <th style="padding:12px;">ƒê√°nh gi√°</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                </tbody>
        </table>
    </div>

    <div id="pagination" style="margin-top:15px; display:flex; justify-content:center; gap:10px;"></div>
</div>
<div id="feedbackModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin: 0 0 15px 0; color: #1a73e8;">üìã B√°o c√°o c√¥ng vi·ªác</h3>
        
        <div class="form-group">
            <label class="form-label">M√£ s·ªë nh√¢n vi√™n (MSNV) <span style="color:red">*</span></label>
            <input type="text" id="modalMsnv" class="form-input" placeholder="Nh·∫≠p m√£ nh√¢n vi√™n...">
        </div>

        <div class="form-group">
            <label class="form-label">T√™n KH / M√£ ƒêH</label>
            <input type="text" id="modalCustomerInfo" class="form-input" readonly style="background: #f9fafb; color: #6b7280;">
        </div>

        <div class="form-group">
            <label class="form-label">B·∫°n ƒë√£ l√†m g√¨ ƒë·ªÉ kh√°ch h√†ng h√†i l√≤ng? (Ch·ªçn √≠t nh·∫•t 1) <span style="color:red">*</span></label>
            
            <div class="action-list">
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="V·ªá sinh ngo·∫°i quan">
                    <span>V·ªá sinh ngo·∫°i quan</span>
                </label>
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="T∆∞ v·∫•n Zalo OA h·ªó tr·ª£ sau b√°n h√†ng">
                    <span>T∆∞ v·∫•n Zalo OA ƒë·ªÉ h·ªó tr·ª£ sau b√°n h√†ng</span>
                </label>
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="Khi√™ng h√†ng / R√†ng h√†ng l√™n xe">
                    <span>Khi√™ng h√†ng c·ªìng k·ªÅnh / gi√∫p kh√°ch r√†ng h√†ng h√≥a l√™n xe</span>
                </label>
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="ƒê√≥ng h√†ng k·ªπ / B·ªçc m√†ng PE">
                    <span>ƒê√≥ng h√†ng k·ªπ / b·ªçc m√†ng PE n·∫øu th·ªùi ti·∫øt chuy·ªÉn m∆∞a</span>
                </label>
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="H·ªèi nhu c·∫ßu / T∆∞ v·∫•n th√™m">
                    <span>Ch·ªß ƒë·ªông h·ªèi k·ªπ v·ªÅ nhu c·∫ßu s·ª≠ d·ª•ng ƒë·ªÉ t∆∞ v·∫•n/ c√†i ƒë·∫∑t th√™m</span>
                </label>
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng">
                    <span>Ch·ªß ƒë·ªông h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng m√°y v√† c√°c ph·∫ßn m·ªÅm c∆° b·∫£n</span>
                </label>
                <label class="action-item">
                    <input type="checkbox" name="workAction" value="H·ªó tr·ª£ qua Zalo OA">
                    <span>H·ªó tr·ª£ Kh√°ch h√†ng qua k√™nh chat Zalo OA</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">C√°c h√†nh ƒë·ªông kh√°c (Nh·∫≠p th√™m n·∫øu c√≥)</label>
            <input type="text" id="modalOtherAction" class="form-input" placeholder="Ghi ch√∫ th√™m...">
        </div>

        <div class="modal-btns">
            <button class="btn-modal btn-cancel" onclick="closeLogModal()">H·ªßy b·ªè</button>
            <button class="btn-modal btn-confirm" id="btnConfirmLog" onclick="submitWorkLog()">‚úÖ X√°c nh·∫≠n & Ho√†n th√†nh</button>
        </div>
    </div>
</div>
    <script>
       let currentCallType = ''; 

        // M·ªü Modal & T·ª± ƒë·ªông ƒëi·ªÅn t√™n c≈© ƒë√£ l∆∞u
        function openCallModal(type) {
            currentCallType = type;
            const modal = document.getElementById('callModal');
            modal.classList.add('open');

            // 1. L·∫•y d·ªØ li·ªáu ƒë√£ l∆∞u trong tr√¨nh duy·ªát (LocalStorage)
            const savedKtv = localStorage.getItem('last_ktv') || '';
            const savedCounter = localStorage.getItem('last_counter') || '';

            const ktvSelect = document.getElementById('ktvSelect');
            const ktvInput = document.getElementById('ktvInput');
            
            // 2. Logic "Nh·ªõ" th√¥ng minh
            let foundInList = false;
            
            // Duy·ªát qua danh s√°ch ƒë·ªÉ xem t√™n ƒë√£ l∆∞u c√≥ kh·ªõp v·ªõi ai trong DB kh√¥ng
            for(let i=0; i<ktvSelect.options.length; i++){
                if(ktvSelect.options[i].value === savedKtv) {
                    ktvSelect.selectedIndex = i; // C√≥ trong list -> Ch·ªçn lu√¥n
                    foundInList = true;
                    break;
                }
            }

            // 3. X·ª≠ l√Ω hi·ªÉn th·ªã
            if(savedKtv && !foundInList) {
                // N·∫øu c√≥ t√™n l∆∞u m√† KH√îNG n·∫±m trong list DB -> Ch·ªçn "Nh·∫≠p kh√°c" v√† ƒëi·ªÅn v√†o input
                ktvSelect.value = 'other';
                ktvInput.style.display = 'block';
                ktvInput.value = savedKtv;
            } else if (foundInList) {
                // N·∫øu c√≥ trong list -> ·∫®n input nh·∫≠p tay
                ktvInput.style.display = 'none';
            } else {
                // L·∫ßn ƒë·∫ßu ch∆∞a l∆∞u g√¨ -> Reset v·ªÅ m·∫∑c ƒë·ªãnh
                ktvSelect.selectedIndex = 0; 
                ktvInput.style.display = 'none';
            }

            // 4. Set l·∫°i b√†n/qu·∫ßy ƒë√£ l∆∞u
            document.getElementById('counterSelect').value = savedCounter;
        }

        function closeModal() {
            document.getElementById('callModal').classList.remove('open');
        }

        // X·ª≠ l√Ω khi ch·ªçn "Nh·∫≠p t√™n kh√°c"
        function checkKtvOther(select) {
            const input = document.getElementById('ktvInput');
            if(select.value === 'other') {
                input.style.display = 'block';
                input.focus();
                input.value = ''; // Reset ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p m·ªõi
            } else {
                input.style.display = 'none';
            }
        }

        async function confirmCall() {
            const ktvSelect = document.getElementById('ktvSelect');
            const ktvInput = document.getElementById('ktvInput');
            const counterSelect = document.getElementById('counterSelect');

            // L·∫•y t√™n KTV (t·ª´ dropdown ho·∫∑c t·ª´ input nh·∫≠p tay)
            let ktvName = ktvSelect.value === 'other' ? ktvInput.value.trim() : ktvSelect.value;
            
            if(!ktvName || (ktvSelect.value === 'other' && !ktvName)) {
                alert("Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p t√™n KTV!");
                return;
            }

            let counterVal = counterSelect.value;
            
            // Gh√©p chu·ªói hi·ªÉn th·ªã: "V≈© (B√†n 1)"
            let finalName = ktvName;
            if (counterVal) finalName = `${ktvName} (${counterVal})`;

            // === L∆ØU L·∫†I L·ª∞A CH·ªåN V√ÄO TR√åNH DUY·ªÜT ===
            localStorage.setItem('last_ktv', ktvName);
            localStorage.setItem('last_counter', counterVal);

            // G·ª≠i API
            try {
                const btn = document.querySelector('.btn-confirm');
                btn.innerText = "ƒêang g·ªçi..."; btn.disabled = true;

                const res = await fetch('/api/queue/control', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'CALL_NEXT', 
                        service_type: currentCallType, 
                        counter_name: finalName 
                    })
                });
                const data = await res.json();
                
                if(data.ok) window.location.reload();
                else {
                    alert(data.message);
                    btn.innerText = "üìû G·ªåI NGAY"; btn.disabled = false;
                    closeModal();
                }
            } catch(e) { 
                alert('L·ªói k·∫øt n·ªëi'); 
                closeModal();
            }
        }

        async function control(action, id, type) {
            if(action==='COMPLETE' && !confirm('X√°c nh·∫≠n ho√†n th√†nh?')) return;
            await fetch('/api/queue/control', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action, ticket_id: id, service_type: type}) });
            window.location.reload();
        }
        async function updateProcess(id, step) {
            await fetch('/api/queue/control', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'UPDATE_PROCESS', ticket_id: id, process_step: step}) });
            window.location.reload();
        }
        

       let currentPage = 1;

    async function loadHistory(page = 1) {
        currentPage = page;
        const tbody = document.getElementById('historyTableBody');
        const pagDiv = document.getElementById('pagination');
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
        if(tbody.innerHTML.trim() === '') {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
        }

        try {
            // G·ªçi API
            const res = await fetch(`/api/queue/history?branch=<%= user.branch_code %>&page=${page}`);
            const json = await res.json();
            
            if(!json.ok || !json.data || json.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">üì≠ Ch∆∞a c√≥ kh√°ch n√†o ho√†n th√†nh h√¥m nay.</td></tr>';
                pagDiv.innerHTML = '';
                return;
            }

            // Render d·ªØ li·ªáu ra b·∫£ng
            tbody.innerHTML = json.data.map((item, index) => {
                const stt = (page - 1) * 10 + index + 1;
                
                // Format Ng√†y gi·ªù
                const dateObj = new Date(item.updated_at);
                const timeStr = dateObj.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                
                // Format Lo·∫°i d·ªãch v·ª•
                let typeInfo = '';
                if(item.service_type === 'REPAIR') typeInfo = '<span style="color:#1a73e8; font-weight:700;">S·ª≠a ch·ªØa</span>';
                else if(item.service_type === 'WARRANTY') typeInfo = '<span style="color:#d97706; font-weight:700;">B·∫£o h√†nh</span>';
                else typeInfo = '<span style="color:#0d9488; font-weight:700;">L·∫Øp r√°p</span>';

                // Format ƒê√°nh gi√°
                let feedbackHtml = '<span style="color:#ccc;">--</span>';
                if(item.service_feedback && item.service_feedback.length > 0) {
                    const fb = item.service_feedback[0];
                    const stars = '‚≠ê'.repeat(fb.service_score || 5);
                    feedbackHtml = `<div>${stars}</div><div style="font-size:11px; color:#666;">${fb.comment || ''}</div>`;
                }

                // T√≠nh th·ªùi gian ph·ª•c v·ª•
                const durationMs = new Date(item.updated_at) - new Date(item.created_at);
                const durationMin = Math.floor(durationMs / 60000);

                return `
                    <tr style="border-bottom:1px solid #eee; hover:background-color:#f9f9f9;">
                        <td style="padding:12px; text-align:center;">${stt}</td>
                        <td style="padding:12px;">${timeStr}</td>
                        <td style="padding:12px;">${typeInfo}<br><small style="color:#555">${item.ticket_number}</small></td>
                        <td style="padding:12px; font-weight:600;">${item.customer_name}</td>
                        <td style="padding:12px;">
                            ${item.customer_phone || ''}
                            ${item.order_id ? `<br><span style="color:#0d9488; font-size:11px;">ƒê∆°n: ${item.order_id}</span>` : ''}
                        </td>
                        <td style="padding:12px;">${item.counter_name || '---'}</td>
                        <td style="padding:12px;">${durationMin} ph√∫t</td>
                        <td style="padding:12px;">${feedbackHtml}</td>
                    </tr>
                `;
            }).join('');

            // Render Ph√¢n trang
            const { totalPages } = json.pagination;
            let pagHtml = '';
            if(page > 1) pagHtml += `<button onclick="loadHistory(${page-1})" style="padding:5px 10px; cursor:pointer;">Pop tr∆∞·ªõc</button>`;
            pagHtml += `<span style="padding:0 10px; font-weight:bold; color:#555;">Trang ${page}/${totalPages}</span>`;
            if(page < totalPages) pagHtml += `<button onclick="loadHistory(${page+1})" style="padding:5px 10px; cursor:pointer;">Ti·∫øp theo</button>`;
            pagDiv.innerHTML = pagHtml;

        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="8" style="color:red; text-align:center;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu. H√£y ki·ªÉm tra server.</td></tr>';
        }
    }

    // [M·ªöI] H√†m x√≥a v√©
    async function deleteTicket(id) {
        if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA v√© n√†y kh√¥ng?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) return;

        try {
            const res = await fetch('/api/queue/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'DELETE', ticket_id: id })
            });
            
            const data = await res.json();
            if (data.ok) {
                // X√≥a th√†nh c√¥ng th√¨ reload l·∫°i trang
                window.location.reload();
            } else {
                alert("L·ªói khi x√≥a: " + (data.message || 'Unknown'));
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi server!");
        }
    }


   let logTicketId = null; 
    const logModal = document.getElementById('feedbackModal');
    const msnvInput = document.getElementById('modalMsnv');

    document.addEventListener('DOMContentLoaded', () => {
        const savedMsnv = localStorage.getItem('user_msnv');
        if (savedMsnv && msnvInput) msnvInput.value = savedMsnv;
    });

    // H√†m m·ªü modal
    window.openLogModal = function(ticketId, customerInfo) {
        logTicketId = ticketId;
        document.getElementById('modalCustomerInfo').value = customerInfo || 'N/A';
        
        // Reset form: b·ªè ch·ªçn t·∫•t c·∫£ checkbox
        document.querySelectorAll('input[name="workAction"]').forEach(cb => cb.checked = false);
        document.getElementById('modalOtherAction').value = '';
        
        logModal.classList.add('open');
    }

    // H√†m ƒë√≥ng modal
    window.closeLogModal = function() {
        logModal.classList.remove('open');
        logTicketId = null;
    }

    // H√†m g·ª≠i d·ªØ li·ªáu
    window.submitWorkLog = async function() {
        const msnv = msnvInput.value.trim();
        const otherAction = document.getElementById('modalOtherAction').value.trim();
        const customerInfo = document.getElementById('modalCustomerInfo').value;

        // 1. L·∫•y danh s√°ch c√°c checkbox ƒë√£ ch·ªçn
        const checkedBoxes = document.querySelectorAll('input[name="workAction"]:checked');
        
        // Chuy·ªÉn th√†nh m·∫£ng c√°c gi√° tr·ªã chu·ªói
        let selectedActions = Array.from(checkedBoxes).map(cb => cb.value);

        // Ki·ªÉm tra l·ªói
        if (!msnv) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ s·ªë nh√¢n vi√™n (MSNV)!");
            msnvInput.focus();
            return;
        }
        if (selectedActions.length === 0 && !otherAction) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h√†nh ƒë·ªông ƒë√£ l√†m!");
            return;
        }

        // G·ªôp c√°c h√†nh ƒë·ªông th√†nh 1 chu·ªói ƒë·ªÉ g·ª≠i ƒëi (v√≠ d·ª•: "V·ªá sinh, H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng")
        const actionDesc = selectedActions.join(', ');

        localStorage.setItem('user_msnv', msnv);

        const btn = document.getElementById('btnConfirmLog');
        const oldText = btn.innerText;
        btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω..."; 
        btn.disabled = true;

        try {
            console.log("ƒêang g·ª≠i:", { ticket_id: logTicketId, msnv, action_desc: actionDesc }); // Debug log

            const res = await fetch('/api/queue/log-and-complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ticket_id: logTicketId,
                    msnv: msnv,
                    customer_info: customerInfo,
                    action_desc: actionDesc, // G·ª≠i chu·ªói ƒë√£ g·ªôp
                    other_action: otherAction
                })
            });

            const data = await res.json();
            
            if (data.ok) {
                closeLogModal();
                window.location.reload(); 
            } else {
                alert("‚ùå L·ªói server: " + (data.message || 'Kh√¥ng th·ªÉ l∆∞u'));
                console.error(data);
            }
        } catch (e) {
            console.error("L·ªói fetch:", e);
            alert("‚ùå L·ªói k·∫øt n·ªëi m·∫°ng ho·∫∑c Server!");
        } finally {
            btn.innerText = oldText; 
            btn.disabled = false;
        }
    }
    // --- 3. K√çCH HO·∫†T ---
    // G·ªçi h√†m ngay khi v√†o trang
    loadHistory(); 

    // T·ª± ƒë·ªông c·∫≠p nh·∫≠t b·∫£ng sau m·ªói 10 gi√¢y (Kh√¥ng load l·∫°i trang)
    setInterval(() => loadHistory(currentPage), 10000);
    
    // T·ª± ƒë·ªông reload trang sau 60 gi√¢y ƒë·ªÉ c·∫≠p nh·∫≠t v√© m·ªõi ·ªü 2 c·ªôt tr√™n (thay th·∫ø reload 15s c≈©)
    setTimeout(() => window.location.reload(), 60000);
        //setTimeout(() => window.location.reload(), 15000);
    </script>

</body>
</html>
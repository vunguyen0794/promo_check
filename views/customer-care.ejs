<%- include('partials/header', {title: 'ChƒÉm s√≥c kh√°ch h√†ng', currentPage: 'customer-care'}) %>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>


    /* --- CSS M·ªöI: WRAPPER CHO DASHBOARD --- */
    .dashboard-wrapper {
        background-color: #f0f9ff; /* M√†u xanh d∆∞∆°ng si√™u nh·∫°t */
        border: 1px solid #bae6fd; /* Vi·ªÅn xanh nh·∫°t */
        border-radius: 16px;       /* Bo g√≥c to */
        padding: 20px;             /* Kho·∫£ng c√°ch b√™n trong */
        margin-bottom: 30px;       /* C√°ch b√™n d∆∞·ªõi */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    /* Ch·ªânh l·∫°i n·ªÅn Card th√†nh tr·∫Øng tinh ƒë·ªÉ n·ªïi b·∫≠t tr√™n n·ªÅn xanh */
    .cskh-card, .matrix-card {
        background-color: #ffffff !important; 
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03) !important;
    }
    /* Matrix Table Styles */
    .matrix-card { background: white; border-radius: 12px; border: 1px solid #e9ecef; padding: 20px; margin-bottom: 20px; overflow-x: auto; }
    .matrix-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
    .matrix-table th { background: #f1f5f9; padding: 12px 8px; text-align: center; border: 1px solid #e2e8f0; color: #475569; font-weight: 700; white-space: nowrap; }
    .matrix-table td { padding: 10px 8px; border: 1px solid #e2e8f0; text-align: center; }
    
    .col-branch { background-color: #e0f2fe; font-weight: 700; color: #0369a1; text-align: left !important; }
    .col-sales { text-align: left !important; font-weight: 600; color: #334155; padding-left: 20px !important; }
    .col-total { font-weight: 700; background: #f8fafc; }
    .col-rev { font-weight: 700; color: #16a34a; background: #f0fdf4; }
    .val-cell { color: #64748b; }
    .val-cell.has-val { color: #2563eb; font-weight: 600; background: #eff6ff; }
    
    /* Sticky Header */
    .matrix-table thead th { position: sticky; top: 0; z-index: 10; }
    /* Accordion Table */
    .parent-row { cursor: pointer; transition: background 0.2s; }
    .parent-row:hover { background-color: #f1f5f9; }
    .parent-row.expanded { background-color: #e0f2fe; border-left: 4px solid #2563eb; }
    
    .detail-row { display: none; background-color: #f8fafc; }
    .detail-row.show { display: table-row; animation: fadeIn 0.3s; }
    
    .detail-table-inner { margin: 10px 0 10px 50px; width: calc(100% - 50px); border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; }
    .detail-table-inner th { background: #e2e8f0; font-size: 12px; padding: 8px; }
    .detail-table-inner td { background: #fff; font-size: 12px; padding: 8px; border-bottom: 1px solid #eee; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .toggle-icon { display: inline-block; width: 20px; text-align: center; transition: transform 0.2s; }
    .expanded .toggle-icon { transform: rotate(90deg); }



    .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .custom-select {
        appearance: none; /* ·∫®n m≈©i t√™n m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát */
        -webkit-appearance: none;
        background-color: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 32px 8px 12px; /* Padding b√™n ph·∫£i r·ªông ƒë·ªÉ ch·ª©a m≈©i t√™n */
        font-size: 13px;
        font-weight: 500;
        color: #334155;
        cursor: pointer;
        outline: none;
        transition: all 0.2s ease;
        
        /* T·∫°o m≈©i t√™n custom b·∫±ng h√¨nh ·∫£nh SVG encoded */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 14px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        min-width: 140px;
    }

    .custom-select:hover {
        border-color: #cbd5e1;
        background-color: #f8fafc;
    }

    .custom-select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* M√†u ri√™ng cho t·ª´ng lo·∫°i filter ƒë·ªÉ d·ªÖ ph√¢n bi·ªát */
    .select-status { border-left: 3px solid #2563eb; }
    .select-tax { border-left: 3px solid #ea580c; }
    .select-sort { border-left: 3px solid #059669; }
    /* CSS Select2 */
    .select2-container .select2-selection--single {
        height: 42px !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        display: flex !important;
        align-items: center !important;
        padding-left: 10px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px !important; top: 1px !important; right: 5px !important;
    }
    .select2-container { width: 100% !important; max-width: 250px; margin-right: 10px; }

    /* Dashboard & Layout */
    .cskh-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .cskh-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e9ecef; box-shadow: 0 2px 6px rgba(0,0,0,0.04); text-align: center; }
    .cskh-card h3 { font-size: 24px; color: #2563eb; margin-bottom: 5px; font-weight: 800; }
    .cskh-card p { color: #64748b; font-size: 14px; font-weight: 600; margin: 0; }
    
    /* Search Controls */
    .search-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    .search-controls select.std-select { width: 160px; padding: 0 12px; border-radius: 8px; border: 1px solid #e5e7eb; height: 42px; }
    .search-controls input { flex: 1; padding: 0 12px; border-radius: 8px; border: 1px solid #e5e7eb; height: 42px; }
    .search-controls button { height: 42px; padding: 0 20px; font-weight: 600; }

    /* Table Elements */
    .prod-detail { font-size: 13px; color: #334155; line-height: 1.5; max-height: 80px; overflow-y: auto; }
    .status-tag { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block; }
    .st-uncared { background: #fee2e2; color: #dc2626; }
    .st-caring { background: #fef3c7; color: #d97706; }
    .st-done { background: #dcfce7; color: #16a34a; }
    .btn-care { background: #fff; border: 1px solid #2563eb; color: #2563eb; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: .2s; }
    .btn-care:hover { background: #2563eb; color: #fff; }

    /* History Log */
    .history-item { background: #f8fafc; border-left: 3px solid #cbd5e1; padding: 8px 12px; margin-bottom: 8px; font-size: 13px; }
    .history-meta { color: #64748b; font-size: 11px; margin-bottom: 4px; }
    
    /* Rank Modal Table */
    #rankModal table tr td { padding: 10px; border-bottom: 1px solid #eee; }

    /* CSS cho Filter Bar Qu·∫£n tr·ªã */
    .admin-filter-bar {
        display: flex;
        gap: 10px;
        padding-bottom: 20px;
        margin-bottom: 20px;
        border-bottom: 1px dashed #bae6fd;
        flex-wrap: wrap;
        align-items: end;
    }
    .filter-item { display: flex; flex-direction: column; gap: 5px; }
    .filter-item label { font-size: 12px; font-weight: 700; color: #475569; }
    .filter-input { 
        height: 38px; border: 1px solid #cbd5e1; border-radius: 6px; padding: 0 10px; font-size: 13px;
    }
    .btn-filter-apply {
        height: 38px; padding: 0 20px; background: #0f172a; color: #fff; border-radius: 6px; font-weight: 600; border: none; cursor: pointer;
    }
    .btn-filter-preset {
        height: 38px; padding: 0 12px; background: #fff; border: 1px solid #cbd5e1; color: #475569; border-radius: 6px; font-size: 12px; cursor: pointer;
    }
    .btn-filter-preset:hover { background: #f1f5f9; }
    /* Th√™m v√†o th·∫ª <style> */
.clickable-row {
    cursor: pointer;
    transition: background 0.1s;
}
.clickable-row:hover {
    background-color: #eff6ff; /* Xanh nh·∫°t khi hover */
}

/* --- CSS CHO THANH ACTION BAR (G√ÅN KH√ÅCH) --- */
.action-bar {
    position: fixed;
    bottom: 30px; /* C√°ch ƒë√°y m√†n h√¨nh 30px */
    left: 50%;
    transform: translateX(-50%) translateY(150%); /* M·∫∑c ƒë·ªãnh ·∫©n xu·ªëng d∆∞·ªõi */
    
    background-color: rgba(255, 255, 255, 0.95); /* N·ªÅn tr·∫Øng h∆°i trong su·ªët */
    backdrop-filter: blur(10px); /* Hi·ªáu ·ª©ng m·ªù n·ªÅn ƒë·∫±ng sau */
    
    padding: 15px 25px;
    border-radius: 50px; /* Bo tr√≤n h√¨nh vi√™n thu·ªëc */
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); /* ƒê·ªï b√≥ng ƒë·∫πp */
    border: 1px solid #e2e8f0;
    
    display: flex; /* X·∫øp h√†ng ngang */
    align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
    
    z-index: 9999; /* Lu√¥n n·ªïi tr√™n c√πng */
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); /* Hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t m√† */
    min-width: 600px; /* ƒê·ªô r·ªông t·ªëi thi·ªÉu */
    justify-content: space-between;
}

/* Khi c√≥ class .visible th√¨ tr∆∞·ª£t l√™n */
.action-bar.visible {
    transform: translateX(-50%) translateY(0);
}

/* Style cho ch·ªØ "ƒê√£ ch·ªçn..." */
.count-display {
    font-weight: 600;
    color: #334155;
    background: #f1f5f9;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 14px;
}
.count-display b {
    color: #2563eb;
    font-size: 16px;
}

/* Style cho √¥ ch·ªçn nh√¢n vi√™n (Select box) */
.action-bar select {
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 8px 12px;
    outline: none;
    font-size: 14px;
    min-width: 250px; /* ƒê·ªô r·ªông √¥ ch·ªçn */
    cursor: pointer;
    background-color: #fff;
    transition: border 0.2s;
}
.action-bar select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* Style cho n√∫t G√°n */
.btn-assign {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 30px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    transition: transform 0.1s, box-shadow 0.2s;
    white-space: nowrap;
}
.btn-assign:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4);
}
.btn-assign:active {
    transform: translateY(1px);
}
</style>

<div class="container">
    <div class="dashboard-wrapper">
        <% if (isManager) { %>
    <form method="GET" action="/customer-care" id="adminFilterForm">
        <div class="admin-filter-bar">
            
            <% if (isGlobalAdmin) { %>
                <div class="filter-item">
                    <label>Chi nh√°nh</label>
                    <select name="branch" class="filter-input" style="width: 150px;">
                        <option value="">-- T·∫•t c·∫£ --</option>
                        <% branchList.forEach(br => { %>
                            <option value="<%= br %>" <%= filters.branch === br ? 'selected' : '' %>><%= br %></option>
                        <% }) %>
                    </select>
                </div>
            <% } %>

                <div class="filter-item">
    <label>Nh√¢n vi√™n</label>
    <select name="emp" class="filter-input" style="width: 180px;">
        <option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
        <% if (typeof branchStaffs !== 'undefined' && branchStaffs) { %>
            <% branchStaffs.forEach(st => { %>
                <option value="<%= st.id %>" <%= filters.emp === st.id ? 'selected' : '' %>>
                    <%= st.full_name || st.email %>
                </option>
            <% }) %>
        <% } %>
    </select>
</div>

            <div class="filter-item">
                <label>T·ª´ ng√†y</label>
                <input type="date" name="start" class="filter-input" value="<%= filters.start %>">
            </div>
            <div class="filter-item">
                <label>ƒê·∫øn ng√†y</label>
                <input type="date" name="end" class="filter-input" value="<%= filters.end %>">
            </div>

            <button type="submit" class="btn-filter-apply">L·ªçc d·ªØ li·ªáu</button>

            <div style="display:flex; gap:5px; margin-left:auto;">
                <button type="button" class="btn-filter-preset" onclick="setPeriod('today')">H√¥m nay</button>
                <button type="button" class="btn-filter-preset" onclick="setPeriod('week')">Tu·∫ßn n√†y</button>
                <button type="button" class="btn-filter-preset" onclick="setPeriod('month')">Th√°ng n√†y</button>
            </div>
        </div>
    </form>
    <% } %>
        <div class="cskh-dashboard">
            <div class="cskh-card">
                <h3><%= new Intl.NumberFormat('vi-VN').format(dashboard.revenue || 0) %> ‚Ç´</h3>
                <p>Doanh thu</p>
            </div>
            <div class="cskh-card">
                <h3><%= dashboard.cared_count || 0 %></h3>
                <p>Kh√°ch ƒë√£ Care</p>
            </div>
            <div class="cskh-card">
                <h3><%= dashboard.closed_count || 0 %></h3>
                <p>Kh√°ch ƒë√£ ch·ªët</p>
            </div>
            
            <% 
                // Ki·ªÉm tra quy·ªÅn xem BXH
                const canViewRank = (user.role === 'manager' || user.role === 'admin' || typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin);
            %>
            <div class="cskh-card" 
                 onclick="openRankModal()" 
                 style="<%= canViewRank ? 'cursor:pointer; border: 2px solid #bfdbfe !important;' : '' %>">
                <h3 style="color:#e11d48"><%= dashboard.rank || '--' %></h3>
                <p style="color:#e11d48">Rank (Click xem BXH)</p>
            </div>
        </div>

        <% if ((user.role === 'manager' || user.role === 'admin' || user.branch_code === 'HCM.BD') && dashboard.matrix_data) { %>
        <div class="matrix-card">
            <div class="dash-title" style="border-bottom:none; margin-bottom:15px;">
                üìä B√°o c√°o hi·ªáu qu·∫£ l√†m vi·ªác (Th√°ng n√†y)
            </div>
            
            <div class="table-scroll-wrapper" style="max-height: 400px;">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th style="min-width: 200px; text-align:left; padding-left:15px; z-index:20; left:0; position:sticky;">Nh√¢n s·ª±</th>
                            <th style="min-width: 80px;">T·ªïng Care</th>
                            <th style="min-width: 120px;">Doanh thu Care</th>
                            <% dashboard.result_columns.forEach(col => { %>
                                <th><%= col %></th>
                            <% }) %>
                        </tr>
                    </thead>
                    <tbody>
                        <% Object.keys(dashboard.matrix_data).sort().forEach(branch => { %>
                            <tr style="background:#f1f5f9;">
                                <td class="col-branch" colspan="<%= 3 + dashboard.result_columns.length %>">
                                    üè¢ <%= branch %>
                                </td>
                            </tr>
                            <% const users = dashboard.matrix_data[branch]; %>
                            <% Object.entries(users).sort(([,a], [,b]) => b.total_revenue - a.total_revenue).forEach(([key, sale]) => { %>
    <tr>
        <td class="col-sales"><%= sale.name %></td>
        <td class="col-total"><%= sale.total_care %></td>
        <td class="col-rev"><%= new Intl.NumberFormat('vi-VN').format(sale.total_revenue) %></td>
        <% dashboard.result_columns.forEach(col => { %>
            <% const count = sale.results[col] || 0; %>
            <td class="val-cell <%= count > 0 ? 'has-val' : '' %>"
                style="<%= count > 0 ? 'cursor:pointer; text-decoration:underline;' : '' %>"
                onclick="<%= count > 0 ? `openMatrixDetail('${key}', '${col}', '${branch}')` : '' %>"
            >
                <%= count > 0 ? count : '-' %>
            </td>
        <% }) %>
    </tr>
<% }) %>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
        <% } %>

    </div> <div id="rankModal" class="modal" style="display:none; z-index: 9999;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="document.getElementById('rankModal').style.display='none'">&times;</span>
            <h3 style="color:#2563eb; margin-bottom:15px; text-align:center;">üèÜ B·∫£ng X·∫øp H·∫°ng Chi Nh√°nh</h3>
            
            <div style="max-height: 60vh; overflow-y: auto;">
                <table class="info-table">
                    <thead style="background:#f1f5f9; position: sticky; top: 0;">
                        <tr><th>H·∫°ng</th><th>Nh√¢n vi√™n</th><th style="text-align:right">Doanh thu Care</th></tr>
                    </thead>
                    <tbody>
                        <% if (dashboard.ranking_list && dashboard.ranking_list.length > 0) { %>
                            <% dashboard.ranking_list.forEach((r, index) => { %>
                                <tr style="<%= r.id === user.id ? 'background:#e0f2fe; font-weight:bold;' : '' %>">
                                    <td>
                                        <% if(index === 0) { %> ü•á <% } else if(index === 1) { %> ü•à <% } else if(index === 2) { %> ü•â <% } else { %> #<%= index + 1 %> <% } %>
                                    </td>
                                    <td><%= r.name %> <br> <small style="color:#64748b"><%= r.branch %></small></td>
                                    <td style="text-align:right; color:#16a34a; font-weight:bold;">
                                        <%= new Intl.NumberFormat('vi-VN').format(r.total) %> ‚Ç´
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="3" style="text-align:center; padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <div id="breakdownModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="document.getElementById('breakdownModal').style.display='none'">&times;</span>
        
        <h3 style="color:#2563eb; margin-bottom:5px; text-align:center;">üìä Ph√¢n b·ªï ƒë∆°n h√†ng</h3>
        <p id="breakdownCustomerName" style="text-align:center; font-weight:bold; color:#64748b; margin-bottom:15px;"></p>
        
        <div style="max-height: 60vh; overflow-y: auto;">
            <div id="breakdownNav" style="display:none; margin-bottom: 10px;">
    <button class="btn-care" onclick="resetToBranchView()" style="background:#f1f5f9; color:#334155; border:1px solid #cbd5e1;">
        ‚¨Ö Quay l·∫°i danh s√°ch Chi nh√°nh
    </button>
</div>
            <table class="info-table">
                <thead style="background:#f1f5f9; position: sticky; top: 0;">
                    <tr>
                        <th id="breakdownColName">Ti√™u ch√≠</th> <th style="text-align:right">S·ªë l∆∞·ª£ng</th>
                        <th style="text-align:right">T·ª∑ tr·ªçng</th>
                    </tr>
                </thead>
                <tbody id="breakdownTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

   <div class="dash-card" style="margin-top: 20px;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap:15px;">
            <div class="dash-title" style="margin:0; border-bottom:none; font-size:18px; white-space:nowrap;">
                üìã Danh s√°ch kh√°ch h√†ng
            </div>
            
            <div style="display:flex; gap:10px; flex:1; max-width:600px;">
                <select id="searchType" class="custom-select" style="width:140px; background-color:#f8fafc;">
                    <option value="customer_name">T√™n kh√°ch h√†ng</option>
                    <option value="order_code">M√£ ƒë∆°n h√†ng</option>
                    <option value="tax_code">M√£ s·ªë thu·∫ø</option>
                </select>
                <div style="position:relative; flex:1;">
                    <input type="text" id="searchInput" 
                           placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..." 
                           style="width:100%; height:38px; border:1px solid #cbd5e1; border-radius:8px; padding:0 10px 0 35px;"
                           onkeypress="if(event.key==='Enter') loadWorkList(1)">
                    <span style="position:absolute; left:10px; top:9px;">üîç</span>
                </div>
                <button class="btn btn-primary" onclick="loadWorkList(1)" style="height:38px; padding:0 20px;">T√¨m</button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap; padding-bottom:15px; border-bottom:1px dashed #e2e8f0; margin-bottom:15px;">
            
            <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin) { %>
                <select id="wlBranch" onchange="loadWorkList(1)" class="custom-select" style="border-left: 3px solid #6366f1;">
                    <option value="all">-- T·∫•t c·∫£ CN --</option>
                    <% if (branchList) { branchList.forEach(br => { %>
                        <option value="<%= br %>"><%= br %></option>
                    <% }) } %>
                </select>
            <% } else { %>
                <input type="hidden" id="wlBranch" value="">
            <% } %>

            <% if (isManager) { %>
                <div style="width: 200px;">
                    <select id="filterEmail" class="select2-enable" onchange="loadWorkList(1)">
    <option value="">-- L·ªçc theo nh√¢n vi√™n --</option>
    <% if (typeof branchStaffs !== 'undefined' && branchStaffs) { %>
        <% branchStaffs.forEach(st => { %>
            <option value="<%= st.id %>">
                [<%= st.branch_code %>] <%= st.full_name || st.email %>
            </option>
        <% }) %>
    <% } %>
</select>
                </div>
            <% } else { %>
                <input type="hidden" id="filterEmail" value="">
            <% } %>

            <select id="wlMonth" onchange="loadWorkList(1)" class="custom-select" style="border-left: 3px solid #e11d48;">
                <% const d = new Date(); const currentM = d.toISOString().slice(0, 7); %>
                <option value="<%= currentM %>">Th√°ng n√†y (<%= currentM %>)</option>
                <option value="all">üìÖ To√†n th·ªùi gian</option>
                <% for(let i=1; i<=11; i++) { d.setMonth(d.getMonth() - 1); const mStr = d.toISOString().slice(0, 7); %>
                    <option value="<%= mStr %>">Th√°ng <%= mStr %></option>
                <% } %>
            </select>

            <select id="wlStatus" onchange="loadWorkList(1)" class="custom-select select-status">
                <option value="all">-- Tr·∫°ng th√°i --</option>
                <option value="uncared">üî¥ Ch∆∞a care</option>
                <option value="caring">üü° ƒêang care</option>
                <option value="done">üü¢ ƒê√£ ch·ªët</option>
            </select>

            <select id="wlTax" onchange="loadWorkList(1)" class="custom-select select-tax">
                <option value="all">Lo·∫°i KH</option>
                <option value="has_tax">üè¢ Doanh nghi·ªáp</option>
                <option value="no_tax">üë§ C√° nh√¢n</option>
            </select>
            
            <select id="wlSort" onchange="loadWorkList(1)" class="custom-select select-sort">
                <option value="price_desc">üí∞ DT Cao nh·∫•t</option>
                <option value="date_desc">üìÖ M·ªõi nh·∫•t</option>
                <option value="date_asc">üìÖ C≈© nh·∫•t</option>
            </select>
        </div>
<div id="actionBar" class="action-bar">
    <span class="count-display">
        ƒê√£ ch·ªçn: <b id="countDisplay">0</b> kh√°ch h√†ng
    </span>
    
    <% if (isManager) { %>
        <div style="display: flex; align-items: center; gap: 10px; flex: 1; justify-content: flex-end;">
            
            <select id="targetEmployeeSelect">
                <option value="">-- Ch·ªçn nh√¢n vi√™n ti·∫øp nh·∫≠n --</option>
                <% if (branchStaffs && branchStaffs.length > 0) { %>
                    <% branchStaffs.forEach(staff => { %>
                        <option value="<%= staff.id %>">
                            <%= staff.full_name %> (<%= staff.branch_code %>)
                        </option>
                    <% }) %>
                <% } else { %>
                    <option disabled>Kh√¥ng c√≥ nh√¢n vi√™n n√†o</option>
                <% } %>
            </select>

            <button class="btn-assign" onclick="submitAssignment()">
                <i class="bi bi-person-check-fill"></i> G√°n kh√°ch ngay
            </button>
        </div>
    <% } %>
</div>

<div style="display: flex; align-items: center; gap: 20px; margin-left: 15px; border-left: 1px solid #cbd5e1; padding-left: 15px;">
    

        <div class="form-check form-switch" style="min-height: auto; padding-left: 2.5em; margin: 0;">
            <input class="form-check-input" type="checkbox" id="checkAssignedOnly" 
                   onchange="loadWorkList(1)" 
                   style="cursor: pointer; width: 35px; height: 18px; margin-left: -2.5em;">
            <label class="form-check-label" for="checkAssignedOnly" 
                   style="cursor: pointer; font-weight: 600; color: #334155; font-size: 14px; margin-top: 1px;">
                ƒê∆∞·ª£c ph√¢n b·ªï b·ªüi QLSR
            </label>
        </div>


    <div class="form-check d-flex align-items-center" style="padding: 0; gap: 8px;">
        <input type="checkbox" id="excludeGrab" 
               onchange="loadWorkList(1)" 
               style="width: 18px; height: 18px; cursor: pointer; accent-color: #2563eb;"
               <%= (filters.excludeGrab !== 'false') ? 'checked' : '' %> >
        <label for="excludeGrab" 
               style="margin: 0; font-size: 14px; font-weight: 600; color: #334155; cursor: pointer; user-select: none;">
            ·∫®n Grab
        </label>
    </div>

</div>
        
        <div style="margin-bottom:10px; display:flex; justify-content:flex-end; gap:10px; align-items:center;">
            <button class="btn-view-more" onclick="loadWorkList(currentPage - 1)">‚ùÆ Tr∆∞·ªõc</button>
            <span style="font-weight:600; font-size:14px; color:#475569;" id="pageIndicator">Trang 1</span>
            <button class="btn-view-more" onclick="loadWorkList(currentPage + 1)">Sau ‚ùØ</button>
        </div>

        <div id="workListContainer">
            <div style="padding:40px; text-align:center; color:#64748b;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
    </div>

<div id="careModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 style="margin-bottom:15px; color:#2563eb; font-weight:700;">üìû C·∫≠p nh·∫≠t chƒÉm s√≥c</h2>
        
        <form id="careForm">
            <input type="hidden" name="order_code" id="m_order_code">
            <input type="hidden" name="customer_name" id="m_customer_name">

            <div class="promo-form">
                <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <div><strong>ƒê∆°n h√†ng:</strong> <span id="d_order_code"></span></div>
                    <div><strong>Kh√°ch h√†ng:</strong> <span id="d_customer_name"></span></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>SƒêT Kh√°ch h√†ng (*)</label>
                        <input type="text" name="phone" required placeholder="VD: 0909..." id="m_phone">
                    </div>
                    <div class="form-group">
                        <label>L·∫ßn chƒÉm s√≥c</label>
                        <select name="care_stage">
                            <option value="L·∫ßn 1">L·∫ßn 1</option>
                            <option value="L·∫ßn 2">L·∫ßn 2</option>
                            <option value="L·∫ßn 3">L·∫ßn 3</option>
                            <option value="L·∫ßn 4+">L·∫ßn 4+</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ph∆∞∆°ng th·ª©c</label>
                        <select name="contact_method">
                            <option value="Zalo">Zalo</option>
                            <option value="Phone c√° nh√¢n">Phone c√° nh√¢n</option>
                            <option value="Phone c√¥ng ty">Phone c√¥ng ty</option>
                            <option value="Email">Email</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>K·∫øt qu·∫£ (*)</label>
                        <select name="result" id="resultSelect" onchange="toggleRevenue()">
                            <option value="Ch∆∞a nghe m√°y">Kh√¥ng b·∫Øt m√°y / Thu√™ bao</option>
                            <option value="ƒê√£ k·∫øt n·ªëi Zalo OA">ƒê√£ k·∫øt n·ªëi Zalo OA</option>
                            <option value="ƒê√£ b√°o gi√°">ƒê√£ b√°o gi√° qua Zalo</option>
                            <option value="Ch·ªù ph·∫£n h·ªìi">Ch·ªù ph·∫£n h·ªìi</option>
                            <option value="Li√™n h·ªá sau">Li√™n h·ªá sau</option>
                            <option value="Kh√¥ng c√≥ nhu c·∫ßu">Kh√¥ng c√≥ nhu c·∫ßu</option>
                            <option value="Ch·ªët ƒë∆°n">‚úÖ Ch·ªët ƒë∆°n (C√≥ doanh thu)</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="revenueBox" style="display:none; background:#f0fdf4; padding:10px; border:1px dashed #16a34a; border-radius:6px;">
                    <label style="color:#16a34a;">üí∞ Doanh thu ph√°t sinh th√™m (VNƒê):</label>
                    <input type="number" name="revenue" placeholder="0">
                </div>

                <div class="form-group">
                    <label>Ng√†y h·∫πn li√™n h·ªá l·∫°i</label>
                    <input type="date" name="next_date">
                </div>

                <div class="form-group">
                    <label>Ghi ch√∫ chi ti·∫øt</label>
                    <textarea name="note" rows="2" placeholder="Kh√°ch quan t√¢m s·∫£n ph·∫©m g√¨..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" style="width:100%;">L∆∞u th√¥ng tin</button>
                </div>

                <div style="margin-top:20px; border-top:1px solid #e5e7eb; padding-top:10px;">
                    <h4 style="font-size:14px; margin-bottom:10px;">L·ªãch s·ª≠ chƒÉm s√≥c ƒë∆°n n√†y:</h4>
                    <div id="historyContainer" style="max-height:150px; overflow-y:auto;"></div>
                </div>
            </div>
        </form>
    </div>
</div>

<% if (dashboard.ranking_list) { %>
<div id="rankModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="document.getElementById('rankModal').style.display='none'">&times;</span>
        <h3 style="color:#2563eb; margin-bottom:15px; text-align:center;">üèÜ B·∫£ng X·∫øp H·∫°ng Chi Nh√°nh</h3>
        <div style="max-height: 60vh; overflow-y: auto;">
            <table class="info-table">
                <thead style="background:#f1f5f9; position: sticky; top: 0;">
                    <tr><th>H·∫°ng</th><th>Nh√¢n vi√™n</th><th style="text-align:right">Doanh thu Care</th></tr>
                </thead>
                <tbody>
                    <% dashboard.ranking_list.forEach((r, index) => { %>
                        <tr style="<%= r.id === user.id ? 'background:#e0f2fe; font-weight:bold;' : '' %>">
                            <td>
                                <% if(index === 0) { %> ü•á <% } else if(index === 1) { %> ü•à <% } else if(index === 2) { %> ü•â <% } else { %> #<%= index + 1 %> <% } %>
                            </td>
                            <td><%= r.name %> <br> <small style="color:#64748b"><%= r.branch %></small></td>
                            <td style="text-align:right; color:#16a34a; font-weight:bold;">
                                <%= new Intl.NumberFormat('vi-VN').format(r.total) %> ‚Ç´
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="matrixDetailModal" class="modal" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
        <span class="close" onclick="document.getElementById('matrixDetailModal').style.display='none'">&times;</span>
        <h3 style="color:#2563eb; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            üìä Chi ti·∫øt: <span id="matrixDetailTitle"></span>
        </h3>
        
        <div class="table-scroll-wrapper" style="max-height: 70vh;">
            <table class="info-table" style="width:100%; min-width:800px;">
                <thead style="background:#f1f5f9; position:sticky; top:0; z-index:10;">
                    <tr>
                        <th width="50">STT</th>
                        <th width="80">CN</th>
                        <th width="150">Salesman</th>
                        <th width="120">M√£ ƒë∆°n</th>
                        <th>Ten KH/ Cty</th>
                        <th width="100">SƒêT</th>
                        <th width="100">MST</th>
                        <th width="120" style="text-align:right">Doanh thu</th>
                        <th style="min-width: 250px;">Ghi ch√∫ chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="matrixDetailBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>
<% } %>

<script>
    // ==============================================================
    // 1. LOGIC T√åM KI·∫æM (BLOCK 2)
    // ==============================================================
    let globalWorkListData = [];
    let currentSearchPage = 1; 
    let currentData = [];

    // --- H√ÄM RENDER B·∫¢NG T√åM KI·∫æM (ƒê√É KH·ªöP C·ªòT) ---
    function renderMainTable(data) {
        const tbody = document.querySelector('#resultTable tbody');
        
        // L·∫•y quy·ªÅn user (ƒë·ªÉ ·∫©n/hi·ªán c·ªôt)
        const isManager = "<%= user.role === 'manager' || user.role === 'admin' || user.branch_code === 'HCM.BD' %>" === 'true';
        const isGlobalAdmin = "<%= typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin %>" === 'true';

        if(!data || !data.length) {
            // T√≠nh t·ªïng s·ªë c·ªôt ƒë·ªÉ colspan cho ƒë·∫πp (C∆° b·∫£n 6 c·ªôt + 3 c·ªôt ƒëi·ªÅu ki·ªán)
            let totalCols = 6 + (isGlobalAdmin ? 1 : 0) + (isManager ? 1 : 0);
            tbody.innerHTML = `<tr><td colspan="${totalCols}" style="text-align:center; padding:20px; color:#64748b;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.</td></tr>`;
            return;
        }

        let html = '';

        data.forEach((cust, index) => {
            const totalRev = new Intl.NumberFormat('vi-VN').format(cust.Total_Revenue);
            const rowId = `search-detail-${index}`;
            
            // Badge tr·∫°ng th√°i
            let statusBadge = '';
            if (cust.Care_Status === 'done') statusBadge = '<span class="status-tag st-done">ƒê√£ xong</span>';
            else if (cust.Care_Status === 'partial') statusBadge = '<span class="status-tag st-caring">ƒêang care</span>';
            else statusBadge = '<span class="status-tag st-uncared">Ch∆∞a care</span>';

            // D·ªØ li·ªáu cho n√∫t Care (L·∫•y ƒë∆°n m·ªõi nh·∫•t l√†m m·ªëc)
            const latestOrder = (cust.Orders && cust.Orders.length > 0) ? cust.Orders[0] : {};
            const modalData = {
                Order_code: latestOrder.Order_code || '',
                Customer_full_name: cust.Customer_Name
            };

            // --- X·ª¨ L√ù C√ÅC √î (TD) THEO ƒê√öNG TH·ª® T·ª∞ THEAD ---
            
            // 1. M≈©i t√™n
            const tdArrow = `<td><span class="toggle-icon">‚ñ∂</span></td>`;
            
            // 2. Ng√†y
            const tdDate = `<td>${cust.Max_Date ? (cust.Max_Date.value || cust.Max_Date) : '-'}</td>`;
            
            // 3. Branch (N·∫øu l√† Admin)
            const tdBranch = isGlobalAdmin ? `<td><span class="badge badge-subgroup">${cust.Branch_Code || '-'}</span></td>` : '';
            
            // 4. Salesman (N·∫øu l√† Manager)
            const tdSales = isManager ? `<td style="font-size:12px; color:#64748b;">${cust.Sales_Email || 'N/A'}</td>` : '';

            // 5. Kh√°ch h√†ng
            const tdCustomer = `
                <td>
                    <div style="font-weight:700; color:#1e293b; font-size:14px;">${cust.Customer_Name}</div>
                    ${cust.Tax_Code ? `<div style="font-size:11px; color:#64748b;">MST: ${cust.Tax_Code}</div>` : ''}
                </td>`;

            // 6. S·ªë ƒë∆°n
            const tdCount = `<td style="font-weight:600; color:#2563eb; text-align:center;">${cust.Order_Count} ƒë∆°n</td>`;

            // 7. T·ªïng doanh thu
            const tdRevenue = `<td style="font-weight:700; color:#16a34a; text-align:right;">${totalRev} ‚Ç´</td>`;

            // 8. Tr·∫°ng th√°i
            const tdStatus = `<td>${statusBadge}</td>`;

            // 9. Action (Care & Xem)
            const tdAction = `
                <td>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-care" style="background:#2563eb; color:#fff; padding:4px 8px;"
                            onclick='event.stopPropagation(); openModal(${JSON.stringify(modalData)})'>
                            üìû Care
                        </button>
                        <button class="btn-care" style="background:#fff; color:#2563eb; padding:4px 8px;"
                            onclick="event.stopPropagation(); toggleDetail('${rowId}', this.closest('tr'))">
                            üëÅÔ∏è Xem
                        </button>
                    </div>
                </td>`;

            // RENDER D√íNG CHA
            html += `
                <tr class="parent-row" onclick="toggleDetail('${rowId}', this)">
                    ${tdArrow}
                    ${tdDate}
                    ${tdBranch}
                    ${tdSales}
                    ${tdCustomer}
                    ${tdCount}
                    ${tdRevenue}
                    ${tdStatus}
                    ${tdAction}
                </tr>
            `;

            // --- T√çNH TO√ÅN COLSPAN CHO D√íNG CON ---
            // T·ªïng s·ªë c·ªôt = 6 c·ªôt c·ª©ng + s·ªë c·ªôt ƒëi·ªÅu ki·ªán
            let colSpanCount = 6; 
            if (isGlobalAdmin) colSpanCount++;
            if (isManager) colSpanCount++;

            // RENDER D√íNG CON (CHI TI·∫æT ƒê∆†N H√ÄNG)
            html += `<tr id="${rowId}" class="detail-row"><td colspan="${colSpanCount}" style="padding:0; border:none;">`;
            html += `<div class="detail-table-inner">
                        <table style="width:100%;">
                            <thead>
                                <tr>
                                    <th width="100">Ng√†y mua</th>
                                    <th width="150">M√£ ƒë∆°n</th>
                                    <th width="60">CN</th>     
                                    <th width="120">NV B√°n</th>
                                    <th>S·∫£n ph·∫©m chi ti·∫øt</th>
                                    <th width="120">Gi√° tr·ªã</th>
                                    <th width="120">K·∫øt qu·∫£</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            const seenOrders = new Set();
            cust.Orders.forEach(order => {
                if(seenOrders.has(order.Order_code)) return;
                seenOrders.add(order.Order_code);

                const orderRev = new Intl.NumberFormat('vi-VN').format(order.Revenue);
                const orderStatus = order.status === 'ƒê√£ chƒÉm s√≥c' 
                    ? `<span style="color:#16a34a; font-weight:600; font-size:12px;">${order.result}</span>` 
                    : '<span style="color:#94a3b8; font-size:12px;">-</span>';
                
                    const productDisplay = `
    <div style="font-size:13px; line-height:1.6;">
        ${order.Product_Display_Html} 
    </div>
`;

                html += `
                    <tr>
                        <td>${order.Report_date || '-'}</td>
                        <td><span class="badge badge-subgroup">${order.Branch_code || '-'}</span></td>
        
        <td style="font-size:11px; color:#64748b;">
            ${order.Sales_Email ? order.Sales_Email.split('@')[0] : 'N/A'}
        </td>
                        <td style="color:#2563eb; font-weight:600;">${order.Order_code}</td>
                        <td>${productDisplay}</td>
                        <td style="font-weight:700;">${orderRev} ‚Ç´</td>
                        <td>${orderStatus}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div></td></tr>`;
        });

        tbody.innerHTML = html;
    }
    // ==============================================================
    // 2. LOGIC WORKLIST (BLOCK 3)
    // ==============================================================
    let currentPage = 1;


    // --- H√ÄM LOAD D·ªÆ LI·ªÜU DUY NH·∫§T ---
   // --- H√ÄM LOAD D·ªÆ LI·ªÜU (ƒê√£ c·∫≠p nh·∫≠t logic l·ªçc G√°n) ---
    async function loadWorkList(page) {
        if (page < 1) return;
        
        // 1. L·∫•y gi√° tr·ªã c√°c b·ªô l·ªçc
        const sort = document.getElementById('wlSort').value;
        const tax = document.getElementById('wlTax').value;
        const status = document.getElementById('wlStatus').value;
        const month = document.getElementById('wlMonth').value;
        const branchEl = document.getElementById('wlBranch');
        const branch = branchEl ? branchEl.value : '';
        
        // Checkbox: ·∫®n Grab & Xem data ƒë∆∞·ª£c g√°n
        const excludeGrab = document.getElementById('excludeGrab').checked;
        const showAssigned = document.getElementById('checkAssignedOnly') ? document.getElementById('checkAssignedOnly').checked : false;

        // T√¨m ki·∫øm
        const q = document.getElementById('searchInput').value.trim();
        const type = document.getElementById('searchType').value;
        
        // L·ªçc theo nh√¢n vi√™n
        let emp = '';
        if ($('#filterEmail').length > 0) emp = $('#filterEmail').val();

        const container = document.getElementById('workListContainer');
        container.style.opacity = '0.5';

        try {
            // 2. T·∫°o URL v·ªõi tham s·ªë showAssigned
            const url = `/api/cskh/worklist?page=${page}&sort=${sort}&tax=${tax}&status=${status}&month=${month}&branch=${branch}&q=${encodeURIComponent(q)}&type=${type}&emp=${emp}&excludeGrab=${excludeGrab}&showAssigned=${showAssigned}`;
            
            const res = await fetch(url);
            const json = await res.json();

            if (json.ok) {
                if (json.data.length === 0 && page > 1) {
                    alert("ƒê√£ h·∫øt d·ªØ li·ªáu!");
                } else {
                    currentPage = page;
                    document.getElementById('pageIndicator').innerText = `Trang ${currentPage}`;
                    globalWorkListData = json.data;
                    renderGroupedTable(json.data);
                }
            } else {
                container.innerHTML = `<div class="no-data" style="color:red;">${json.error}</div>`;
            }
        } catch (e) {
            console.error(e);
        } finally {
            container.style.opacity = '1';
        }
    }
    // --- [UPDATED] RENDER B·∫¢NG WORKLIST (GOM NH√ìM - CARE ·ªû CHA) ---
    // --- H√ÄM RENDER B·∫¢NG (ƒê√£ th√™m Checkbox cho Manager) ---
    function renderGroupedTable(customers) {
        const container = document.getElementById('workListContainer');
        
        // L·∫•y quy·ªÅn Manager t·ª´ EJS truy·ªÅn xu·ªëng
        const isManager = <%= isManager %>; 

        if (!customers || customers.length === 0) {
            container.innerHTML = '<div class="no-data" style="padding:40px; text-align:center; color:#64748b;">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.</div>';
            return;
        }

        // C·∫•u h√¨nh Header: N·∫øu l√† Manager th√¨ hi·ªán √¥ checkbox ch·ªçn t·∫•t c·∫£
        const checkHeader = isManager 
            ? `<input type="checkbox" class="form-check-input" onclick="toggleAll(this)">`
            : ``;

        let html = `
            <div class="table-scroll-wrapper">
            <table class="info-table" style="border-collapse: separate; border-spacing: 0;">
                <thead>
                    <tr>
                        <th style="width:40px; text-align:center;">${checkHeader}</th>
                        <th style="width:40px"></th> <th>Kh√°ch h√†ng</th>
                        <th>T·ªïng ƒê∆°n</th>
                        <th>T·ªïng Doanh Thu</th>
                        <th>Tr·∫°ng th√°i Care</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
        `;

        customers.forEach((cust, index) => {
            const totalRev = new Intl.NumberFormat('vi-VN').format(cust.Total_Revenue);
            const rowId = `detail-${index}`;
            
            let statusBadge = '';
            if (cust.Care_Status === 'done') statusBadge = '<span class="status-tag st-done">ƒê√£ xong</span>';
            else if (cust.Care_Status === 'partial') statusBadge = '<span class="status-tag st-caring">ƒêang care</span>';
            else statusBadge = '<span class="status-tag st-uncared">Ch∆∞a care</span>';

            // Badge b√°o hi·ªáu kh√°ch ƒë∆∞·ª£c G√°n
            // [UPDATE] Badge n·ªïi b·∫≠t cho QLSR G√°n
const assignedBadge = cust.is_assigned_group 
    ? `<span class="badge" 
             style="background: linear-gradient(135deg, #ef4444, #f97316); 
                    color: white; 
                    font-weight: 700; 
                    font-size: 11px; 
                    margin-left: 8px; 
                    padding: 5px 10px; 
                    border-radius: 12px; 
                    box-shadow: 0 3px 6px rgba(249, 115, 22, 0.3);
                    border: 1px solid rgba(255,255,255,0.4);">
         <i class="bi bi-bell-fill"></i> QLSR G√°n
       </span>` 
    : ``;

            // L·∫•y ƒë∆°n m·ªõi nh·∫•t
            const sortedOrders = (cust.Orders || []).sort((a, b) => new Date(b.Report_date) - new Date(a.Report_date));
            const latestOrder = sortedOrders.length > 0 ? sortedOrders[0] : {};
            
            // L·∫•y m√£ Order Code ƒë·∫°i di·ªán ƒë·ªÉ g√°n
            const repOrderCode = latestOrder.Order_code || '';

            const modalData = {
                Order_code: repOrderCode,
                Customer_full_name: cust.Customer_Name,
            };

            // C·∫•u h√¨nh √¥ Checkbox t·ª´ng d√≤ng
            const checkCell = isManager 
                ? `<input type="checkbox" class="form-check-input bulk-check" value="${repOrderCode}" onchange="updateBulkAction()">`
                : `<span style="color:#cbd5e1">‚Ä¢</span>`;

            // --- RENDER D√íNG CHA ---
            html += `
                <tr class="parent-row" onclick="toggleDetail('${rowId}', this)">
                    <td style="text-align:center;" onclick="event.stopPropagation()">
                        ${checkCell}
                    </td>
                    <td><span class="toggle-icon">‚ñ∂</span></td>
                    <td>
                        <div style="font-weight:700; color:#1e293b; font-size:14px;">
                            ${cust.Customer_Name} ${assignedBadge}
                        </div>
                        ${cust.Tax_Code ? `<div style="font-size:11px; color:#64748b;">MST: ${cust.Tax_Code}</div>` : ''}
                    </td>
                    <td style="font-weight:600; color:#2563eb; cursor:pointer; text-decoration:underline;" 
                        onclick="event.stopPropagation(); showOrderBreakdown(${index})">
                        ${cust.Order_Count} ƒë∆°n
                    </td>
                    <td style="font-weight:700; color:#16a34a;">${totalRev} ‚Ç´</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-care" style="background:#2563eb; color:#fff; padding:4px 8px;"
                                onclick='event.stopPropagation(); openModal(${JSON.stringify(modalData)})'>
                                üìû Care
                            </button>
                            <button class="btn-care" style="background:#fff; color:#2563eb; padding:4px 8px;"
                                onclick="event.stopPropagation(); toggleDetail('${rowId}', this.closest('tr'))">
                                üëÅÔ∏è Xem
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            // --- RENDER D√íNG CON (CHI TI·∫æT) ---
            html += `<tr id="${rowId}" class="detail-row"><td colspan="7" style="padding:0; border:none;">`;
            html += `<div class="detail-table-inner">
                        <table style="width:100%;">
                            <thead>
                                <tr>
                                    <th width="100">Ng√†y mua</th>
                                    <th width="60">CN</th>     
                                    <th width="120">NV B√°n</th>
                                    <th width="150">M√£ ƒë∆°n</th>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th width="100">Gi√° tr·ªã</th>
                                    <th width="100">K·∫øt qu·∫£</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            const seenOrders = new Set();
            cust.Orders.forEach(order => {
                if(seenOrders.has(order.Order_code)) return;
                seenOrders.add(order.Order_code);

                const orderRev = new Intl.NumberFormat('vi-VN').format(order.Revenue);
                const orderStatus = order.status === 'ƒê√£ chƒÉm s√≥c' 
                    ? `<span style="color:#16a34a; font-weight:600; font-size:12px;">${order.result}</span>` 
                    : '<span style="color:#94a3b8; font-size:12px;">-</span>';

                const productDisplay = `<div style="font-size:13px; line-height:1.6;">${order.Product_Display_Html}</div>`;
                
                html += `
                    <tr>
                        <td>${order.Report_date || '-'}</td>
                        <td><span class="badge badge-subgroup">${order.Branch_code || '-'}</span></td>
                        <td style="font-size:11px; color:#64748b;">${order.Sales_Email ? order.Sales_Email.split('@')[0] : 'N/A'}</td>
                        <td style="color:#2563eb; font-weight:600;">${order.Order_code}</td>
                        <td>${productDisplay}</td>
                        <td style="font-weight:700;">${orderRev} ‚Ç´</td>
                        <td>${orderStatus}</td>
                    </tr>`;
            });

            html += `</tbody></table></div></td></tr>`;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
    }

    function toggleDetail(rowId, trElement) {
        const detailRow = document.getElementById(rowId);
        if (detailRow.classList.contains('show')) {
            detailRow.classList.remove('show');
            trElement.classList.remove('expanded');
        } else {
            detailRow.classList.add('show');
            trElement.classList.add('expanded');
        }
    }

    // ==============================================================
    // 3. MODAL & FORM (GI·ªÆ NGUY√äN)
    // ==============================================================
    const modal = document.getElementById('careModal');
    
    async function openModal(row) {
        document.getElementById('careForm').reset();
        document.getElementById('revenueBox').style.display = 'none';
        document.getElementById('m_order_code').value = row.Order_code;
        document.getElementById('m_customer_name').value = row.Customer_full_name;
        document.getElementById('d_order_code').innerText = row.Order_code;
        document.getElementById('d_customer_name').innerText = row.Customer_full_name;

        const historyDiv = document.getElementById('historyContainer');
        historyDiv.innerHTML = '<div style="padding:10px; color:#64748b;">ƒêang t·∫£i l·ªãch s·ª≠...</div>';
        modal.style.display = 'flex';

        try {
            // G·ªçi API l·ªãch s·ª≠ (c√≥ th·ªÉ s·ª≠a API n√†y ƒë·ªÉ l·∫•y history theo KH n·∫øu c·∫ßn, hi·ªán t·∫°i l·∫•y theo OrderCode)
            const res = await fetch(`/api/cskh/history/${row.Order_code}`);
            const json = await res.json();
            if(json.data && json.data.length) {
                if(json.data[0].phone_number) document.getElementById('m_phone').value = json.data[0].phone_number;
                
                historyDiv.innerHTML = json.data.map(log => `
                    <div class="history-item">
                        <div class="history-meta">
                            <strong>${new Date(log.created_at).toLocaleString('vi-VN')}</strong> 
                            b·ªüi ${log.users?.full_name || 'Unknown'}
                        </div>
                        <div><span style="font-weight:700; color:#2563eb;">[${log.care_stage}]</span> ${log.contact_method} ‚ûî <strong>${log.result}</strong></div>
                        <div style="font-style:italic; margin-top:4px;">"${log.sale_note || ''}"</div>
                    </div>
                `).join('');
            } else {
                historyDiv.innerHTML = '<div style="padding:10px; color:#94a3b8; font-style:italic;">Ch∆∞a c√≥ l·ªãch s·ª≠ chƒÉm s√≥c ƒë∆°n n√†y.</div>';
            }
        } catch(e) { historyDiv.innerHTML = 'L·ªói t·∫£i l·ªãch s·ª≠'; }
    }

    function closeModal() { modal.style.display = 'none'; }
    function toggleRevenue() {
        const val = document.getElementById('resultSelect').value;
        document.getElementById('revenueBox').style.display = (val === 'Ch·ªët ƒë∆°n') ? 'block' : 'none';
    }
    function openRankModal() {
        // Ki·ªÉm tra xem modal c√≥ t·ªìn t·∫°i kh√¥ng
        const modal = document.getElementById('rankModal');
        if(modal) {
            modal.style.display = 'flex';
        } else {
            alert("B·∫°n kh√¥ng c√≥ quy·ªÅn xem B·∫£ng x·∫øp h·∫°ng ho·∫∑c ch∆∞a c√≥ d·ªØ li·ªáu.");
        }
    }
    
    // ƒê√≥ng modal khi click ra ngo√†i (th√™m v√†o window.onclick c≈©)
    window.onclick = function(e) {
        if(e.target == document.getElementById('careModal')) closeModal();
        if(e.target == document.getElementById('rankModal')) document.getElementById('rankModal').style.display='none';
    }

    document.getElementById('careForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData.entries());
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.innerText = 'ƒêang l∆∞u...';

        try {
            const res = await fetch('/api/cskh/log', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            });
            const json = await res.json();
            if(json.ok) {
                alert('L∆∞u th√†nh c√¥ng!');
                closeModal();
                loadWorkList(currentPage); 
                if(currentData.length > 0) performSearch(0); 
            } else {
                alert('L·ªói: ' + json.error);
            }
        } catch(err) { alert('L·ªói k·∫øt n·ªëi'); } 
        finally { btn.disabled = false; btn.innerText = 'L∆∞u th√¥ng tin'; }
    });

    // INIT
    $(document).ready(function() {
        if($('#filterEmail').length > 0) {
            $('#filterEmail').select2({ placeholder: "üîç T√¨m nh√¢n vi√™n...", allowClear: true });
        }
        loadWorkList(1);
    });

    window.onclick = function(e) { 
        if(e.target == modal) closeModal(); 
        if(e.target == document.getElementById('rankModal')) document.getElementById('rankModal').style.display='none';
    }

    // --- H√ÄM X·ª¨ L√ù CH·ªåN NHANH TH·ªúI GIAN ---
    function setPeriod(type) {
        const d = new Date();
        
        // Helper: Format YYYY-MM-DD theo gi·ªù ƒë·ªãa ph∆∞∆°ng
        const toLocalISO = (date) => {
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().slice(0, 10);
        }

        let start = new Date();
        let end = new Date(); // H√¥m nay

        if (type === 'today') {
            // Start = End = H√¥m nay
        } else if (type === 'week') {
            // Th·ª© 2 ƒë·∫ßu tu·∫ßn hi·ªán t·∫°i
            const day = d.getDay(); 
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            start.setDate(diff);
        } else if (type === 'month') {
            // Ng√†y 1 ƒë·∫ßu th√°ng
            start.setDate(1);
        }

        // G√°n gi√° tr·ªã v√†o √¥ input
        const startInput = document.querySelector('input[name="start"]');
        const endInput = document.querySelector('input[name="end"]');
        
        if(startInput && endInput) {
            startInput.value = toLocalISO(start);
            endInput.value = toLocalISO(end);
            
            // T·ª± ƒë·ªông Submit form sau khi ch·ªçn xong ng√†y
            document.getElementById('adminFilterForm').submit();
        }
    }

    let currentBreakdownIndex = null; // L∆∞u index kh√°ch h√†ng ƒëang xem

// 1. H√ÄM M·ªû MODAL (C·∫§P 1)
function showOrderBreakdown(index) {
    currentBreakdownIndex = index;
    const cust = globalWorkListData[index];
    if (!cust || !cust.Orders) return;

    // Reset giao di·ªán v·ªÅ c·∫•p 1
    document.getElementById('breakdownNav').style.display = 'none';
    document.getElementById('breakdownCustomerName').innerText = `Kh√°ch h√†ng: ${cust.Customer_Name}`;

    const isGlobalAdmin = "<%= typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin %>" === 'true';

    // N·∫øu l√† Admin -> Hi·ªán danh s√°ch Branch
    if (isGlobalAdmin) {
        renderBreakdownTable(cust.Orders, 'branch');
    } else {
        // N·∫øu l√† Manager -> Hi·ªán danh s√°ch Sales lu√¥n
        renderBreakdownTable(cust.Orders, 'sales');
    }

    document.getElementById('breakdownModal').style.display = 'flex';
}

// 2. H√ÄM XEM CHI TI·∫æT BRANCH (C·∫§P 2 - D√†nh cho Admin)
function showBranchDetail(targetBranch) {
    const cust = globalWorkListData[currentBreakdownIndex];
    
    // L·ªçc ra c√°c ƒë∆°n h√†ng CH·ªà thu·ªôc chi nh√°nh v·ª´a b·∫•m
    const filteredOrders = cust.Orders.filter(o => o.Branch_code === targetBranch);

    // Hi·ªÉn th·ªã n√∫t Back
    document.getElementById('breakdownNav').style.display = 'block';
    
    // Render l·∫°i b·∫£ng theo ti√™u ch√≠ Sales
    renderBreakdownTable(filteredOrders, 'sales', targetBranch);
}

// 3. H√ÄM QUAY L·∫†I C·∫§P 1
function resetToBranchView() {
    // G·ªçi l·∫°i h√†m g·ªëc ƒë·ªÉ render l·∫°i danh s√°ch Branch
    showOrderBreakdown(currentBreakdownIndex);
}

// 4. H√ÄM RENDER CHUNG (CORE LOGIC)
function renderBreakdownTable(ordersList, mode, branchNameLabel = '') {
    const tbody = document.getElementById('breakdownTableBody');
    const titleCol = document.getElementById('breakdownColName');
    
    // Config ti√™u ƒë·ªÅ
    if (mode === 'branch') titleCol.innerText = "Chi Nh√°nh (Click ƒë·ªÉ xem)";
    else titleCol.innerText = branchNameLabel ? `Sales (${branchNameLabel})` : "Nh√¢n vi√™n Kinh doanh";

    // Gom nh√≥m d·ªØ li·ªáu
    const stats = {};
    let totalCount = 0;

    ordersList.forEach(order => {
        let key = 'N/A';
        if (mode === 'branch') {
            key = order.Branch_code || 'Ch∆∞a x√°c ƒë·ªãnh';
        } else {
            // L·∫•y t√™n Sales t·ª´ email (tr∆∞·ªõc @)
            const email = order.Sales_Email || 'N/A';
            key = email.split('@')[0];
        }
        stats[key] = (stats[key] || 0) + 1;
        totalCount++;
    });

    // Sort gi·∫£m d·∫ßn
    const sortedStats = Object.entries(stats)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);

    // Render HTML
    let html = '';
    sortedStats.forEach(item => {
        const percent = ((item.count / totalCount) * 100).toFixed(1);
        const barStyle = `background: linear-gradient(90deg, #dbeafe ${percent}%, transparent ${percent}%);`;
        
        // Logic Clickable: Ch·ªâ click ƒë∆∞·ª£c n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô Branch view
        const isClickable = (mode === 'branch');
        const clickAttr = isClickable ? `onclick="showBranchDetail('${item.name}')"` : '';
        const rowClass = isClickable ? 'clickable-row' : '';
        const nameStyle = isClickable ? 'color:#2563eb; text-decoration:underline;' : 'color:#334155;';

        html += `
            <tr class="${rowClass}" style="${barStyle}" ${clickAttr}>
                <td style="font-weight:600; ${nameStyle}">
                    ${item.name} 
                    ${isClickable ? '<span style="float:right; font-size:10px;">üëâ</span>' : ''}
                </td>
                <td style="text-align:right; font-weight:700; color:#2563eb;">${item.count}</td>
                <td style="text-align:right; color:#64748b; font-size:12px;">${percent}%</td>
            </tr>
        `;
    });

    if (sortedStats.length === 0) {
        html = '<tr><td colspan="3" style="text-align:center; padding:10px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
    }

    tbody.innerHTML = html;

    // 5. Hi·ªÉn th·ªã Modal
    document.getElementById('breakdownModal').style.display = 'flex';
}
// H√†m m·ªü Popup Chi ti·∫øt Matrix
async function openMatrixDetail(userId, resultType, branchName) {
    // 1. Hi·ªÉn th·ªã Modal & Loading
    const modal = document.getElementById('matrixDetailModal');
    const tbody = document.getElementById('matrixDetailBody');
    const title = document.getElementById('matrixDetailTitle');
    
    // L·∫•y th√°ng ƒëang ch·ªçn ·ªü b·ªô l·ªçc (ƒë·ªÉ bi·∫øt xem th√°ng n√†o)
    const currentMonth = document.getElementById('wlMonth').value; 
    // N·∫øu ƒëang ch·ªçn "All" ho·∫∑c filter kh√°c, m·∫∑c ƒë·ªãnh l·∫•y th√°ng hi·ªán t·∫°i cho dashboard n√†y (v√¨ dashboard l√† "Th√°ng n√†y")
    // Tuy nhi√™n dashboard c·ªßa b·∫°n ƒëang c·ªë ƒë·ªãnh l√† "Th√°ng n√†y" (logic server). 
    // T·ªët nh·∫•t l·∫•y gi√° tr·ªã t·ª´ input month, n·∫øu 'all' th√¨ fallback v·ªÅ th√°ng hi·ªán t·∫°i.
    const d = new Date();
    const queryMonth = (currentMonth === 'all') ? d.toISOString().slice(0, 7) : currentMonth;

    title.innerText = `${resultType} - ${branchName} (Th√°ng ${queryMonth})`;
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
    modal.style.display = 'flex';

    try {
        // 2. G·ªçi API
        const res = await fetch(`/api/cskh/matrix-detail?userId=${userId}&resultType=${encodeURIComponent(resultType)}&month=${queryMonth}&branch=${encodeURIComponent(branchName)}`);
        const json = await res.json();

        if (json.ok) {
            if (json.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:red;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt.</td></tr>';
            } else {
                // 3. Render d·ªØ li·ªáu
               const html = json.data.map(item => `
                        <tr>
                            <td style="text-align:center">${item.stt}</td>
                            <td><span class="badge badge-subgroup">${item.branch}</span></td>
                            <td>${item.salesman}</td>
                            
                            <td>
                                <a href="javascript:void(0)" 
                                   onclick="searchOrderFromModal('${item.order_code}')"
                                   style="font-weight:700; color:#2563eb; text-decoration:underline;">
                                   ${item.order_code}
                                </a>
                            </td>

                            <td>
                                <div style="font-weight:600;">${item.customer_name}</div>
                            </td>
                            <td>${item.phone}</td>
                            <td>${item.tax_code}</td>
                            
                            <td style="text-align:right; font-weight:700; color:#16a34a;">
                                ${new Intl.NumberFormat('vi-VN').format(item.revenue)} ‚Ç´
                            </td>

                            <td style="font-size:12px; color:#334155; text-align:left; white-space: normal;">
                                ${item.note || '-'}
                            </td>
                        </tr>
                    `).join('');
                    tbody.innerHTML = html;
                }
        } else {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">L·ªói: ${json.error}</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">L·ªói k·∫øt n·ªëi m√°y ch·ªß.</td></tr>`;
    }
}

// --- H√ÄM T√åM KI·∫æM T·ª™ MODAL (ƒê√É FIX: RESET B·ªò L·ªåC) ---
function searchOrderFromModal(orderCode) {
    // 1. ƒê√≥ng Modal hi·ªán t·∫°i
    const modal = document.getElementById('matrixDetailModal');
    if (modal) modal.style.display = 'none';

    // 2. ƒêi·ªÅn th√¥ng tin v√†o √¥ t√¨m ki·∫øm
    const searchType = document.getElementById('searchType');
    const searchInput = document.getElementById('searchInput');

    if(searchType && searchInput) {
        searchType.value = 'order_code'; // Chuy·ªÉn lo·∫°i t√¨m ki·∫øm th√†nh M√£ ƒë∆°n
        searchInput.value = orderCode;   // ƒêi·ªÅn m√£ ƒë∆°n
        
        // 3. [QUAN TR·ªåNG] Reset t·∫•t c·∫£ b·ªô l·ªçc v·ªÅ "T·∫•t c·∫£"
        // ƒê·ªÉ ƒë·∫£m b·∫£o t√¨m th·∫•y ƒë∆°n h√†ng d√π n√≥ ·ªü th√°ng c≈© hay tr·∫°ng th√°i kh√°c
        
        // Reset Th√°ng -> To√†n th·ªùi gian
        const wlMonth = document.getElementById('wlMonth');
        if (wlMonth) wlMonth.value = 'all';

        // Reset Tr·∫°ng th√°i -> T·∫•t c·∫£
        const wlStatus = document.getElementById('wlStatus');
        if (wlStatus) wlStatus.value = 'all';

        // Reset Lo·∫°i thu·∫ø -> T·∫•t c·∫£
        const wlTax = document.getElementById('wlTax');
        if (wlTax) wlTax.value = 'all';

        // Reset Chi nh√°nh (cho Manager) -> T·∫•t c·∫£
        const wlBranch = document.getElementById('wlBranch');
        if (wlBranch) wlBranch.value = 'all';

        // Reset Nh√¢n vi√™n (n·∫øu c√≥) -> T·∫•t c·∫£
        if (typeof $ !== 'undefined' && $('#filterEmail').length > 0) {
            $('#filterEmail').val(null).trigger('change'); 
        } else {
            const filterEmail = document.getElementById('filterEmail');
            if (filterEmail) filterEmail.value = '';
        }
        
        // 4. G·ªçi h√†m load d·ªØ li·ªáu
        loadWorkList(1);
        
        // 5. Cu·ªôn m√†n h√¨nh xu·ªëng ph·∫ßn danh s√°ch ƒë·ªÉ user th·∫•y ngay
        const targetSection = document.querySelector('.dash-card');
        if (targetSection) {
            targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
}


// ƒê√≥ng modal khi click ngo√†i
window.addEventListener('click', function(e) {
    const m = document.getElementById('matrixDetailModal');
    if (e.target == m) m.style.display = 'none';
});
// ƒê√≥ng modal khi click ra ngo√†i
window.addEventListener('click', function(e) {
    const modal = document.getElementById('breakdownModal');
    if (e.target == modal) {
        modal.style.display = "none";
    }
});


// C·∫≠p nh·∫≠t thanh Action Bar khi tick checkbox
    window.updateBulkAction = function() {
        const checkboxes = document.querySelectorAll('.bulk-check:checked');
        const count = checkboxes.length;
        const countDisplay = document.getElementById('countDisplay');
        const actionBar = document.getElementById('actionBar');

        if (countDisplay) countDisplay.textContent = count;
        
        if (actionBar) {
            if (count > 0) {
                actionBar.classList.add('visible'); 
                actionBar.style.display = 'flex'; // ƒê·∫£m b·∫£o hi·ªán flex
            } else {
                actionBar.classList.remove('visible');
                setTimeout(() => { if(actionBar.classList.contains('visible') === false) actionBar.style.display = 'none'; }, 300);
            }
        }
    };

    // Ch·ªçn t·∫•t c·∫£
    window.toggleAll = function(source) {
        const checkboxes = document.querySelectorAll('.bulk-check');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
        });
        updateBulkAction();
    };

   window.submitAssignment = async function() {
        const targetSelect = document.getElementById('targetEmployeeSelect');
        const targetUserId = targetSelect ? targetSelect.value : null;

        if (!targetUserId) {
            alert('Vui l√≤ng ch·ªçn nh√¢n vi√™n ƒë·ªÉ g√°n.');
            return;
        }

        // L·∫•y danh s√°ch m√£ ƒë∆°n h√†ng ƒë√£ tick
        const checkedBoxes = document.querySelectorAll('.bulk-check:checked');
        const orderCodes = Array.from(checkedBoxes).map(cb => cb.value);

        if (orderCodes.length === 0) return;

        if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën ph√¢n b·ªï ${orderCodes.length} kh√°ch h√†ng n√†y?`)) return;

        // [FIX L·ªñI T·∫†I ƒê√ÇY] Ch·ªçn ƒë√∫ng class .btn-assign
        const btn = document.querySelector('#actionBar .btn-assign');
        let originalText = '';
        
        if (btn) {
            originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ƒêang x·ª≠ l√Ω...';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }

        try {
            const res = await fetch('/api/cskh/assign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_codes: orderCodes,
                    target_user_id: targetUserId
                })
            });
            
            const data = await res.json();
            
            if (data.ok) {
                alert(data.message);
                loadWorkList(currentPage); // T·∫£i l·∫°i trang hi·ªán t·∫°i
                // ·∫®n action bar
                const actionBar = document.getElementById('actionBar');
                if (actionBar) actionBar.style.display = 'none';
                
                // Reset checkbox header
                const headerCheck = document.querySelector('thead input[type="checkbox"]');
                if (headerCheck) headerCheck.checked = false;
            } else {
                alert('L·ªói: ' + data.error);
            }

        } catch (e) {
            alert('L·ªói h·ªá th·ªëng: ' + e.message);
            console.error(e);
        } finally {
            // [FIX] Reset n√∫t b·∫•m d√π th√†nh c√¥ng hay th·∫•t b·∫°i
            if (btn) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }
    };
</script>
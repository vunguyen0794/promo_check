<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Báo giá <%= quoteNumber %></title>
    <style>
        body { font-family: Arial, sans-serif; color: #333; font-size: 10px; line-height: 1.4; }
        .container { width: 95%; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid #999; padding: 5px; text-align: left; vertical-align: top; }
        
        /* MÀU SẮC TỪ FILE EXCEL */
        th {
            background-color: #DDEBF7; /* Xanh nhạt */
            color: #1F4E78; /* Xanh đậm */
            font-weight: bold;
            font-size: 9.5px;
        }
        .quote-title {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #FFFFFF; /* Chữ trắng */
            background-color: #2F75B5; /* Xanh đậm */
            padding: 5px;
            margin: 15px 0 10px 0;
        }
        .total-section .total-row:nth-child(1) span,
        .total-section .total-row:nth-child(2) span {
            font-weight: bold;
        }
        .total-row.grand-total {
            font-weight: bold;
            font-size: 11px;
            background-color: #FFF2CC; /* Vàng nhạt */
        }
        
        .right { text-align: right; }
        .center { text-align: center; }
        .no-border { border: none; }
        .header-table, .info-table, .customer-table { border: none; }
        .header-table td, .info-table td, .customer-table td { border: none; padding: 1px; }
        .company-info { font-size: 11px; font-weight: bold; }
        
        .total-section { float: right; width: 45%; }
        .total-section .total-row { display: flex; justify-content: space-between; padding: 4px 5px; }
        .total-section .total-row.grand-total td { border: 1px solid #999; }
        
        .footer-terms { clear: both; margin-top: 20px; font-size: 9.5px; }
        .footer-terms ol { padding-left: 20px; margin: 5px 0; }
        .footer-contact { margin-top: 15px; font-size: 9.5px; }
        .signature-section { margin-top: 20px; text-align: center; float: right; width: 40%; }
        .signature-section strong { font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        
        <table class="header-table">
            <tr>
                <td style="width: 50%;">
                    <img src="data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMTkuNjMgNDQuNjEiPjxkZWZzPjxzdHlsZT4uY2xzLTF7ZmlsbDojMTQzNWMzO30uY2xzLTJ7ZmlsbDojNWZlN2ZmO308L3N0eWxlPjwvZGVmcz48dGl0bGU+UzJfbG9nb19wdl9ibHVlPC90aXRsZT48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xOTYuMzEsMzMuMXYzLjgzaDguMzR2Mi4zNWMtNC4zMSwwLTguNTIsMC0xMi43MywwLTEuMDksMC0xLjUzLS43NC0xLjUzLTEuNzYsMC0xLjU4LDAtMy4xNywwLTQuNzVzLjcxLTIuMjcsMi4zNS0yLjI1YzQuNC4wNyw4LjgsMCwxMy4yLDBoM1YyNi4zOWMtNi41MywwLTEyLjkxLS4wOS0xOS4yOC4wNWE0LjM2LDQuMzYsMCwwLDAtNCw0LjQzYy0uMSwyLjQ2LS4wOSw0LjkzLDAsNy4zOS4wNiwzLjMzLDEuOSw1LjI1LDUuMjUsNS4zMmwxMiwwaDYuNDhWMzMuMVoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSI5My4yNiAzNC41MiA5OC4xIDM0LjUyIDk4LjEgMjguNDYgMTEwLjk4IDI4LjQ2IDExMC45OCAzNC41NCAxMTUuNjcgMzQuNTQgMTE1LjY3IDE3LjQ2IDExMC44OSAxNy40NiAxMTAuODkgMjMuODggOTggMjMuODggOTggMTcuNDcgOTMuMjYgMTcuNDcgOTMuMjYgMzQuNTIiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0yNDUuNzgsMjYuNDJoLTQuODVsMCwxMi43M2MuMTIsMi42NiwyLjE1LDQuMzUsNSw0LjQyaDEyLjQ4YzIuNjEtLjA3LDQuNzYtMS42OSw0Ljg3LTQsMCwwLC4wNi04Ljc0LjA2LTEzLjE1aC00LjcybDAsMTAuNjVjMCwxLjU2LS42NywyLjI1LTIuMjIsMi4yMy0yLjgyLDAtNS42My0uMDYtOC40NCwwLTEuNjQsMC0yLjMzLS41OS0yLjI5LTIuMjhaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNy4yNiAtOS4wNSkiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0yMTIuNzMsMjYuMzIsMjIzLjM4LDQzLjZoNS4xNmwxMC43LTE3LjIyaC01LjY3UzIyOC4yNywzNS4yOSwyMjYsMzljLS40Ny0uNzMtLjg2LTEuMy0xLjIyLTEuODlsLTYuNDctMTAuNzRzLTMuNzktLjA2LTUuNi0uMDYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI3NC42MiwyNi4zMiwyODUuMjcsNDMuNmg1LjE2bDEwLjY5LTE3LjIyaC01LjY2cy01LjMsOC45MS03LjU1LDEyLjYzYy0uNDgtLjczLS44Ni0xLjMtMS4yMi0xLjg5bC02LjQ3LTEwLjc0cy0zLjc5LS4wNi01LjYtLjA2IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNy4yNiAtOS4wNSkiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xNDcuMSwyNi4zM2E0LjgsNC44LDAsMCwxLDUuMDYsNS4xcS4wNiwzLjQyLDAsNi44NmMwLDMuMTQtMS44MSw1LjE3LTQuOTMsNS4yNi00LjgxLjE0LTkuNjMuMTQtMTQuNDMsMC0zLjE2LS4wOS00LjkxLTIuMDYtNS01LjIyLDAtMi4zNCwwLTQuNjksMC03YTQuNyw0LjcsMCwwLDEsNS01YzIuNDEtLjA3LDExLjkxLS4wNiwxNC4yNiwwbS0xMi41MSw0LjJjLTEuMjMsMC0xLjg4LjUxLTEuODksMS43NSwwLDEuNzYsMCwzLjUyLDAsNS4yOGExLjUzLDEuNTMsMCwwLDAsMS43MiwxLjc0YzMuNjksMCw3LjM4LDAsMTEuMDcsMCwxLjIsMCwxLjg1LS41NiwxLjgyLTEuODMsMC0xLjcsMC0zLjQsMC01LjFhMS41OSwxLjU5LDAsMCwwLTEuODItMS44M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSIxNzIuNzkgMzQuNTQgMTY3LjcgMzQuNTQgMTU1LjI1IDIzLjE2IDE1NS4yNSAzNC41NCAxNTAuNDMgMzQuNTQgMTUwLjQzIDE3LjUgMTU1Ljc3IDE3LjUgMTY3Ljk2IDI4Ljg4IDE2Ny45NiAxNy40NyAxNzIuNzkgMTcuNDcgMTcyLjc5IDM0LjU0Ii8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjMxOS42MyAzNC41NCAzMTQuNTQgMzQuNTQgMzAyLjA5IDIzLjE2IDMwMi4wOSAzNC41NCAyOTcuMjcgMzQuNTQgMjk3LjI3IDE3LjUgMzAyLjYxIDE3LjUgMzE0LjggMjguODggMzE0LjggMTcuNDcgMzE5LjYzIDE3LjQ3IDMxOS42MyAzNC41NCIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTg5LjIyLDI2LjQxYy00LjIyLDAtOS42NSwwLTEzLjg3LDBINzEuMjZWNDMuNkg3NlYzOC4yNmgzLjI4YzMuNCwwLDYuOC4wOCwxMC4yLDAsMy42NC0uMTQsNS42Mi0yLjQxLDUuNTUtNi4wOGE1LjY2LDUuNjYsMCwwLDAtNS44NC01LjczbS0uOTEsNy43Nkg3Ni4xNFYzMC42NUg4OC4zMWExLjc2LDEuNzYsMCwwLDEsMCwzLjUyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNy4yNiAtOS4wNSkiLz48cmVjdCBjbGFzcz0iY2xzLTEiIHg9IjI2MS41NyIgeT0iMjkuODMiIHdpZHRoPSI0Ljc2IiBoZWlnaHQ9IjQuNzYiLz48cGF0aCBjbGFzcz0iY2xzLTIiIGQ9Ik0zNC4xNiwyMS4wOWE4LjUxLDguNTEsMCwxLDAsOC41MS04LjUxLDguNTEsOC41MSwwLDAsMC04LjUxLDguNTEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTEwLjc5LDQ1LjE1YTguNTEsOC41MSwwLDEsMCw4LjUxLTguNTEsOC41MSw4LjUxLDAsMCwwLTguNTEsOC41MSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcuMjYgLTkuMDUpIi8+PHJlY3QgY2xhc3M9ImNscy0yIiB4PSIxMC43OSIgeT0iMTIuNTgiIHdpZHRoPSIxNy4wMiIgaGVpZ2h0PSIxNy4wMiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE2LjUyIDEwLjc3KSByb3RhdGUoLTQ1KSIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgeD0iMjYuOSIgeT0iMjcuNTkiIHdpZHRoPSIxNy4wMiIgaGVpZ2h0PSIxNy4wMiIvPjwvc3ZnPg==" alt="Logo" style="max-height: 60px;">
                    <div class="company-info" style="margin-top: 5px;">
                        <%= branchInfo.name.toUpperCase() %>
                    </div>
                </td>
                <td style="width: 50%; text-align: right; font-size: 9.5px;">
                    <strong>Đ/c:</strong> <%= branchInfo.address %><br>
                    <strong>MST:</strong> <%= branchInfo.mst %><br>
                    <strong>Hotline:</strong> <%= branchInfo.hotline %><br>
                    <strong>Website:</strong> <%= branchInfo.website %>
                </td>
            </tr>
        </table>
        <div class="quote-title">BẢNG BÁO GIÁ</div>
        <table class="info-table">
            <tr>
                <td style="width: 50%;">
                    <table class="customer-table">
                        <tr><td style="font-weight: bold;">Kính gửi</td></tr>
                        <tr><td><strong>Khách hàng/Công ty:</strong> <%= customerName %></td></tr>
                        <tr><td><strong>SĐT:</strong> <%= customerPhone %></td></tr>
                        <% if (customerEmail) { %>
                        <tr><td><strong>Email:</strong> <%= customerEmail %></td></tr>
                        <% } %>
                    </table>
                </td>
                <td style="width: 50%;">
                    <table class="customer-table">
                        <tr><td style="font-weight: bold;">Nhân viên Kinh doanh:</td></tr>
                        <tr><td><strong>Họ tên:</strong> <%= salesName %></td></tr>
                        <tr><td><strong>SĐT/Zalo:</strong> <%= salesContact %></td></tr>
                        <tr><td><strong>Email:</strong> <%= salesEmail %></td></tr>
                    </table>
                </td>
            </tr>
        </table>
        <table>
            <thead>
                <tr>
                    <th class="center">STT</th>
                    <th>Mã SP (SKU)</th>
                    <th>Tên sản phẩm</th>
                    <th class="center">ĐVT</th>
                    <th class="right">SL</th>
                    <th class="right">Đơn giá (chưa VAT)</th>
                    <th class="right">Thành tiền (chưa VAT)</th>
                    <th class="right">Thuế (VAT 8%)</th>
                    <th class="right">Tổng tiền (có VAT)</th>
                </tr>
            </thead>
            <tbody>
                <% 
                  let subTotalNoVat = 0;
                  let totalVat = 0;
                %>
                <% items.forEach((item, index) => { %>
                    <% 
                      // 1. Lấy đơn giá (coi như ĐÃ CÓ VAT)
                      const unitPriceWithVat = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
                      
                      // 2. Tính đơn giá (CHƯA VAT) - (tính ngược)
                      const unitPriceNoVat = Math.round(unitPriceWithVat / 1.08);
                      
                      // 3. Tính Thành tiền (CHƯA VAT)
                      const lineTotalNoVat = unitPriceNoVat * item.quantity;
                      
                      // 4. Tính Thành tiền (CÓ VAT)
                      const lineTotalWithVat = unitPriceWithVat * item.quantity;
                      
                      // 5. Tiền thuế là chênh lệch
                      const lineVat = lineTotalWithVat - lineTotalNoVat;
                      
                      // 6. Cộng dồn
                      subTotalNoVat += lineTotalNoVat;
                      totalVat += lineVat;
                    %>
                    <tr>
                        <td class="center"><%= index + 1 %></td>
                        <td><%= item.sku %></td>
                        <td><%= item.product_name %></td>
                        <td class="center">Cái</td>
                        <td class="right"><%= item.quantity %></td>
                        
                                                <td class="right"><%= formatVND(unitPriceNoVat) %></td>
                        
                                                <td class="right"><%= formatVND(lineTotalNoVat) %></td>
                        
                                               <td class="right"><%= formatVND(lineVat) %></td>
                        
                                               <td class="right"><%= formatVND(lineTotalWithVat) %></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>

        <div class="total-section">
            <div class="total-row">
                <span>Tổng cộng (chưa VAT):</span>
                <span class="right"><%= formatVND(subTotalNoVat) %></span>
            </div>
            <div class="total-row">
                <span>Tổng tiền VAT (8%):</span>
                <span class="right"><%= formatVND(totalVat) %></span>
            </div>
            
            <% let finalTotal = subTotalNoVat + totalVat; %>
            
            <% if (promo) { %>
                <div class="total-row">
                    <span><%= promo.name %></span>
                    <span class="right" style="color: #e53935;">-<%= formatVND(promo.discount_amount) %></span>
                </div>
                <% finalTotal -= promo.discount_amount; %>
            <% } %>

          <div class="total-row grand-total" style="border: 1px solid #999; margin-top: 5px;">
    <span>TỔNG THANH TOÁN:</span>
    <span class="right"><%= formatVND(finalTotal) %></span>
</div>
        </div>

        <div class="footer-terms">
            <strong>Điều kiện giao hàng:</strong> Giao hàng 1 lần tại kho Phong Vũ.<br>
            <strong>Điều kiện thanh toán:</strong> 100% trước khi giao hàng.<br>
            <strong>Điều kiện bảo hành:</strong> Theo tiêu chuẩn của nhà sản xuất.<br>
            <strong>Ghi chú:</strong> Báo giá có hiệu lực trong vòng 03 ngày.<br><br>
            
            <strong>Thông tin chuyển khoản:</strong><br>
            - Ngân hàng: <%= branchInfo.bankName %><br>
            - Số tài khoản: <%= branchInfo.bankAccount %><br>
            - Tên tài khoản: <%= branchInfo.bankHolder %>
        </div>
        
        <div class="signature-section">
            <strong>Đại diện Kinh doanh</strong><br>
            <i>(Ký, ghi rõ họ tên)</i>
            <br><br><br><br>
            <strong><%= salesName %></strong>
        </div>

    </div>
</body>
</html>
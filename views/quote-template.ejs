<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Báo giá <%= quoteNumber %></title>
    <style>
        body { font-family: Arial, sans-serif; color: #333; font-size: 10px; line-height: 1.4; }
        .container { width: 95%; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid #999; padding: 5px; text-align: left; vertical-align: top; }
        th { background-color: #DDEBF7; color: #1F4E78; font-weight: bold; font-size: 9.5px; text-align: center; }
        .quote-title { text-align: center; font-size: 16px; font-weight: bold; color: #FFFFFF; background-color: #2F75B5; padding: 5px; margin: 15px 0 10px 0; }
        .right { text-align: right; } .center { text-align: center; } .no-border { border: none; }
        .header-table, .info-table, .customer-table { border: none; }
        .header-table td, .info-table td, .customer-table td { border: none; padding: 1px; }
        .company-info { font-size: 11px; font-weight: bold; }
        .total-section { float: right; width: 45%; }
        .total-section .total-row { display: flex; justify-content: space-between; padding: 4px 5px; }
        .total-section .total-row.grand-total { font-weight: bold; font-size: 11px; background-color: #FFF2CC; border: 1px solid #999; margin-top: 5px;}
        .footer-terms { clear: both; margin-top: 20px; font-size: 9.5px; }
        .signature-section { margin-top: 20px; text-align: center; float: right; width: 40%; }
    </style>
</head>
<body>
    <div class="container">
        <table class="header-table">
            <tr>
                <td style="width: 50%;">
                    <img src="data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMTkuNjMgNDQuNjEiPjxkZWZzPjxzdHlsZT4uY2xzLTF7ZmlsbDojMTQzNWMzO30uY2xzLTJ7ZmlsbDojNWZlN2ZmO308L3N0eWxlPjwvZGVmcz48dGl0bGU+UzJfbG9nb19wdl9ibHVlPC90aXRsZT48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xOTYuMzEsMzMuMXYzLjgzaDguMzR2Mi4zNWMtNC4zMSwwLTguNTIsMC0xMi43MywwLTEuMDksMC0xLjUzLS43NC0xLjUzLTEuNzYsMC0xLjU4LDAtMy4xNywwLTQuNzVzLjcxLTIuMjcsMi4zNS0yLjI1YzQuNC4wNyw4LjgsMCwxMy4yLDBoM1YyNi4zOWMtNi41MywwLTEyLjkxLS4wOS0xOS4yOC4wNWE0LjM2LDQuMzYsMCwwLDAtNCw0LjQzYy0uMSwyLjQ2LS4wOSw0LjkzLDAsNy4zOS4wNiwzLjMzLDEuOSw1LjI1LDUuMjUsNS4zMmwxMiwwaDYuNDhWMzMuMVoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSI5My4yNiAzNC41MiA5OC4xIDM0LjUyIDk4LjEgMjguNDYgMTEwLjk4IDI4LjQ2IDExMC45OCAzNC41NCAxMTUuNjcgMzQuNTQgMTE1LjY3IDE3LjQ2IDExMC44OSAxNy40NiAxMTAuODkgMjMuODggOTggMjMuODggOTggMTcuNDcgOTMuMjYgMTcuNDcgOTMuMjYgMzQuNTIiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0yNDUuNzgsMjYuNDJoLTQuODVsMCwxMi43M2MuMTIsMi42NiwyLjE1LDQuMzUsNSw0LjQyaDEyLjQ4YzIuNjEtLjA3LDQuNzYtMS42OSw0Ljg3LTQsMCwwLC4wNi04Ljc0LjA2LTEzLjE1aC00LjcybDAsMTAuNjVjMCwxLjU2LS42NywyLjI1LTIuMjIsMi4yMy0yLjgyLDAtNS42My0uMDYtOC40NCwwLTEuNjQsMC0yLjMzLS41OS0yLjI5LTIuMjhaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNy4yNiAtOS4wNSkiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0yMTIuNzMsMjYuMzIsMjIzLjM4LDQzLjZoNS4xNmwxMC43LTE3LjIyaC01LjY3UzIyOC4yNywzNS4yOSwyMjYsMzljLS40Ny0uNzMtLjg2LTEuMy0xLjIyLTEuODlsLTYuNDctMTAuNzRzLTMuNzktLjA2LTUuNi0uMDYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTI3NC42MiwyNi4zMiwyODUuMjcsNDMuNmg1LjE2bDEwLjY5LTE3LjIyaC01LjY2cy01LjMsOC45MS03LjU1LDEyLjYzYy0uNDgtLjczLS44Ni0xLjMtMS4yMi0xLjg5bC02LjQ3LTEwLjc0cy0zLjc5LS4wNi01LjYtLjA2IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNy4yNiAtOS4wNSkiLz48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xNDcuMSwyNi4zM2E0LjgsNC44LDAsMCwxLDUuMDYsNS4xcS4wNiwzLjQyLDAsNi44NmMwLDMuMTQtMS44MSw1LjE3LTQuOTMsNS4yNi00LjgxLjE0LTkuNjMuMTQtMTQuNDMsMC0zLjE2LS4wOS00LjkxLTIuMDYtNS01LjIyLDAtMi4zNCwwLTQuNjksMC03YTQuNyw0LjcsMCwwLDEsNS01YzIuNDEtLjA3LDExLjkxLS4wNiwxNC4yNiwwbS0xMi41MSw0LjJjLTEuMjMsMC0xLjg4LjUxLTEuODksMS44NSwwLDEuNzYsMCwzLjUyLDAsNS4yOGExLjUzLDEuNTMsMCwwLDAsMS43MiwxLjc0YzMuNjksMCw3LjM4LDAsMTEuMDcsMCwxLjIsMCwxLjg1LS41NiwxLjgyLTEuODMsMC0xLjcsMC0zLjQsMC01LjFhMS41OSwxLjU5LDAsMCwwLTEuODItMS44M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMSIgcG9pbnRzPSIxNzIuNzkgMzQuNTQgMTY3LjcgMzQuNTQgMTU1LjI1IDIzLjE2IDE1NS4yNSAzNC41NCAxNTAuNDMgMzQuNTQgMTUwLjQzIDE3LjUgMTU1Ljc3IDE3LjUgMTY3Ljk2IDI4Ljg4IDE2Ny45NiAxNy40NyAxNzIuNzkgMTcuNDcgMTcyLjc5IDM0LjU0Ii8+PHBvbHlnb24gY2xhc3M9ImNscy0xIiBwb2ludHM9IjMxOS42MyAzNC41NCAzMTQuNTQgMzQuNTQgMzAyLjA5IDIzLjE2IDMwMi4wOSAzNC41NCAyOTcuMjcgMzQuNTQgMjk3LjI3IDE3LjUgMzAyLjYxIDE3LjUgMzE0LjggMjguODggMzE0LjggMTcuNDcgMzE5LjYzIDE3LjQ3IDMxOS42MyAzNC41NCIvPjxwYXRoIGNsYXNzPSJjbHMtMSIgZD0iTTg5LjIyLDI2LjQxYy00LjIyLDAtOS42NSwwLTEzLjg3LDBINzEuMjZWNDMuNkg3NlYzOC4yNmgzLjI4YzMuNCwwLDYuOC4wOCwxMC4yLDAsMy42NC0uMTQsNS42Mi0yLjQxLDUuNTUtNi4wOGE1LjY2LDUuNjYsMCwwLDAtNS44NC01LjczbS0uOTEsNy43Nkg3Ni4xNFYzMC42NUg4OC4zMWExLjc2LDEuNzYsMCwwLDEsMCwzLjUyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNy4yNiAtOS4wNSkiLz48cmVjdCBjbGFzcz0iY2xzLTEiIHg9IjI2MS41NyIgeT0iMjkuODMiIHdpZHRoPSI0Ljc2IiBoZWlnaHQ9IjQuNzYiLz48cGF0aCBjbGFzcz0iY2xzLTIiIGQ9Ik0zNC4xNiwyMS4wOWE4LjUxLDguNTEsMCwxLDAsOC41MS04LjUxLDguNTEsOC41MSwwLDAsMC04LjUxLDguNTEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03LjI2IC05LjA1KSIvPjxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTEwLjc5LDQ1LjE1YTguNTEsOC41MSwwLDEsMCw4LjUxLTguNTEsOC41MSw4LjUxLDAsMCwwLTguNTEsOC41MSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcuMjYgLTkuMDUpIi8+PHJlY3QgY2xhc3M9ImNscy0yIiB4PSIxMC43OSIgeT0iMTIuNTgiIHdpZHRoPSIxNy4wMiIgaGVpZ2h0PSIxNy4wMiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE2LjUyIDEwLjc3KSByb3RhdGUoLTQ1KSIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgeD0iMjYuOSIgeT0iMjcuNTkiIHdpZHRoPSIxNy4wMiIgaGVpZ2h0PSIxNy4wMiIvPjwvc3ZnPg==" alt="Logo" style="max-height: 60px;">
                    <div class="company-info" style="margin-top: 5px;"><%= branchInfo.name.toUpperCase() %></div>
                </td>
                <td style="width: 50%; text-align: right; font-size: 9.5px;">
                    <strong>Đ/c:</strong> <%= branchInfo.address %><br>
                    <strong>MST:</strong> <%= branchInfo.mst %><br>
                    <strong>Hotline:</strong> <%= branchInfo.hotline %>
                </td>
            </tr>
        </table>

        <div class="quote-title">BẢNG BÁO GIÁ</div>

        <table class="info-table">
            <tr>
                <td style="width: 50%;">
                    <table class="customer-table">
                        <tr><td style="font-weight: bold;">Kính gửi:</td></tr>
                        <tr><td><strong>Khách hàng:</strong> <%= customerName %></td></tr>
                        <tr><td><strong>SĐT:</strong> <%= customerPhone %></td></tr>
                    </table>
                </td>
                <td style="width: 50%;">
                    <table class="customer-table">
                        <tr><td style="font-weight: bold;">Kinh doanh:</td></tr>
                        <tr><td><strong>Họ tên:</strong> <%= salesName %></td></tr>
                        <tr><td><strong>SĐT/Zalo:</strong> <%= salesContact %></td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <% 
           // 1. Kiểm tra xem có sản phẩm nào được giảm giá không?
           // Nếu tất cả item_discount đều = 0 thì ẩn cột này đi
           const hasAnyDiscount = items.some(i => (i.item_discount || 0) > 0);
        %>
        
        <table>
            <thead>
                <tr>
                    <th class="center" style="width: 30px;">STT</th>
                    <th style="width: 80px;">Mã SP</th>
                    <th>Tên sản phẩm</th>
                    <th class="center" style="width: 40px;">ĐVT</th>
                    <th class="right" style="width: 30px;">SL</th>
                    
                    <% if (templateType === 'b2b') { %>
                        <th class="right">Đơn giá<br><i>(Chưa VAT)</i></th>
                        
                        <% if (hasAnyDiscount) { %>
                            <th class="right">Giảm giá<br><i>(Chi tiết)</i></th>
                        <% } %>
                        
                        <th class="right">Thành tiền<br><i>(Chưa VAT)</i></th>
                        <th class="right">Thuế VAT<br><i>(8%)</i></th>
                        <th class="right">Tổng cộng<br><i>(Gồm VAT)</i></th>
                    <% } else { %>
                        <th class="right">Đơn giá<br><i>(Gồm VAT)</i></th>
                        
                        <% if (hasAnyDiscount) { %>
                            <th class="right">Giảm giá<br><i>(Chi tiết)</i></th>
                        <% } %>
                        
                        <th class="right">Thành tiền<br><i>(Gồm VAT)</i></th>
                    <% } %>
                </tr>
            </thead>
            <tbody>
                <% items.forEach((item, index) => { %>
                    <% 
                      const unitPriceIncVat = item.edited_price !== undefined ? item.edited_price : (item.list_price || 0);
                      const unitDiscountIncVat = item.item_discount || 0; 
                      const lineTotalIncVat = (unitPriceIncVat - unitDiscountIncVat) * item.quantity;

                      // Tính ngược cho B2B
                      const unitPriceExVat = Math.round(unitPriceIncVat / 1.08);
                      const unitDiscountExVat = Math.round(unitDiscountIncVat / 1.08);
                      const lineTotalExVat = (unitPriceExVat - unitDiscountExVat) * item.quantity;
                      const lineVat = lineTotalIncVat - lineTotalExVat;
                    %>
                    <tr>
                        <td class="center"><%= index + 1 %></td>
                        <td><%= item.sku %></td>
                        <td><%= item.product_name %></td>
                        <td class="center">Cái</td>
                        <td class="right"><%= item.quantity %></td>
                        
                        <% if (templateType === 'b2b') { %>
                            <td class="right"><%= formatVND(unitPriceExVat) %></td>
                            
                            <% if (hasAnyDiscount) { %>
                                <td class="right" style="color: #e53935;">
                                    <%= unitDiscountExVat > 0 ? '-' + formatVND(unitDiscountExVat) : '-' %>
                                </td>
                            <% } %>
                            
                            <td class="right"><%= formatVND(lineTotalExVat) %></td>
                            <td class="right"><%= formatVND(lineVat) %></td>
                            <td class="right"><%= formatVND(lineTotalIncVat) %></td>
                        <% } else { %>
                            <td class="right"><%= formatVND(unitPriceIncVat) %></td>
                            
                            <% if (hasAnyDiscount) { %>
                                <td class="right" style="color: #e53935;">
                                    <%= unitDiscountIncVat > 0 ? '-' + formatVND(unitDiscountIncVat) : '-' %>
                                </td>
                            <% } %>
                            
                            <td class="right" style="font-weight: bold;"><%= formatVND(lineTotalIncVat) %></td>
                        <% } %>
                    </tr>
                <% }); %>
            </tbody>
        </table>

        <div class="total-section">
            <% 
               // Tính toán tổng cuối cùng
               const totalExVat = Math.round(finalTotal / 1.08);
               const totalVat = finalTotal - totalExVat;
            %>

            <div class="total-row">
                <span>Cộng tiền hàng (Gồm VAT):</span>
                <span class="right"><%= formatVND(totalItemsPrice) %></span>
            </div>

            <% if (globalDiscountAmt > 0) { %>
            <div class="total-row">
                <span>Giảm giá thêm / Chiết khấu:</span>
                <span class="right" style="color: #e53935;">-<%= formatVND(globalDiscountAmt) %></span>
            </div>
            <% } %>
            
            <% if (appliedPromo) { %>
            <div class="total-row">
                <span><%= appliedPromo.name %>:</span>
                <span class="right" style="color: #e53935;">-<%= formatVND(appliedPromo.discount_amount) %></span>
            </div>
            <% } %>

            <% if (templateType === 'b2b') { %>
                <div class="total-row" style="border-top: 1px dashed #ccc; margin-top: 2px; font-style: italic;">
                    <span>Thành tiền (Trước thuế):</span>
                    <span class="right"><%= formatVND(totalExVat) %></span>
                </div>
                <div class="total-row" style="font-style: italic;">
                    <span>Tiền thuế VAT (8%):</span>
                    <span class="right"><%= formatVND(totalVat) %></span>
                </div>
            <% } %>

            <div class="total-row grand-total">
                <span>TỔNG THANH TOÁN:</span>
                <span class="right"><%= formatVND(finalTotal) %></span>
            </div>
        </div>

        <div class="footer-terms">
            <strong>Điều kiện giao hàng:</strong> Giao hàng 1 lần tại kho Phong Vũ.<br>
            <strong>Điều kiện thanh toán:</strong> 100% trước khi giao hàng.<br>
            <strong>Bảo hành:</strong> Theo tiêu chuẩn NSX.<br>
            <strong>Ghi chú:</strong> Báo giá có hiệu lực <%= validityDays %> ngày.<br><br>
            
            <strong>Thông tin chuyển khoản:</strong><br>
            - Ngân hàng: <%= branchInfo.bankName %><br>
            - Số tài khoản: <%= branchInfo.bankAccount %><br>
            - Tên tài khoản: <%= branchInfo.bankHolder %>
        </div>
        
        <div class="signature-section">
            <strong>Đại diện Kinh doanh</strong><br>
            <i>(Ký, ghi rõ họ tên)</i>
            <br><br><br><br>
            <strong><%= salesName %></strong>
        </div>
    </div>
</body>
</html>
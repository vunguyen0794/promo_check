<%- include('partials/header', {title: 'Qu·∫£n l√Ω CTKM' , currentPage: 'promo-management' , time: time}) %>


<% 
  // --- [FIX] KHAI B√ÅO BI·∫æN listCompat ƒê·ªÇ TR√ÅNH L·ªñI REFERENCE ERROR ---
  var listCompat = [];
  try {
    if (typeof allPromosForCompat !== 'undefined' && Array.isArray(allPromosForCompat)) {
      listCompat = allPromosForCompat;
    }
  } catch (e) { listCompat = []; }
%>
<style>
    /* --- STYLES MODAL T·∫†O M·ªöI (CHU·∫®N H√ìA) --- */
    .modal-xl { max-width: 1100px; width: 95%; margin: 30px auto; }

    /* Form Layout */
    .form-section { 
        background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; 
        margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
    }
    .form-section h3 { 
        margin: 0 0 15px 0; font-size: 15px; font-weight: 700; color: #111827; 
        text-transform: uppercase; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; 
    }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 13px; }
    .form-control, .form-group input, .form-group select, .form-group textarea { 
        width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; 
        font-size: 14px; background-color: #fff; 
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    /* Special Blocks (Gift, Combo...) */
    .special-block { 
        background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; 
        border-radius: 8px; margin-top: 10px; 
    }
    .special-title { 
        font-size: 13px; font-weight: 700; color: #0f172a; margin-bottom: 10px; 
        text-transform: uppercase; border-bottom: 1px dashed #cbd5e1; padding-bottom: 5px; 
    }

    /* Dynamic Rows */
    .sku-link-row { 
        display: flex; gap: 10px; align-items: center; margin-bottom: 8px; width: 100%;
    }
    .combo-row, .gift-option { 
        border: 1px solid #e5e7eb; background: #fff; padding: 10px; 
        border-radius: 6px; margin-bottom: 10px; position: relative; 
    }
    .remove-row-btn { 
        position: absolute; top: 5px; right: 8px; color: #ef4444; 
        cursor: pointer; font-size: 18px; font-weight: bold; 
    }
    .add-btn-dashed { 
        width: 100%; border: 1px dashed #3b82f6; color: #3b82f6; background: #eff6ff; 
        padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; 
        font-weight: 600; font-size: 13px; margin-top: 5px; 
    }

    /* Table Grid cho n·ªôi dung */
    .detail-grid { width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; }
    .detail-grid th { background: #f8fafc; padding: 10px; text-align: left; width: 200px; border-bottom: 1px solid #e5e7eb; font-size: 13px;}
    .detail-grid td { padding: 10px; border-bottom: 1px solid #e5e7eb; background: #fff; }
    .rte-field { min-height: 60px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; max-height: 300px; overflow-y: auto;}

    /* RTE Toolbar */
    .rte-toolbar { display: flex; gap: 5px; margin-bottom: 5px; background: #f9fafb; padding: 5px; border: 1px solid #e5e7eb; border-radius: 4px; }
    .rte-btn { padding: 2px 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-size: 12px; font-weight: bold; }

    /* Filter Bar Styles (Legacy) */
    .search-and-filter { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; position: relative; }
    .search-input { flex: 1; height: 40px; padding: 0 12px; border: 1px solid #e5e7eb; border-radius: 8px; }
    .filter-popover { 
        position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #e5e7eb; 
        padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        display: none; z-index: 50; width: 300px; 
    }
    .filter-popover.show { display: block; }
    .popover-row { margin-bottom: 10px; }
    .info-select { width: 100%; height: 36px; padding: 0 8px; border: 1px solid #e5e7eb; border-radius: 6px; }

    /* Promo List Styles */
    .promo-list { display: grid; gap: 15px; }
    .promo-card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .status-badge.active { background: #dcfce7; color: #166534; }
    .status-badge.expired { background: #fee2e2; color: #991b1b; }

    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
</style>

<div class="promo-management">
    <h1 class="section-title">Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh Khuy·∫øn m√£i</h1>

    <div class="action-buttons">
        <button class="btn btn-primary" onclick="showCreateModal()">+ T·∫°o CTKM m·ªõi</button>
    </div>
  
    <div class="search-and-filter">
        <input id="promoSearch" class="search-input" type="text" placeholder="T√¨m ki·∫øm CTKM..." value="<%= q || '' %>">
        <button type="button" class="btn btn-primary filter-toggle">‚öôÔ∏è</button>

        <form method="get" action="/promo-management" id="filterForm" class="filter-popover">
            <input type="hidden" name="q" id="qHidden" value="<%= q %>">
            <div class="popover-row">
                <label>Nh√≥m</label>
                <select name="group" id="groupSelect" class="info-select">
                    <option value="">-- Nh√≥m --</option>
                    <% (groups || []).forEach(g=> { %>
                        <option value="<%= g %>" <%=selectedGroup===g ? 'selected' : '' %>><%= g %></option>
                    <% }) %>
                </select>
            </div>
            <div class="popover-row">
                <label>Bi·∫øn th·ªÉ</label>
                <select name="subgroup" id="subgroupSelect" class="info-select">
                    <option value="">-- Bi·∫øn th·ªÉ --</option>
                    <% (subgroups || []).forEach(sg=> { %>
                        <option value="<%= sg %>" <%=selectedSubgroup===sg ? 'selected' : '' %>><%= sg %></option>
                    <% }) %>
                </select>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="btn btn-primary">L·ªçc</button>
                <a class="btn btn-secondary" href="/promo-management">X√≥a l·ªçc</a>
            </div>
        </form>
    </div>

    <div class="promo-list">
        <% if (promotions && promotions.length> 0) { %>
            <% promotions.forEach(promo=> { %>
                <div class="promo-card" data-name="<%= promo.name.toLowerCase() %>">
                    <h3 style="margin-top:0"><%= promo.name %></h3>
                    <% if (promo.group_name) { %>
                        <span style="background:#eff6ff; color:#1e40af; padding:2px 6px; border-radius:4px; font-size:12px;">
                            <%= promo.group_name %>
                        </span>
                    <% } %>
                    <p style="font-size:13px; color:#64748b; margin: 5px 0;">
                        üìÖ <%= new Date(promo.start_date).toLocaleDateString('vi-VN') %> - <%= new Date(promo.end_date).toLocaleDateString('vi-VN') %>
                    </p>
                    <p><strong>üéØ Lo·∫°i:</strong> <%= promo.promo_type %></p>
                    
                    <% 
                        const endDate = new Date(promo.end_date);
                        endDate.setHours(23, 59, 59, 999);
                        const isActive = endDate >= new Date();
                    %>
                    <p><span class="status-badge <%= isActive ? 'active' : 'expired' %>"><%= isActive ? 'üü¢ ƒêang ho·∫°t ƒë·ªông' : 'üî¥ ƒê√£ h·∫øt h·∫°n' %></span></p>
                    
                    <div style="margin-top:10px; display:flex; gap:5px;">
                        <a href="/promotion-detail/<%= promo.id %>" class="btn btn-info" style="padding:5px 10px; font-size:13px;">üëÅÔ∏è Xem</a>
                        <% if (user && user.role==='manager' ) { %>
                            <button class="btn btn-warning" onclick="window.location.href='/edit-promotion/<%= promo.id %>'" style="padding:5px 10px; font-size:13px;">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-secondary" onclick="copyPromo(<%= promo.id %>)" style="padding:5px 10px; font-size:13px;">üìë Copy</button>
                            <button class="btn btn-danger" onclick="deletePromo(<%= promo.id %>)" style="padding:5px 10px; font-size:13px;">üóëÔ∏è X√≥a</button>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-data" style="text-align:center; padding:20px; color:#64748b;">üì≠ Ch∆∞a c√≥ CTKM n√†o.</div>
        <% } %>
    </div>
</div>

<div id="createPromoModal" class="modal">
    <div class="modal-content modal-xl">
        <span class="close" onclick="document.getElementById('createPromoModal').style.display='none'">&times;</span>
        
        <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <h2 style="margin:0; color: #1e293b;">‚ú® T·∫°o Ch∆∞∆°ng Tr√¨nh Khuy·∫øn M√£i M·ªõi</h2>
        </div>

        <form action="/create-promotion" method="POST" id="createPromoForm">
            
            <div class="form-section">
                <h3>1. Th√¥ng tin chung & Ph·∫°m vi</h3>
                <div class="form-group">
                    <label>T√™n ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i *</label>
                    <input type="text" name="name" required placeholder="Nh·∫≠p t√™n CTKM...">
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£ ng·∫Øn (Hi·ªÉn th·ªã d∆∞·ªõi t√™n CTKM)</label>
                    <textarea name="description" rows="2" placeholder="VD: √Åp d·ª•ng cho c√°c s·∫£n ph·∫©m Apple..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i CTKM (Quy·∫øt ƒë·ªãnh form nh·∫≠p li·ªáu) *</label>
                        <select name="promo_type" id="promoTypeSelect" required onchange="handlePromoTypeChange()">
                            <option value="Kh√¥ng c√≥ m√£">Kh√¥ng c√≥ m√£</option>
                            <option value="Coupon">Coupon (Nh·∫≠p m√£)</option>
                            <option value="Voucher">Voucher (T·ª± ƒë·ªông)</option>
                            <option value="T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau">T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau</option>
                            <option value="∆Øu ƒë√£i thanh to√°n">∆Øu ƒë√£i thanh to√°n</option>
                            <option value="Tr·∫£ g√≥p">∆Øu ƒë√£i tr·∫£ g√≥p</option>
                            <option value="Gift">Qu√† t·∫∑ng (Gift)</option>
                            <option value="Combo">Combo</option>
                            <option value="Thi ƒëua n·ªôi b·ªô">Thi ƒëua n·ªôi b·ªô</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nh√≥m (Group)</label>
                        <input type="text" name="group_name" list="groupList" placeholder="VD: BACK_TO_SCHOOL">
                        <datalist id="groupList"><% groups.forEach(g => { %> <option value="<%= g %>"> <% }) %></datalist>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" name="start_date" required></div>
<div class="form-group"><label>Ng√†y k·∫øt th√∫c</label><input type="date" name="end_date" required></div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Channel</label>
                        <select name="channel">
                            <option value="All">T·∫•t c·∫£</option>
                            <option value="Online">Online</option>
                            <option value="Offline">Offline</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üè¢ Chi nh√°nh √°p d·ª•ng</label>
                        <select name="apply_branches[]" multiple class="form-control" style="height: 100px;">
                            <option value="HCM.BD">HCM.BD</option>
                            <option value="CP01">CP01 - 264 NTMK</option>
                            <option value="CP02">CP02 - B√¨nh D∆∞∆°ng</option>
                            <option value="CP05">CP05 - Qu·∫≠n 6</option>
                            <option value="CP07">CP07 - Qu·∫≠n 7</option>
                            <option value="CP08">CP08 - G√≤ V·∫•p</option>
                            <option value="CP40">CP40 - T√¢n B√¨nh</option>
                            <option value="CP46">CP46 - Th·ªß ƒê·ª©c 1</option>
                            <option value="CP67">CP67 - Th·ªß ƒê·ª©c 2</option>
                            <option value="CP58">CP58 - CMT8</option>
                            <option value="CP62">CP62 - B√¨nh Th·∫°nh</option>
                            <option value="CP64">CP64 - Qu·∫≠n 12</option>
                            <option value="CP69">CP69 - Dƒ© An</option>
                            </select>
                        <small style="color:#6b7280; font-size:11px;">Gi·ªØ Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu. Kh√¥ng ch·ªçn = To√†n qu·ªëc.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:normal;">
                        <input type="checkbox" name="show_multiple_in_group" style="width:auto;">
                        <span>Lu√¥n hi·ªÉn th·ªã (Kh√¥ng ·∫©n d√π c√≥ CTKM t·ªët h∆°n trong c√πng nh√≥m)</span>
                    </label>
                </div>
            </div>

            <div class="form-section">
                <h3>2. Gi√° tr·ªã & M√£ gi·∫£m gi√°</h3>
                
                <div id="blockBasicValue">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ki·ªÉu gi·∫£m gi√°</label>
                            <select name="discount_value_type" id="discount_value_type" onchange="toggleDiscountInputs()">
                                <option value="">-- Kh√¥ng gi·∫£m ti·ªÅn tr·ª±c ti·∫øp --</option>
                                <option value="amount">Gi·∫£m s·ªë ti·ªÅn c·ªë ƒë·ªãnh (VNƒê)</option>
                                <option value="percent">Gi·∫£m theo ph·∫ßn trƒÉm (%)</option>
                            </select>
                        </div>
                        <div class="form-group" id="amountBox" style="display:none;">
                            <label>S·ªë ti·ªÅn gi·∫£m (VNƒê)</label>
                            <input type="number" name="discount_amount" placeholder="VD: 500000">
                        </div>
                        <div class="form-group" id="percentBox" style="display:none;">
                            <label>% Gi·∫£m</label>
                            <input type="number" name="discount_percent" placeholder="VD: 10">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ƒê∆°n t·ªëi thi·ªÉu (VNƒê)</label>
                            <input type="number" name="min_order_value" value="0">
                        </div>
                        <div class="form-group" id="capBox" style="display:none;">
                            <label>Gi·∫£m t·ªëi ƒëa (VNƒê)</label>
                            <input type="number" name="max_discount_amount" placeholder="T·ªëi ƒëa bao nhi√™u?">
                        </div>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dashed #e5e7eb; padding-top: 10px;">
                        <label style="display:flex; gap:8px; font-weight:600; color:#b45309; cursor:pointer;">
                            <input type="checkbox" name="has_coupon_list" id="hasCouponListCheckbox" onchange="toggleCouponBuilder()" style="width:auto;">
                            <span>S·ª≠ d·ª•ng danh s√°ch Coupon/Voucher (Nhi·ªÅu m√£)</span>
                        </label>
                    </div>
                    
                    <div class="form-group" id="couponCodeInput">
                        <label>M√£ Coupon (M√£ ƒë∆°n)</label>
                        <input type="text" name="coupon_code" placeholder="VD: SUMMER2025">
                    </div>

                    <div id="couponListBuilder" style="display: none; background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <div class="special-title" style="color: #b45309; border-bottom-color: #fcd34d;">üìù Danh s√°ch m√£ gi·∫£m gi√°</div>
                        <div id="couponListContainer"></div>
                        <div class="add-btn-dashed" onclick="addCouponRow()" style="color:#b45309; border-color:#b45309; background:#fff;">+ Th√™m d√≤ng m√£</div>
                    </div>
                </div>

                <div id="blockNextOrder" class="special-block" style="display:none;">
                <div class="special-title">üé´ C·∫•u h√¨nh M√£ t·∫∑ng ƒë∆°n sau</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>M√£ gi·∫£m ƒë∆°n sau (N·∫øu c√≥)</label>
                        <input type="text" name="detail[next_order_code]" class="rte-field-input" placeholder="VD: THANKYOU">
                    </div>
                    <div class="form-group">
                        <label>C√°ch th·ª©c nh·∫≠n m√£</label>
                        <select name="detail[receive_method]" class="rte-field-input">
                            <option value="M√£ c·ªë ƒë·ªãnh">M√£ c·ªë ƒë·ªãnh (Chung)</option>
                            <option value="Qua App Consumer">Qua App Consumer (Voucher kho)</option>
                            <option value="SMS">G·ª≠i qua SMS</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Gi√° tr·ªã gi·∫£m (M√¥ t·∫£)</label>
                    <input type="text" name="detail[next_order_value]" class="rte-field-input" placeholder="VD: Gi·∫£m 100k cho ƒë∆°n t·ª´ 1 tri·ªáu">
                </div>
                
                <div class="form-group" style="margin-top: 10px; border-top: 1px dashed #cbd5e1; padding-top: 10px;">
                    <label>Danh s√°ch SKU √°p d·ª•ng m√£ gi·∫£m n√†y (List SKU):</label>
                    <textarea name="detail[next_order_target_skus]" rows="3" class="rte-field-input" 
                        placeholder="Paste danh s√°ch SKU v√†o ƒë√¢y (c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng)..."></textarea>
                    <small class="hint">V√≠ d·ª•: 2401001, 2401002 (ƒê·ªÉ tr·ªëng n·∫øu √°p d·ª•ng to√†n b·ªô)</small>
                </div>
            </div>

                <div id="blockInstallment" class="special-block" style="display:none;">
                    <div class="special-title">üè¶ C·∫•u h√¨nh Tr·∫£ g√≥p</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lo·∫°i tr·∫£ g√≥p</label>
                            <select name="detail[installment_type]">
                                <option value="">-- Kh√¥ng ch·ªçn --</option>
                                <option value="Th·∫ª t√≠n d·ª•ng">Qua th·∫ª t√≠n d·ª•ng</option>
                                <option value="C√¥ng ty t√†i ch√≠nh">Qua c√¥ng ty t√†i ch√≠nh</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ƒê·ªëi t√°c</label>
                            <select name="detail[installment_partner]">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="ACS">ACS</option>
                                <option value="HD SAISON">HD SAISON</option>
                                <option value="Home Credit">Home Credit</option>
                                <option value="Mcredit">Mcredit</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tr·∫£ tr∆∞·ªõc (%)</label><input type="text" name="detail[installment_prepay]" placeholder="VD: 0%"></div>
                        <div class="form-group"><label>L√£i su·∫•t (%)</label><input type="text" name="detail[installment_interest]" placeholder="VD: 0%"></div>
                    </div>
                    <div class="form-group"><label>Ph√≠ (N·∫øu c√≥)</label><input type="text" name="detail[installment_fee]" placeholder="0ƒë"></div>
                </div>

                <div id="blockGift" class="special-block" style="display:none;">
                    <div class="special-title">üéÅ C·∫•u h√¨nh Qu√† t·∫∑ng (Options)</div>
                    <div id="giftContainer"></div>
                    <div class="add-btn-dashed" onclick="addGiftOption()">+ Th√™m Option qu√† t·∫∑ng</div>
                </div>

                <div id="blockCombo" class="special-block" style="display:none;">
                    <div class="special-title">üß© C·∫•u h√¨nh Combo</div>
                    <div id="comboContainer"></div>
                    <div class="add-btn-dashed" onclick="addComboRow()">+ Th√™m b·ªô Combo</div>
                </div>
            </div>

            <div class="form-section">
                <h3>3. N·ªôi dung & Quy ƒë·ªãnh</h3>
                <div class="rte-toolbar" id="rteToolbar">
                    <button type="button" class="rte-btn" data-cmd="bold"><b>B</b></button>
                    <button type="button" class="rte-btn" data-cmd="italic"><i>I</i></button>
                    <button type="button" class="rte-btn" data-cmd="underline"><u>U</u></button>
                    <input type="color" class="rte-btn" id="rteColor" style="width:30px; padding:0; height:24px;">
                    <button type="button" class="rte-btn" id="rteLink">Link</button>
                </div>
                <table class="detail-grid">
                    <tbody>
                        <% ['N·ªôi dung', 'ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng √°p d·ª•ng', 'ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng lo·∫°i tr·ª´', 'Gi·ªõi h·∫°n l∆∞·ª£t √°p d·ª•ng', 'Y√™u c·∫ßu ƒë·∫∑c bi·ªát', 'Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng coupon', 'Link n·ªôi b·ªô/ b√°o c√°o'].forEach(function(label){ %>
                            <tr>
                                <th><%= label %></th>
                                <td>
                                    <div class="rte-field" contenteditable="true" data-name="detail[<%= label %>]"></div>
                                    <textarea name="detail[<%= label %>]" hidden></textarea>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <div class="form-section">
                <h3>4. Ph·∫°m vi s·∫£n ph·∫©m √°p d·ª•ng</h3>
                <div class="form-group">
                    <label>√Åp d·ª•ng cho:</label>
                    <select name="apply_to_type" id="applyToTypeSelect" onchange="toggleScopeFields()">
                        <option value="all">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                        <option value="sku">Theo danh s√°ch SKU</option>
                        <option value="brand">Theo Brand</option>
                        <option value="category">Theo Category</option>
                        <option value="subcat">Theo Subcat</option>
                        <option value="brand_subcat">Theo Brand + Subcat</option>
                    </select>
                </div>

                <div id="skuField" style="display:none;" class="form-group">
                    <label>Nh·∫≠p SKU (c√°ch nhau d·∫•u ph·∫©y/xu·ªëng d√≤ng)</label>
                    <textarea name="skus" rows="4"></textarea>
                </div>
                <div id="brandField" style="display:none;" class="form-group">
                    <label>Nh·∫≠p Brand</label>
                    <input type="text" name="apply_brands">
                </div>
                <div id="categoryField" style="display:none;" class="form-group">
                    <label>Nh·∫≠p Category</label>
                    <input type="text" name="apply_categories">
                </div>
                <div id="subcatField" style="display:none;" class="form-group">
                    <label>Nh·∫≠p Subcat</label>
                    <input type="text" name="apply_subcats">
                </div>

                <hr style="border:0; border-top:1px dashed #e5e7eb; margin: 15px 0;">
                
                <div class="form-row">
                    <div class="form-group"><label>Lo·∫°i tr·ª´ Brand</label><input type="text" name="exclude_brands"></div>
                    <div class="form-group"><label>Lo·∫°i tr·ª´ Subcat</label><input type="text" name="exclude_subcats"></div>
                </div>
                <div class="form-group"><label>Lo·∫°i tr·ª´ SKU c·ª• th·ªÉ</label><textarea name="excluded_skus" rows="2"></textarea></div>
            </div>

            <div class="form-section">
                <h3>5. Quan h·ªá v·ªõi CTKM kh√°c</h3>
                <% 
                   // Logic group cho quan h·ªá
                   const grouped = {};
                   (listCompat || []).forEach(p => { 
                       const g = p.group_name || 'Kh√°c'; 
                       (grouped[g] = grouped[g] || []).push(p); 
                   });
                   const groupNames = Object.keys(grouped).sort();
                %>
                
                <div class="form-row">
                    <div class="form-group">
                        <label style="color:#059669;">‚úÖ √Åp d·ª•ng c√πng (C·ªông d·ªìn)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="quickSelectAllow" style="flex:1; font-size:12px; height:30px; border:1px solid #ccc; border-radius:4px;">
                                <option value="">-- Ch·ªçn nh√≥m nhanh --</option>
                                <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                            </select>
                            <button type="button" onclick="handleGroupSelection('applyWithSelect', 'quickSelectAllow', true)" class="btn btn-secondary" style="padding:2px 8px; font-size:12px;">Ch·ªçn</button>
                            <button type="button" onclick="handleGroupSelection('applyWithSelect', 'quickSelectAllow', false)" class="btn btn-secondary" style="padding:2px 8px; font-size:12px;">B·ªè</button>
                        </div>

                        <select name="apply_with[]" id="applyWithSelect" multiple class="form-control" style="height:150px;">
                            <% groupNames.forEach(g => { %>
                                <optgroup label="<%= g %>">
                                    <% grouped[g].forEach(function(p){ %>
                                        <option value="<%= p.id %>" data-group="<%= g %>"><%= p.name %></option>
                                    <% }) %>
                                </optgroup>
                            <% }) %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="color:#dc2626;">‚õî Kh√¥ng √°p d·ª•ng c√πng (Lo·∫°i tr·ª´)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="quickSelectExclude" style="flex:1; font-size:12px; height:30px; border:1px solid #ccc; border-radius:4px;">
                                <option value="">-- Ch·ªçn nh√≥m nhanh --</option>
                                <% groupNames.forEach(g => { %><option value="<%= g %>"><%= g %></option><% }) %>
                            </select>
                            <button type="button" onclick="handleGroupSelection('excludeWithSelect', 'quickSelectExclude', true)" class="btn btn-secondary" style="padding:2px 8px; font-size:12px;">Ch·ªçn</button>
                            <button type="button" onclick="handleGroupSelection('excludeWithSelect', 'quickSelectExclude', false)" class="btn btn-secondary" style="padding:2px 8px; font-size:12px;">B·ªè</button>
                        </div>

                        <select name="exclude_with[]" id="excludeWithSelect" multiple class="form-control" style="height:150px;">
                            <% groupNames.forEach(g => { %>
                                <optgroup label="<%= g %>">
                                    <% grouped[g].forEach(function(p){ %>
                                        <option value="<%= p.id %>" data-group="<%= g %>"><%= p.name %></option>
                                    <% }) %>
                                </optgroup>
                            <% }) %>
                        </select>
                    </div>
                </div>
            </div>

            <div style="position: sticky; bottom: 0; background: #fff; padding: 15px; border-top: 1px solid #e5e7eb; text-align: right; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">
                <button type="button" onclick="document.getElementById('createPromoModal').style.display='none'" class="btn-cancel" style="padding: 10px 20px; border: 1px solid #d1d5db; background: #fff; border-radius: 6px; cursor: pointer; margin-right: 10px;">H·ªßy b·ªè</button>
                <button type="submit" style="padding: 10px 25px; background: #1e293b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">L∆∞u CTKM</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- SEARCH & FILTER (LEGACY) ---
    (function () {
        const legacy = document.getElementById('promoSearch');
        const form = document.getElementById('filterForm');
        const qHidden = document.getElementById('qHidden');
        const toggle = document.querySelector('.filter-toggle');
        if (!legacy || !form || !qHidden || !toggle) return;

        let t;
        function debounce(fn, ms) { clearTimeout(t); t = setTimeout(fn, ms); }

        legacy.addEventListener('input', () => {
            qHidden.value = legacy.value;
            const v = (legacy.value || '').trim().toLowerCase();
            document.querySelectorAll('.promo-card').forEach(c => {
                const name = (c.getAttribute('data-name') || '').toLowerCase();
                c.style.display = name.includes(v) ? '' : 'none';
            });
            debounce(() => form.submit(), 350);
        });

        toggle.addEventListener('click', () => {
            form.classList.toggle('show');
        });
        document.addEventListener('click', (e) => {
            if (!form.classList.contains('show')) return;
            if (!e.target.closest('.filter-popover') && !e.target.closest('.filter-toggle')) {
                form.classList.remove('show');
            }
        });
    })();

    // --- MAIN MODAL LOGIC ---
    function showCreateModal() {
    const form = document.getElementById('createPromoForm');
    if (form) {
        form.reset(); // Reset c√°c input c∆° b·∫£n
        
        // Reset c√°c bi·∫øn ƒë·∫øm dynamic
        giftIndex = 0; 
        comboIndex = 0; 
        couponIndex = 0;

        // X√≥a s·∫°ch c√°c container dynamic c≈©
        document.getElementById('giftContainer').innerHTML = '';
        document.getElementById('comboContainer').innerHTML = '';
        document.getElementById('couponListContainer').innerHTML = '';
        
        // X√≥a n·ªôi dung trong c√°c √¥ Rich Text Editor (RTE)
        document.querySelectorAll('.rte-field').forEach(div => div.innerHTML = '');

        // ·∫®n c√°c block ƒë·∫∑c bi·ªát ƒë·ªÉ v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
        handlePromoTypeChange(); 
        toggleDiscountInputs();
        toggleCouponBuilder();
        toggleScopeFields();
    }
    
    document.getElementById('createPromoModal').style.display = 'block';
    document.body.classList.add('modal-open');
}

    function handlePromoTypeChange() {
        const type = document.getElementById('promoTypeSelect').value;
        const blocks = ['blockBasicValue', 'blockNextOrder', 'blockInstallment', 'blockGift', 'blockCombo'];
        
        // 1. ·∫®n t·∫•t c·∫£ v√† RESET gi√° tr·ªã c·ªßa c√°c block b·ªã ·∫©n
        blocks.forEach(id => {
            const block = document.getElementById(id);
            if (!block) return;

            // M·∫∑c ƒë·ªãnh ·∫©n
            block.style.display = 'none';

            // Logic reset: T√¨m t·∫•t c·∫£ input/select trong block n√†y v√† x√≥a gi√° tr·ªã
            // ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o khi block ·∫©n ƒëi, n√≥ kh√¥ng g·ª≠i data r√°c l√™n server
            const inputs = block.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0; // V·ªÅ option ƒë·∫ßu ti√™n (th∆∞·ªùng l√† --Ch·ªçn--)
                } else {
                    input.value = '';
                }
            });
            
            // X√≥a n·ªôi dung dynamic (Gift/Combo list) n·∫øu c·∫ßn thi·∫øt
            if (id === 'blockGift') document.getElementById('giftContainer').innerHTML = '';
            if (id === 'blockCombo') document.getElementById('comboContainer').innerHTML = '';
        });

        // 2. Hi·ªán block t∆∞∆°ng ·ª©ng theo lo·∫°i CTKM
        if (type === 'T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau') {
            document.getElementById('blockNextOrder').style.display = 'block';
        }
        else if (type.includes('Tr·∫£ g√≥p')) {
            document.getElementById('blockInstallment').style.display = 'block';
        }
        else if (type === 'Gift') {
            document.getElementById('blockGift').style.display = 'block';
            if(document.getElementById('giftContainer').children.length === 0) addGiftOption();
        }
        else if (type === 'Combo') {
            document.getElementById('blockCombo').style.display = 'block';
            if(document.getElementById('comboContainer').children.length === 0) addComboRow();
        }
        else {
            // M·∫∑c ƒë·ªãnh hi·ªán Basic Value cho c√°c lo·∫°i c√≤n l·∫°i (Coupon, Voucher, v.v.)
            document.getElementById('blockBasicValue').style.display = 'block';
        }
    }



    function toggleDiscountInputs() {
        const t = document.getElementById('discount_value_type').value;
        document.getElementById('amountBox').style.display = (t === 'amount') ? 'block' : 'none';
        document.getElementById('percentBox').style.display = (t === 'percent') ? 'block' : 'none';
        document.getElementById('capBox').style.display = (t === 'percent') ? 'block' : 'none';
    }

    function toggleScopeFields() {
        const type = document.getElementById('applyToTypeSelect').value;
        const fields = { sku: 'skuField', brand: 'brandField', category: 'categoryField', subcat: 'subcatField' };
        for (let k in fields) document.getElementById(fields[k]).style.display = 'none';
        
        if (type === 'brand_subcat') {
            document.getElementById('brandField').style.display = 'block';
            document.getElementById('subcatField').style.display = 'block';
        } else if (fields[type]) {
            document.getElementById(fields[type]).style.display = 'block';
        }
    }

    // --- Y√äU C·∫¶U 2: GROUP SELECTION ---
    window.handleGroupSelection = function(selectId, pickerId, isSelect) {
        const groupName = document.getElementById(pickerId).value;
        if(!groupName) return;
        const select = document.getElementById(selectId);
        Array.from(select.options).forEach(opt => {
            if(opt.getAttribute('data-group') === groupName) {
                opt.selected = isSelect;
            }
        });
    }

    // --- DYNAMIC BUILDERS ---
    let giftIndex = 0;
    let comboIndex = 0;
    let couponIndex = 0;

    function addSkuInputToGroup(containerId, fieldNameBase) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'sku-link-row';
        div.innerHTML = `
            <input type="text" name="${fieldNameBase}[]" class="form-control" style="width:130px;" placeholder="Nh·∫≠p SKU" onblur="checkSkuInfo(this, this.nextElementSibling)">
            <div class="sku-info-display" style="font-size:12px; color:#64748b; flex:1;"></div>
            <button type="button" onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;">√ó</button>
        `;
        container.appendChild(div);
    }

    function addGiftOption() {
        const idx = giftIndex++;
        const container = document.getElementById('giftContainer');
        const skuContainerId = `gift-skus-${idx}`;
        
        const div = document.createElement('div');
        div.className = 'gift-option';
        div.innerHTML = `
            <div class="remove-row-btn" onclick="this.parentElement.remove()">√ó</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#b45309">Option (ID: ${idx})</div>
            <div class="form-group">
                <input type="text" name="detail[gift_options][${idx}][code]" class="form-control" placeholder="M√£ Coupon/Voucher (n·∫øu c√≥)">
            </div>
            <label style="font-size:12px; font-weight:600;">Danh s√°ch s·∫£n ph·∫©m qu√† t·∫∑ng:</label>
            <div id="${skuContainerId}" style="margin-bottom:5px;"></div>
            <button type="button" onclick="addSkuInputToGroup('${skuContainerId}', 'detail[gift_options][${idx}][skus]')" style="font-size:12px; color:#2563eb; background:none; border:none; cursor:pointer;">+ Th√™m SKU qu√†</button>
        `;
        container.appendChild(div);
        addSkuInputToGroup(skuContainerId, `detail[gift_options][${idx}][skus]`);
    }

    function addComboRow() {
        const idx = comboIndex++;
        const container = document.getElementById('comboContainer');
        const skuContainerId = `combo-skus-${idx}`;
        
        const div = document.createElement('div');
        div.className = 'combo-row';
        div.innerHTML = `
            <div class="remove-row-btn" onclick="this.parentElement.remove()">√ó</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#4338ca">B·ªô Combo (ID: ${idx})</div>
            <label style="font-size:12px; font-weight:600;">C√°c s·∫£n ph·∫©m trong Combo:</label>
            <div id="${skuContainerId}" style="margin-bottom:8px;"></div>
            <button type="button" onclick="addSkuInputToGroup('${skuContainerId}', 'detail[combos][${idx}][skus]')" style="font-size:12px; color:#2563eb; background:none; border:none; cursor:pointer;">+ Th√™m SKU v√†o combo</button>
            <div class="form-row" style="margin-top:10px; border-top:1px dashed #e5e7eb; padding-top:8px;">
                <input type="number" name="detail[combos][${idx}][discount_val]" class="form-control" placeholder="Gi√° tr·ªã gi·∫£m">
                <select name="detail[combos][${idx}][discount_type]" class="form-control">
                    <option value="amount">Gi·∫£m ti·ªÅn</option>
                    <option value="percent">Gi·∫£m %</option>
                </select>
            </div>
        `;
        container.appendChild(div);
        addSkuInputToGroup(skuContainerId, `detail[combos][${idx}][skus]`);
        addSkuInputToGroup(skuContainerId, `detail[combos][${idx}][skus]`);
    }

    function toggleCouponBuilder() {
        const checked = document.getElementById('hasCouponListCheckbox').checked;
        document.getElementById('couponListBuilder').style.display = checked ? 'block' : 'none';
        document.getElementById('couponCodeInput').style.display = checked ? 'none' : 'block';
        if (checked && document.getElementById('couponListContainer').children.length === 0) addCouponRow();
    }

    function addCouponRow() {
        const idx = couponIndex++;
        const div = document.createElement('div');
        div.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 30px; gap:8px; margin-bottom:5px;';
        div.innerHTML = `
            <input type="text" name="coupons[${idx}][name]" class="form-control" placeholder="T√™n/Nh√≥m">
            <input type="text" name="coupons[${idx}][code]" class="form-control" placeholder="M√£ Code" required style="font-weight:bold; color:#b45309;">
            <input type="text" name="coupons[${idx}][discount]" class="form-control" placeholder="M·ª©c gi·∫£m">
            <input type="text" name="coupons[${idx}][note]" class="form-control" placeholder="Ghi ch√∫">
            <button type="button" onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">√ó</button>
        `;
        document.getElementById('couponListContainer').appendChild(div);
    }

    // --- Y√äU C·∫¶U 4: SKU INFO CHECKER (Name + Stock) ---
    async function checkSkuInfo(inputEl, displayEl) {
        const sku = inputEl.value.trim();
        if(!sku) { displayEl.innerHTML = ''; return; }
        
        displayEl.innerHTML = '<span style="color:#94a3b8; font-size:11px;">üîÑ ƒêang t·∫£i...</span>';
        
        try {
            // [C·∫¨P NH·∫¨T] G·ªçi API m·ªõi chuy√™n d·ª•ng cho Admin
            const res = await fetch(`/api/admin/search-sku-stock?q=${encodeURIComponent(sku)}`);
            const json = await res.json();
            
            if(json.ok && json.results && json.results.length > 0) {
                // L·∫•y k·∫øt qu·∫£ ch√≠nh x√°c nh·∫•t (SKU kh·ªõp ho√†n to√†n) ho·∫∑c k·∫øt qu·∫£ ƒë·∫ßu ti√™n
                const found = json.results.find(i => i.sku == sku) || json.results[0];
                
                // Hi·ªÉn th·ªã T√™n & T·ªìn kho
                const stockColor = found.stock > 0 ? '#16a34a' : '#dc2626'; // Xanh n·∫øu c√≤n, ƒê·ªè n·∫øu h·∫øt
                const priceStr = new Intl.NumberFormat('vi-VN').format(found.list_price || 0);

                displayEl.innerHTML = `
                    <div style="line-height:1.3;">
                        <div style="color:#0f172a; font-weight:600; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:250px;" title="${found.product_name}">
                            ${found.product_name}
                        </div>
                        <div style="font-size:11px;">
                            <span style="color:#64748b;">${priceStr}ƒë</span> 
                            <span style="margin:0 4px; color:#cbd5e1;">|</span> 
                            <span style="color:${stockColor}; font-weight:700;">T·ªìn: ${found.stock}</span>
                        </div>
                    </div>
                `;
            } else {
                displayEl.innerHTML = `<span style="color:#dc2626; font-size:12px;">‚ùå Kh√¥ng t√¨m th·∫•y SP</span>`;
            }
        } catch(e) {
            console.error(e);
            displayEl.innerHTML = `<span style="color:#dc2626; font-size:12px;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi</span>`;
        }
    }

    
  
    let savedRange = null;

    // 1. X·ª≠ l√Ω l∆∞u v·ªã tr√≠ con tr·ªè khi r·ªùi kh·ªèi √¥ nh·∫≠p li·ªáu
    document.querySelectorAll('.rte-field').forEach(div => {
        div.addEventListener('blur', () => {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0);
            }
        });
        // Khi focus l·∫°i, reset savedRange ƒë·ªÉ tr√°nh xung ƒë·ªôt
        div.addEventListener('focus', () => {
            savedRange = null;
        });
    });

    // 2. X·ª≠ l√Ω c√°c n√∫t B, I, U, Link
    document.querySelectorAll('.rte-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            // [QUAN TR·ªåNG] N·∫øu l√† n√∫t ch·ªçn m√†u (input type color), KH√îNG ƒë∆∞·ª£c preventDefault
            // N·∫øu ch·∫∑n, b·∫£ng m√†u s·∫Ω kh√¥ng hi·ªán ra.
            if (btn.id === 'rteColor') return; 

            e.preventDefault(); // Ch·∫∑n h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh cho c√°c n√∫t button th∆∞·ªùng
            
            const cmd = btn.dataset.cmd;
            if(cmd) document.execCommand(cmd, false, null);
            
            if(btn.id === 'rteLink') {
                const url = prompt('URL:', 'https://');
                if(url) document.execCommand('createLink', false, url);
            }
        });
    });

    // 3. X·ª≠ l√Ω khi ch·ªçn m√†u xong (s·ª± ki·ªán input)
    document.getElementById('rteColor').addEventListener('input', (e) => {
        // Kh√¥i ph·ª•c v√πng ch·ªçn c≈© (n·∫øu c√≥) tr∆∞·ªõc khi t√¥ m√†u
        if (savedRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(savedRange);
        } else {
            // N·∫øu kh√¥ng c√≥ v√πng ch·ªçn, focus l·∫°i v√†o √¥ editor ƒë·∫ßu ti√™n (fallback)
            const firstEditor = document.querySelector('.rte-field');
            if (firstEditor) firstEditor.focus();
        }

        // L·ªánh t√¥ m√†u: styleWithCSS ƒë·ªÉ d√πng span style="color:..." thay v√¨ th·∫ª font c≈©
        document.execCommand('styleWithCSS', false, true);
        document.execCommand('foreColor', false, e.target.value);
    });

    // Handle Submit (Code m·ªõi ƒë√£ fix l·ªói ƒë∆° n√∫t)
    document.getElementById('createPromoForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Ch·∫∑n reload trang ngay l·∫≠p t·ª©c
        console.log("ƒêang x·ª≠ l√Ω t·∫°o CTKM..."); // Ki·ªÉm tra xem code c√≥ ch·∫°y kh√¥ng

        const btn = this.querySelector('button[type="submit"]');
        const oldText = btn.innerText;

        // 1. Kh√≥a n√∫t ƒë·ªÉ tr√°nh b·∫•m nhi·ªÅu l·∫ßn
        btn.disabled = true;
        btn.innerText = "ƒêang l∆∞u...";

        try {
            // 2. ƒê·ªìng b·ªô d·ªØ li·ªáu t·ª´ khung so·∫°n th·∫£o (RTE) v√†o th·∫ª textarea ·∫©n
            document.querySelectorAll('.rte-field').forEach((div) => {
                const name = div.getAttribute('data-name');
                const ta = div.parentElement.querySelector('textarea[name="' + name + '"]');
                if (ta) ta.value = div.innerHTML;
            });

            // 3. Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi
            // S·ª≠ d·ª•ng URLSearchParams ƒë·ªÉ server nodejs (body-parser) t·ª± ƒë·ªông hi·ªÉu c√°c field detail[...]
            const formData = new FormData(this);
            const urlEncodedData = new URLSearchParams(formData);

            // 4. G·ª≠i Request l√™n Server
            const res = await fetch('/create-promotion', {
                method: 'POST',
                body: urlEncodedData,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                }
            });

            const result = await res.json();

            if (result.success) {
                alert('‚úÖ T·∫°o th√†nh c√¥ng!');
                window.location.reload();
            } else {
                throw new Error(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server');
            }

        } catch (err) {
            console.error("L·ªói submit:", err);
            alert('‚ùå L·ªói: ' + err.message);
        } finally {
            // 5. M·ªü l·∫°i n√∫t d√π th√†nh c√¥ng hay th·∫•t b·∫°i ƒë·ªÉ kh√¥ng b·ªã c·ª©ng ƒë∆°
            btn.disabled = false;
            btn.innerText = oldText;
        }
    });
    // Copy/Delete functions (Legacy)
    async function copyPromo(id) {
        if (!confirm("Sao ch√©p CTKM #" + id + "?")) return;
        try {
            const res = await fetch(`/api/promotions/${id}/clone`, { method: 'POST' });
            const js = await res.json();
            if (js.ok) window.location.href = `/edit-promotion/${js.new_id}`;
            else alert(js.error);
        } catch (e) { alert(e.message); }
    }
    
    function deletePromo(id) {
        if(confirm("X√≥a CTKM n√†y?")) {
            fetch(`/api/promotions/${id}`, { method: 'DELETE' })
            .then(r=>r.json()).then(d=>{ if(d.success) location.reload(); else alert(d.error); });
        }
    }
</script>

<%- include('partials/footer') %>
<%- include('partials/header', {title: title, currentPage: currentPage, time: time}) %>
<%
  // H√†m lo·∫°i b·ªè th·∫ª HTML ƒë·ªÉ l·∫•y vƒÉn b·∫£n thu·∫ßn
  function stripTags(input) {
    if (!input) return '';
    return input.replace(/<[^>]*>?/gm, ''); // Regex x√≥a h·∫øt th·∫ª <...>
  }
%>
<style>
/* Container cho n·ªôi dung xem tr∆∞·ªõc */
.news-description-html {
    color: #4b5563;
    font-size: 14px;
    line-height: 1.5em; /* Chi·ªÅu cao m·ªói d√≤ng */
    margin-top: 8px;
    
    /* 1. Logic c·∫Øt d√≤ng hi·ªán ƒë·∫°i (WebKit) */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* S·ªë d√≤ng mu·ªën hi·ªán */
    -webkit-box-orient: vertical;
    text-overflow: ellipsis;
    
    /* 2. Logic c·∫Øt d√≤ng d·ª± ph√≤ng (An to√†n tuy·ªát ƒë·ªëi) */
    /* N·∫øu tr√¨nh duy·ªát kh√¥ng hi·ªÉu line-clamp th√¨ n√≥ s·∫Ω c·∫Øt b·∫±ng max-height */
    max-height: 4.5em; /* 1.5em * 3 d√≤ng = 4.5em */
    overflow: hidden; 
    
    /* Trang tr√≠ th√™m */
    word-break: break-word; /* Ng·∫Øt t·ª´ d√†i ƒë·ªÉ kh√¥ng tr√†n ngang */
}

/* ·∫®n tuy·ªát ƒë·ªëi t·∫•t c·∫£ ·∫£nh/video/iframe trong ph·∫ßn xem tr∆∞·ªõc */
.news-description-html img, 
.news-description-html video, 
.news-description-html iframe,
.news-description-html figure {
    display: none !important; 
}

/* √âp th·∫ª p hi·ªÉn th·ªã nh∆∞ vƒÉn b·∫£n th∆∞·ªùng ƒë·ªÉ n·ªëi d√≤ng li·ªÅn m·∫°ch */
.news-description-html p,
.news-description-html div,
.news-description-html h1, .news-description-html h2, .news-description-html h3 {
    margin: 0 !important; 
    padding: 0 !important;
    display: inline; /* Bi·∫øn th√†nh inline ƒë·ªÉ n·ªëi ch·ªØ l·∫°i v·ªõi nhau */
}
.news-description-html br {
    display: none; /* ·∫®n xu·ªëng d√≤ng th·ª´a */
}
</style>

<div class="newsfeed-container">

  <div class="dash-card">
    <form class="news-filters" action="/newsfeed" method="GET">

      <select name="period" id="filter-period">
        <option value="">Ch·ªçn Chu k·ª≥ BXH</option>
        <% allPeriods.forEach(function(period) { %>
          <option value="<%= period %>" <%= selectedPeriod === period ? 'selected' : '' %>>
            <%= period %>
          </option>
        <% }) %>
      </select>

      <select name="category" id="filter-category">
        <option value="">T·∫•t c·∫£ Ch·ªß ƒë·ªÅ</option>
        <% allCategories.forEach(function(cat) { %>
          <option value="<%= cat %>" <%= selectedCategory === cat ? 'selected' : '' %>>
            <%= cat %>
          </option>
        <% }) %>
      </select>

      <input type="search" name="q" id="filter-search" placeholder="T√¨m theo ti√™u ƒë·ªÅ..." value="<%= searchQuery %>">

      <button type="submit">L·ªçc / T√¨m ki·∫øm</button>

      <% if (user && (user.role === 'admin' || user.role === 'manager')) { %>
        <a href="/admin/create-post" class="news-filters button admin-btn">+ So·∫°n b√†i m·ªõi</a>
      <% } %>

      <% if (user && (user.role === 'admin' || (user.role === 'manager' && user.branch_code === 'HCM.BD'))) { %>
        <a href="/admin/ranking" class="news-filters button">üèÜ Qu·∫£n l√Ω BXH</a>
      <% } %>

    </form>
  </div>
  
  <% if (error) { %>
    <div class="dash-card" style="background-color: #ffebee; color: #c62828; padding: 16px;">
      <strong>L·ªói:</strong> <%= error %>
    </div>
  <% } %>

  <% if (featuredPost) { %>
    <a href="/newsfeed/post/<%= featuredPost.id %>" class="featured-block">
      <div class="featured-img">
        <img src="<%= featuredPost.cover_image_url || 'https://picsum.photos/800/400' %>" alt="·∫¢nh n·ªïi b·∫≠t">
      </div>
      <div class="featured-content">
        <% if (featuredPost.category) { %>
          <span class="category-tag"><%= featuredPost.category %></span>
        <% } %>
        
        <h2><%= featuredPost.title %></h2>
        
        <% if (featuredPost.subtitle) { %>
          <p class="subtitle"><%= featuredPost.subtitle %></p>
        <% } %>

        <p class="dash-muted" style="font-size: 14px; margin-bottom: 12px;">
          ƒêƒÉng ng√†y: <%= new Date(featuredPost.published_at).toLocaleDateString('vi-VN') %>
        </p>
        
        <% if (featuredPost.content) { %>
  <p class="news-description" style="color: #4b5563; font-size: 14px; margin-top: 8px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
    <%= stripTags(featuredPost.content).substring(0, 300) %>...
  </p>
<% } %>
      </div>
    </a>
  <% } else if (!error) { %>
    <div class="dash-card"><p class="dash-muted">Kh√¥ng c√≥ tin n·ªïi b·∫≠t n√†o.</p></div>
  <% } %>


  <% if (newsPosts && newsPosts.length > 0) { %>
    <div class="news-grid">
      
      <% newsPosts.forEach(function(post) { %>
        <a href="/newsfeed/post/<%= post.id %>" class="news-card">
          <div class="news-card-img">
            <img src="<%= post.cover_image_url || 'https://picsum.photos/300/300' %>" alt="·∫¢nh tin t·ª©c">
          </div>
          <div class="news-card-content">
            <h3><%= post.title %></h3>
            <% if (post.subtitle) { %>
              <p class="subtitle"><%= post.subtitle %></p>
            <% } %>

            <p class="dash-muted" style="font-size: 13px; margin-top: 8px;">
              <%= new Date(post.published_at).toLocaleDateString('vi-VN') %>
            </p>

            <% if (post.content) { %>
  <p class="news-description" style="color: #64748b; font-size: 13px; margin-top: 6px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
    <%= stripTags(post.content).substring(0, 150) %>...
  </p>
<% } %>

          </div>
        </a>
      <% }) %>

    </div>
  <% } else if (!error) { %>
    <div class="dash-card"><p class="dash-muted">Kh√¥ng c√≥ tin t·ª©c n√†o.</p></div>
  <% } %>


  <% if (rankingTop1 || (rankingOthers && rankingOthers.length > 0)) { %>
    <div class="ranking-block">
      <div class="dash-title" style="font-size: 24px; font-weight: 700;">B·∫£ng X·∫øp H·∫°ng (<%= selectedPeriod %>)</div>

      <% if (rankingTop1) { %>
        <div class="rank-top1-card rank-order-<%= rankingTop1.rank_order %>">
          <img src="<%= rankingTop1.avatar_image_url || 'https://picsum.photos/400/400' %>" alt="Avatar Top 1" class="rank-top1-img">
          <div class="rank-top1-content">
            <div class="rank-label">üèÜ TOP 1</div>
            <div class="rank-name"><%= rankingTop1.full_name %></div>
            <div class="rank-info">
              <% if (rankingTop1.sales_percentage) { %>
                <span style="color: #c62828; font-weight: 700;">ƒê·∫°t: <strong><%= rankingTop1.sales_percentage %>%</strong></span>
              <% } %>

              <% if (rankingTop1.store) { %>
                <span>C·ª≠a h√†ng: <strong><%= rankingTop1.store %></strong></span>
              <% } %>
              <% if (rankingTop1.department) { %>
                <span>B·ªô ph·∫≠n: <strong><%= rankingTop1.department %></strong></span>
              <% } %>
            </div>
          </div>
        </div>
      <% } %>

      <% if (rankingOthers && rankingOthers.length > 0) { %>
        <div class="rank-others-grid">
          
          <% rankingOthers.forEach(function(person) { %>
            <div class="rank-person-card rank-order-<%= person.rank_order %>">
              <img src="<%= person.avatar_image_url || 'https://picsum.photos/400/400' %>" alt="Avatar <%= person.full_name %>" class="rank-person-img">
              <div class="rank-person-text-content"></div>
              <div class="rank-label">TOP <%= person.rank_order %></div>
              <div class="rank-name"><%= person.full_name %></div>
              <% if (person.sales_percentage) { %>
                <div class="rank-info" style="color: #c62828; font-weight: 700; margin-bottom: 4px;">
                  ƒê·∫°t: <%= person.sales_percentage %>%
                </div>
              <% } %>
              <div class="rank-info">
                <%= person.store || '' %><br>
                <%= person.department || '' %>
              </div>
            </div>
          <% }) %>

        </div>
      <% } %>

    </div>
  <% } else if (!error) { %>
    <div class="dash-card"><p class="dash-muted">Ch∆∞a c√≥ d·ªØ li·ªáu B·∫£ng x·∫øp h·∫°ng.</p></div>
  <% } %>

</div> 
<%- include('partials/footer') %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #1a73e8, #0d9488); 
            font-family: 'Be Vietnam Pro', sans-serif; 
            min-height: 100vh; margin: 0; padding: 20px;
            display: flex; align-items: center; justify-content: center;
            color: #333;
        }
        .status-card {
            background: white; width: 100%; max-width: 400px;
            border-radius: 24px; padding: 25px; text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        
        .ticket-box {
            background: #f3f4f6; border-radius: 16px; padding: 20px; margin-bottom: 20px;
            border: 2px dashed #ccc;
        }
        .ticket-number { font-size: 60px; font-weight: 800; line-height: 1; margin: 10px 0; color: #1a73e8; }
        .ticket-type { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 700; background: #e0f2fe; color: #1a73e8; }
        
        /* FEEDBACK FORM STYLE */
        .feedback-box { text-align: left; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .fb-title { font-weight: 700; margin-bottom: 10px; font-size: 15px; }
        
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: start; gap: 5px; margin-bottom: 15px; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 30px; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-rating input:checked ~ label { color: #f59e0b; }
        .star-rating label:hover, .star-rating label:hover ~ label { color: #f59e0b; }

        .form-area { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; margin-bottom: 15px; resize: vertical; box-sizing: border-box; }
        
        .btn-submit-fb { width: 100%; padding: 12px; background: #10b981; color: white; font-weight: 700; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .btn-refresh { margin-top: 15px; width: 100%; padding: 12px; background: #f3f4f6; color: #555; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }

        .ktv-info { background: #e0e7ff; color: #3730a3; padding: 10px; border-radius: 8px; font-weight: 700; margin-bottom: 15px; text-align: center; }
        
        /* Animation Pulse cho tr·∫°ng th√°i Serving */
        .serving-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body>
    <div class="status-card">
        <div style="font-size:16px; color:#666;">Xin ch√†o, <strong><%= ticket.customer_name %></strong></div>

        <div class="ticket-box" id="ticketBox">
            <div style="font-size:13px; text-transform:uppercase; color:#555;">S·ªë th·ª© t·ª± c·ªßa b·∫°n</div>
            <div class="ticket-number"><%= ticket.ticket_number %></div>
            <div class="ticket-type">
                <%= ticket.service_type === 'SALES' ? 'L·∫Øp r√°p v√† c√†i ƒë·∫∑t' : (ticket.service_type === 'WARRANTY' ? 'B·∫£o h√†nh' : 'S·ª≠a ch·ªØa') %>
            </div>
        </div>

        <% if(ticket.status === 'WAITING') { %>
            <div style="margin:20px 0;">
                <div style="font-size:40px; font-weight:700; color:#d93025;"><%= peopleAhead %></div>
                <div style="color:#666;">ng∆∞·ªùi ƒëang ch·ªù ph√≠a tr∆∞·ªõc</div>
                <div style="font-size:12px; color:#999; margin-top:5px;">(T·ªïng to√†n c·ª≠a h√†ng)</div>
            </div>
            <% } else if (ticket.status === 'SERVING') { %>
            <div class="ktv-info serving-pulse">
                üîî M·ªúI B·∫†N ƒê·∫æN QU·∫¶Y PH·ª§C V·ª§<br>
                <%= ticket.counter_name ? 'üìç ' + ticket.counter_name : '' %>
            </div>
            <div style="margin-top:20px; color:#666;">K·ªπ Thu·∫≠t Vi√™n ƒëang x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n...</div>
            
            <div style="margin-top:30px; border-top:1px dashed #ddd; padding-top:15px; font-size:14px; color:#888;">
                (Sau khi ƒë∆∞·ª£c h·ªó tr·ª£, b·∫°n h√£y d√†nh ra ch√∫t th·ªùi gian ƒë·ªÉ ƒë√°nh gi√° c·ª≠a h√†ng nh√© ^^ !)
            </div>

        <% } else { %>
            <% if(ticket.counter_name) { %>
                <div class="ktv-info">‚úÖ ƒê√£ ph·ª•c v·ª• b·ªüi: <%= ticket.counter_name %></div>
            <% } %>

            <div id="feedbackForm" class="feedback-box">
                <h3 style="text-align:center; color:#1a73e8; margin-top:0;">üåü ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• v√† d·ªãch v·ª• t·∫°i c·ª≠a h√†ng</h3>
                
                <div class="fb-title">1. B·∫°n h√†i l√≤ng v·ªÅ d·ªãch v·ª• t·∫°i c·ª≠a h√†ng kh√¥ng?</div>
                <div class="star-rating">
                    <input type="radio" name="service" id="s10" value="10"><label for="s10">‚òÖ</label>
                    <input type="radio" name="service" id="s8" value="8"><label for="s8">‚òÖ</label>
                    <input type="radio" name="service" id="s6" value="6"><label for="s6">‚òÖ</label>
                    <input type="radio" name="service" id="s4" value="4"><label for="s4">‚òÖ</label>
                    <input type="radio" name="service" id="s2" value="2"><label for="s2">‚òÖ</label>
                </div>

                <div class="fb-title">2. B·∫°n h√†i l√≤ng v·ªÅ K·ªπ thu·∫≠t vi√™n ƒë√£ h·ªó tr·ª£ b·∫°n kh√¥ng?</div>
                <div class="star-rating">
                    <input type="radio" name="tech" id="t10" value="10"><label for="t10">‚òÖ</label>
                    <input type="radio" name="tech" id="t8" value="8"><label for="t8">‚òÖ</label>
                    <input type="radio" name="tech" id="t6" value="6"><label for="t6">‚òÖ</label>
                    <input type="radio" name="tech" id="t4" value="4"><label for="t4">‚òÖ</label>
                    <input type="radio" name="tech" id="t2" value="2"><label for="t2">‚òÖ</label>
                </div>

                <div class="fb-title">3. G√≥p √Ω th√™m:</div>
                <textarea id="comment" class="form-area" rows="3" placeholder="Nh·∫≠p l·ªùi nh·∫Øn c·ªßa b·∫°n..."></textarea>

                <button class="btn-submit-fb" onclick="submitFeedback()">G·ª¨I ƒê√ÅNH GI√Å</button>
            </div>
            
            <div id="thankYou" style="display:none; text-align:center; padding:20px; color:#10b981;">
                <h2 style="font-size:40px; margin:0;">‚ù§Ô∏è</h2>
                <h3>C·∫£m ∆°n ƒë√°nh gi√° c·ªßa b·∫°n!</h3>
            </div>
        <% } %>
    </div>

    <script>
        const currentStatus = '<%= ticket.status %>';
        const ticketId = '<%= ticket.id %>';

        // --- AUTO REFRESH LOGIC ---
        // Ch·ªâ ch·∫°y khi tr·∫°ng th√°i l√† WAITING ho·∫∑c SERVING
        if (currentStatus === 'WAITING' || currentStatus === 'SERVING') {
            setInterval(async () => {
                try {
                    const res = await fetch(`/api/queue/check-status/${ticketId}`);
                    const data = await res.json();
                    
                    if (data) {
                        // N·∫øu tr·∫°ng th√°i thay ƒë·ªïi so v·ªõi hi·ªán t·∫°i
                        // WAITING -> SERVING: Reload ƒë·ªÉ hi·ªán th√¥ng b√°o ƒë·∫øn qu·∫ßy
                        // SERVING -> COMPLETED: Reload ƒë·ªÉ hi·ªán form ƒë√°nh gi√°
                        if (data.status !== currentStatus) {
                            window.location.reload();
                        }
                    }
                } catch (e) { console.error("Polling error", e); }
            }, 3000); // Ki·ªÉm tra m·ªói 3 gi√¢y
        }

        // Logic g·ª≠i ƒë√°nh gi√° (Gi·ªØ nguy√™n)
        async function submitFeedback() {
            const sEl = document.querySelector('input[name="service"]:checked');
            const tEl = document.querySelector('input[name="tech"]:checked');
            
            if(!sEl || !tEl) { alert("Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!"); return; }

            const data = {
                ticket_id: ticketId,
                service_score: sEl.value,
                technician_score: tEl.value,
                comment: document.getElementById('comment').value
            };

            const btn = document.querySelector('.btn-submit-fb');
            btn.innerText = "ƒêang g·ª≠i..."; btn.disabled = true;

            try {
                const res = await fetch('/api/queue/feedback', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if(res.ok) {
                    document.getElementById('feedbackForm').style.display = 'none';
                    document.getElementById('thankYou').style.display = 'block';
                } else {
                    alert("L·ªói g·ª≠i ƒë√°nh gi√°");
                    btn.innerText = "G·ª¨I ƒê√ÅNH GI√Å"; btn.disabled = false;
                }
            } catch(e) { alert("L·ªói k·∫øt n·ªëi"); }
        }
    </script>
</body>
</html>
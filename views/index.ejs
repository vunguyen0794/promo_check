<%- include('partials/header', {title: 'Trang chủ', currentPage: 'home', time: time}) %>

<div class="search-box">
  <form id="searchForm" action="/search-promotion" method="GET" class="search-form">
    <div class="autocomplete-container">
      <input id="skuSearch" name="query" class="search-input" placeholder="Nhập SKU hoặc tên SP" autocomplete="off">
      <div id="autocompleteResults" class="autocomplete-results"></div>
    </div>
    <button class="search-btn" type="submit">Tìm kiếm</button>
  </form>
</div>

<div class="dash-card">
  <div class="dash-title">Danh sách sản phẩm</div>
  <% if ((randomSkus||[]).length) { %>
    <div class="c-product-grid">
      <% randomSkus.forEach(function(s){ %>
        <a class="product-card" href="/search-promotion?query=<%= s.sku %>">
          <div class="product-sku">SKU: <strong><%= s.sku %></strong></div>
          <div class="product-name"><%= s.product_name || '-' %></div>
          <div class="product-meta">
            <span class="brand"><%= s.brand || '-' %></span>
            <span class="price"><%= (typeof s.list_price==='number') ? new Intl.NumberFormat('vi-VN').format(s.list_price) + ' ₫' : '-' %></span>
          </div>
        </a>
      <% }) %>
    </div>
    <div style="margin-top:10px"><a class="btn-view-more" href="/products">Xem thêm</a></div>
  <% } else { %>
    <div class="dash-muted">Chưa có dữ liệu sản phẩm.</div>
  <% } %>
</div>

<div class="dash-card" id="featured-promos-container">
    <div class="dash-title">CTKM nổi bật</div>
    <div class="promo-filter-tabs">
        <a href="/" data-ajax="true" class="<%= selectedGroup === '' ? 'active' : '' %>">Tất cả</a>
        <% (allGroups || []).forEach(function(group) { %>
            <a href="/?group=<%= encodeURIComponent(group) %>" data-ajax="true" class="<%= selectedGroup === group ? 'active' : '' %>"><%= group %></a>
        <% }) %>
    </div>
    
    <div id="promo-list-content">
        <%- include('partials/_featured-promos', { featuredPromos, page, totalPages, selectedGroup }) %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('featured-promos-container');
    const contentTarget = document.getElementById('promo-list-content');
    
    container.addEventListener('click', async function(e) {
        const link = e.target.closest('a[data-ajax="true"]');
        if (!link) return;
        
        e.preventDefault(); // Ngăn hành vi mặc định (tải lại trang)
        
        const url = link.getAttribute('href');
        const isPagination = link.textContent.includes('Xem thêm');
        
        try {
            // Thay đổi URL trên thanh địa chỉ
            history.pushState(null, '', url);
            
            // Hiển thị trạng thái đang tải (tùy chọn)
            contentTarget.style.opacity = '0.5';
            
            // Gọi API để lấy HTML mới
            const response = await fetch('/api/featured-promos' + url);
            const html = await response.text();
            
            // Cập nhật nội dung
            if (isPagination) {
                // Nếu là nút "Xem thêm", xóa nút đó và nối thêm nội dung mới
                link.parentElement.remove();
                contentTarget.insertAdjacentHTML('beforeend', html);
            } else {
                // Nếu là tab lọc, thay thế toàn bộ nội dung
                contentTarget.innerHTML = html;
            }

        } catch (error) {
            console.error('Lỗi khi tải CTKM:', error);
            // Nếu lỗi, điều hướng đến link như bình thường
            window.location.href = url;
        } finally {
            contentTarget.style.opacity = '1';
        }
    });
});
</script>

<div class="dash-card">
    <div class="dash-title">Sản phẩm có nhiều lượt so sánh giá</div>
    <% if (matrixRows && matrixRows.length) { %>
        <div class="table-scroll">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>SKU</th><th>Tên SP</th><th>Brand</th>
                        <% (competitorCols || []).forEach(function(c){ %><th><%= c %></th><% }); %>
                        <th>Tổng</th><th>Đối thủ nổi bật</th>
                    </tr>
                </thead>
                <tbody>
                    <% matrixRows.forEach(function(r){ %>
                        <tr>
                            <td><a href="/search-promotion?query=<%= r.sku %>"><strong><%= r.sku %></strong></a></td>
                            <td><%= r.product_name || '-' %></td>
                            <td><%= r.brand || '-' %></td>
                            <% (r.cells || []).forEach(function(n){ %><td><%= n %></td><% }); %>
                            <td><strong><%= r.total %></strong></td>
                            <td><span class="pill"><%= r.top_competitor %></span></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <div class="dash-muted">Chưa có dữ liệu so sánh giá.</div>
    <% } %>
</div>

<%- include('partials/search-autocomplete') %>
<%- include('partials/footer') %>
<%- include('partials/header', {title: 'Trang ch·ªß', currentPage: 'home', time: time}) %>

<div class="search-box">
  <form id="searchForm" action="/search-promotion" method="GET" class="search-form">
    <div class="autocomplete-container">
      <input id="skuSearch" name="query" class="search-input" placeholder="Nh·∫≠p SKU ho·∫∑c t√™n SP" autocomplete="off">
      <div id="autocompleteResults" class="autocomplete-results"></div>
    </div>
    <button class="search-btn" type="submit">T√¨m ki·∫øm</button>
  </form>
</div>

<div class="dash-card">
  <div class="dash-title">Danh s√°ch s·∫£n ph·∫©m</div>
  <% if ((randomSkus||[]).length) { %>
    <div class="c-product-grid">
      <% randomSkus.forEach(function(s){ %>
        <a class="product-card" href="/search-promotion?query=<%= s.sku %>">
          <div class="product-sku">SKU: <strong><%= s.sku %></strong></div>
          <div class="product-name"><%= s.product_name || '-' %></div>
          <div class="product-meta">
            <span class="brand"><%= s.brand || '-' %></span>
            <span class="price"><%= (typeof s.list_price==='number') ? new Intl.NumberFormat('vi-VN').format(s.list_price) + ' ‚Ç´' : '-' %></span>
          </div>
        </a>
      <% }) %>
    </div>
    <div style="margin-top:10px"><a class="btn-view-more" href="/products">Xem th√™m</a></div>
  <% } else { %>
    <div class="dash-muted">Ch∆∞a c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m.</div>
  <% } %>
</div>

<div class="dash-card" id="featured-promos-container">
    <div class="dash-title">CTKM n·ªïi b·∫≠t</div>
    
    <div class="promo-filters-bar" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
        
        <div style="flex: 0 0 auto; min-width: 200px;">
            <select id="promoGroupSelect" class="info-select" style="width: 100%; height: 42px; border-radius: 8px; border: 1px solid #e5e7eb; padding: 0 12px; font-weight: 500;">
                <option value="">üìÇ T·∫•t c·∫£ nh√≥m</option>
                <% (allGroups || []).forEach(function(group) { %>
                    <option value="<%= group %>" <%= selectedGroup === group ? 'selected' : '' %>>
                        <%= group %>
                    </option>
                <% }) %>
            </select>
        </div>

        <div style="flex: 1; position: relative;">
            <input type="text" id="promoSearchInput" 
                   class="search-input" 
                   placeholder="üîç T√¨m theo t√™n, m√¥ t·∫£, SKU √°p d·ª•ng..." 
                   value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
                   autocomplete="off"
                   style="width: 100%; height: 42px; padding: 8px 14px; border-radius: 8px; border: 1px solid #e5e7eb;">
        </div>
    </div>
    
    <div id="promo-list-content">
        <%- include('partials/_featured-promos', { featuredPromos, page, totalPages, selectedGroup }) %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('featured-promos-container');
    const contentTarget = document.getElementById('promo-list-content');
    const groupSelect = document.getElementById('promoGroupSelect');
    const searchInput = document.getElementById('promoSearchInput');
    
    let debounceTimer;
    
    // H√†m g·ªçi API chung
    async function fetchPromos(pageToLoad = 1, isAppend = false) {
        // L·∫•y gi√° tr·ªã hi·ªán t·∫°i c·ªßa c·∫£ 2 input
        const group = groupSelect.value;
        const q = searchInput.value.trim();
        
        // T·∫°o URL query
        const params = new URLSearchParams();
        if (group) params.append('group', group);
        if (q) params.append('q', q);
        params.append('page', pageToLoad);
        
        const queryString = params.toString();
        const url = '/?' + queryString;
        const apiUrl = '/api/featured-promos?' + queryString;

        try {
            if (!isAppend) {
                contentTarget.style.opacity = '0.5';
            }
            
            // C·∫≠p nh·∫≠t URL tr√¨nh duy·ªát (ƒë·ªÉ reload kh√¥ng m·∫•t filter)
            window.history.replaceState(null, '', url);

            const response = await fetch(apiUrl);
            const html = await response.text();

            if (isAppend) {
                contentTarget.insertAdjacentHTML('beforeend', html);
            } else {
                contentTarget.innerHTML = html;
            }
        } catch (error) {
            console.error('L·ªói t·∫£i CTKM:', error);
        } finally {
            contentTarget.style.opacity = '1';
        }
    }

    // 1. S·ª± ki·ªán thay ƒë·ªïi Nh√≥m -> Reset v·ªÅ trang 1, gi·ªØ nguy√™n t·ª´ kh√≥a t√¨m ki·∫øm
    groupSelect.addEventListener('change', function() {
        fetchPromos(1, false);
    });

    // 2. S·ª± ki·ªán g√µ t√¨m ki·∫øm -> Debounce -> Reset v·ªÅ trang 1, gi·ªØ nguy√™n nh√≥m
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetchPromos(1, false);
        }, 500); // ƒê·ª£i 500ms sau khi ng·ª´ng g√µ
    });

    // 3. S·ª± ki·ªán ph√¢n trang (N√∫t Xem th√™m)
    container.addEventListener('click', function(e) {
        const link = e.target.closest('a[data-ajax="true"]');
        if (!link) return;
        
        e.preventDefault();
        
        // L·∫•y page t·ª´ link (n·∫øu c√≥)
        const href = link.getAttribute('href');
        const urlParams = new URLSearchParams(href.split('?')[1]);
        const nextPage = urlParams.get('page') || 1;

        // X√≥a n√∫t c≈© v√† t·∫£i ti·∫øp
        if (link.parentElement) link.parentElement.remove();
        fetchPromos(nextPage, true);
    });
});
</script>

<div class="dash-card">
    <div class="dash-title">S·∫£n ph·∫©m c√≥ nhi·ªÅu l∆∞·ª£t so s√°nh gi√°</div>
    <% if (matrixRows && matrixRows.length) { %>
        <div class="table-scroll">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>SKU</th><th>T√™n SP</th><th>Brand</th>
                        <% (competitorCols || []).forEach(function(c){ %><th><%= c %></th><% }); %>
                        <th>T·ªïng</th><th>ƒê·ªëi th·ªß n·ªïi b·∫≠t</th>
                    </tr>
                </thead>
                <tbody>
                    <% matrixRows.forEach(function(r){ %>
                        <tr>
                            <td><a href="/search-promotion?query=<%= r.sku %>"><strong><%= r.sku %></strong></a></td>
                            <td><%= r.product_name || '-' %></td>
                            <td><%= r.brand || '-' %></td>
                            <% (r.cells || []).forEach(function(n){ %><td><%= n %></td><% }); %>
                            <td><strong><%= r.total %></strong></td>
                            <td><span class="pill"><%= r.top_competitor %></span></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <div class="dash-muted">Ch∆∞a c√≥ d·ªØ li·ªáu so s√°nh gi√°.</div>
    <% } %>
</div>

<%- include('partials/search-autocomplete') %>
<%- include('partials/footer') %>
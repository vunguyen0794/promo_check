<%- include('partials/header', {title: 'Trang chủ', currentPage: 'home', time: time}) %>

<div class="search-box">
    <form action="/search-promotion" method="POST" class="search-form" id="searchForm">
        <div class="autocomplete-container">
            <input type="text" name="sku" class="search-input" placeholder="Nhập SKU hoặc tên sản phẩm" required
                   id="skuSearch" autocomplete="off">
            <div class="autocomplete-results" id="autocompleteResults"></div>
        </div>
        <button type="submit" class="search-btn">Tìm kiếm</button>
    </form>
</div>

<div class="no-orders">
    <p>Chúc bạn một ngày tốt lành!</p>
</div>

<div class="price-battle-section">
    <h2 class="section-title">Chiến giá</h2>
    <p>Chức năng chiến giá sẽ được triển khai trong phiên bản tiếp theo.</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('skuSearch');
    const resultsContainer = document.getElementById('autocompleteResults');
    const searchForm = document.getElementById('searchForm');
    let timeoutId;

    searchInput.addEventListener('input', function(e) {
        clearTimeout(timeoutId);
        const value = e.target.value.trim();
        
        if (value.length < 1) {
            resultsContainer.style.display = 'none';
            return;
        }

        timeoutId = setTimeout(async () => {
            try {
                console.log('Fetching SKUs for:', value);
                const response = await fetch(`/api/skus?q=${encodeURIComponent(value)}`);
                const data = await response.json();
                console.log('Received data:', data);
                
                if (data && data.length > 0) {
                    resultsContainer.innerHTML = '';
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.innerHTML = `
                            <div><strong>${item.sku}</strong> - ${item.product_name}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${item.brand} | ${item.category} | ${item.subcat}
                            </div>
                            <div style="font-size: 12px; color: #e53935; font-weight: bold;">
                                ${new Intl.NumberFormat('vi-VN').format(item.list_price)} VNĐ
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            searchInput.value = item.sku;
                            resultsContainer.style.display = 'none';
                            searchForm.submit();
                        });
                        resultsContainer.appendChild(div);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Autocomplete error:', error);
                resultsContainer.style.display = 'none';
            }
        }, 300);
    });

    // Ẩn autocomplete khi click outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            resultsContainer.style.display = 'none';
        }
    });

    // Tự động submit khi chọn từ autocomplete
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchForm.submit();
        }
    });
});
</script>

<%- include('partials/footer') %>
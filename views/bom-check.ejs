<%- include('partials/header', { title, currentPage }) %>

<% /* === CSS cho trang BOM === */ %>
<style>
  .bom-container {
    max-width: 1200px;
    margin: 0 auto;
  }
  .search-controls {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    margin-bottom: 20px;
  }
  .search-controls .form-group {
    flex-grow: 1;
  }
  .search-options {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }
  .search-options label {
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* CSS cho b·∫£ng k·∫øt qu·∫£ (t√°i s·ª≠ d·ª•ng t·ª´ promotion.ejs) */
  .info-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  .info-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border: 1px solid #dee2e6;
  }
  .info-table td {
    padding: 12px;
    border: 1px solid #dee2e6;
    background: white;
  }
  .info-table tr:nth-child(even) td {
    background: #f8f9fa;
  }
  .table-scroll-wrapper {
    overflow-x: auto;
  }

  /* CSS cho chi ti·∫øt linh ki·ªán */
  .component-detail-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .component-detail-list li {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 5px 0;
    border-bottom: 1px dashed #e5e7eb;
  }
  .component-detail-list li:last-child {
    border-bottom: none;
  }
  .component-detail-list .sku-name {
    font-weight: 600;
  }
  .component-detail-list .sku-stats {
    text-align: right;
    white-space: nowrap;
  }
  .bottleneck {
    background-color: #fef9c3; /* V√†ng nh·∫°t */
    color: #713f12;
    font-weight: 700;
  }
</style>

<div class="bom-container">
  <div class="dash-card">
    <div class="dash-title">Ki·ªÉm tra BOM (ƒê·ªãnh m·ª©c) PCPV</div>
    
    <div class="search-controls">
      <div class="form-group">
        <label for="skuSearchInput">Nh·∫≠p SKU:</label>
        <input type="text" id="skuSearchInput" class="search-input" placeholder="Nh·∫≠p SKU Th√†nh ph·∫©m ho·∫∑c Linh ki·ªán...">
      </div>
      <button class="btn btn-primary" id="searchButton" style="padding: 10px 20px;">
        üîç Tra c·ª©u
      </button>
    </div>

    <div class="search-options">
      <label>
        <input type="radio" name="search_mode" value="final" checked>
        T√¨m theo SKU Th√†nh ph·∫©m (PCPV)
      </label>
      <label>
        <input type="radio" name="search_mode" value="component">
        T√¨m theo SKU Linh ki·ªán (Tra ng∆∞·ª£c)
      </label>
    </div>
  </div>

  <div class="dash-card" style="margin-top: 20px;">
    <div class="dash-title">K·∫øt qu·∫£ tra c·ª©u</div>
    <div id="resultsContainer">
      <div class="dash-muted" style="text-align: center; padding: 20px;">
        Vui l√≤ng nh·∫≠p SKU v√† nh·∫•n "Tra c·ª©u".
      </div>
    </div>
  </div>
</div>

<%- include('partials/toast') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('skuSearchInput');
  const searchButton = document.getElementById('searchButton');
  const resultsContainer = document.getElementById('resultsContainer');
  const currentUserRole = "<%= user ? user.role : 'staff' %>";

  // B·∫Øt s·ª± ki·ªán Enter
  searchInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault(); // NgƒÉn form submit (n·∫øu c√≥)
      handleSearch();
    }
  });

  // B·∫Øt s·ª± ki·ªán Click
  searchButton.addEventListener('click', handleSearch);

  async function handleSearch() {
    const sku = searchInput.value.trim();
    const mode = document.querySelector('input[name="search_mode"]:checked').value;

    if (!sku) {
      showToast('Vui l√≤ng nh·∫≠p SKU.', 'warn');
      return;
    }

    let url = '';
    if (mode === 'final') {
      // Y√™u c·∫ßu 1: T√¨m theo SKU Th√†nh ph·∫©m
      url = `/api/utils/bom/by-final?sku=${encodeURIComponent(sku)}`;
    } else {
      // Y√™u c·∫ßu 2: T√¨m theo SKU Linh ki·ªán (Tra ng∆∞·ª£c)
      url = `/api/utils/bom/by-component?sku=${encodeURIComponent(sku)}`;
    }

    resultsContainer.innerHTML = '<div class="dash-muted" style="text-align: center; padding: 20px;">ƒêang t·∫£i...</div>';
    
    try {
      const res = await fetch(url);
      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server');
      }

      // G·ªçi h√†m render t∆∞∆°ng ·ª©ng
      if (mode === 'final') {
        renderFinalResults(data); // Render k·∫øt qu·∫£ t√≠nh to√°n
      } else {
        renderComponentResults(data); // Render danh s√°ch PCPV
      }

    } catch (err) {
      console.error('L·ªói khi tra c·ª©u BOM:', err);
      resultsContainer.innerHTML = `<div class="error-message">L·ªói: ${err.message}</div>`;
      showToast(err.message, 'error');
    }
  }

  // H√ÄM RENDER K·∫æT QU·∫¢ (Req 2 & 3: T√≠nh to√°n s·ªë l∆∞·ª£ng r√°p)
  function renderFinalResults(data) {
    const { final, buildableByBranch } = data;
    const isManager = (currentUserRole === 'manager' || currentUserRole === 'admin');

    if (!buildableByBranch || buildableByBranch.length === 0) {
      let emptyHtml = `
        <div class="dash-muted" style="text-align: center; padding: 20px;">
          Kh√¥ng t√¨m th·∫•y ƒë·ªãnh m·ª©c (BOM) cho SKU: <strong>${final.sku}</strong>
        </div>`;
      
      // (M·ªöI) N·∫øu l√† manager, hi·ªÉn th·ªã n√∫t "T·∫°o BOM"
      if (isManager) {
        emptyHtml += `
          <div style="text-align: center; margin-top: -10px; margin-bottom: 20px;">
            <a href="/admin/bom/create?final_sku=${final.sku}" class="btn btn-primary">
              + T·∫°o BOM cho SKU n√†y
            </a>
          </div>
        `;
      }
      resultsContainer.innerHTML = emptyHtml;
      return;
    }

    // Hi·ªÉn th·ªã t√™n PCPV
    let html = `<h3 style="margin-top:0;">SKU Th√†nh ph·∫©m: ${final.name || final.sku}</h3>`;

    // (Req 2) B·∫£ng data ƒë·ªÉ th·∫•y list PCPV c√≥ th·ªÉ r√°p ·ªü m·ªói branch
    html += '<div class="table-scroll-wrapper">';
    html += '<table class="info-table">';
    html += `
      <thead>
        <tr>
          <th>Chi nh√°nh</th>
          <th style="text-align: right;">S·ªë l∆∞·ª£ng c√≥ th·ªÉ r√°p</th>
          <th>Linh ki·ªán thi·∫øu (T√¥ m√†u n·ªïi b·∫≠t)</th>
          <th>Chi ti·∫øt linh ki·ªán (C·∫ßn/ T·ªìn/ R√°p ƒë∆∞·ª£c)</th>
        </tr>
      </thead>
      <tbody>
    `;

    buildableByBranch.forEach(branchData => {
      // (Req 3) T√≠nh to√°n chi ti·∫øt linh ki·ªán
      const componentsHtml = branchData.components.map(comp => {
        const isBottleneck = (comp.have < comp.need);
        return `
          <li class="${isBottleneck ? 'bottleneck' : ''}">
            <span class="sku-name">${comp.sku} (${comp.name})</span>
            <span class="sku-stats">
              (C·∫ßn: ${comp.need} / 
              T·ªìn: ${comp.have} / 
              R√°p ƒë∆∞·ª£c: ${comp.can_build_this})
            </span>
          </li>
        `;
      }).join('');

      html += `
        <tr>
          <td><strong>${branchData.branch}</strong></td>
          <td style="text-align: right; font-size: 1.2rem; font-weight: 800;">
            ${branchData.buildable}
          </td>
          <td>${branchData.bottleneck || (branchData.buildable > 0 ? 'N/A' : 'Kh√¥ng c√≥ linh ki·ªán')}</td>
          <td><ul class="component-detail-list">${componentsHtml}</ul></td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
    resultsContainer.innerHTML = html;
  }
  
  // H√ÄM RENDER K·∫æT QU·∫¢ (Req 1: Tra c·ª©u ng∆∞·ª£c)
  function renderComponentResults(data) {
    const { component, results } = data;

    if (!results || results.length === 0) {
      resultsContainer.innerHTML = `<div class="dash-muted" style="text-align: center; padding: 20px;">Kh√¥ng t√¨m th·∫•y PCPV n√†o s·ª≠ d·ª•ng linh ki·ªán: <strong>${component}</strong></div>`;
      return;
    }

    let html = `<h3 style="margin-top:0;">Linh ki·ªán: ${component}</h3>`;
    html += `<p>${results.length} SKU Th√†nh ph·∫©m (PCPV) sau s·ª≠ d·ª•ng linh ki·ªán n√†y:</p>`;
    
    html += '<table class="info-table"><tbody>';
    results.forEach(final => {
      html += `
        <tr>
          <td><strong>${final.sku}</strong></td>
          <td>${final.name || 'N/A'}</td>
          <td>
            <button class="btn btn-secondary" 
                    style="padding: 5px 10px; font-size: 12px;"
                    onclick="searchSku('${final.sku}')">
              Check s·ªë l∆∞·ª£ng r√°p
            </button>
          </td>
        </tr>
      `;
    });
    html += '</tbody></table>';
    resultsContainer.innerHTML = html;
  }

  // H√†m helper ƒë·ªÉ b·∫•m n√∫t "Check s·ªë l∆∞·ª£ng r√°p"
  window.searchSku = function(sku) {
    document.getElementById('skuSearchInput').value = sku;
    document.querySelector('input[name="search_mode"][value="final"]').checked = true;
    handleSearch();
  }
});
</script>

<%- include('partials/footer') %>
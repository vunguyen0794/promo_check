<!DOCTYPE html>
<html lang="vi">
<head>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>H·ªá th·ªëng Ho√†n ti·ªÅn</title>
    <link rel="stylesheet" href="/css/refund.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS B·ªî SUNG */
        .dash-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-val { font-size: 24px; font-weight: 700; color: var(--primary-color); margin-top: 5px; }
        .stat-label { font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .filter-bar { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; background: #f1f3f4; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 12px; font-weight: 600; color: #555; }
        
        /* Modal View Style */
        .view-section { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .view-section:last-child { border-bottom: none; }
        .view-title { font-size: 14px; font-weight: 700; color: var(--primary-color); margin-bottom: 8px; text-transform: uppercase; }
        .view-row { display: flex; justify-content: space-between; padding: 6px 0; }
        .view-label { color: #666; font-size: 13px; }
        .view-val { font-weight: 600; color: #222; text-align: right; max-width: 60%; }
        .text-red { color: #d93025; }
        /* CSS cho list k√©o th·∫£ */
.sortable-list { list-style: none; padding: 0; margin: 0; }
.sortable-item { 
    display: flex; align-items: center; gap: 10px; 
    padding: 10px; background: #fff; border: 1px solid #eee; margin-bottom: 5px; 
    border-radius: 4px; cursor: grab; transition: background 0.2s;
}
.sortable-item:hover { background: #f8f9fa; border-color: #ddd; }
.sortable-item.sortable-ghost { opacity: 0.4; background: #c8ebfb; }
.drag-handle { cursor: grab; color: #999; font-size: 16px; }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div><div>ƒêang x·ª≠ l√Ω...</div></div>

    <header style="background:#fff; border-bottom:1px solid #ddd; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
        <h1 style="margin:0; font-size:20px; color:#1a73e8; font-weight:700;">QU·∫¢N L√ù HO√ÄN TI·ªÄN</h1>
        <div>
            <button onclick="location.reload()" class="btn ghost">‚Üª T·∫£i l·∫°i d·ªØ li·ªáu</button>
        </div>
    </header>

    <main class="container">
        <section class="dash-stats">
            <div class="stat-card"><div class="stat-label">T·ªïng phi·∫øu</div><div class="stat-val" id="stat-count">0</div></div>
            <div class="stat-card"><div class="stat-label">T·ªïng ti·ªÅn ho√†n</div><div class="stat-val text-red" id="stat-money">0</div></div>
            <div class="stat-card"><div class="stat-label">C·∫•n tr·ª´</div><div class="stat-val" id="stat-offset">0</div></div>
            <div class="stat-card"><div class="stat-label">Ch·ªù duy·ªát</div><div class="stat-val" style="color:#f9ab00" id="stat-pending">0</div></div>
        </section>

        <section class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2 class="card-title">üìù Th√¥ng tin phi·∫øu</h2>
                
            </div>
            
            <form id="refund-form">
                <div class="form-grid">
                    <div class="form-group col-1"><label>Ng√†y y√™u c·∫ßu</label><input name="RequestDate" type="date"></div>
                    <div class="form-group col-1"><label>M√£ ƒë∆°n h√†ng *</label><input name="OrderID" id="inp-OrderID" placeholder="VD: 2405..."></div>
                    <div class="form-group col-1"><label>SƒêT Kh√°ch</label><input name="Phone"></div>
                    <div class="form-group col-1"><label>T√™n Kh√°ch h√†ng</label><input name="CustomerName"></div>

                    <div class="form-group col-2"><label>S·∫£n ph·∫©m</label><input name="Product"></div>
                    <div class="form-group col-2"><label>L√Ω do ho√†n *</label><input name="Reason" id="inp-Reason"></div>

                    <div class="form-group col-1"><label>T·ªïng gi√° tr·ªã ƒë∆°n</label><input name="OrderTotal" type="number" class="text-right"></div>
                    <div class="form-group col-1"><label>S·ªë ti·ªÅn ho√†n *</label><input name="RefundAmount" id="inp-RefundAmount" type="number" class="text-right font-bold text-red"></div>
                    <div class="form-group col-1"><label>Ph∆∞∆°ng th·ª©c</label><select name="RefundMethod" id="refund-method"></select></div>
                    <div class="form-group col-1"><label>Tr·∫°ng th√°i</label><select name="Status"><option>M·ªõi t·∫°o</option><option>ƒê√£ duy·ªát</option><option>ƒê√£ chi</option><option>Hu·ª∑</option></select></div>
                </div>

                <div style="margin-top:15px; padding:10px; background:#f8f9fa; border-radius:6px; border:1px solid #eee;">
                    <label style="display:flex; gap:10px; font-weight:600; color:#1a73e8; cursor:pointer;">
                        <input type="checkbox" id="chk-offset-new" name="OffsetToNewOrder"> K√≠ch ho·∫°t C·∫•n tr·ª´ ƒë∆°n m·ªõi
                    </label>
                    <div id="offset-section" class="form-grid hidden" style="margin-top:10px;">
                        <input type="hidden" name="OldOrderID"><input type="hidden" name="SRApprover">
                        <div class="form-group col-1"><label>M√£ ƒë∆°n m·ªõi</label><input name="NewOrderID"></div>
                        <div class="form-group col-1"><label>Gi√° tr·ªã m·ªõi</label><input name="NewOrderValue" type="number" class="text-right"></div>
                        <div class="form-group col-1"><label>Ti·ªÅn KM</label><input name="NewKM" type="number" class="text-right"></div>
                        <div class="form-group col-1"><label>Sau KM</label><input name="NewAfterKM" type="number" class="text-right"></div>
                    </div>
                </div>

                <div id="bank-section" class="hidden" style="margin-top:15px; padding-top:10px; border-top:1px dashed #ccc;">
                    <div class="form-grid">
                        <div class="form-group col-1"><label>Ng√¢n h√†ng</label><input name="BankName"></div>
                        <div class="form-group col-1"><label>Chi nh√°nh</label><input name="Branch"></div>
                        <div class="form-group col-1"><label>S·ªë t√†i kho·∫£n</label><input name="AccountNumber"></div>
                        <div class="form-group col-1"><label>Ch·ªß t√†i kho·∫£n</label><input name="AccountName"></div>
                    </div>
                </div>

                <div class="form-grid" style="margin-top:15px;">
                     <div class="form-group col-1"><label>Ng∆∞·ªùi y√™u c·∫ßu</label><input name="RequestedBy"></div>
                     <div class="form-group col-1"><label>Ng∆∞·ªùi duy·ªát</label><input name="ApprovedBy"></div>
                     <div class="form-group col-2"><label>Ghi ch√∫</label><input name="Notes"></div>
                </div>

                <div class="actions">
                    <button type="button" id="btn-save" class="btn primary">L∆∞u d·ªØ li·ªáu</button>
                    <button type="button" id="btn-save-print" class="btn">L∆∞u & In</button>
                    <button type="button" onclick="openPrintColsModal()" class="btn ghost">‚öôÔ∏è C·∫•u h√¨nh c·ªôt in</button>
                    <button type="button" onclick="resetForm()" class="btn ghost" style="margin-left:auto; color:#d93025">‚ùå Nh·∫≠p m·ªõi / H·ªßy</button>
                </div>
            </form>
        </section>

        <section class="card">
            <h2 class="card-title">L·ªãch s·ª≠ giao d·ªãch</h2>
            <div class="filter-bar">
                <div class="filter-group"><label>T·ª´ ng√†y</label><input type="date" id="f-start"></div>
                <div class="filter-group"><label>ƒê·∫øn ng√†y</label><input type="date" id="f-end"></div>
                <div class="filter-group" style="flex:1"><label>T√¨m ki·∫øm</label><input type="text" id="f-search" placeholder="Nh·∫≠p M√£ ƒë∆°n, T√™n KH, SƒêT..."></div>
                <button class="btn primary" onclick="applyFilter()">L·ªçc</button>
            </div>
            <div class="table-wrap">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>Lo·∫°i</th>
                            <th>Ng√†y</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>M√£ ƒë∆°n</th>
                            <th class="text-right">S·ªë ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th style="text-align:center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="printcols-modal" class="modal">
        <div class="modal-backdrop" onclick="closePrintColsModal()"></div>
        <div class="modal-panel">
            <h3 style="margin-top:0">Ch·ªçn c·ªôt hi·ªÉn th·ªã khi In</h3>
            <div id="printcols-list" class="modal-grid"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn ghost" onclick="closePrintColsModal()">ƒê√≥ng</button>
                <button class="btn primary" onclick="applyPrintCols()">√Åp d·ª•ng</button>
            </div>
        </div>
    </div>

    <div id="view-modal" class="modal">
        <div class="modal-backdrop" onclick="closeViewModal()"></div>
        <div class="modal-panel" style="width: 500px;">
            <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between;">
                <span>Chi ti·∫øt phi·∫øu</span>
                <button onclick="closeViewModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
            </h3>
            <div id="view-content" style="max-height:60vh; overflow-y:auto; padding-right:5px;"></div>
            <div style="text-align: right; margin-top: 15px; border-top:1px solid #eee; padding-top:10px;">
                <button class="btn primary" onclick="closeViewModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        let __allRows = [], __editingId = null;

// ===== DANH S√ÅCH C·ªòT C√ì TH·ªÇ IN =====
const ALL_COLUMNS = [
    { key:'ID', label:'S·ªë ch·ª©ng t·ª´' },
    { key:'RequestDate', label:'Ng√†y y√™u c·∫ßu' },
    { key:'CustomerName', label:'Kh√°ch h√†ng' },
    { key:'Phone', label:'SƒêT' },
    { key:'OrderID', label:'M√£ ƒë∆°n h√†ng' },
    { key:'Product', label:'S·∫£n ph·∫©m' },
    { key:'Reason', label:'L√Ω do' },
    { key:'OrderTotal', label:'Gi√° tr·ªã ƒë∆°n' },
    { key:'RefundAmount', label:'S·ªë ti·ªÅn ho√†n' },
    { key:'RefundMethod', label:'Ph∆∞∆°ng th·ª©c' },
    { key:'Bank', label:'Th√¥ng tin ng√¢n h√†ng' },
    { key:'Status', label:'Tr·∫°ng th√°i' },
    { key:'ApprovedBy', label:'Ng∆∞·ªùi duy·ªát' },
    { key:'Notes', label:'Ghi ch√∫' }
];

// --- KHAI B√ÅO BI·∫æN C√ì L∆ØU TR·ªÆ (LOCAL STORAGE) ---
    
    // 1. Danh s√°ch m·∫∑c ƒë·ªãnh (n·∫øu ng∆∞·ªùi d√πng ch∆∞a t·ª´ng c√†i ƒë·∫∑t)
    const DEFAULT_COLS = [
        'OrderID', 'CustomerName', 'Product','Reason','OrderTotal',
        'RefundAmount', 'RefundMethod', 'Bank', 'ApprovedBy'
    ];

    // 2. Th·ª≠ l·∫•y c√†i ƒë·∫∑t c≈© t·ª´ b·ªô nh·ªõ tr√¨nh duy·ªát
    const savedCols = localStorage.getItem('MY_PRINT_CONFIG');

    // 3. N·∫øu c√≥ th√¨ d√πng c√°i c≈©, n·∫øu kh√¥ng th√¨ d√πng m·∫∑c ƒë·ªãnh
    let selectedPrintCols = savedCols ? JSON.parse(savedCols) : DEFAULT_COLS;


        // --- H√ÄM M·ªû TRANG IN ---
function openPrint(id) {
    if (!selectedPrintCols || selectedPrintCols.length === 0) {
        alert('B·∫°n ch∆∞a ch·ªçn c·ªôt n√†o');
        return;
    }

    const colsParam = selectedPrintCols.join(',');
    window.open(`/refunds/print/${id}?cols=${colsParam}`, '_blank');
}


// --- H√ÄM L∆ØU C·∫§U H√åNH C·ªòT ---
function applyPrintCols() {
    const checks = document.querySelectorAll('#printcols-list input:checked');
    if (items.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 c·ªôt');
        return;
    }

// L·∫•y danh s√°ch c·ªôt ng∆∞·ªùi d√πng v·ª´a ch·ªçn
        selectedPrintCols = Array.from(checks).map(c => c.value);
        
        // === D√íNG QUAN TR·ªåNG: L∆ØU V√ÄO B·ªò NH·ªö TR√åNH DUY·ªÜT ===
        localStorage.setItem('MY_PRINT_CONFIG', JSON.stringify(selectedPrintCols));
        
        closePrintColsModal();
        alert('ƒê√£ l∆∞u c·∫•u h√¨nh c·ªôt in!'); // (T√πy ch·ªçn) Th√¥ng b√°o cho user bi·∫øt
    }



        document.addEventListener('DOMContentLoaded', () => {
            const methods = ['Chuy·ªÉn kho·∫£n', 'Ti·ªÅn m·∫∑t', 'VNPay QR', 'V√≠ ƒëi·ªán t·ª≠'];
            document.getElementById('refund-method').innerHTML = methods.map(m => `<option>${m}</option>`).join('');
            
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('f-start').value = firstDay.toISOString().slice(0,10);
            document.getElementById('f-end').value = today.toISOString().slice(0,10);

            resetForm();
            fetchData();
            
            document.getElementById('btn-save').onclick = () => handleSave(false);
            document.getElementById('btn-save-print').onclick = () => handleSave(true);
            document.getElementById('refund-method').onchange = toggleBank;
            document.getElementById('chk-offset-new').onchange = toggleOffset;
        });

        // --- CORE FUNCTIONS ---
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        
        async function fetchData() {
            showLoading(true);
            try {
                const res = await fetch('/api/refunds/list?limit=500');
                const json = await res.json();
                __allRows = json.data || [];
                applyFilter();
            } catch(e) {} finally { showLoading(false); }
        }

        function applyFilter() {
            const start = document.getElementById('f-start').value;
            const end = document.getElementById('f-end').value;
            const kw = document.getElementById('f-search').value.toLowerCase().trim();
            let filtered = __allRows.filter(r => {
                if (start && r.RequestDate < start) return false;
                if (end && r.RequestDate > end) return false;
                if (kw && ![r.ID, r.CustomerName, r.Phone, r.OrderID].join(' ').toLowerCase().includes(kw)) return false;
                return true;
            });
            updateDashboard(filtered); renderTable(filtered);
        }

        function updateDashboard(rows) {
    let refundCash = 0;      // Ho√†n ti·ªÅn th·ª±c tr·∫£
    let offsetRefund = 0;   // C·∫•n tr·ª´ nh∆∞ng tr·∫£ l·∫°i kh√°ch
    let offsetExtra = 0;    // Kh√°ch b√π th√™m ti·ªÅn

    rows.forEach(r => {
        const isOffset = String(r.OffsetToNewOrder).toLowerCase() === 'true';
        const orderTotal = Number(r.OrderTotal || 0);
        const newAfter = Number(r.NewAfterKM || 0);

        if (!isOffset) {
            refundCash += Number(r.RefundAmount || 0);
        } else {
            const diff = orderTotal - newAfter;
            if (diff >= 0) offsetRefund += diff;
            else offsetExtra += Math.abs(diff);
        }
    });

    document.getElementById('stat-count').textContent = rows.length;
    document.getElementById('stat-money').textContent = refundCash.toLocaleString('vi-VN');
    document.getElementById('stat-offset').textContent = offsetRefund.toLocaleString('vi-VN');
    document.getElementById('stat-pending').textContent = rows.filter(r=>r.Status=='M·ªõi t·∫°o').length;

    console.log({ refundCash, offsetRefund, offsetExtra });
}


        function renderTable(rows) {
            const tb = document.querySelector('#history-table tbody');
            if(!rows.length) return tb.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            
            tb.innerHTML = rows.map(r => {
                const isOffset = String(r.OffsetToNewOrder).toLowerCase() === 'true';
                const badge = isOffset ? '<span class="badge badge-offset">C·∫•n tr·ª´</span>' : '<span class="badge badge-refund">Ho√†n ti·ªÅn</span>';
                
                return `<tr>
                    <td>${badge}</td>
                    <td>${r.RequestDate}</td>
                    <td><b>${r.CustomerName}</b><br><small>${r.Phone}</small></td>
                    <td>${r.OrderID}</td>
                    <td class="text-right text-red font-bold">${Number(r.RefundAmount).toLocaleString('vi-VN')}</td>
                    <td>${r.Status}</td>
                    <td style="text-align:center; white-space:nowrap;">
                        <button class="btn ghost" title="Xem" onclick="openViewModal('${r.ID}')">üëÅÔ∏è</button>
                        <button class="btn ghost" title="S·ª≠a" onclick="loadEdit('${r.ID}')">‚úèÔ∏è</button>
                        <button class="btn ghost" title="In" onclick="openPrint('${r.ID}')">üñ®Ô∏è</button>
                        <button class="btn ghost" title="X√≥a" style="color:red" onclick="deleteItem('${r.ID}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- MODAL XEM CHI TI·∫æT (ƒê√£ fix) ---
        function openViewModal(id) {
            const r = __allRows.find(x => x.ID === id);
            if (!r) return;

            const isOffset = String(r.OffsetToNewOrder) === 'true';
            const bank = r.Bank || [r.BankName, r.Branch, r.AccountNumber, r.AccountName].filter(Boolean).join(' - ');

            let html = `
                <div class="view-section">
                    <div class="view-title">Th√¥ng tin chung</div>
                    <div class="view-row"><span class="view-label">M√£ phi·∫øu</span><span class="view-val">${r.ID}</span></div>
                    <div class="view-row"><span class="view-label">Ng√†y y√™u c·∫ßu</span><span class="view-val">${r.RequestDate}</span></div>
                    <div class="view-row"><span class="view-label">Kh√°ch h√†ng</span><span class="view-val">${r.CustomerName}</span></div>
                    <div class="view-row"><span class="view-label">S·ªë ƒëi·ªán tho·∫°i</span><span class="view-val">${r.Phone}</span></div>
                </div>
                <div class="view-section">
                    <div class="view-title">Chi ti·∫øt ho√†n ti·ªÅn</div>
                    <div class="view-row"><span class="view-label">M√£ ƒë∆°n h√†ng</span><span class="view-val">${r.OrderID}</span></div>
                    <div class="view-row"><span class="view-label">S·∫£n ph·∫©m</span><span class="view-val">${r.Product}</span></div>
                    <div class="view-row"><span class="view-label">L√Ω do</span><span class="view-val">${r.Reason}</span></div>
                    <div class="view-row"><span class="view-label">T·ªïng gi√° tr·ªã ƒë∆°n</span><span class="view-val">${Number(r.OrderTotal).toLocaleString('vi-VN')}</span></div>
                    <div class="view-row"><span class="view-label">S·ªë ti·ªÅn ho√†n</span><span class="view-val text-red" style="font-size:16px">${Number(r.RefundAmount).toLocaleString('vi-VN')}</span></div>
                </div>
            `;

            if (isOffset) {
                html += `
                <div class="view-section">
                    <div class="view-title">Th√¥ng tin C·∫•n tr·ª´</div>
                    <div class="view-row"><span class="view-label">ƒê∆°n h√†ng m·ªõi</span><span class="view-val">${r.NewOrderID}</span></div>
                    <div class="view-row"><span class="view-label">Gi√° tr·ªã m·ªõi</span><span class="view-val">${Number(r.NewOrderValue).toLocaleString('vi-VN')}</span></div>
                    <div class="view-row"><span class="view-label">Sau KM</span><span class="view-val">${Number(r.NewAfterKM).toLocaleString('vi-VN')}</span></div>
                </div>`;
            } else {
                html += `
                <div class="view-section">
                    <div class="view-title">Thanh to√°n</div>
                    <div class="view-row"><span class="view-label">Ph∆∞∆°ng th·ª©c</span><span class="view-val">${r.RefundMethod}</span></div>
                    <div class="view-row"><span class="view-label">Ng√¢n h√†ng</span><span class="view-val" style="font-size:12px">${bank}</span></div>
                </div>`;
            }
            
            html += `<div class="view-row" style="margin-top:10px"><span class="view-label">Tr·∫°ng th√°i</span><span class="badge badge-refund">${r.Status}</span></div>`;

            document.getElementById('view-content').innerHTML = html;
            document.getElementById('view-modal').classList.add('show');
        }

        function closeViewModal() { document.getElementById('view-modal').classList.remove('show'); }

        // --- EDIT / DELETE / SAVE ---
        function loadEdit(id) {
            const r = __allRows.find(x => x.ID === id);
            if(!r) return;
            __editingId = id;
            const form = document.getElementById('refund-form');
            Object.keys(r).forEach(k => {
                const el = form.querySelector(`[name="${k}"]`);
                if(el) { if(el.type=='checkbox') el.checked=(String(r[k])=='true'); else el.value=r[k]; }
            });
            toggleBank(); toggleOffset(); window.scrollTo({top:0,behavior:'smooth'});
        }

        async function deleteItem(id) {
            if(!confirm('X√≥a phi·∫øu n√†y?')) return;
            await fetch('/api/refunds/delete/'+id, {method:'DELETE'});
            fetchData();
        }

        async function handleSave(alsoPrint) {
    // 1. Validate c∆° b·∫£n
    const orderID = document.getElementById('inp-OrderID').value;
    const refundVal = Number(document.getElementById('inp-RefundAmount').value);
    const orderTotalVal = Number(document.querySelector('[name="OrderTotal"]').value);

    if(!orderID) return alert('Vui l√≤ng nh·∫≠p M√£ ƒë∆°n h√†ng!');
    if(!refundVal) return alert('Vui l√≤ng nh·∫≠p S·ªë ti·ªÅn ho√†n!');

    // 2. [M·ªöI] Validate: Ti·ªÅn ho√†n > Gi√° tr·ªã ƒë∆°n
    // L∆∞u √Ω: Ch·ªâ check n·∫øu OrderTotal > 0 (ƒë·ªÅ ph√≤ng tr∆∞·ªùng h·ª£p ch∆∞a nh·∫≠p gi√° tr·ªã ƒë∆°n)
    if (orderTotalVal > 0 && refundVal > orderTotalVal) {
        return alert(`L·ªñI: S·ªë ti·ªÅn ho√†n (${refundVal.toLocaleString()}) kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n T·ªïng gi√° tr·ªã ƒë∆°n (${orderTotalVal.toLocaleString()})!`);
    }

    const form = document.getElementById('refund-form');
    const data = Object.fromEntries(new FormData(form).entries());
    data.OffsetToNewOrder = document.getElementById('chk-offset-new').checked;
        // ===== AUTO T√çNH TI·ªÄN C·∫§N TR·ª™ =====
    if (data.OffsetToNewOrder === true || data.OffsetToNewOrder === 'true') {
        const oldVal = Number(data.OrderTotal || 0);
        const newAfter = Number(data.NewAfterKM || 0);

        // RefundAmount = ƒê∆°n c≈© - ƒê∆°n m·ªõi sau KM
        data.RefundAmount = oldVal - newAfter;
    }
    // ===== END AUTO =====

    showLoading(true);
    try {
        const url = __editingId ? `/api/refunds/update/${__editingId}` : '/api/refunds/create';
        const res = await fetch(url, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.message);

        alert('L∆∞u th√†nh c√¥ng!');
        const id = __editingId || json.id;
        
        resetForm();
        await fetchData(); // ƒê·ª£i load l·∫°i d·ªØ li·ªáu ƒë·ªÉ c√≥ th√¥ng tin m·ªõi nh·∫•t cho vi·ªác in

        if (alsoPrint) openPrint(id);
    } catch(e) { 
        alert(e.message); 
    } finally { 
        showLoading(false);
    }
}

        function resetForm() {
            document.getElementById('refund-form').reset();
            __editingId = null;
            document.querySelector('[name="RequestDate"]').value = new Date().toISOString().slice(0,10);
            toggleBank(); toggleOffset();
        }

        function openPrint(id) { 
    // 1. Ki·ªÉm tra c·∫•u h√¨nh c·ªôt
    if (!selectedPrintCols || selectedPrintCols.length === 0) {
        alert('B·∫°n ch∆∞a ch·ªçn c·ªôt n√†o ƒë·ªÉ in!');
        return;
    }

    // 2. T√¨m d·ªØ li·ªáu phi·∫øu
    const r = __allRows.find(x => x.ID === id);
    if (!r) return;

    // 3. T·∫°o b·∫£n sao danh s√°ch c·ªôt ƒë·ªÉ x·ª≠ l√Ω
    let colsToSend = [...selectedPrintCols];
    
    // Ki·ªÉm tra lo·∫°i phi·∫øu
    const isOffset = String(r.OffsetToNewOrder).toLowerCase() === 'true';

    if (isOffset) {
        // === LOGIC CHO PHI·∫æU C·∫§N TR·ª™ ===
        
        // a. Lo·∫°i b·ªè c√°c c·ªôt kh√¥ng d√πng cho c·∫•n tr·ª´
        colsToSend = colsToSend.filter(col => !['Bank', 'RefundMethod', 'ApprovedBy'].includes(col));

        // b. T·ª± ƒë·ªông TH√äM c√°c c·ªôt c·∫•n tr·ª´ quan tr·ªçng (n·∫øu ch∆∞a c√≥)
        const offsetCols = ['NewOrderID', 'NewOrderValue', 'NewAfterKM', 'SRApprover'];
        offsetCols.forEach(col => {
            if (!colsToSend.includes(col)) colsToSend.push(col);
        });

    } else {
        // === LOGIC CHO PHI·∫æU HO√ÄN TI·ªÄN TH∆Ø·ªúNG ===
        
        // N·∫øu l√† Ti·ªÅn m·∫∑t -> B·ªè c·ªôt Bank
        if (r.RefundMethod === 'Ti·ªÅn m·∫∑t') {
            colsToSend = colsToSend.filter(col => col !== 'Bank');
        }
        // ƒê·∫£m b·∫£o c√≥ c·ªôt Ng∆∞·ªùi duy·ªát th∆∞·ªùng
        if (!colsToSend.includes('ApprovedBy')) colsToSend.push('ApprovedBy');
    }

    // 4. M·ªü trang in
    const colsParam = colsToSend.join(',');
    window.open(`/refunds/print/${id}?cols=${colsParam}`, '_blank');
}
        // --- PRINT COLS MODAL ---
        function openPrintColsModal() {
    const list = document.getElementById('printcols-list');

    list.innerHTML = ALL_COLUMNS.map(col => `
        <div class="sortable-item">
            <span class="drag-handle">‚ò∞</span>
            <label style="flex:1">
                <input type="checkbox" value="${col.key}"
                    ${selectedPrintCols.includes(col.key) ? 'checked' : ''}>
                ${col.label}
            </label>
        </div>
    `).join('');

    // K√âO TH·∫¢
    new Sortable(list, {
        animation: 150,
        handle: '.drag-handle'
    });

    document.getElementById('printcols-modal').classList.add('show');
}



        function closePrintColsModal() { document.getElementById('printcols-modal').classList.remove('show'); }
        function applyPrintCols() {
            const checks = document.querySelectorAll('#printcols-list input:checked');
            selectedPrintCols = Array.from(checks).map(c => c.value);
            closePrintColsModal();
        }

        function toggleBank() {
            const v = document.getElementById('refund-method').value;
            const show = /chuy·ªÉn|qr|v√≠/i.test(v);
            document.getElementById('bank-section').classList.toggle('hidden', !show);
        }
        function toggleOffset() {
            const chk = document.getElementById('chk-offset-new');
            document.getElementById('offset-section').classList.toggle('hidden', !chk.checked);
        }
    </script>
</body>
</html>
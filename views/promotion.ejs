<%- include('partials/header', {title: 'CTKM theo SKU' , currentPage: 'promotion' , time: time}) %>

<style>

 <style>
/* --- [FIX FINAL] SEARCH BLOCK (S·ª¨A L·ªñI TR√ÄN VI·ªÄN + HI·ªÜN G·ª¢I √ù) --- */
    .modern-search-wrapper {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.08); 
        
        /* [THAY ƒê·ªîI QUAN TR·ªåNG] D√πng border th·∫≠t thay v√¨ ::before */
        border: 1px solid #e2e8f0;
        border-left: 5px solid #2563eb; /* ƒê∆∞·ªùng xanh t√≠ch h·ª£p v√†o vi·ªÅn */
        
        padding: 24px;
        margin-bottom: 25px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        position: relative;
        
        /* ƒê·∫£m b·∫£o dropdown hi·ªán l√™n tr√™n */
        z-index: 50; 
    }

    /* [QUAN TR·ªåNG] X√ìA b·ªè ƒëo·∫°n .modern-search-wrapper::before c≈© ƒëi */
    /* .modern-search-wrapper::before { ... } -> KH√îNG C·∫¶N N·ªÆA */

    .ms-title {
        font-family: 'Be Vietnam Pro', sans-serif;
        font-size: 18px; 
        font-weight: 800; 
        color: #1e293b;
        margin: 0;
        display: flex; align-items: center; gap: 10px;
    }

    .ms-form {
        display: flex; gap: 10px; align-items: center; width: 100%;
        position: relative; /* Neo dropdown */
    }

    .ms-input-group {
        flex-grow: 1; 
        position: relative;
        /* ƒê·∫£m b·∫£o √¥ input n·∫±m tr√™n layer n·ªÅn */
        z-index: 51; 
    }

    /* Dropdown g·ª£i √Ω */
    .autocomplete-results {
        position: absolute;
        top: 100%; /* Hi·ªán ngay d∆∞·ªõi √¥ input */
        left: 0;
        width: 100%;
        background: #fff;
        border: 1px solid #cbd5e1;
        border-top: none;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
        /* ƒê·ªï b√≥ng ƒë·∫≠m h∆°n ƒë·ªÉ n·ªïi b·∫≠t tr√™n n·ªÅn tr·∫Øng */
        box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15);
        /* Z-index cao nh·∫•t ƒë·ªÉ ƒë√® l√™n m·ªçi th·ª© b√™n d∆∞·ªõi */
        z-index: 9999; 
        max-height: 300px;
        overflow-y: auto;
    }
    
    .autocomplete-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
        color: #334155;
        transition: background 0.1s;
    }
    .autocomplete-item:hover {
        background-color: #f0f9ff;
        color: #2563eb;
    }
    
    /* ... Gi·ªØ nguy√™n c√°c class .ms-input, .ms-btn, .ms-icon c≈© ... */
    .ms-input {
        width: 100%;
        height: 48px;
        padding: 0 15px 0 45px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 15px;
        font-family: 'Inter', sans-serif;
        color: #0f172a;
        background: #f8fafc;
        transition: all 0.2s ease;
    }
    .ms-input:focus {
        outline: none; background: #fff; border-color: #2563eb;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    .ms-icon {
        position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
        font-size: 18px; color: #64748b; pointer-events: none;
    }
    .ms-btn {
        height: 48px; padding: 0 24px; background: #2563eb; color: #fff;
        border: none; border-radius: 8px; font-weight: 700; font-family: 'Be Vietnam Pro', sans-serif;
        font-size: 14px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        white-space: nowrap;
    }
    .ms-btn:hover { background: #1d4ed8; transform: translateY(-1px); }
    @media (max-width: 600px) {
        .ms-form { flex-direction: column; gap: 12px; }
        .ms-input-group, .ms-btn { width: 100%; }
    }
/* --- VOUCHER TICKET CARD (SEARCH PAGE) --- */
.voucher-tear {
    background: linear-gradient(to right, #eff6ff, #f0f9ff);
    border: 1px dashed #60a5fa;
    border-radius: 8px;
    padding: 12px 15px;
    margin-top: 10px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    /* T·∫°o kho·∫£ng c√°ch an to√†n 2 b√™n ƒë·ªÉ kh√¥ng b·ªã c·∫Øt ch·ªØ */
    margin-left: 6px;
    margin-right: 6px;
}

/* T·∫°o hi·ªáu ·ª©ng l√µm tr√≤n (X√©) b√™n tr√°i */
.voucher-tear::before {
    content: "";
    position: absolute;
    top: 50%;
    left: -7px; /* ƒê·∫©y ra m√©p tr√°i */
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    background: #fff; /* M√†u tr√πng v·ªõi n·ªÅn card m·∫π */
    border-radius: 50%;
    border-right: 1px dashed #60a5fa; /* Vi·ªÅn tr√πng v·ªõi voucher */
    box-shadow: inset -1px 0 2px rgba(0,0,0,0.05);
}

/* T·∫°o hi·ªáu ·ª©ng l√µm tr√≤n (X√©) b√™n ph·∫£i */
.voucher-tear::after {
    content: "";
    position: absolute;
    top: 50%;
    right: -7px; /* ƒê·∫©y ra m√©p ph·∫£i */
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    background: #fff;
    border-radius: 50%;
    border-left: 1px dashed #60a5fa;
    box-shadow: inset 1px 0 2px rgba(0,0,0,0.05);
}

.vt-label {
    font-size: 10px;
    text-transform: uppercase;
    color: #64748b;
    font-weight: 700;
    margin-bottom: 2px;
}

.vt-value {
    font-size: 18px;
    font-weight: 800;
    color: #2563eb;
    line-height: 1.2;
}

.vt-code {
    font-family: monospace;
    background: #fff;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #bfdbfe;
    color: #1e40af;
    font-weight: 700;
    font-size: 12px;
}




    /* --- CSS M·ªöI CHO GIFT/COMBO GROUP --- */
.promo-extras-container {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c Option */
}

.option-group {
    border: 1px dashed #cbd5e1;
    background: #f8fafc;
    border-radius: 8px;
    padding: 8px 10px;
    position: relative;
}

.option-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 700;
    color: #475569;
}

.option-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    color: #fff;
    text-transform: uppercase;
}
.badge-gift { background: #f97316; }   /* M√†u cam cho Qu√† */
.badge-combo { background: #7c3aed; }  /* M√†u t√≠m cho Combo */

.gift-row-compact {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    font-size: 13px;
    color: #334155;
    margin-top: 4px;
}/* --- CSS M·ªöI CHO GIFT/COMBO GROUP --- */
.promo-extras-container {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c Option */
}

.option-group {
    border: 1px dashed #cbd5e1;
    background: #f8fafc;
    border-radius: 8px;
    padding: 8px 10px;
    position: relative;
}

.option-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 12px;
    font-weight: 700;
    color: #475569;
}

.option-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    color: #fff;
    text-transform: uppercase;
}
.badge-gift { background: #f97316; }   /* M√†u cam cho Qu√† */
.badge-combo { background: #7c3aed; }  /* M√†u t√≠m cho Combo */

.gift-row-compact {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    font-size: 13px;
    color: #334155;
    margin-top: 4px;
}

    /* --- [M·ªöI] MODERN COMPACT SEARCH BAR --- */
    .modern-search-wrapper {
        background: #fff;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
    }
    .ms-title {
        font-size: 16px; font-weight: 700; color: #1e293b;
        white-space: nowrap; margin: 0;
        display: flex; align-items: center; gap: 8px;
    }
    .ms-form {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0; /* Override c≈© */
    }
    .ms-input-group {
        flex-grow: 1;
        position: relative;
    }
    .ms-input {
        width: 100%;
        padding: 10px 15px 10px 40px; /* Ch·ª´a ch·ªó cho icon */
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s;
        outline: none;
        background: #f8fafc;
    }
    .ms-input:focus {
        border-color: #3b82f6;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .ms-icon {
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        color: #64748b; font-size: 16px;
    }
    .ms-btn {
        background: #2563eb; color: #fff;
        border: none; padding: 10px 20px;
        border-radius: 8px; font-weight: 600; font-size: 14px;
        cursor: pointer; transition: background 0.2s;
        white-space: nowrap;
        height: 42px; /* ƒê·ªìng b·ªô chi·ªÅu cao */
    }
    .ms-btn:hover { background: #1d4ed8; }

    @media (max-width: 768px) {
        .modern-search-wrapper { flex-direction: column; align-items: stretch; gap: 15px; }
        .ms-form { width: 100%; }
    }




    /* --- [M·ªöI] MODERN HISTORY BANNER --- */
    .history-banner {
        background-color: #f0f9ff; /* N·ªÅn xanh d∆∞∆°ng nh·∫°t hi·ªán ƒë·∫°i */
        border: 1px solid #bae6fd; /* Vi·ªÅn xanh nh·∫π */
        border-radius: 12px;
        padding: 15px 20px;
        margin: 20px 0; /* Kho·∫£ng c√°ch tr√™n d∆∞·ªõi */
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .history-banner .info-group { display: flex; align-items: center; gap: 12px; }
    .history-banner .icon-box { 
        width: 40px; height: 40px; background: #fff; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 20px; color: #0284c7; border: 1px solid #e0f2fe;
    }
    .history-banner .title-text { color: #0c4a6e; font-weight: 700; font-size: 15px; margin: 0; }
    .history-banner .count-badge { 
        background: #0ea5e9; color: white; padding: 3px 10px; border-radius: 20px; 
        font-weight: 700; font-size: 13px; margin-left: 8px; display: inline-block;
    }
    .history-banner .btn-view-modern {
        background: #fff; color: #0284c7; padding: 10px 18px; border-radius: 8px; 
        font-weight: 600; text-decoration: none; transition: all .2s;
        border: 1px solid #0284c7; display: inline-flex; align-items: center; gap: 6px; font-size: 14px;
    }
    .history-banner .btn-view-modern:hover { background: #0284c7; color: white; }
    @media (max-width: 600px) {
        .history-banner { flex-direction: column; align-items: flex-start; gap: 10px; }
        .history-banner .btn-view-modern { width: 100%; justify-content: center; }
    }

    /* --- CSS CHUNG --- */
    .promotion-container { max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; min-height: 100vh; }
    .page-search { margin-bottom: 20px; }
    
    /* SEARCH SECTION */
    .search-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); border: 1px solid #e9ecef; }
    .search-form { display: flex; gap: 10px; align-items: flex-end; }
    .form-group { flex: 1; }
    .form-group label { font-weight: 600; font-size: 14px; color: #475569; margin-bottom: 5px; display: block; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: .2s; }
    .form-group input:focus { border-color: #3b82f6; outline: none; }
    .btn-search { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; height: 48px; }
    .btn-search:hover { background: #2563eb; }

    /* --- [NEW UI] PRODUCT DASHBOARD CARD --- */
    .product-dashboard-card {
        background: #fff; border-radius: 16px; overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
        margin-bottom: 25px;
    }
    .pd-header {
        /* [FIX] ƒê·ªïi sang gradient xanh d∆∞∆°ng ch·ªß ƒë·∫°o */
        background: linear-gradient(135deg, #2664eb 0%, #2664eb 100%);
        padding: 16px 20px; color: #fff; display: flex; justify-content: space-between; align-items: center;
    }
    .pd-header h2 { margin: 0; font-size: 16px; font-weight: 700; color: #fff; }
    .pd-body { padding: 20px; }
    
    .pd-grid { display: grid; grid-template-columns: 2fr 3fr; gap: 25px; }
    @media (max-width: 768px) { .pd-grid { grid-template-columns: 1fr; } }

    .pd-info-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #e2e8f0; font-size: 14px; }
    .pd-info-row:last-child { border-bottom: none; }
    .pd-label { color: #64748b; font-weight: 500; }
    .pd-value { color: #1e293b; font-weight: 700; text-align: right; }
    
    .pd-price-box {
        background: #f8fafc; padding: 15px; border-radius: 12px; text-align: center; margin-top: 15px;
        border: 1px solid #e2e8f0;
    }
    .pd-main-price { font-size: 22px; color: #dc2626; font-weight: 800; display: block; }
    
    /* --- STOCK PILLS UI (User th∆∞·ªùng) --- */
    /* Chia 3 c·ªôt, t·ª± xu·ªëng d√≤ng ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªß 5 lo·∫°i kho */
    .stock-mini-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 8px; 
        margin-top: 10px; 
    }
    .stock-pill {
        background: #f1f5f9; padding: 8px; border-radius: 8px; text-align: center;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 1px solid transparent;
    }
    .stock-pill.active { background: #ecfdf5; border-color: #a7f3d0; }
    .stock-pill .num { font-size: 16px; font-weight: 800; color: #0f172a; line-height: 1.2; }
    .stock-pill.active .num { color: #059669; }
    .stock-pill .lbl { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 600; margin-top: 2px; white-space: nowrap; }

    /* --- ADMIN STOCK TABLE (Admin/Manager) --- */
    .admin-stock-wrapper {
        border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-top: 10px;
    }
    .admin-stock-header {
        background: #f1f5f9; padding: 8px 10px; font-size: 11px; font-weight: 700; color: #475569;
        /* Grid 6 c·ªôt: T√™n CN + 5 lo·∫°i kho */
        display: grid; grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr; gap: 4px; text-align: right;
    }
    .admin-stock-header div:first-child { text-align: left; }
    
    .admin-stock-list { max-height: 250px; overflow-y: auto; }
    .admin-stock-row {
        display: grid; grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr; gap: 4px; 
        padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; color: #334155; text-align: right;
    }
    .admin-stock-row:last-child { border-bottom: none; }
    .admin-stock-row div:first-child { text-align: left; font-weight: 600; color: #0f172a; }
    .zero-muted { color: #e2e8f0; font-weight: 400; } /* S·ªë 0 l√†m m·ªù h·∫≥n */

    /* PROMO CARDS */
    .promo-blocks-container { display: flex; flex-direction: column; gap: 20px; }
    .block-hot-wrapper { background-color: #fff1f2; border: 1px solid #fecaca; border-radius: 12px; padding: 20px; }
    .block-title-hot { color: #b91c1c; font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .block-std-wrapper { background-color: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; }
    .block-title-std { color: #1e40af; font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

    .promo-card-item {
        background: #fff; border-radius: 8px; padding: 14px 16px; margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
        display: flex; flex-direction: column;
    }
    .promo-card-item:last-child { margin-bottom: 0; }
    
    .p-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 6px; }
    .p-title { font-weight: 700; color: #333; font-size: 15px; line-height: 1.4; }
    .p-badge { background: #dc2626; color: #fff; font-weight: 700; font-size: 13px; padding: 4px 8px; border-radius: 4px; white-space: nowrap; }
    .p-desc { font-size: 13px; color: #64748b; margin-top: 0px; line-height: 1.4; }
    .p-link { font-size: 13px; color: #2563eb; text-decoration: underline; margin-top: 8px; cursor: pointer; display: inline-block; font-weight: 500;}

    /* EXTRA SKU (Gift/Combo) */
    .promo-extras { margin-top: 10px; padding-top: 8px; border-top: 1px dashed #e2e8f0; }
    .gift-row { 
        display: flex; align-items: center; gap: 8px; background: #fff7ed; 
        padding: 6px 10px; border-radius: 6px; font-size: 13px; color: #9a3412; margin-top: 5px;
        border: 1px solid #ffedd5;
    }
    .gift-badge { background: #f97316; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
    .stock-badge { background: #fff; border: 1px solid #9a3412; color: #9a3412; font-size: 11px; padding: 1px 6px; border-radius: 99px; margin-left: auto; font-weight: 700; }
    .stock-badge.zero { border-color: #9ca3af; color: #9ca3af; background: #f3f4f6; }

    /* COMPATIBILITY TAGS */
    .compat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; font-size: 12px; }
    .compat-tag { padding: 4px 8px; border-radius: 4px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .compat-tag.allow { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .compat-tag.deny { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    /* BUTTONS */
    .copy-btn { background: #f1f5f9; border: 1px dashed #94a3b8; color: #334155; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 6px; display: inline-block; }
    .no-data { text-align: center; padding: 40px; color: #94a3b8; font-style: italic; }
    .error-message { background: #fef2f2; color: #991b1b; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fecaca; }
    
    /* --- PRICE SUMMARY (SOFT STYLE) --- */
    .price-summary { 
        background: #f8fafc; /* N·ªÅn x√°m r·∫•t nh·∫°t */
        padding: 20px 25px; 
        border-radius: 12px; 
        margin-top: 25px; 
        border: 1px solid #e2e8f0; /* Vi·ªÅn x√°m nh·∫π */
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    
    .summary-item { 
        display: flex; 
        justify-content: space-between; 
        padding: 10px 0; 
        border-bottom: 1px dashed #cbd5e1; /* ƒê∆∞·ªùng k·∫ª ƒë·ª©t n√©t m√†u x√°m */
        color: #334155; /* M√†u ch·ªØ x√°m ƒë·∫≠m */
        font-size: 14px; 
    }
    
    .summary-item:last-child { 
        border-bottom: none; 
    }
    
    .final-price { 
        font-size: 22px; 
        font-weight: 800; 
        color: #dc2626; /* Gi√° cu·ªëi v·∫´n gi·ªØ ƒë·ªè ƒë·ªÉ d·ªÖ nh√¨n */
        border-top: 2px solid #e2e8f0; /* ƒê∆∞·ªùng k·∫ª tr√™n ƒë·∫≠m h∆°n ch√∫t */
        margin-top: 10px; 
        padding-top: 15px; 
    }


    /* Badge KFI n·ªïi b·∫≠t */
.kfi-block {
    display: inline-flex;
    align-items: center;
    background: #fff0f6; /* N·ªÅn h·ªìng ph·∫•n */
    border: 1px solid #ffadd2;
    border-radius: 6px;
    padding: 6px 10px;
    margin: 10px 0;
    font-family: 'Be Vietnam Pro', sans-serif;
    box-shadow: 0 2px 4px rgba(255, 105, 180, 0.15);
}
.kfi-icon { font-size: 18px; margin-right: 8px; }
.kfi-content { display: flex; align-items: center; gap: 15px; }
.kfi-item { display: flex; flex-direction: column; }
.kfi-label { font-size: 10px; text-transform: uppercase; color: #999; font-weight: 600; letter-spacing: 0.5px; }
.kfi-value { font-size: 15px; font-weight: 700; color: #d93025; }
.kfi-sep { width: 1px; height: 25px; background: #ffadd2; }

/* Badge t√≠nh ti·ªÅn ∆∞u ƒë√£i thanh to√°n */
.pay-discount-tag {
    background: #e8f0fe; 
    color: #1967d2; 
    font-weight: 700; 
    font-size: 12px; 
    padding: 2px 6px; 
    border-radius: 4px; 
    margin-left: 5px;
}

/* Badge hi·ªÉn th·ªã s·ªë ti·ªÅn gi·∫£m ∆∞u ƒë√£i thanh to√°n */
.pay-discount-tag {
    display: inline-block;
    background-color: #e8f0fe; /* N·ªÅn xanh nh·∫°t Google */
    color: #1a73e8;            /* Ch·ªØ xanh ƒë·∫≠m */
    font-weight: 700;
    font-size: 13px;
    padding: 2px 8px;
    border-radius: 4px;
    margin-left: 8px;          /* C√°ch t√™n ∆∞u ƒë√£i m·ªôt ch√∫t */
    vertical-align: middle;
}

/* --- BADGE M√ÄU XANH (CHO ∆ØU ƒê√ÉI THANH TO√ÅN) --- */
.p-badge-blue {
    background: #2563eb; /* M√†u xanh d∆∞∆°ng Google */
    color: #fff;
    font-weight: 700;
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap; /* Kh√¥ng xu·ªëng d√≤ng */
    display: inline-block;}
/* --- NEW KFI PREMIUM STYLE --- */


/* --- KFI POINT BAR (BLUE THEME) --- */
.kfi-point-bar {
    background: #f0f9ff; /* N·ªÅn xanh si√™u nh·∫°t (g·∫ßn nh∆∞ tr·∫Øng) */
    border: 1px solid #bae6fd; /* Vi·ªÅn xanh d∆∞∆°ng nh·∫°t */
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 5px rgba(14, 165, 233, 0.1); /* B√≥ng xanh nh·∫π */
}

/* Ph·∫ßn ti√™u ƒë·ªÅ b√™n tr√°i */
.kfi-pb-left {
    display: flex; align-items: center; gap: 8px;
    font-weight: 800; 
    color: #0369a1; /* M√†u xanh ƒë·∫≠m (thay v√¨ v√†ng) */
    font-size: 13px; 
    text-transform: uppercase;
    white-space: nowrap;
}

/* Ph·∫ßn s·ªë li·ªáu b√™n ph·∫£i */
.kfi-pb-right {
    display: flex; align-items: center; gap: 20px;
}

.kfi-p-item {
    display: flex; align-items: baseline; gap: 5px;
    font-size: 12px; 
    color: #334155; /* Text m√†u ƒëen x√°m (chu·∫©n d·ªÖ ƒë·ªçc) */
    font-weight: 600;
}

.kfi-p-num {
    font-family: sans-serif;
    font-size: 15px;
    font-weight: 800;
    color: #0284c7; /* S·ªë m√†u xanh d∆∞∆°ng n·ªïi b·∫≠t */
}

/* --- CSS CHO COMBO SLIDER & MODAL --- */
.combo-slider-container {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding-bottom: 5px;
    scrollbar-width: thin; /* Firefox */
    -webkit-overflow-scrolling: touch;
}
.combo-slider-container::-webkit-scrollbar { height: 4px; }
.combo-slider-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

.mini-sku-card {
    min-width: 110px;
    max-width: 110px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: #fff;
    padding: 6px;
    font-size: 10px;
    flex-shrink: 0; /* Kh√¥ng b·ªã co l·∫°i */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.mini-sku-img { width: 100%; height: 80px; object-fit: contain; background: #f8fafc; border-radius: 4px; margin-bottom: 4px; }
.mini-sku-code { font-weight: bold; color: #333; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mini-sku-price { color: #d97706; font-weight: 700; margin-top: auto; }

/* Modal Styles */
#comboModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
#comboModalContent { 
    background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; 
    border-radius: 8px; max-height: 80vh; overflow-y: auto; position: relative;
}
.grid-view-modal { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
.no-img-box {
        width: 100%;
        height: 80px;
        background: #f1f5f9;
        color: #334155;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 5px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
        line-height: 1.2;
        border: 1px solid #e2e8f0;
        margin-bottom: 4px;
        overflow: hidden;
    }

    /* CSS cho d√≤ng highlight gi·∫£m gi√° */
    .highlight-discount {
        background: #ffe4e6;
        color: #e11d48;
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        padding: 2px 4px;
        border-radius: 3px;
        margin-top: 2px;
        border: 1px dashed #fda4af;
    }

/* --- CSS FIX L·ªñI N√öT SLIDER (D√ÅN ƒê√à C≈®) --- */

/* 1. Khung bao quanh: D√πng Padding ƒë·ªÉ t·∫°o ch·ªó tr√∫ cho 2 n√∫t */
.slider-wrapper {
    position: relative; /* QUAN TR·ªåNG: L√†m g·ªëc to·∫° ƒë·ªô */
    width: 100%;
    /* D√†nh ra 32px m·ªói b√™n ƒë·ªÉ ƒë·∫∑t n√∫t, ƒë·∫£m b·∫£o n√∫t n·∫±m TRONG khung n√†y */
    padding: 0 32px; 
    box-sizing: border-box; /* T√≠nh padding v√†o ƒë·ªô r·ªông t·ªïng */
}

/* 2. Khung ch·ª©a s·∫£n ph·∫©m: ·∫®n thanh cu·ªôn */
.combo-slider-container {
    display: flex;
    overflow-x: auto; /* Cho ph√©p tr∆∞·ª£t */
    gap: 10px;
    padding: 5px 0;
    
    /* ·∫®n thanh scrollbar x·∫•u x√≠ */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE */
    scroll-behavior: smooth;
}
.combo-slider-container::-webkit-scrollbar { 
    display: none; /* Chrome/Safari */ 
}

/* 3. N√∫t b·∫•m: Neo s√°t v√†o l·ªÅ tr√°i/ph·∫£i (trong v√πng padding ƒë√£ t·∫°o) */
.nav-btn {
    position: absolute; /* Neo theo slider-wrapper */
    top: 50%;
    transform: translateY(-50%); /* CƒÉn gi·ªØa chi·ªÅu d·ªçc */
    width: 28px;
    height: 28px;
    
    background: #fff;
    border: 1px solid #cbd5e1;
    border-radius: 50%;
    
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    
    color: #334155;
    font-size: 14px;
    font-weight: bold;
    user-select: none;
    transition: all 0.2s;
}

.nav-btn:hover {
    background: #eff6ff;
    color: #2563eb;
    border-color: #60a5fa;
    box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
}

/* ƒê·∫∑t to·∫° ƒë·ªô 0 ƒë·ªÉ n√≥ n·∫±m s√°t m√©p trong c·ªßa wrapper */
.nav-prev { left: 0; } 
.nav-next { right: 0; }



.mini-stock-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 9px;
    font-weight: 700;
    background: rgba(255, 255, 255, 0.95);
    padding: 1px 5px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    color: #059669; /* M√†u xanh l√° */
    z-index: 5;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.mini-stock-badge.out-stock { color: #dc2626; border-color: #fecaca; } /* H·∫øt h√†ng m√†u ƒë·ªè */

.mini-sku-card { position: relative; } /* ƒê·ªÉ neo badge t·ªìn */
.tier-badge {
        flex: 1;
        font-size: 10px;
        text-align: center;
        background: #fff;
        border: 1px solid #fed7aa;
        padding: 4px 2px;
        border-radius: 4px;
        color: #c2410c;
        line-height: 1.3;
    }

</style>

<div class="promotion-container">
    <% if (typeof error !=='undefined' && error) { %>
        <div class="error-message">‚ö†Ô∏è <%= error %></div>
    <% } %>

    <div class="page-search">
        <div class="modern-search-wrapper">
            <h1 class="ms-title">üîç Tra c·ª©u CTKM</h1>
            <form action="/search-promotion" method="POST" class="search-form ms-form" id="searchForm">
                <div class="ms-input-group">
                    <span class="ms-icon">‚å®Ô∏è</span>
                    <input type="text" id="skuSearch" name="sku" class="ms-input" autocomplete="off" 
                           placeholder="Nh·∫≠p m√£ SKU s·∫£n ph·∫©m..." 
                           value="<%= typeof product !== 'undefined' && product ? product.sku : '' %>">
                    <div class="autocomplete-results" id="autocompleteResults"></div> 
                </div>
                <button type="submit" class="ms-btn">T√¨m ki·∫øm</button>
            </form>
        </div>
    </div>

    <% if (internalContest) { %>
        <div class="internal-contest-card">
            <div class="contest-icon">üèÜ</div>
            <div class="contest-content">
                <div class="contest-title"><%= internalContest.name %></div>
                <% if (internalContest.description) { %> <p class="contest-desc"><%= internalContest.description %></p> <% } %>
                <div class="contest-expiry">H·∫°n: <%= new Date(internalContest.end_date).toLocaleDateString('vi-VN') %></div>
            </div>
            <a href="/promotion-detail/<%= internalContest.id %>" class="contest-link">Xem</a>
        </div>
    <% } %>

    <% if (typeof product !=='undefined' && product) { %>
        <div class="product-dashboard-card">
            <div class="pd-header">
                <h2>üì¶ Th√¥ng tin s·∫£n ph·∫©m</h2>
                <span style="font-family: monospace; font-size: 15px; font-weight: 700; color: #fff; background: rgba(255,255,255,0.25); padding: 5px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); letter-spacing: 0.5px;">
    SKU: <%= product.sku %>
</span>
            </div>
            <div class="pd-body">
                <div class="pd-grid">
                    <div>
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; line-height: 1.4;"><%= product.product_name %></h3>
                        <div class="pd-info-row"><span class="pd-label">Th∆∞∆°ng hi·ªáu</span> <span class="pd-value"><%= product.brand %></span></div>
                        <div class="pd-info-row"><span class="pd-label">Nh√≥m h√†ng</span> <span class="pd-value"><%= product.subcat %></span></div>
                        <% if (product.kfi_end_user > 0 || product.kfi_dealer > 0) { %>
    
    <% 
        // Logic l·∫•y th√°ng hi·ªán t·∫°i
        const d = new Date();
        const currentMonth = d.getMonth() + 1;
        const monthStr = currentMonth < 10 ? '0' + currentMonth : currentMonth;
    %>

    <div class="kfi-point-bar">
        <div class="kfi-pb-left">
            <span>üíé</span> KFI TH√ÅNG <%= monthStr %>
        </div>

        <div class="kfi-pb-right">
            <% if (product.kfi_end_user > 0) { %>
                <div class="kfi-p-item">
                    <span>User:</span>
                    <span class="kfi-p-num"><%= Number(product.kfi_end_user).toLocaleString('vi-VN') %></span>
                </div>
            <% } %>

            <% if (product.kfi_end_user > 0 && product.kfi_dealer > 0) { %>
                <div style="width:1px; height:14px; background:#bfdbfe;"></div>
            <% } %>

            <% if (product.kfi_dealer > 0) { %>
                <div class="kfi-p-item">
                    <span>Dealer:</span>
                    <span class="kfi-p-num"><%= Number(product.kfi_dealer).toLocaleString('vi-VN') %></span>
                </div>
            <% } %>
        </div>
    </div>
<% } %>
                        
                        <div class="pd-price-box">
                            <span style="font-size: 12px; color: #64748b;">Gi√° ni√™m y·∫øt</span>
                            <span id="priceView" class="pd-main-price">
                                <%= product.list_price ? new Intl.NumberFormat('vi-VN').format(product.list_price) + ' ƒë' : 'N/A' %>
                            </span>
                            <div style="margin-top: 8px;">
                                <button id="btnEditPrice" type="button" style="font-size: 12px; padding: 4px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:6px; cursor:pointer;">‚úèÔ∏è S·ª≠a gi√°</button>
                                <button id="btnHistoryPrice" type="button" style="font-size: 12px; padding: 4px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:6px; cursor:pointer; margin-left:5px;">üïò L·ªãch s·ª≠</button>
                            </div>
                            <span id="priceEdit" style="display:none; margin-top:8px;">
                                <input id="priceInput" type="text" value="<%= product.list_price ? new Intl.NumberFormat('vi-VN').format(product.list_price) : '0' %>" style="width:100px; padding:6px; border:1px solid #cbd5e1; border-radius:4px;">
                                <button id="btnSavePrice" style="padding:6px 10px; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;">L∆∞u</button> 
                                <button id="btnCancelPrice" style="padding:6px 10px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer;">H·ªßy</button>
                            </span>
                        </div>
                    </div>
    
                    <div>
                        <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin && inventoryMap && inventoryMap.get(product.sku)) { %>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <strong style="color:#0f172a; font-size:14px;">üì¶ T·ªìn kho h·ªá th·ªëng (Admin)</strong>
                                <span style="font-size:11px; color:#64748b;">(ƒê√£ tr·ª´ serial ƒë√£ xu·∫•t)</span>
                            </div>
                            
                            <div class="admin-stock-wrapper">
                                <div class="admin-stock-header">
                                    <div>Chi nh√°nh</div>
                                    <div>B√°n m·ªõi</div>
                                    <div>TB Cƒê</div>
                                    <div>L∆∞u TL</div>
                                    <div>TB TL</div>
                                    <div>Kh√°c</div>
                                </div>
                                <div class="admin-stock-list">
                                    <% const branchMap = inventoryMap.get(product.sku); %>
                                    <% if (branchMap && branchMap.size > 0) { %>
                                        <% [...branchMap.keys()].sort().forEach(branchId => { %>
                                            <% const counts = branchMap.get(branchId); %>
                                            <div class="admin-stock-row">
                                                <div><%= branchId %></div>
                                                <div class="<%= counts.hang_ban_moi === 0 ? 'zero-muted' : '' %>">
                                                    <strong><%= counts.hang_ban_moi %></strong>
                                                </div>
                                                <div class="<%= counts.trung_bay_chi_dinh === 0 ? 'zero-muted' : '' %>">
                                                    <%= counts.trung_bay_chi_dinh %>
                                                </div>
                                                <div class="<%= counts.luu_kho_tl === 0 ? 'zero-muted' : '' %>">
                                                    <%= counts.luu_kho_tl %>
                                                </div>
                                                <div class="<%= counts.trung_bay_tl === 0 ? 'zero-muted' : '' %>">
                                                    <%= counts.trung_bay_tl %>
                                                </div>
                                                <div class="<%= counts.ton_khac === 0 ? 'zero-muted' : '' %>">
                                                    <%= counts.ton_khac %>
                                                </div>
                                            </div>
                                        <% }); %>
                                    <% } else { %>
                                        <div style="padding:10px; text-align:center; font-size:13px; color:#64748b;">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho.</div>
                                    <% } %>
                                </div>
                            </div>

                        <% } else if (typeof inventoryCounts !== 'undefined' && inventoryCounts) { %>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <strong style="color:#0f172a; font-size:14px;">T·ªìn kho: <%= userBranch %></strong>
                                <span style="font-size:11px; color:#64748b;">(ƒê√£ tr·ª´ serial ƒë√£ xu·∫•t)</span>
                            </div>
                            <div class="stock-mini-grid">
                                <div class="stock-pill <%= inventoryCounts.hang_ban_moi > 0 ? 'active' : '' %>">
                                    <span class="num"><%= inventoryCounts.hang_ban_moi %></span>
                                    <span class="lbl">B√°n m·ªõi</span>
                                </div>
                                <div class="stock-pill <%= inventoryCounts.trung_bay_chi_dinh > 0 ? 'active' : '' %>">
                                    <span class="num"><%= inventoryCounts.trung_bay_chi_dinh %></span>
                                    <span class="lbl">TB Cƒê</span>
                                </div>
                                <div class="stock-pill" style="opacity: 0.9;">
                                    <span class="num"><%= inventoryCounts.luu_kho_tl %></span>
                                    <span class="lbl">LK TL</span>
                                </div>
                                <div class="stock-pill" style="opacity: 0.9;">
                                    <span class="num"><%= inventoryCounts.trung_bay_tl %></span>
                                    <span class="lbl">TB TL</span>
                                </div>
                                <div class="stock-pill" style="opacity: 0.7;">
                                    <span class="num"><%= inventoryCounts.ton_khac %></span>
                                    <span class="lbl">Kh√°c</span>
                                </div>
                            </div>

                        <% } else { %>
                            <div class="no-data" style="padding: 20px; background: #f8fafc; border-radius: 8px; border:1px dashed #e2e8f0; margin-top:10px;">
                                <small>Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho BigQuery <% if (!isGlobalAdmin) { %>t·∫°i <%= userBranch %><% } %></small>
                            </div>
                        <% } %>
    
                        <% if (typeof oldestSerials !== 'undefined' && oldestSerials.length > 0) { %>
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                                <strong style="font-size: 14px; color: #b45309;">‚ö†Ô∏è 5 Serial t·ªìn l√¢u nh·∫•t (B√°n m·ªõi/TB):</strong>
                                <div style="margin-top: 5px; max-height: 100px; overflow-y: auto;">
                                    <% oldestSerials.forEach(s => { %>
                                        <div style="display: flex; justify-content: space-between; font-size: 13px; padding: 4px 0; border-bottom: 1px dashed #f1f5f9;">
                                            <span style="font-family:monospace;"><%= s.serial %> (<%= s.bin_zone %>)</span>
                                            <strong style="color: #c2410c;"><%= s.days_old %> ng√†y</strong>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

    <div class="history-banner">
    <div class="info-group">
        <div class="icon-box">üîé</div>
        <div>
            <h4 class="title-text">
                L·ªãch s·ª≠ so s√°nh gi√°
                <span class="count-badge"><%= comparisonCount || 0 %> l·∫ßn</span>
            </h4>
            <span style="font-size: 13px; color: #64748b;">Xem l·∫°i c√°c l·∫ßn so gƒÉng gi√° c·ªßa SKU n√†y.</span>
        </div>
    </div>
    <a href="/price-battle?sku=<%= product.sku %>" class="btn-view-modern">Xem chi ti·∫øt ‚Üí</a>
</div>

        <% if (typeof promoGroups !== 'undefined') { 
            if (promoGroups.other && promoGroups.other.length > 0) {
            promoGroups.other = promoGroups.other.filter(p => p.promo_type !== 'KFI');
        };
            const hasHot = promoGroups.hot && promoGroups.hot.length > 0;
             const hasFuture = promoGroups.future && promoGroups.future.length > 0;
             const hasPayment = promoGroups.payment && promoGroups.payment.length > 0;
             const hasInstallment = promoGroups.installment && promoGroups.installment.length > 0;
             const hasOther = promoGroups.other && promoGroups.other.length > 0;
        %>

        <div class="promo-blocks-container">
            <% if (hasHot) { %>
            <div class="block-hot-wrapper">
                <div class="block-title-hot">üî• ∆Øu ƒë√£i HOT (Tr·ª´ tr·ª±c ti·∫øp)</div>
                <% promoGroups.hot.forEach(p => { %>
                    <div class="promo-card-item">
                        <div class="p-header">
                            <span class="p-title"><%= p.name %></span>
                            <% if (p.discount_amount_calc > 0) { %>
                                <span class="p-badge">-<%= new Intl.NumberFormat('vi-VN').format(p.discount_amount_calc) %>ƒë</span>
                            <% } %>
                        </div>
                        <% if(p.description) { %> <div class="p-desc"><%= p.description %></div> <% } %>
                        
                        
                       <% 
                            // Logic m·ªõi: Gom nh√≥m theo Option
                            let promoOptions = [];
                            if (p.detail_fields) {
                                // 1. X·ª≠ l√Ω Qu√† t·∫∑ng (Gift Options)
                                if (p.detail_fields.gift_options) {
                                    Object.values(p.detail_fields.gift_options).forEach((opt, idx) => {
                                        if (opt.skus && Array.isArray(opt.skus) && opt.skus.length > 0) {
                                            promoOptions.push({
                                                type: 'Qu√† t·∫∑ng',
                                                cssClass: 'badge-gift',
                                                // [FIX] L·∫•y th√™m m√£ code ƒë·ªÉ hi·ªÉn th·ªã
                                                code: opt.code, 
                                                name: opt.name || `T√πy ch·ªçn ${idx + 1}`,
                                                skus: opt.skus
                                            });
                                        }
                                    });
                                }
                                // 2. X·ª≠ l√Ω Combo
                                if (p.detail_fields.combos) {
                                    Object.values(p.detail_fields.combos).forEach((opt, idx) => {
                                        if (opt.skus && Array.isArray(opt.skus) && opt.skus.length > 0) {
                                            promoOptions.push({
                                                type: 'Combo',
                                                cssClass: 'badge-combo',
                                                // Combo th∆∞·ªùng kh√¥ng c√≥ code ri√™ng l·∫ª ·ªü ƒë√¢y, nh∆∞ng c·ª© l·∫•y n·∫øu c√≥
                                                code: opt.code, 
                                                name: opt.name || `Combo ${idx + 1}`,
                                                skus: opt.skus
                                            });
                                        }
                                    });
                                }
                            }
                        %>

                        <% if (promoOptions.length > 0) { %>
                            <div class="promo-extras-container">
                                <% promoOptions.forEach((group) => { %>
                                    <div class="option-group">
                                        <div class="option-header">
                                            <span class="option-badge <%= group.cssClass %>"><%= group.type %></span>
                                            
                                            <% if (group.code) { %>
                                                <code style="font-size:11px; color:#c2410c; background:#fff7ed; border:1px solid #fdba74; padding:1px 6px; border-radius:4px; font-weight:700;">
                                                    <%= group.code %>
                                                </code>
                                            <% } %>

                                            <span><%= group.name %></span>
                                        </div>

                                        <div style="display: flex; flex-direction: column; gap: 6px;">
                                            <% group.skus.forEach(skuCode => { %>
                                                <div class="gift-row-compact js-combo-item" data-sku="<%= skuCode %>" 
                                                     style="display: flex; align-items: center; justify-content: space-between; gap: 12px; background: #fff; border: 1px solid #e2e8f0; padding: 6px 10px; border-radius: 6px;">
                                                    
                                                    <span style="flex: 1; font-size: 12px; color: #334155; line-height: 1.4;">
                                                        <strong style="color: #0f172a; white-space: nowrap;"><%= skuCode %></strong> - 
                                                        <span class="js-name" style="color:#94a3b8;">‚è≥ ƒêang t·∫£i...</span>
                                                    </span>
                                                    
                                                    <span class="stock-badge zero js-stock" 
                                                          style="font-size: 10px; font-weight: 600; padding: 2px 6px; line-height: 1; white-space: nowrap; border-radius: 20px; display: flex; align-items: center; height: fit-content; flex-shrink: 0;">
                                                        --
                                                    </span>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        <% } %>

                        <% if ((p.compat_allow_names && p.compat_allow_names.length) || (p.compat_exclude_names && p.compat_exclude_names.length)) { %>
                            <div class="compat-row">
                                <% if (p.compat_allow_names && p.compat_allow_names.length) { %>
                                    <div class="compat-tag allow" title="ƒê∆∞·ª£c √°p d·ª•ng ƒë·ªìng th·ªùi">‚úÖ C√πng: <%= p.compat_allow_names.join(', ') %></div>
                                <% } %>
                                <% if (p.compat_exclude_names && p.compat_exclude_names.length) { %>
                                    <div class="compat-tag deny" title="Kh√¥ng √°p d·ª•ng c√πng">‚õî Tr·ª´: <%= p.compat_exclude_names.join(', ') %></div>
                                <% } %>
                            </div>
                        <% } %>

                        <% if (p.coupon_code) { %>
                            <div><span class="copy-btn" onclick="copyCode(this)" data-code="<%= p.coupon_code %>">Code: <%= p.coupon_code %> ‚ùê</span></div>
                        <% } else if (p.coupon_list && p.coupon_list.length > 0) { %>
                            <div><span class="copy-btn" onclick="showCouponListModal(this)" data-promo-name="<%= p.name %>" data-coupons='<%- JSON.stringify(p.coupon_list) %>'>Xem <%= p.coupon_list.length %> m√£ ‚ùê</span></div>
                        <% } %>
                        
                        <a href="/promotion-detail/<%= p.id %>" class="p-link">Chi ti·∫øt ></a>
                    </div>
                <% }) %>
            </div>
            <% } %>
    
            <% if (hasFuture) { %>
            <div class="block-std-wrapper">
                <div class="block-title-std">üé´ T·∫∑ng m√£ gi·∫£m ƒë∆°n h√†ng sau</div>
                <% promoGroups.future.forEach(p => { 
                    const details = p.detail_fields || {};
                    const val = details.next_order_value;
                    const code = details.next_order_code;
                %>
                    <div class="promo-card-item">
                        <div class="p-title"><%= p.name %></div>
                        
                        <% if(p.description) { %> 
                            <div class="p-desc" style="margin-top:4px;"><%= p.description %></div> 
                        <% } %>

                        <% if (val) { %>
                            <div class="voucher-tear">
                                <div>
                                    <div class="vt-label">Tr·ªã gi√° phi·∫øu</div>
                                    <div class="vt-value">
                                        <% 
                                            let displayVal = val;
                                            if (val && !isNaN(String(val).replace(/\D/g, ''))) {
                                                displayVal = new Intl.NumberFormat('vi-VN').format(Number(String(val).replace(/\D/g, ''))) + ' ƒë';
                                            }
                                        %>
                                        <%= displayVal %>
                                    </div>
                                </div>
                                
                                <% if(code) { %>
                                    <div style="text-align: right; z-index: 1;">
                                        <div class="vt-label">M√£ Code</div>
                                        <div class="vt-code"><%= code %></div>
                                    </div>
                                <% } %>
                            </div>
                        <% } %>

                        <a href="/promotion-detail/<%= p.id %>" class="p-link">Chi ti·∫øt ></a>
                    </div>
                <% }) %>
            </div>
            <% } %>
            
            <% if (hasPayment) { %>
            <div class="block-std-wrapper">
                <div class="block-title-std">üí≥ ∆Øu ƒë√£i thanh to√°n</div>
                <% promoGroups.payment.forEach(p => { %>
                    <div class="promo-card-item">
                        
                        <div class="p-header">
                            <span class="p-title"><%= p.name %></span>
                            
                            <% 
                                /* --- T√çNH TO√ÅN GI√Å TR·ªä GI·∫¢M --- */
                                let payDiscount = 0;
                                let priceVal = (typeof product !== 'undefined' && product) ? Number(product.list_price || 0) : 0;

                                if (priceVal > 0) {
                                    // 1. Gi·∫£m theo % (C√≥ ki·ªÉm tra tr·∫ßn t·ªëi ƒëa)
                                    if (p.discount_value_type === 'percent') {
                                        let rawDiscount = (priceVal * (Number(p.discount_value) || 0)) / 100;
                                        let maxCap = Number(p.max_discount_amount || p.max_discount_value || 0);
                                        
                                        // N·∫øu c√≥ tr·∫ßn v√† gi√° t√≠nh ra v∆∞·ª£t tr·∫ßn -> L·∫•y tr·∫ßn
                                        if (maxCap > 0 && rawDiscount > maxCap) {
                                            payDiscount = maxCap;
                                        } else {
                                            payDiscount = rawDiscount;
                                        }
                                    } 
                                    // 2. Gi·∫£m ti·ªÅn m·∫∑t
                                    else if (p.discount_value_type === 'amount') {
                                        payDiscount = Number(p.discount_value) || 0;
                                    }
                                }
                            %>

                            <% if (payDiscount > 0) { %>
                                <span class="p-badge-blue">
                                    -<%= Math.round(payDiscount).toLocaleString('vi-VN') %>‚Ç´
                                </span>
                            <% } %>
                        </div>

                        <div class="p-desc"><%= p.description || 'Gi·∫£m th√™m khi thanh to√°n qua ƒë·ªëi t√°c' %></div>
                        <a href="/promotion-detail/<%= p.id %>" class="p-link">Chi ti·∫øt ></a>
                    </div>
                <% }) %>
            </div>
            <% } %>
           
    
            <% if (hasInstallment) { %>
            <div class="block-std-wrapper">
                <div class="block-title-std">üè¶ ∆Øu ƒë√£i tr·∫£ g√≥p</div>
                <% promoGroups.installment.forEach(p => { %>
                    <div class="promo-card-item">
                        <div class="p-title"><%= p.name %></div>
                        <div class="p-desc"><%= p.description || 'L√£i su·∫•t ∆∞u ƒë√£i qua c√¥ng ty t√†i ch√≠nh ho·∫∑c th·∫ª t√≠n d·ª•ng' %></div>
                        <a href="/promotion-detail/<%= p.id %>" class="p-link">Chi ti·∫øt ></a>
                    </div>
                <% }) %>
            </div>
            <% } %>
    
            <% if (hasOther) { %>
    <div class="block-std-wrapper">
        <div class="block-title-std">üéÅ Qu√† t·∫∑ng & Combo kh√°c</div>
        <% promoGroups.other.forEach(p => { %>
            <div class="promo-card-item">
                <div class="p-title"><%= p.name %></div>
                <% if(p.description) { %> <div class="p-desc"><%= p.description %></div> <% } %>

                <% 
                    const df = p.detail_fields || {};
                    
                    // [FIX] 1. KI·ªÇM TRA XEM C√ì TIER PRICE KH√îNG?
                    const hasTierPrice = (df.tiers && Array.isArray(df.tiers) && df.tiers.length > 0);

                    // [FIX] 2. SETUP COMBO SLIDER (Ch·ªâ b·∫≠t n·∫øu KH√îNG C√ì Tier Price)
                    const hasCombo = !hasTierPrice && (p.promo_type === 'Combo' && (df.combo_partner_subcat || df.combo_sku_list));
                    
                    const cVal = df.combo_discount_val || 0;
                    const cType = df.combo_discount_type || 'amount';
                    const cMin = df.combo_min_order ? new Intl.NumberFormat('vi-VN').format(df.combo_min_order) : 0;
                    
                    // X·ª≠ l√Ω text hi·ªÉn th·ªã
                    let comboText = "Mua k√®m c√°c s·∫£n ph·∫©m b√™n d∆∞·ªõi";
                    if(cVal > 0) {
                        const valStr = cType === 'percent' ? `${cVal}%` : `${new Intl.NumberFormat('vi-VN').format(cVal)}ƒë`;
                        comboText += ` s·∫Ω ƒë∆∞·ª£c <span style="color:#d97706; font-weight:bold;">GI·∫¢M NGAY ${valStr}</span>`;
                    }
                    if(cMin != 0) comboText += ` (ƒê∆°n t·ª´ ${cMin}ƒë)`;

                    // [FIX] 3. SETUP VOLUME DISCOUNT (Ch·ªâ b·∫≠t n·∫øu KH√îNG C√ì Tier Price)
                    const hasVolume = !hasTierPrice && df.volume_subcat;

                    // [FIX] 4. SETUP QU√Ä T·∫∂NG TH∆Ø·ªúNG / TEXT C≈® (Ch·ªâ ch·∫°y n·∫øu KH√îNG C√ì Tier Price)
                    let promoOptions = [];
                    
                    if (!hasTierPrice) {
                        // L·∫•y Qu√† t·∫∑ng
                        if (df.gift_options) {
                            Object.values(df.gift_options).forEach((opt, idx) => {
                                if (opt.skus && Array.isArray(opt.skus) && opt.skus.length > 0) {
                                    promoOptions.push({
                                        type: 'Qu√† t·∫∑ng', cssClass: 'badge-gift',
                                        code: opt.code || p.coupon_code, 
                                        name: opt.name || `T√πy ch·ªçn ${idx + 1}`, skus: opt.skus
                                    });
                                }
                            });
                        }

                        // L·∫•y Combo c≈© (d·∫°ng text list) N·∫æU KH√îNG C√ì Slider Combo m·ªõi
                        if (!hasCombo && df.combos) { 
                            Object.values(df.combos).forEach((opt, idx) => {
                                if (opt.skus && Array.isArray(opt.skus) && opt.skus.length > 0) {
                                    promoOptions.push({
                                        type: 'Combo', cssClass: 'badge-combo',
                                        code: opt.code || p.coupon_code, 
                                        name: opt.name || `Combo ${idx + 1}`, skus: opt.skus
                                    });
                                }
                            });
                        }
                    }
                %>

                <% if (hasTierPrice) { %>
                    <div class="option-group" style="margin-top:8px; border:1px dashed #f59e0b; background:#fffbeb; padding:8px; border-radius:6px;">
                        <div class="option-header" style="color:#b45309; font-weight:700; font-size:12px; margin-bottom: 5px;">
                            <span style="background:#f59e0b; color:#fff; padding:2px 6px; border-radius:4px; margin-right:5px;">TIER</span>
                            MUA NHI·ªÄU GI·∫¢M S√ÇU
                        </div>
                        
                        <% df.tiers.forEach(function(t) { %>
                            <div style="display:flex; justify-content:space-between; font-size:13px; border-bottom:1px dashed #fcd34d; padding:3px 0;">
                                <span>Mua t·ª´ <b><%= t.min_qty %></b> sp</span>
                                <span style="color:#d97706; font-weight:700;">
                                    Gi·∫£m th√™m 
                                    <% if (t.type === 'percent') { %>
                                        <%= t.discount %>%
                                    <% } else { %>
                                        <%= new Intl.NumberFormat('vi-VN').format(t.discount) %>ƒë
                                    <% } %>
                                    /sp
                                </span>
                            </div>
                        <% }) %>
                    </div>
                <% } %>

                <% if (hasCombo) { %>
                    <div style="margin-top:10px; padding:10px; background:#f0f9ff; border:1px dashed #3b82f6; border-radius:6px;">
                        
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                            
                            <div style="font-size:12px; color:#1e3a8a; line-height:1.4; flex:1; padding-right:10px;">
                                üß© <%- comboText %>
                            </div>

                            <button type="button" 
                                    onclick="openComboModal('<%= df.combo_partner_subcat || '' %>', `<%= df.combo_sku_list ? df.combo_sku_list.replace(/[\r\n]+/g, ',') : '' %>`)"
                                    style="border:none; background:none; color:#2563eb; font-size:11px; font-weight:600; cursor:pointer; text-decoration:underline; white-space:nowrap;">
                                Xem t·∫•t c·∫£ &rsaquo;
                            </button>
                        </div>

                        <div class="slider-wrapper">
                            <button class="nav-btn nav-prev" onclick="scrollSlider(this, -1)">&#10094;</button>
                            <div class="combo-slider-container" 
                                 data-subcat="<%= df.combo_partner_subcat || '' %>"
                                 data-sku-list="<%= df.combo_sku_list || '' %>" 
                                 data-discount-val="<%= cVal %>"
                                 data-discount-type="<%= cType %>">
                                 <span style="font-size:10px; color:#666;">‚è≥ ƒêang t·∫£i DS Combo...</span>
                            </div>
                            <button class="nav-btn nav-next" onclick="scrollSlider(this, 1)">&#10095;</button>
                        </div>
                    </div>
                <% } %>

                <% if (hasVolume) { %>
                    <div style="margin-top:10px; padding:10px; background:#fff7ed; border:1px dashed #f97316; border-radius:6px;">
                        <div style="font-size:12px; color:#c2410c; font-weight:700; margin-bottom:5px;">
                            üì¶ Mua S·ªë L∆∞·ª£ng L·ªõn - Gi√° S·ªëc (Nh√≥m <%= df.volume_subcat %>)
                        </div>
                        <div class="slider-wrapper">
                            <button class="nav-btn nav-prev" onclick="scrollSlider(this, -1)">&#10094;</button>
                            <div class="combo-slider-container" 
                                 data-subcat="<%= df.volume_subcat %>"
                                 data-type="volume">
                                 <span style="font-size:10px; color:#666;">‚è≥ ƒêang t·∫£i DS Volume...</span>
                            </div>
                            <button class="nav-btn nav-next" onclick="scrollSlider(this, 1)">&#10095;</button>
                        </div>
                    </div>
                <% } %>

                <% if (promoOptions.length > 0) { %>
                    <div class="promo-extras-container" style="margin-top:10px;">
                        <% promoOptions.forEach((group) => { %>
                            <div class="option-group">
                                <div class="option-header">
                                    <span class="option-badge <%= group.cssClass %>"><%= group.type %></span>
                                    <span><%= group.name %></span>
                                </div>
                                <% group.skus.forEach(skuCode => { 
                                    const info = (typeof extraSkuInfoMap !== 'undefined' && extraSkuInfoMap) ? extraSkuInfoMap[skuCode] : null;
                                %>
                                    <div class="gift-row-compact">
                                        <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                            <strong><%= skuCode %></strong> - <%= info ? info.name : 'ƒêang t·∫£i...' %>
                                        </span>
                                        <span class="stock-badge <%= (!info || info.stock === 0) ? 'zero' : '' %>">
                                            T·ªìn: <%= info ? info.stock : 0 %>
                                        </span>
                                    </div>
                                <% }) %>
                            </div>
                        <% }) %>
                    </div>
                <% } %>

                <a href="/promotion-detail/<%= p.id %>" class="p-link" style="margin-top:5px; display:inline-block;">Chi ti·∫øt ch∆∞∆°ng tr√¨nh ></a>
            </div>
        <% }) %>
    </div>
<% } %>
    
            <% if (!hasHot && !hasFuture && !hasPayment && !hasInstallment && !hasOther) { %>
                <div class="no-data"><i>üì≠</i> <p>Kh√¥ng c√≥ CTKM n√†o √°p d·ª•ng cho s·∫£n ph·∫©m n√†y.</p></div>
            <% } %>
        </div>
    
        <% if (totalDiscount > 0) { %>
        <div class="price-summary">
            <h3 style="color:#0f172a; font-size:15px; margin: 0 0 15px 0; font-weight: 700; text-transform: uppercase;">
                üßæ T·ªïng t·∫°m t√≠nh (Tham kh·∫£o)
            </h3>
            
            <div class="summary-item">
                <span style="color: #64748b;">Gi√° ni√™m y·∫øt:</span>
                <strong><%= new Intl.NumberFormat('vi-VN').format(product.list_price) %> VNƒê</strong>
            </div>
            
            <div class="summary-item">
                <span style="color: #64748b;">T·ªïng gi·∫£m tr·ª±c ti·∫øp (∆Øu ƒë√£i Hot):</span>
                <strong style="color:#dc2626;">-<%= new Intl.NumberFormat('vi-VN').format(totalDiscount) %> VNƒê</strong>
            </div>
            
            <div class="summary-item final-price">
                <span style="color: #0f172a;">Gi√° kh√°ch mua:</span>
                <strong><%= new Intl.NumberFormat('vi-VN').format(finalPrice) %> VNƒê</strong>
            </div>
            
            <div style="font-size:12px; color:#94a3b8; margin-top:10px; font-style:italic;">
                * Gi√° tr√™n ch∆∞a bao g·ªìm gi·∫£m th√™m t·ª´ ∆∞u ƒë√£i thanh to√°n, m√£ gi·∫£m ƒë∆°n h√†ng sau.
            </div>
        </div>
        <% } %>
    
        <% } else { %>
            <% if (typeof product === 'undefined') { %>
               <div style="text-align: center; padding: 40px; color: #94a3b8;">
                   <p style="font-size: 16px;">Vui l√≤ng nh·∫≠p SKU ƒë·ªÉ tra c·ª©u ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i.</p>
               </div>
            <% } else { %>
               <div class="no-data"><i>üì≠</i> <p>Kh√¥ng c√≥ d·ªØ li·ªáu cho SKU n√†y.</p></div>
            <% } %>
        <% } %>
    <% } %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function parseNumber(s) { return parseInt(String(s || '').replace(/\D/g, ''), 10) || 0; }
    function formatNumber(n) { return new Intl.NumberFormat('vi-VN').format(Number(n || 0)); }
    
    // Popup Coupon List
    window.showCouponListModal = function (button) {
        var modal = document.getElementById('couponListModal');
        var titleEl = document.getElementById('couponModalTitle');
        var container = document.getElementById('couponModalTableContainer');
        if (!modal || !titleEl || !container) return;
        var promoName = (button && button.dataset && button.dataset.promoName) ? button.dataset.promoName : '‚Äî';
        var coupons = [];
        try { coupons = JSON.parse((button && button.dataset && button.dataset.coupons) ? button.dataset.coupons : '[]'); } catch (e) { coupons = []; }
        function fmt(n) { return new Intl.NumberFormat('vi-VN').format(n); }
        var sorted = coupons.slice().sort(function(a, b) {
            return (parseFloat(String(b.discount).replace(/\D/g,'')) || 0) - (parseFloat(String(a.discount).replace(/\D/g,'')) || 0);
        });
        var rows = sorted.map(function(c) {
            var disc = parseFloat(String(c.discount).replace(/\D/g,'')) || 0;
            return `<tr><td>${c.name||'-'}</td><td><button class="code-badge" onclick="copyCode(this)" data-code="${c.code||''}">${c.code||''}</button></td><td class="money">${disc?fmt(disc):'-'}</td><td>${c.note||'-'}</td></tr>`;
        }).join('');
        titleEl.textContent = 'Danh s√°ch coupon: ' + promoName;
        container.innerHTML = '<div class="table-scroll-wrapper"><table class="info-table" style="margin-top:10px"><thead><tr><th>T√™n/Nh√≥m</th><th>M√£</th><th>Gi·∫£m</th><th>Ghi ch√∫</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
        modal.style.display = 'flex';
    };

    // Copy Code Logic
    window.copyCode = function(btn) {
        const code = btn.getAttribute('data-code');
        if (code) {
            navigator.clipboard.writeText(code).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>ƒê√£ copy!</span>';
                setTimeout(() => btn.innerHTML = originalText, 1500);
            });
        }
    };

    // Logic S·ª≠a gi√° / L·ªãch s·ª≠ gi√° (nh∆∞ c≈©)
    const sku = "<%= (typeof product !== 'undefined' && product) ? product.sku : '' %>";
    if (sku) {
        const btnEdit = document.getElementById('btnEditPrice');
        const btnSave = document.getElementById('btnSavePrice');
        const btnCancel = document.getElementById('btnCancelPrice');
        const view = document.getElementById('priceView');
        const editWrap = document.getElementById('priceEdit');
        const input = document.getElementById('priceInput');
        const btnHistory = document.getElementById('btnHistoryPrice');
        const historyModal = document.getElementById('priceHistoryModal');
        const historyTbody = document.querySelector('#phTable tbody');

        if (input) input.addEventListener('input', (e) => { e.target.value = formatNumber(parseNumber(e.target.value)); });
        if (btnEdit) btnEdit.onclick = () => { view.style.display = 'none'; editWrap.style.display = 'block'; input.focus(); };
        if (btnCancel) btnCancel.onclick = () => { editWrap.style.display = 'none'; view.style.display = 'block'; };
        
        if (btnSave) btnSave.onclick = async () => {
            try {
                const newPrice = parseNumber(input.value);
                if (newPrice < 0) { alert('Gi√° kh√¥ng h·ª£p l·ªá'); return; }
                const res = await fetch(`/api/sku/${encodeURIComponent(sku)}/price`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_price: newPrice })
                });
                const js = await res.json();
                if (!js.ok) throw new Error(js.error || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
                document.getElementById('searchForm').submit();
            } catch (e) { alert(e.message); }
        };

        if (btnHistory) btnHistory.onclick = async (e) => {
            e.preventDefault();
            historyTbody.innerHTML = '<tr><td colspan="4" style="text-align:center">ƒêang t·∫£i...</td></tr>';
            historyModal.style.display = 'flex';
            try {
                const res = await fetch(`/api/sku/${encodeURIComponent(sku)}/price-history`);
                const js = await res.json();
                if (!js.ok) throw new Error(js.error);
                const rows = (js.history || []).map(r => `<tr><td>${new Date(r.changed_at).toLocaleString('vi-VN')}</td><td>${new Intl.NumberFormat('vi-VN').format(r.old_price||0)}</td><td><strong>${new Intl.NumberFormat('vi-VN').format(r.new_price||0)}</strong></td><td>${r.user||'-'}</td></tr>`).join('');
                historyTbody.innerHTML = rows || `<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>`;
            } catch (e) { historyTbody.innerHTML = `<tr><td colspan="4">L·ªói: ${e.message}</td></tr>`; }
        };
        
        // Close modal
        window.onclick = (e) => {
            if (e.target == historyModal) historyModal.style.display = "none";
            if (e.target == document.getElementById('couponListModal')) document.getElementById('couponListModal').style.display = "none";
        }
        document.querySelectorAll('.close').forEach(el => el.onclick = function() { this.closest('.modal').style.display = 'none'; });
    }
});
</script>

<div id="priceHistoryModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>L·ªãch s·ª≠ s·ª≠a gi√°</h3>
    <table class="info-table" id="phTable">
      <thead><tr><th>Th·ªùi gian</th><th>Gi√° c≈©</th><th>Gi√° m·ªõi</th><th>Ng∆∞·ªùi s·ª≠a</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="couponListModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="couponModalTitle"></h2>
        <div id="couponModalTableContainer"></div>
    </div>
</div>
<div id="comboModal">
    <div id="comboModalContent">
        <span onclick="document.getElementById('comboModal').style.display='none'" style="float:right; font-size:24px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3 id="modalTitle" style="margin-top:0; color:#1e3a8a;">Danh s√°ch s·∫£n ph·∫©m gh√©p</h3>
        <input type="text" id="modalSearch" placeholder="L·ªçc nhanh t√™n ho·∫∑c m√£ sku trong danh s√°ch n√†y..." 
               style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; margin-bottom:15px;"
               onkeyup="filterModalItems()">
        
        <div id="modalList" class="grid-view-modal"></div>
    </div>
</div>

<script>
window.scrollSlider = function(btn, direction) {
    const wrapper = btn.parentElement;
    const container = wrapper.querySelector('.combo-slider-container');
    // Scroll 150px m·ªói l·∫ßn b·∫•m (t∆∞∆°ng ƒë∆∞∆°ng h∆°n 1 card)
    container.scrollBy({ left: direction * 150, behavior: 'smooth' });
};
    
// 1. H√†m ch·∫°y t·ª± ƒë·ªông khi load trang
document.addEventListener("DOMContentLoaded", async function() {
    const sliders = document.querySelectorAll('.combo-slider-container');
    
    for (let box of sliders) {
        // L·∫•y d·ªØ li·ªáu
        const subcat = box.getAttribute('data-subcat');
        const skuListRaw = box.getAttribute('data-sku-list'); // L·∫•y list SKU
        
        // N·∫øu kh√¥ng c√≥ c·∫£ 2 th√¨ b·ªè qua
        if(!subcat && !skuListRaw) continue;

        try {
        // L·∫•y th√¥ng tin gi·∫£m gi√° t·ª´ data attributes
        const discountVal = Number(box.getAttribute('data-discount-val')) || 0;
        const discountType = box.getAttribute('data-discount-type') || 'amount';
        
        // T·∫°o chu·ªói hi·ªÉn th·ªã gi·∫£m gi√°
        let discountHtml = '';
        if (discountVal > 0) {
            const label = discountType === 'percent' ? `Gi·∫£m th√™m ${discountVal}%` : `Gi·∫£m th√™m -${new Intl.NumberFormat('vi-VN').format(discountVal)}ƒë`;
            discountHtml = `<div class="highlight-discount">üî• ${label}</div>`;
        }

        let apiUrl = '';
            
            if (skuListRaw && skuListRaw.trim() !== '') {
                // X·ª≠ l√Ω chu·ªói nh·∫≠p v√†o: thay xu·ªëng d√≤ng b·∫±ng d·∫•u ph·∫©y
                const cleanList = skuListRaw.replace(/\n/g, ',').replace(/;/g, ',');
                apiUrl = `/api/components?skus=${encodeURIComponent(cleanList)}`;
            } else {
                apiUrl = `/api/components?subcat=${encodeURIComponent(subcat)}`;
            }

            const res = await fetch(apiUrl);
            // -------------------------

            const json = await res.json();
            let data = json.components || [];


        data.sort((a, b) => (b.list_price || 0) - (a.list_price || 0));
        box.innerHTML = ''; 

        if (data && data.length > 0) {
                // Ch·ªâ hi·ªÉn th·ªã t·ªëi ƒëa 15 s·∫£n ph·∫©m ƒë·ªÉ nh·∫π trang
                data.slice(0, 15).forEach(item => {
                    const priceStr = new Intl.NumberFormat('vi-VN').format(item.list_price || 0);
                    const productName = item.product_name || item.sku;
                    
                    // [Y√äU C·∫¶U 2] X·ª≠ l√Ω hi·ªÉn th·ªã T·ªìn kho
                    const stockQty = item.total_stock || 0;
                    const stockClass = stockQty > 0 ? '' : 'out-stock';
                    const stockLabel = stockQty > 0 ? `T·ªìn: ${stockQty}` : 'H·∫øt h√†ng';

                    const html = `
                        <div class="mini-sku-card" onclick="window.open('/search-promotion?sku=${item.sku}', '_blank')" style="cursor:pointer;">
                            
                            <div class="mini-stock-badge ${stockClass}">${stockLabel}</div>

                            <div class="no-img-box" title="${productName}">
                                ${productName}
                            </div>

                            <div class="mini-sku-code" style="text-align:center;">${item.sku}</div>
                            <div class="mini-sku-price" style="text-align:center;">${priceStr}ƒë</div>
                            
                            ${discountHtml}
                        </div>
                    `;
                    box.insertAdjacentHTML('beforeend', html);
                });
            } else {
                box.innerHTML = `<span style="font-size:11px; color:#64748b; padding:10px;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y SP: ${subcat}</span>`;
            }
        } catch (e) {
            console.error(e);
            box.innerHTML = '<span style="font-size:11px; color:red; padding:10px;">L·ªói t·∫£i d·ªØ li·ªáu.</span>';
        }
    }
});

// 2. Bi·∫øn l∆∞u d·ªØ li·ªáu t·∫°m cho Modal
let currentModalData = [];

// 3. H√†m m·ªü Modal "Xem t·∫•t c·∫£"
// [FIXED] H√†m m·ªü Modal Combo - X·ª≠ l√Ω danh s√°ch SKU th√¥ng minh
async function openComboModal(subcatCode, skuListRaw) {
    const modal = document.getElementById('comboModal');
    const listDiv = document.getElementById('modalList');
    const title = document.getElementById('modalTitle');
    const searchInput = document.getElementById('modalSearch');
    
    // Reset search input
    if(searchInput) searchInput.value = '';

    // Update Modal Title based on context
    if (skuListRaw && skuListRaw.trim()) {
        title.innerText = 'Danh s√°ch s·∫£n ph·∫©m Combo (Theo SKU)';
    } else {
        title.innerText = `S·∫£n ph·∫©m nh√≥m: ${subcatCode}`;
    }
    
    listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>';
    modal.style.display = 'block';

    try {
        let apiUrl = '';
        
        // [IMPORTANT] SKU List Processing Logic
        // Automatically splits by: newline (\n), comma (,), semicolon (;), or whitespace (\s)
        if (skuListRaw && skuListRaw.trim() !== '') {
            const cleanList = skuListRaw.split(/[\n\r,;\s]+/) // Split by any separator
                                        .map(s => s.trim())   // Trim whitespace
                                        .filter(s => s.length > 0) // Remove empty strings
                                        .join(',');           // Join with standard comma
                                        
            apiUrl = `/api/components?skus=${encodeURIComponent(cleanList)}`;
        } else {
            apiUrl = `/api/components?subcat=${encodeURIComponent(subcatCode)}`;
        }

        console.log("Calling API:", apiUrl); // Debug log

        const res = await fetch(apiUrl);
        const json = await res.json();
        
        // Store data for client-side filtering
        currentModalData = json.components || [];
        
        // Render the list
        renderModalItems(currentModalData);
        
    } catch (e) {
        console.error(e);
        listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">‚ö†Ô∏è L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.</div>';
    }
}


// 4. H√†m v·∫Ω l·∫°i items trong Modal
function renderModalItems(items) {
    const listDiv = document.getElementById('modalList');
    if(!items || items.length === 0) {
        listDiv.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
        return;
    }
    
    listDiv.innerHTML = items.map(item => {
        const price = new Intl.NumberFormat('vi-VN').format(item.list_price || 0);
        // C√≥ th·ªÉ hi·ªÉn th·ªã th√™m t·ªìn kho n·∫øu API tr·∫£ v·ªÅ
        const stockInfo = item.total_stock > 0 ? `<span style="color:green; font-size:10px;">S·∫µn h√†ng: ${item.total_stock}</span>` : `<span style="color:red; font-size:10px;">H·∫øt h√†ng</span>`;
        
        return `
        <div class="mini-sku-card" style="width:100%; max-width:none; height:auto; min-height:160px;" onclick="window.open('/search-promotion?sku=${item.sku}', '_blank')">
            <div style="font-weight:bold; color:#2563eb; margin-bottom:2px;">${item.sku}</div>
            <div style="font-size:11px; color:#334155; line-height:1.3; margin-bottom:5px; height:30px; overflow:hidden;">${item.product_name || 'T√™n s·∫£n ph·∫©m...'}</div>
            <div style="margin-top:auto;">
                <div class="mini-sku-price" style="font-size:13px;">${price}ƒë</div>
                <div style="margin-top:2px;">${stockInfo}</div>
            </div>
        </div>
    `}).join('');
}

// 5. H√†m l·ªçc trong Modal (Search Client-side)
function filterModalItems() {
    const keyword = document.getElementById('modalSearch').value.toLowerCase();
    const filtered = currentModalData.filter(i => 
        (i.sku && i.sku.toLowerCase().includes(keyword)) || 
        (i.product_name && i.product_name.toLowerCase().includes(keyword))
    );
    renderModalItems(filtered);
}

// ƒê√≥ng modal khi click ra ngo√†i
window.onclick = function(event) {
    const modal = document.getElementById('comboModal');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>
<%- include('partials/toast') %>
<%- include('partials/search-autocomplete') %>
<%- include('partials/footer') %>
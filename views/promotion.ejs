<%- include('partials/header', {title: 'CTKM theo SKU' , currentPage: 'promotion' , time: time}) %>

    <style>
        .promotion-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .search-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .search-section h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: end;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn-search {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            height: 50px;
        }

        .btn-search:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .product-info {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .product-info h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 22px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 3px solid #e74c3c;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .info-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
            width: 150px;
        }

        .info-table td {
            padding: 15px;
            border: 1px solid #dee2e6;
            font-weight: 500;
            color: #2c3e50;
            background: white;
        }

        .info-table tr:nth-child(even) td {
            background: #f8f9fa;
        }

        .promotions-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .promotions-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 22px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 3px solid #27ae60;
        }

        .promotion-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .promotion-table th {
            background: #27ae60;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #229954;
        }

        .promotion-table td {
            padding: 15px;
            border: 1px solid #dee2e6;
            vertical-align: top;
        }

        .promotion-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .promo-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .promo-detail {
            color: #6c757d;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .promo-detail strong {
            color: #495057;
        }

        .discount-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .discount-item {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }

        .discount-item strong {
            color: #27ae60;
        }

        .price-summary {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border: 2px solid #ffc107;
        }

        .price-summary h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ffeaa7;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item strong {
            color: #856404;
        }

        .final-price {
            font-size: 20px;
            font-weight: 700;
            color: #e74c3c;
        }

        .no-data {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }

        .no-data i {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
            color: #adb5bd;
        }

        .no-data p {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .btn-detail {
            background: #3498db;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-block;
            margin-top: 10px;
        }

        .btn-detail:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        


    </style>

    <div class="promotion-container">
        <% if (typeof error !=='undefined' && error) { %>
            <div class="error-message">
                ‚ö†Ô∏è <%= error %>
            </div>
            <% } %>
                
            
            
            <div class="page-search">
                    <div class="search-section">
                        <h1>CTKM theo SKU</h1>
                       <form action="/search-promotion" method="POST" class="search-form" id="searchForm">
  <div class="form-group">
    <label for="skuSearch">Nh·∫≠p SKU ho·∫∑c CTKM</label>
    <div class="autocomplete-container">
      <!-- ƒë·ªïi id="sku" -> id="skuSearch" -->
      <input type="text" id="skuSearch" name="sku" autocomplete="off"
             placeholder="V√≠ d·ª•: 244994124"
             value="<%= typeof product !== 'undefined' && product ? product.sku : '' %>">
      <!-- ƒë·ªïi id="skuAutocomplete" -> id="autocompleteResults" -->
      <div class="autocomplete-results" id="autocompleteResults"></div>
    </div>
                   
  </div>
  <button type="submit" class="btn-search">üîç T√¨m ki·∫øm</button>
</form>



                    </div>
     <%# === KH·ªêI THI ƒêUA N·ªòI B·ªò M·ªöI === %>
        <% if (internalContest) { %>
          <div class="internal-contest-card">
            <div class="contest-icon">üèÜ</div>
            <div class="contest-content">
              <div class="contest-title"><%= internalContest.name %></div>
              <% if (internalContest.description) { %>
                <p class="contest-desc"><%= internalContest.description %></p>
              <% } %>
              <div class="contest-expiry">
                H·∫°n: <%= new Date(internalContest.end_date).toLocaleDateString('vi-VN') %>
              </div>
            </div>
            <a href="/promotion-detail/<%= internalContest.id %>" class="contest-link">Xem</a>
          </div>
        <% } %>


                

                <% if (typeof product !=='undefined' && product) { %>
                    <div class="product-info">
                        <h2>Th√¥ng tin s·∫£n ph·∫©m</h2>
                        <table class="product-table">
                            <tr>
                                <th>SKU</th>
                                <td>
                                    <%= product.sku %>
                                </td>
                            </tr>
                            <tr>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <td>
                                    <%= product.product_name %>
                                </td>
                            </tr>
                            <tr>
                                <th>Brand</th>
                                <td>
                                    <%= product.brand %>
                                </td>
                            </tr>
                            <tr>
                                <th>Subcat</th>
                                <td>
                                    <%= product.subcat %>
                                </td>
                            </tr>
                            <tr>
  <th>Gi√° ni√™m y·∫øt</th>
  <td>
    <span id="priceView"><strong><%= product.list_price ? new Intl.NumberFormat('vi-VN').format(product.list_price) + ' VNƒê' : 'N/A' %></strong></span>
    <button id="btnEditPrice" type="button" title="S·ª≠a gi√°" style="margin-left:8px;">‚úèÔ∏è</button>
    <button id="btnHistoryPrice" type="button" title="L·ªãch s·ª≠ gi√°">üïò</button>

    <span id="priceEdit" style="display:none;margin-left:8px;">
      <input id="priceInput" type="number" min="0" step="1000" value="<%= product.list_price || 0 %>" style="width:140px;">
      <button id="btnSavePrice" type="button">L∆∞u</button>
      <button id="btnCancelPrice" type="button">Hu·ª∑</button>
    </span>
  </td>
</tr>

                        </table>
                    </div>
                    <p style="margin-top:12px">
                        üîé L·ªãch s·ª≠ so s√°nh gi√°:
                        <strong>
                            <%= comparisonCount || 0 %> l·∫ßn
                        </strong>
                        ¬∑ <a href="/price-battle?sku=<%= product.sku %>">Xem chi ti·∫øt</a>
                    </p>

                    <div class="promotions-section">
                        <h2>CTKM kh·∫£ d·ª•ng</h2>

                        <% if (typeof promotions !=='undefined' && promotions.length> 0) { %>
                            <table class="promo-table">
                                <thead>
                                    <tr>
                                        <th>CTKM</th>
                                        <th>Chi ti·∫øt</th>
                                        <th>√Åp d·ª•ng c√πng</th>
                                        <th>Lo·∫°i tr·ª´</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% promotions.forEach(promo=> { %>
                                        <tr class="<%= (product.list_price || 0) < (promo.min_order_value || 0) ? 'promo-inactive' : '' %>">
                                            <td data-label="CTKM">
                                                <div class="promo-name">
                                                    <%= promo.name %>
                                                </div>
                                                <div class="promo-detail">
                                                    <strong>üìÖ:</strong>
                                                    <%= promo.start_date ? new
                                                        Date(promo.start_date).toLocaleDateString('vi-VN') : 'N/A' %> -
                                                        <%= promo.end_date ? new
                                                            Date(promo.end_date).toLocaleDateString('vi-VN') : 'N/A' %>
                                                </div>
                                                <div class="promo-detail"><strong>üéØ:</strong>
                                                    <%= promo.promo_type %>
                                                </div>
                                            </td>

                                            <td data-label="Chi ti·∫øt">
                                                <% if (promo.description) { %>
                                                    <div class="promo-detail">
                                                        <%= promo.description %>
                                                    </div>
                                                    <% } %>
                                                        <% if (promo.coupon_list && Array.isArray(promo.coupon_list) && promo.coupon_list.length > 0) { %>
    <button type="button" class="code-badge" 
            onclick="showCouponListModal(this)"
            data-promo-name="<%= promo.name %>"
            data-coupons='<%- JSON.stringify(promo.coupon_list) %>'>
        üìú Danh s√°ch coupon (B·∫•m ƒë·ªÉ xem)
    </button>

<% } else if (promo.coupon_code) { %>
    <button type="button" class="code-badge" onclick="copyCode(this)" data-code="<%= promo.coupon_code %>">
        üîë <span><%= promo.coupon_code %></span> <small>(B·∫•m ƒë·ªÉ copy)</small>
    </button>
<% } %>

                                                                <% if (promo.special_promotion_rules &&
                                                                    promo.special_promotion_rules.length> 0) { %>
                                                                    <div class="discount-grid">
                                                                        <% promo.special_promotion_rules.forEach(rule=>
                                                                            { %>
                                                                            <div class="discount-item">
                                                                                <strong>
                                                                                    <%= rule.brand || 'T·∫•t c·∫£' %> - <%=
                                                                                            rule.subcat || 'T·∫•t c·∫£' %>
                                                                                </strong><br>
                                                                                Gi·∫£m: <%= new
                                                                                    Intl.NumberFormat('vi-VN').format(rule.discount_value)
                                                                                    %> VNƒê
                                                                            </div>
                                                                            <% }); %>
                                                                    </div>
                                                                    <% } %>
                                            </td>
                                            <td>
                                                <% if (promo.compat_allow_names && promo.compat_allow_names.length) { %>
  <%= promo.compat_allow_names.join(', ') %>
<% } else { %><span class="muted">Kh√¥ng</span><% } %>
</td>
<td>
  <% if (promo.compat_exclude_names && promo.compat_exclude_names.length) { %>
    <%= promo.compat_exclude_names.join(' , ') %>
  <% } else { %><span class="muted">Kh√¥ng</span><% } %>
</td>
                                                <td data-label="Action">
                                                <a href="/promotion-detail/<%= promo.id %>" class="btn-detail">üëÅÔ∏è Xem
                                                    chi ti·∫øt</a>
                                            </td>
                                        </tr>
                                        <% }); %>
                                </tbody>
                            </table>

                            <!-- Ph·∫ßn t·ªïng k·∫øt gi√° -->
                            <div class="summary-item">
                                <span>T·ªïng c√≥ th·ªÉ gi·∫£m:</span>
                                <strong>
                                    <%= new Intl.NumberFormat('vi-VN').format(totalDiscount || 0) %> VNƒê
                                                        </strong>
                    </div>
                    <div class="summary-item final-price">
                        <span>Gi√° khuy·∫øn m√£i cu·ªëi:</span>
                        <strong>
                            <%= new Intl.NumberFormat('vi-VN').format(finalPrice || 0) %> VNƒê
                        </strong>
                    </div>


                    <% } else { %>
                        <div class="no-data">
                            <i>üì≠</i>
                            <p>Kh√¥ng c√≥ CTKM n√†o √°p d·ª•ng cho s·∫£n ph·∫©m n√†y</p>
                            <p>Vui l√≤ng ki·ªÉm tra l·∫°i SKU ho·∫∑c th·ª≠ SKU kh√°c</p>
                        </div>
                        <% } %>
    </div>
    <% } %>
        </div>


  <!-- ... c√°c script kh√°c c·ªßa trang ... -->
 



<script>
(function(){
  const sku = "<%= product ? product.sku : '' %>";
  const btnEdit  = document.getElementById('btnEditPrice');
  const btnSave  = document.getElementById('btnSavePrice');
  const btnCancel= document.getElementById('btnCancelPrice');
  const view     = document.getElementById('priceView');
  const editWrap = document.getElementById('priceEdit');
  const input    = document.getElementById('priceInput');

  function fmtVND(n){ return new Intl.NumberFormat('vi-VN').format(Number(n||0)) + ' VNƒê'; }

  if (btnEdit){
    btnEdit.onclick = ()=>{ view.style.display='none'; editWrap.style.display='inline-block'; input.focus(); };
  }
  if (btnCancel){
    btnCancel.onclick = ()=>{ editWrap.style.display='none'; view.style.display='inline'; };
  }
  if (btnSave){
    btnSave.onclick = async ()=>{
      try{
        const newPrice = Number(input.value);
        if (!Number.isFinite(newPrice) || newPrice < 0) { alert('Gi√° kh√¥ng h·ª£p l·ªá'); return; }
        const res = await fetch(`/api/sku/${encodeURIComponent(sku)}/price`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ new_price: newPrice })
        });
        const js = await res.json();
        if (!js.ok) throw new Error(js.error || 'C·∫≠p nh·∫≠t gi√° th·∫•t b·∫°i');

        // c·∫≠p nh·∫≠t UI
        view.innerHTML = `<strong>${fmtVND(js.new_price)}</strong>`;
        editWrap.style.display='none'; view.style.display='inline';
        

         // ‚úÖ QUAN TR·ªåNG: g·ª≠i l·∫°i form ƒë·ªÉ server t√≠nh l·∫°i finalPrice/totalDiscount
      const f = document.getElementById('searchForm');
      if (f) f.submit();
        
      // g·ª£i √Ω: m·ªü lu√¥n l·ªãch s·ª≠ ƒë·ªÉ th·∫•y d√≤ng m·ªõi
        //const btnHist = document.getElementById('btnHistoryPrice');
        ///if (btnHist) btnHist.click();
      }catch(e){
        alert(e.message);
      }
    };
  }
})();
</script>



<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- H√†m ƒëi·ªÅu khi·ªÉn popup danh s√°ch coupon ---
    window.showCouponListModal = function (button) {
  var modal     = document.getElementById('couponListModal');
  var titleEl   = document.getElementById('couponModalTitle');
  var container = document.getElementById('couponModalTableContainer');
  if (!modal || !titleEl || !container) return;

  var promoName = (button && button.dataset && button.dataset.promoName) ? button.dataset.promoName : '‚Äî';

  // Parse JSON an to√†n
  var coupons = [];
  try {
    coupons = JSON.parse((button && button.dataset && button.dataset.coupons) ? button.dataset.coupons : '[]');
  } catch (e) {
    console.warn('data-coupons kh√¥ng ph·∫£i JSON h·ª£p l·ªá:', e);
    coupons = [];
  }

  function toNumber(v) {
    if (typeof v === 'number') return v;
    if (v == null || v === '') return 0;
    return parseFloat(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }
  function fmt(n) {
    return new Intl.NumberFormat('vi-VN').format(toNumber(n));
  }
  function esc(s) { return (s == null ? '' : String(s)); }

  // S·∫Øp x·∫øp GI·∫¢M D·∫¶N theo discount
  var sorted = coupons.slice().sort(function(a, b) {
    return toNumber(b && b.discount) - toNumber(a && a.discount);
  });

  // Render b·∫£ng (kh√¥ng d√πng backtick)
  var rows = '';
  sorted.forEach(function(c) {
    rows += '<tr>'
      + '<td>' + (esc(c && c.name) || '-') + '</td>'
      + '<td><button class="code-badge" onclick="copyCode(this)" data-code="' + (esc(c && c.code) || '') + '">'
      + '<span>' + (esc(c && c.code) || '') + '</span> <small>(copy)</small>'
      + '</button></td>'
      + '<td>' + (toNumber(c && c.discount) ? fmt(c.discount) : '-') + '</td>'
      + '<td>' + (esc(c && c.note) || '-') + '</td>'
      + '</tr>';
  });

  titleEl.textContent = 'Danh s√°ch coupon cho: ' + promoName;
  container.innerHTML =
      '<div class="table-scroll-wrapper">'
    +   '<table class="info-table" style="margin-top:15px">'
    +     '<thead>'
    +       '<tr>'
    +         '<th>T√™n/Nh√≥m SP</th>'
    +         '<th>M√£ Voucher</th>'
    +         '<th>M·ª©c gi·∫£m</th>'
    +         '<th>ƒêi·ªÅu ki·ªán</th>'
    +       '</tr>'
    +     '</thead>'
    +     '<tbody>' + rows + '</tbody>'
    +   '</table>'
    + '</div>';

  modal.style.display = 'block';
};
    // --- Logic cho vi·ªác s·ª≠a gi√° v√† xem l·ªãch s·ª≠ ---
    const sku = "<%= (typeof product !== 'undefined' && product) ? product.sku : '' %>";
    if (sku) {
        const btnEdit  = document.getElementById('btnEditPrice');
        const btnSave  = document.getElementById('btnSavePrice');
        const btnCancel= document.getElementById('btnCancelPrice');
        const view     = document.getElementById('priceView');
        const editWrap = document.getElementById('priceEdit');
        const input    = document.getElementById('priceInput');
        const btnHistory = document.getElementById('btnHistoryPrice');
        const historyModal = document.getElementById('priceHistoryModal');
        const historyClose = document.getElementById('phClose');
        const historyTbody = document.querySelector('#phTable tbody');

        if(btnEdit) btnEdit.onclick = () => { view.style.display='none'; editWrap.style.display='inline-block'; input.focus(); };
        if(btnCancel) btnCancel.onclick = () => { editWrap.style.display='none'; view.style.display='inline'; };

        if(btnSave) btnSave.onclick = async () => {
            try {
                const newPrice = Number(input.value);
                if (!Number.isFinite(newPrice) || newPrice < 0) { alert('Gi√° kh√¥ng h·ª£p l·ªá'); return; }
                const res = await fetch(`/api/sku/${encodeURIComponent(sku)}/price`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ new_price: newPrice }) });
                const js = await res.json();
                if (!js.ok) throw new Error(js.error || 'C·∫≠p nh·∫≠t gi√° th·∫•t b·∫°i');
                document.getElementById('searchForm').submit();
            } catch(e) {
                alert(e.message);
            }
        };

        if(btnHistory) btnHistory.addEventListener('click', async () => {
            try{
                const res = await fetch(`/api/sku/${encodeURIComponent(sku)}/price-history`);
                const js = await res.json();
                if (!js.ok) throw new Error(js.error||'Load history failed');
                const rows = (js.history||[]).map(r=>`<tr><td>${new Date(r.changed_at).toLocaleString('vi-VN')}</td><td>${new Intl.NumberFormat('vi-VN').format(r.old_price||0)} VNƒê</td><td>${new Intl.NumberFormat('vi-VN').format(r.new_price||0)} VNƒê</td><td>${r.user||'-'}</td></tr>`).join('');
                historyTbody.innerHTML = rows || `<tr><td colspan="4">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>`;
                historyModal.style.display = 'block'; // 'flex' c√≥ th·ªÉ l√†m v·ª° layout c≈©
            } catch(e) { alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ gi√°: ' + e.message); }
        });

        if (historyClose) historyClose.onclick = () => historyModal.style.display = 'none';
        window.addEventListener('click', e => { 
            if (e.target === historyModal) historyModal.style.display = 'none';
            if (e.target === document.getElementById('couponListModal')) document.getElementById('couponListModal').style.display = 'none';
        });
    }
});
</script>


<div id="priceHistoryModal" class="modal" style="display:none">
  <div class="modal-content">
    <span id="phClose" class="close">&times;</span>
    <h3>L·ªãch s·ª≠ s·ª≠a gi√°</h3>
    <table class="detail-table" id="phTable">
      <thead>
        <tr><th>Th·ªùi gian</th><th>Gi√° c≈©</th><th>Gi√° m·ªõi</th><th>Ng∆∞·ªùi s·ª≠a</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="couponListModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
        <h2 id="couponModalTitle"></h2>
        <div id="couponModalTableContainer"></div>
    </div>
</div>

<%- include('partials/toast') %>
<%- include('partials/search-autocomplete') %>
<%- include('partials/footer') %>
</body>
</html>
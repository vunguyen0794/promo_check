<%- include('partials/header', { title: title, currentPage: currentPage }) %>

<% /* === CSS (Gi·ªØ nguy√™n t·ª´ promotion.ejs) === */ %>
<style>
    .promotion-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    .search-section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    .search-section h1 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 28px;
        font-weight: 700;
        text-align: center;
    }
    .search-form {
        display: flex;
        gap: 15px;
        align-items: end;
        max-width: 600px;
        margin: 0 auto;
    }
    .form-group {
        flex: 1;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    .form-group input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        transition: border-color 0.3s ease;
    }
    .form-group input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    .btn-search {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 14px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        height: 50px;
    }
    .btn-search:hover {
        background: #c0392b;
        transform: translateY(-2px);
    }
    .product-info {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    .product-info h2 {
        color: #2c3e50;
        margin-bottom: 25px;
        font-size: 22px;
        font-weight: 700;
        padding-bottom: 15px;
        border-bottom: 3px solid #e74c3c;
    }
    .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    .info-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border: 1px solid #dee2e6;
        width: 150px;
    }
    .info-table td {
        padding: 15px;
        border: 1px solid #dee2e6;
        font-weight: 500;
        color: #2c3e50;
        background: white;
    }
    .info-table tr:nth-child(even) td {
        background: #f8f9fa;
    }
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
        text-align: center;
    }
    .table-scroll-wrapper {
        overflow-x: auto;
    }
</style>

<div class="promotion-container">
    <% if (typeof error !=='undefined' && error) { %>
        <div class="error-message">
            ‚ö†Ô∏è <%= error %>
        </div>
    <% } %>
    
    <div class="page-search">
        <div class="search-section">
            <h1>Tra c·ª©u h√†ng thanh l√Ω</h1>
            <form action="/clearance-check" method="POST" class="search-form" id="searchForm">
              <div class="form-group">
                <label for="skuSearch">Nh·∫≠p SKU</label>
                <div class="autocomplete-container">
                  <input type="text" id="skuSearch" name="sku" autocomplete="off"
                         placeholder="V√≠ d·ª•: 244994124"
                         value="<%= typeof product !== 'undefined' && product ? product.sku : '' %>">
                  <div class="autocomplete-results" id="autocompleteResults"></div>
                </div>
              </div>
              <button type="submit" class="btn-search">üîç T√¨m ki·∫øm</button>
            </form>
        </div>
    </div>

    <% if (typeof allClearanceItems !== 'undefined' && allClearanceItems.length > 0) { %>
    
    <% 
       const uniqueStores = [...new Set(allClearanceItems.map(i => i.store_name))].sort();
       const uniqueCats = [...new Set(allClearanceItems.map(i => i.category))].sort();
    %>

    <div class="product-info" style="margin-top: 25px;">
        <h2 style="border-bottom-color: #3498db;">
            Danh s√°ch h√†ng thanh l√Ω ƒëang c√≥ (<span id="countDisplay"><%= allClearanceItems.length %></span>)
        </h2>
        
        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            
            <input type="text" id="quickFilter" 
                   placeholder="G√µ t√™n SP, SKU..." 
                   style="flex: 2; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            
            <select id="storeFilter" style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <option value="">-- T·∫•t c·∫£ C·ª≠a h√†ng --</option>
                <% uniqueStores.forEach(s => { %>
                    <option value="<%= s %>"><%= s %></option>
                <% }) %>
            </select>

            <select id="catFilter" style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <option value="">-- T·∫•t c·∫£ Ng√†nh h√†ng --</option>
                <% uniqueCats.forEach(c => { %>
                    <option value="<%= c %>"><%= c %></option>
                <% }) %>
            </select>
        </div>

        <div class="table-scroll-wrapper" style="max-height: 600px; overflow-y: auto;">
            <table class="info-table" id="clearanceTable">
                <thead style="position: sticky; top: 0; z-index: 10; background: #f8f9fa;">
                    <tr>
                        <th style="width: 110px;">SKU</th>
                        <th>T√™n S·∫£n Ph·∫©m</th>
                        <th style="width: 150px;">C·ª≠a h√†ng</th>
                        <th style="width: 120px; text-align: right;">Gi√°</th>
                        <th style="width: 90px; text-align: center;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <% allClearanceItems.forEach(item => { %>
                        <tr class="clearance-row" 
                            data-store="<%= item.store_name %>" 
                            data-cat="<%= item.category %>">
                            
                            <td class="searchable" style="font-weight:bold; color:#555;"><%= item.sku %></td>
                            
                            <td class="searchable">
                                <div style="font-weight: 600; color: #2c3e50;"><%= item.product_name %></div>
                                <div style="font-size: 11px; color: #888; margin-top:2px;">Serial: <%= item.serial %></div>
                            </td>

                            <td><%= item.store_name %></td>
                            
                            <td style="text-align: right; font-weight: bold; color: #e74c3c;">
                                <%= item.priceDisplay %> ‚Ç´
                            </td>
                            
                            <td style="text-align: center;">
                                <button type="button" 
                                        onclick="selectSku('<%= item.sku %>')"
                                        style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size:13px;">
                                    Ki·ªÉm tra
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <div id="noResult" style="display: none; text-align: center; padding: 20px; color: #666;">
            Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.
        </div>
    </div>

    <script>
        // H√ÄM L·ªåC T·ªîNG H·ª¢P
        function filterTable() {
            const textFilter = document.getElementById('quickFilter').value.toLowerCase();
            const storeFilter = document.getElementById('storeFilter').value;
            const catFilter = document.getElementById('catFilter').value;
            
            const rows = document.querySelectorAll('.clearance-row');
            let visibleCount = 0;

            rows.forEach(row => {
                // L·∫•y d·ªØ li·ªáu c·ªßa d√≤ng
                const cells = row.querySelectorAll('.searchable');
                let rowText = "";
                cells.forEach(c => rowText += c.textContent + " ");
                const rowStore = row.getAttribute('data-store');
                const rowCat = row.getAttribute('data-cat');

                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                const matchText = rowText.toLowerCase().includes(textFilter);
                const matchStore = (storeFilter === "") || (rowStore === storeFilter);
                const matchCat = (catFilter === "") || (rowCat === catFilter);

                if (matchText && matchStore && matchCat) {
                    row.style.display = "";
                    visibleCount++;
                } else {
                    row.style.display = "none";
                }
            });

            // C·∫≠p nh·∫≠t giao di·ªán
            document.getElementById('countDisplay').textContent = visibleCount;
            document.getElementById('noResult').style.display = (visibleCount === 0) ? "block" : "none";
        }

        // G√°n s·ª± ki·ªán
        document.getElementById('quickFilter').addEventListener('keyup', filterTable);
        document.getElementById('storeFilter').addEventListener('change', filterTable);
        document.getElementById('catFilter').addEventListener('change', filterTable);

        // H√†m ch·ªçn SKU (gi·ªØ nguy√™n)
        function selectSku(sku) {
            document.getElementById('skuSearch').value = sku;
            document.getElementById('searchForm').submit();
        }
    </script>

    <style>
        /* CSS ph·ª• tr·ª£ */
        .badge { display: inline-block; padding: 3px 7px; font-size: 11px; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 10px; }
        .badge-info { color: #fff; background-color: #17a2b8; }
    </style>
<% } %>

    <% if (typeof product !=='undefined' && product) { %>
        <div class="product-info">
            <h2>Th√¥ng tin s·∫£n ph·∫©m (Supabase)</h2>
            <table class="info-table">
                <tr>
                    <th>SKU</th>
                    <td><%= product.sku %></td>
                </tr>
                 <tr>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <td><%= product.product_name %></td>
                </tr>
                <tr>
                    <th>Brand</th>
                    <td><%= product.brand %></td>
                </tr>
                <tr>
                    <th>Gi√° ni√™m y·∫øt</th>
                    <td><strong><%= product.list_price ? new Intl.NumberFormat('vi-VN').format(product.list_price) + ' VNƒê' : 'N/A' %></strong></td>
                </tr>
            </table>

            <% /* (Ph·∫ßn hi·ªÉn th·ªã t·ªìn kho BQ) */ %>
            <% if (typeof isGlobalAdmin !== 'undefined' && isGlobalAdmin && inventoryMap && inventoryMap.get(product.sku)) { %>
                <h3 style="font-size: 16px; font-weight: 700; margin-top: 20px; margin-bottom: 10px;">
                    T·ªìn kho BigQuery (T·∫•t c·∫£ chi nh√°nh)
                </h3>
                <div class="table-scroll-wrapper">
                    <table class="info-table" style="margin-top: 0;">
                        <thead>
                           <tr>
                              <th>Chi nh√°nh</th>
                              <th style="text-align: right;">H√†ng b√°n m·ªõi</th>
                              <th style="text-align: right;">Tr∆∞ng b√†y Cƒê</th>
                              <th style="text-align: right;">L∆∞u kho TL</th>
                              <th style="text-align: right;">Tr∆∞ng b√†y TL</th>
                              <th style="text-align: right;">T·ªìn kh√°c</th>
                          </tr>
                        </thead>
                        <tbody>
                            <% const branchMap = inventoryMap.get(product.sku); %>
                            <% [...branchMap.keys()].sort().forEach(branchId => { %>
                                <% const counts = branchMap.get(branchId); %>
                                <tr>
                                   <th><%= branchId %></th>
                                   <td style="text-align: right;"><%= counts.hang_ban_moi %></td>
                                   <td style="text-align: right;"><%= counts.trung_bay_chi_dinh %></td>
                                   <td style="text-align: right;"><%= counts.luu_kho_tl %></td>
                                   <td style="text-align: right;"><%= counts.trung_bay_tl %></td>
                                   <td style="text-align: right;"><%= counts.ton_khac %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else if (typeof inventoryCounts !== 'undefined' && inventoryCounts && typeof userBranch !== 'undefined' && userBranch) { %>
                <h3 style="font-size: 16px; font-weight: 700; margin-top: 20px; margin-bottom: 10px;">
                    T·ªìn kho (BigQuery) - Chi nh√°nh: <%= userBranch %>
                </h3>
                <table class="info-table" style="margin-top: 0;">
                    <tbody>
                        <tr><th style="width: 150px;">H√†ng b√°n m·ªõi</th><td><strong><%= inventoryCounts.hang_ban_moi %></strong></td></tr>
                        <tr><th>Tr∆∞ng b√†y ch·ªâ ƒë·ªãnh</th><td><strong><%= inventoryCounts.trung_bay_chi_dinh %></strong></td></tr>
                        <tr><th>L∆∞u kho TL</th><td><strong><%= inventoryCounts.luu_kho_tl %></strong></td></tr>
                        <tr><th>Tr∆∞ng b√†y TL</th><td><strong><%= inventoryCounts.trung_bay_tl %></strong></td></tr>
                        <tr><th>T·ªìn kh√°c</th><td><strong><%= inventoryCounts.ton_khac %></strong></td></tr>
                    </tbody>
                </table>
            <% } else if (typeof userBranch !== 'undefined' && userBranch) { %>
                <div style="padding: 15px; text-align: center; color: #6c757d; font-style: italic;">
                    Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho BigQuery cho SKU n√†y.
                </div>
            <% } %>
        </div>
    <% } %>
    <% /* === H·∫æT PH·∫¶N SAO CH√âP === */ %>


    <% /* === B·∫ÆT ƒê·∫¶U: KH·ªêI HI·ªÇN TH·ªä M·ªöI === */ %>
    <% if (typeof clearanceInfo !== 'undefined' && clearanceInfo && clearanceInfo.length > 0) { %>
      <div class="product-info" style="margin-top: 20px;" id="result-sheet">
        <h2 style="border-bottom-color: #27ae60;">Th√¥ng tin Thanh l√Ω (Google Sheet) - T√¨m th·∫•y <%= clearanceInfo.length %> Serial</h2>
        
        <div class="table-scroll-wrapper">
          <table class="info-table" style="min-width: 800px;">
            <thead>
              <tr>
                <th style="width: 120px;">SR t·ªìn (C·ª≠a h√†ng)</th>
                <th>Serial</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>KFI</th>
                <th>Gi√° Thanh L√Ω</th>
                <th>H·∫øt BH</th>
                <th>H√¨nh ·∫£nh</th>
              </tr>
            </thead>
            <tbody>
              <% clearanceInfo.forEach(item => { %>
                <tr>
                  <td><%= item.store_name %></td>
                  <td><strong><%= item.serial %></strong></td>
                  <td><%- (item.tinh_trang || '').replace(/\n/g, '<br>') %></td>
                  <td><%= item.kfi %></td>
                  <td style="text-align: right; font-weight: 700;">
                    <%= new Intl.NumberFormat('vi-VN').format(Number(String(item.clearance_price).replace(/\D/g,'')) || 0) %>
                  </td>
                  <td><%= item.warranty_end %></td>
                  <td>
                    <% if (item.images && item.images.length > 0) { %>
                      <div style="display:flex; flex-wrap:wrap; gap:10px;">
                        <% item.images.forEach(imgUrl => { %>
                          <a href="<%= imgUrl %>" target="_blank">
                            <img src="<%= imgUrl %>" alt="H√¨nh ·∫£nh thanh l√Ω" style="height: 80px; width: 80px; object-fit: cover; border-radius: 8px;">
                          </a>
                        <% }); %>
                      </div>
                    <% } else { %>
                      <span class="dash-muted">N/A</span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    <% } else if (typeof product !== 'undefined' && product) { %>
      <div class="dash-muted" style="text-align: center; padding: 20px; margin-top: 20px; background: #fff; border-radius: 12px;">
        Kh√¥ng t√¨m th·∫•y th√¥ng tin thanh l√Ω (Google Sheet) cho SKU n√†y.
      </div>
    <% } %>

</div> <% /* ƒê√≥ng .promotion-container */ %>

<script>
    // 1. H√ÄM L·ªåC B·∫¢NG
    function filterTable() {
        const textFilter = document.getElementById('quickFilter').value.toLowerCase();
        const storeFilter = document.getElementById('storeFilter').value;
        const catFilter = document.getElementById('catFilter').value;
        
        const rows = document.querySelectorAll('.clearance-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const cells = row.querySelectorAll('.searchable');
            let rowText = "";
            cells.forEach(c => rowText += c.textContent + " ");
            const rowStore = row.getAttribute('data-store');
            const rowCat = row.getAttribute('data-cat');

            const matchText = rowText.toLowerCase().includes(textFilter);
            // Logic: N·∫øu filter r·ªóng (ch·ªçn t·∫•t c·∫£) HO·∫∂C gi√° tr·ªã kh·ªõp
            const matchStore = (storeFilter === "") || (rowStore === storeFilter);
            const matchCat = (catFilter === "") || (rowCat === catFilter);

            if (matchText && matchStore && matchCat) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
        const countDisplay = document.getElementById('countDisplay');
        if(countDisplay) countDisplay.textContent = visibleCount;
        
        const noResult = document.getElementById('noResult');
        if(noResult) noResult.style.display = (visibleCount === 0) ? "block" : "none";
    }

    // 2. H√ÄM CH·ªåN SKU ƒê·ªÇ KI·ªÇM TRA
    function selectSku(sku) {
        document.getElementById('skuSearch').value = sku;
        document.getElementById('searchForm').submit();
    }

    // 3. KH·ªûI T·∫†O KHI TRANG LOAD XONG
    document.addEventListener("DOMContentLoaded", function() {
        
        // --- A. T·ª∞ ƒê·ªòNG CU·ªòN (AUTO SCROLL) ---
        const sheetResult = document.getElementById('result-sheet');
        const productResult = document.getElementById('result-product');
        const errorMsg = document.querySelector('.error-message') || document.querySelector('.dash-muted');

        if (sheetResult) {
            sheetResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else if (productResult) {
            productResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else if (errorMsg) {
            errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- B. KH√îI PH·ª§C B·ªò L·ªåC T·ª™ LOCALSTORAGE (GI·ªÆ TR·∫†NG TH√ÅI) ---
        const savedStore = localStorage.getItem('clearance_store_filter');
        const savedCat = localStorage.getItem('clearance_cat_filter');
        
        const storeSelect = document.getElementById('storeFilter');
        const catSelect = document.getElementById('catFilter');

        if (storeSelect && savedStore) {
            storeSelect.value = savedStore;
        }
        if (catSelect && savedCat) {
            catSelect.value = savedCat;
        }

        // √Åp d·ª•ng l·ªçc ngay l·∫≠p t·ª©c sau khi kh√¥i ph·ª•c
        if (storeSelect || catSelect) {
            filterTable();
        }
    });

    // 4. G√ÅN S·ª∞ KI·ªÜN & L∆ØU TR·∫†NG TH√ÅI KHI THAY ƒê·ªîI
    const quickInput = document.getElementById('quickFilter');
    if(quickInput) quickInput.addEventListener('keyup', filterTable);

    const storeSelect = document.getElementById('storeFilter');
    if(storeSelect) {
        storeSelect.addEventListener('change', function() {
            // L∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát
            localStorage.setItem('clearance_store_filter', this.value);
            filterTable();
        });
    }

    const catSelect = document.getElementById('catFilter');
    if(catSelect) {
        catSelect.addEventListener('change', function() {
            // L∆∞u v√†o b·ªô nh·ªõ tr√¨nh duy·ªát
            localStorage.setItem('clearance_cat_filter', this.value);
            filterTable();
        });
    }
</script>

<%- include('partials/toast') %>
<%- include('partials/search-autocomplete') %> 
<%- include('partials/footer') %>
</body>
</html>